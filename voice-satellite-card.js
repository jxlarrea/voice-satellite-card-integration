var State={IDLE:"IDLE",CONNECTING:"CONNECTING",LISTENING:"LISTENING",PAUSED:"PAUSED",WAKE_WORD_DETECTED:"WAKE_WORD_DETECTED",STT:"STT",INTENT:"INTENT",TTS:"TTS",ERROR:"ERROR"},DEFAULT_CONFIG={start_listening_on_load:!0,wake_word_switch:"",pipeline_id:"",pipeline_timeout:60,pipeline_idle_timeout:300,chime_on_wake_word:!0,chime_on_request_sent:!0,chime_volume:100,tts_volume:100,tts_target:"",debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,show_transcription:!0,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,streaming_response:!1,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0},EXPECTED_ERRORS=["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"];class VoiceSatelliteCard extends HTMLElement{constructor(){super(),this._state=State.IDLE,this._config=Object.assign({},DEFAULT_CONFIG),this._hass=null,this._connection=null,this._hasStarted=!1,this._isStreaming=!1,this._isPaused=!1,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._idleTimeoutId=null,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3,this._currentAudio=null,this._ttsPlaying=!1,this._ttsEndTimer=null,this._globalUI=null,this._responseTimeout=null,this._streamedResponse="",this._shiftRecalcTimer=null,this._visibilityDebounceTimer=null,this._disconnectTimeout=null,this._wasConnected=!1,this._pendingStartButtonReason=void 0,this._handleVisibilityChange=this._handleVisibilityChangeFn.bind(this)}_log(t,e,i){this._config.debug&&(void 0!==i?console.log("[VS]["+t+"] "+e,i):console.log("[VS]["+t+"] "+e))}_logError(t,e,i){void 0!==i?console.error("[VS]["+t+"] "+e,i):console.error("[VS]["+t+"] "+e)}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render(),this._ensureGlobalUI(),this._setupVisibilityHandler(),!window._voiceSatelliteActive&&this._hass&&this._hass.connection&&this._startListening()}disconnectedCallback(){this._disconnectTimeout=setTimeout(function(){window._voiceSatelliteInstance},100)}setConfig(t){this._config=Object.assign({},DEFAULT_CONFIG,t),this._globalUI&&this._applyStyles(),window._voiceSatelliteInstance&&window._voiceSatelliteInstance!==this&&(window._voiceSatelliteInstance._config=this._config,window._voiceSatelliteInstance._globalUI&&window._voiceSatelliteInstance._applyStyles())}set hass(t){this._hass=t,!this._hasStarted&&t&&t.connection&&!window._voiceSatelliteStarting&&(window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this||(this._connection=t.connection,this._ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,this._startListening()):(this._hasStarted=!0,this._showStartButton())))}getCardSize(){return 0}static getConfigElement(){return document.createElement("voice-satellite-card-editor")}static getStubConfig(){return{start_listening_on_load:!0}}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}_ensureGlobalUI(){if(document.getElementById("voice-satellite-ui")){this._globalUI=document.getElementById("voice-satellite-ui"),this._flushPendingStartButton();return}var t=document.createElement("div");t.id="voice-satellite-ui",t.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-transcription"></div><div class="vs-response"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(t),this._globalUI=t,this._injectGlobalStyles(),this._applyStyles();var e=this;t.querySelector(".vs-start-btn").addEventListener("click",function(){e._handleStartClick()});var i=t.querySelector(".vs-start-btn");i.classList.add("visible"),i.title="Tap to start voice assistant",this._flushPendingStartButton()}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this._showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}_injectGlobalStyles(){if(!document.getElementById("voice-satellite-styles")){var t=document.createElement("style");t.id="voice-satellite-styles",t.textContent="#voice-satellite-ui .vs-blur-overlay {position: fixed; top: 0; left: 0; right: 0; bottom: 0;backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);background: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s ease;z-index: 9999; pointer-events: none;}#voice-satellite-ui .vs-blur-overlay.visible { opacity: 1; }#voice-satellite-ui .vs-start-btn {position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;border-radius: 50%; background: var(--primary-color, #03a9f4);border: none; cursor: pointer; display: none; align-items: center;justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);z-index: 10001; transition: transform 0.2s, box-shadow 0.2s;}#voice-satellite-ui .vs-start-btn.visible { display: flex; animation: vs-btn-pulse 2s ease-in-out infinite; }#voice-satellite-ui .vs-start-btn:hover {transform: scale(1.1); box-shadow: 0 6px 16px rgba(0,0,0,0.4); animation: none;}#voice-satellite-ui .vs-start-btn svg { width: 28px; height: 28px; fill: white; }@keyframes vs-btn-pulse {0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }50% { transform: scale(1.08); box-shadow: 0 6px 20px rgba(3,169,244,0.5); }}#voice-satellite-ui .vs-transcription,#voice-satellite-ui .vs-response {position: fixed; left: 50%; transform: translateX(-50%);opacity: 0; transition: opacity 0.3s ease, bottom 0.3s ease; z-index: 10001;max-width: 80%; text-align: center;box-shadow: 0 4px 12px rgba(0,0,0,0.15);pointer-events: none;}#voice-satellite-ui .vs-response {max-height: 40vh; overflow-y: auto;}#voice-satellite-ui .vs-transcription.visible,#voice-satellite-ui .vs-response.visible { opacity: 1; pointer-events: auto; }#voice-satellite-ui .vs-transcription.shifted { bottom: var(--vs-shifted-bottom, 100px) !important; }#voice-satellite-ui .vs-rainbow-bar {position: fixed; left: 0; right: 0;background-size: 200% 100%; opacity: 0; transition: opacity 0.3s ease;z-index: 10000; pointer-events: none;}#voice-satellite-ui .vs-rainbow-bar.visible { opacity: 1; }#voice-satellite-ui .vs-rainbow-bar.connecting {animation: vs-bar-breathe 1.5s ease-in-out infinite;}#voice-satellite-ui .vs-rainbow-bar.listening {animation: vs-gradient-flow 3s linear infinite;}#voice-satellite-ui .vs-rainbow-bar.processing {animation: vs-gradient-flow 0.5s linear infinite;}#voice-satellite-ui .vs-rainbow-bar.speaking {animation: vs-gradient-flow 2s linear infinite;}#voice-satellite-ui .vs-rainbow-bar.error-mode {animation: vs-gradient-flow 2s linear infinite; opacity: 1;}@keyframes vs-gradient-flow {0% { background-position: 0% 50%; }100% { background-position: 200% 50%; }}@keyframes vs-bar-breathe {0%, 100% { opacity: 0.3; }50% { opacity: 0.7; }}",document.head.appendChild(t)}}_applyStyles(){if(this._globalUI){var t=this._config,e=this._globalUI.querySelector(".vs-rainbow-bar");e.style.height=t.bar_height+"px",e.style["top"===t.bar_position?"top":"bottom"]="0",e.style["top"===t.bar_position?"bottom":"top"]="auto",e.style.background="linear-gradient(90deg, "+t.bar_gradient+")",e.style.backgroundSize="200% 100%";var i=this._globalUI.querySelector(".vs-blur-overlay");t.background_blur?(i.style.backdropFilter="blur("+t.background_blur_intensity+"px)",i.style.webkitBackdropFilter="blur("+t.background_blur_intensity+"px)"):(i.style.backdropFilter="none",i.style.webkitBackdropFilter="none");var s=this._globalUI.querySelector(".vs-transcription");s.style.fontSize=t.transcription_font_size+"px",s.style.fontFamily=t.transcription_font_family,s.style.color=t.transcription_font_color,s.style.fontWeight=t.transcription_font_bold?"bold":"normal",s.style.fontStyle=t.transcription_font_italic?"italic":"normal",s.style.background=t.transcription_background,s.style.border="3px solid "+t.transcription_border_color,s.style.padding=t.transcription_padding+"px",s.style.borderRadius=t.transcription_rounded?"12px":"0";var o=this._globalUI.querySelector(".vs-response");o.style.fontSize=t.response_font_size+"px",o.style.fontFamily=t.response_font_family,o.style.color=t.response_font_color,o.style.fontWeight=t.response_font_bold?"bold":"normal",o.style.fontStyle=t.response_font_italic?"italic":"normal",o.style.background=t.response_background,o.style.border="3px solid "+t.response_border_color,o.style.padding=t.response_padding+"px",o.style.borderRadius=t.response_rounded?"12px":"0";var r=t.bar_height||6;if("bottom"===t.bar_position){var n=r+12;o.style.bottom=n+"px",o.style.top="auto",s.style.bottom=n+"px",s.style.top="auto",this._globalUI.style.setProperty("--vs-shifted-bottom",n+o.offsetHeight+10+"px")}else{var n=12;o.style.bottom=n+"px",o.style.top="auto",s.style.bottom=n+"px",s.style.top="auto",this._globalUI.style.setProperty("--vs-shifted-bottom",n+o.offsetHeight+10+"px")}}}_setState(t){var e=this._state;this._state=t,this._log("state",e+" → "+t),this._updateUI()}_updateUI(){if(this._globalUI){var t={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[this._state];if(t){if(this._serviceUnavailable&&!t.barVisible||this._ttsPlaying&&!t.barVisible)return;var e=this._globalUI.querySelector(".vs-rainbow-bar");t.barVisible?(e.classList.contains("error-mode")&&this._clearErrorBar(),e.classList.add("visible"),e.classList.remove("connecting","listening","processing","speaking"),t.animation&&e.classList.add(t.animation)):(e.classList.contains("error-mode")&&this._clearErrorBar(),e.classList.remove("visible","connecting","listening","processing","speaking"))}}}async _startListening(){if(window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this){this._log("lifecycle","Another instance is active, skipping");return}if(window._voiceSatelliteStarting){this._log("lifecycle","Pipeline already starting globally, skipping");return}window._voiceSatelliteStarting=!0;try{this._setState(State.CONNECTING),await this._startMicrophone(),await this._startPipeline(),window._voiceSatelliteActive=!0,window._voiceSatelliteInstance=this,this._hideStartButton()}catch(t){this._logError("pipeline","Failed to start: "+t);var e="error";"NotAllowedError"===t.name?(e="not-allowed",this._log("mic","Access denied — browser requires user gesture")):"NotFoundError"===t.name?(e="not-found",this._logError("mic","No microphone found")):("NotReadableError"===t.name||"AbortError"===t.name)&&(e="not-readable",this._logError("mic","Microphone in use or not readable")),this._showStartButton(e),this._setState(State.IDLE)}finally{window._voiceSatelliteStarting=!1}}async _startMicrophone(){await this._ensureAudioContextRunning(),this._log("mic","AudioContext state="+this._audioContext.state+" sampleRate="+this._audioContext.sampleRate);var t={sampleRate:16e3,channelCount:1,echoCancellation:this._config.echo_cancellation,noiseSuppression:this._config.noise_suppression,autoGainControl:this._config.auto_gain_control};if(this._config.voice_isolation&&(t.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:t}),this._config.debug){var e=this._mediaStream.getAudioTracks();if(this._log("mic","Got media stream with "+e.length+" audio track(s)"),e.length>0){var i=e[0].getSettings();this._log("mic","Track settings: "+JSON.stringify(i))}}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log("mic","Actual sample rate: "+this._actualSampleRate);try{await this._setupAudioWorklet(this._sourceNode),this._log("mic","Audio capture via AudioWorklet")}catch(s){this._log("mic","AudioWorklet unavailable ("+s.message+"), using ScriptProcessor"),this._setupScriptProcessor(this._sourceNode),this._log("mic","Audio capture via ScriptProcessor")}}_stopMicrophone(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(function(t){t.stop()}),this._mediaStream=null),this._audioBuffer=[]}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw Error("AudioContext failed to start: "+this._audioContext.state)}async _setupAudioWorklet(t){var e=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),i=URL.createObjectURL(e);await this._audioContext.audioWorklet.addModule(i),URL.revokeObjectURL(i),this._workletNode=new AudioWorkletNode(this._audioContext,"voice-satellite-processor");var s=this;this._workletNode.port.onmessage=function(t){s._audioBuffer.push(new Float32Array(t.data))},t.connect(this._workletNode),this._workletNode.connect(this._audioContext.destination)}_setupScriptProcessor(t){this._scriptProcessor=this._audioContext.createScriptProcessor(2048,1,1);var e=this;this._scriptProcessor.onaudioprocess=function(t){var i=t.inputBuffer.getChannelData(0);e._audioBuffer.push(new Float32Array(i))},t.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)}_sendAudioBuffer(){if(null!==this._binaryHandlerId&&void 0!==this._binaryHandlerId&&0!==this._audioBuffer.length){for(var t=0,e=0;e<this._audioBuffer.length;e++)t+=this._audioBuffer[e].length;for(var i=new Float32Array(t),s=0,e=0;e<this._audioBuffer.length;e++)i.set(this._audioBuffer[e],s),s+=this._audioBuffer[e].length;this._audioBuffer=[],16e3!==this._actualSampleRate&&(i=this._resample(i,this._actualSampleRate,16e3));var o=this._floatTo16BitPCM(i);this._sendBinaryAudio(o)}}_resample(t,e,i){if(e===i)return t;for(var s=e/i,o=Math.round(t.length/s),r=new Float32Array(o),n=0;n<o;n++){var a=n*s,l=Math.floor(a),c=Math.min(l+1,t.length-1),h=a-l;r[n]=t[l]*(1-h)+t[c]*h}return r}_floatTo16BitPCM(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++){var s=Math.max(-1,Math.min(1,t[i]));e[i]=s<0?32768*s:32767*s}return e}_sendBinaryAudio(t){if(null!==this._binaryHandlerId&&void 0!==this._binaryHandlerId&&this._connection&&this._connection.socket&&this._connection.socket.readyState===WebSocket.OPEN){var e=new Uint8Array(1+t.byteLength);e[0]=this._binaryHandlerId,e.set(new Uint8Array(t.buffer),1),this._connection.socket.send(e.buffer)}}async _startPipeline(){var t=this;if(!this._connection){if(this._hass&&this._hass.connection)this._connection=this._hass.connection;else throw Error("No Home Assistant connection available")}var e=await this._connection.sendMessagePromise({type:"assist_pipeline/pipeline/list"});this._log("pipeline","Available: "+e.pipelines.map(function(t){return t.name+" ("+t.id+")"+(t.preferred?" [preferred]":"")}).join(", "));var i=this._config.pipeline_id;if(!i){var s=e.pipelines.find(function(t){return t.preferred});i=s?s.id:e.pipelines[0].id}this._log("pipeline","Starting pipeline: "+i);var o={type:"assist_pipeline/run",start_stage:"wake_word",end_stage:"tts",input:{sample_rate:16e3,timeout:0},pipeline:i,timeout:this._config.pipeline_idle_timeout};this._log("pipeline","Run config: "+JSON.stringify(o)),this._unsubscribe=await this._connection.subscribeMessage(function(e){t._handlePipelineMessage(e)},o),this._log("pipeline","Subscribed, waiting for run-start..."),this._sendInterval=setInterval(function(){t._sendAudioBuffer()},100),this._isStreaming=!0,this._startIdleTimeout()}async _stopPipeline(){if(this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null),this._binaryHandlerId=null,this._isStreaming=!1,this._unsubscribe){try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}this._clearIdleTimeout()}_restartPipeline(t){var e=this;if(this._isRestarting){this._log("pipeline","Restart already in progress — skipping");return}this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._clearIdleTimeout(),this._stopPipeline().then(function(){e._restartTimeout=setTimeout(function(){e._restartTimeout=null,e._isRestarting=!1,e._startPipeline().catch(function(t){e._logError("pipeline","Restart failed: "+t),e._serviceUnavailable||(e._showErrorBar(),e._serviceUnavailable=!0),e._restartPipeline(e._calculateRetryDelay())})},t||0)})}_handlePipelineMessage(t){var e=t.type,i=t.data||{};if(this._config.debug){var s=t.timestamp?t.timestamp.split("T")[1].split(".")[0]:"";this._log("event",s+" "+e+" "+JSON.stringify(i).substring(0,500))}switch(e){case"run-start":this._handleRunStart(i);break;case"wake_word-start":this._handleWakeWordStart();break;case"wake_word-end":this._handleWakeWordEnd(i);break;case"stt-start":this._setState(State.STT);break;case"stt-vad-start":this._log("event","VAD: speech started");break;case"stt-vad-end":this._log("event","VAD: speech ended");break;case"stt-end":this._handleSttEnd(i);break;case"intent-start":this._setState(State.INTENT);break;case"intent-progress":this._config.streaming_response&&this._handleIntentProgress(i);break;case"intent-end":this._handleIntentEnd(i);break;case"tts-start":this._setState(State.TTS);break;case"tts-end":this._handleTtsEnd(i);break;case"run-end":this._handleRunEnd();break;case"error":this._handlePipelineError(i)}}_handleRunStart(t){this._binaryHandlerId=t.runner_data.stt_binary_handler_id,this._setState(State.LISTENING),this._resetIdleTimeout(),this._log("pipeline","Running — binary handler ID: "+this._binaryHandlerId),this._log("pipeline","Listening for wake word...")}_handleWakeWordStart(){if(this._serviceUnavailable){var t=this;this._recoveryTimeout&&clearTimeout(this._recoveryTimeout),this._recoveryTimeout=setTimeout(function(){t._serviceUnavailable&&(t._log("recovery","Wake word service recovered"),t._serviceUnavailable=!1,t._retryCount=0,t._clearErrorBar(),t._globalUI.querySelector(".vs-rainbow-bar").classList.remove("visible"))},2e3)}}_handleWakeWordEnd(t){var e=t.wake_word_output;if(!e||0===Object.keys(e).length){this._logError("error","Wake word service unavailable (empty wake_word_output)"),this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._binaryHandlerId=null,this._showErrorBar(),this._serviceUnavailable=!0,this._restartPipeline(this._calculateRetryDelay());return}this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._serviceUnavailable=!1,this._retryCount=0,this._clearErrorBar(),this._ttsPlaying&&(this._stopTTS(),this._pendingRunEnd=!1),this._intentErrorBarTimeout&&(clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=null),this._hideTranscription(),this._hideResponse(),this._setState(State.WAKE_WORD_DETECTED),this._resetIdleTimeout(),this._config.chime_on_wake_word&&this._playChime("wake"),this._turnOffWakeWordSwitch(),this._showBlurOverlay()}_handleSttEnd(t){var e=t.stt_output?t.stt_output.text:"";e&&this._showTranscription(e)}_handleIntentEnd(t){var e=null;try{e=t.intent_output.response.response_type}catch(i){}if("error"===e){var s=this._extractResponseText(t)||"An error occurred";this._logError("error","Intent error: "+s),this._showErrorBar(),this._config.chime_on_wake_word&&this._playChime("error"),this._suppressTTS=!0;var o=this;this._intentErrorBarTimeout&&clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=setTimeout(function(){o._intentErrorBarTimeout=null,o._clearErrorBar(),o._globalUI&&o._globalUI.querySelector(".vs-rainbow-bar").classList.remove("visible")},3e3),this._streamedResponse="";return}var r=this._extractResponseText(t);r&&this._showResponse(r),this._streamedResponse=""}_handleIntentProgress(t){if(t.chat_log_delta){var e=t.chat_log_delta.content;"string"==typeof e&&(this._streamedResponse=(this._streamedResponse||"")+e,this._updateResponse(this._streamedResponse))}}_handleTtsEnd(t){if(this._suppressTTS){this._suppressTTS=!1,this._log("tts","TTS suppressed (intent error)"),this._restartPipeline(0);return}var e=t.tts_output?t.tts_output.url||t.tts_output.url_path:null;e&&this._playTTS(e),this._restartPipeline(0)}_handleRunEnd(){if(this._log("pipeline","Run ended"),this._binaryHandlerId=null,this._isRestarting){this._log("pipeline","Restart already in progress — skipping run-end restart");return}if(this._serviceUnavailable){this._log("ui","Error recovery handling restart"),this._hideBlurOverlay(),this._hideTranscription(),this._hideResponse();return}if(this._ttsPlaying){this._log("ui","TTS playing — deferring cleanup"),this._pendingRunEnd=!0;return}this._finishRunEnd()}_finishRunEnd(){if(this._pendingRunEnd=!1,this._hideBlurOverlay(),this._hideTranscription(),this._hideResponse(),this._setState(State.IDLE),this._serviceUnavailable){this._log("ui","Retry already scheduled — skipping restart");return}this._restartPipeline(0)}_handlePipelineError(t){var e=t.code||"",i=t.message||"";if(this._log("error",e+" — "+i),-1!==EXPECTED_ERRORS.indexOf(e)){this._log("pipeline","Expected error: "+e+" — restarting");var s=[State.WAKE_WORD_DETECTED,State.STT,State.INTENT,State.TTS];if(-1!==s.indexOf(this._state)){this._log("ui","Cleaning up interaction UI after expected error"),this._setState(State.IDLE),this._hideBlurOverlay(),this._hideTranscription(),this._hideResponse();var o=this._config.tts_target&&"browser"!==this._config.tts_target;this._config.chime_on_request_sent&&!o&&this._playChime("done")}this._restartPipeline(0);return}this._logError("error","Unexpected: "+e+" — "+i);var s=[State.WAKE_WORD_DETECTED,State.STT,State.INTENT,State.TTS],r=-1!==s.indexOf(this._state);this._binaryHandlerId=null,r&&this._config.chime_on_wake_word&&this._playChime("error"),this._showErrorBar(),this._serviceUnavailable=!0,this._hideBlurOverlay(),this._restartPipeline(this._calculateRetryDelay())}_extractResponseText(t){try{var e=t.intent_output.response.speech.plain.speech;if(e)return e}catch(i){}try{if(t.intent_output.response.speech.speech)return t.intent_output.response.speech.speech}catch(s){}try{if(t.intent_output.response.plain)return t.intent_output.response.plain}catch(o){}try{if("string"==typeof t.intent_output.response)return t.intent_output.response}catch(r){}return this._log("error","Could not extract response text"),null}_calculateRetryDelay(){this._retryCount++;var t=Math.min(5e3*this._retryCount,3e4);return this._log("pipeline","Retry in "+t+"ms (attempt #"+this._retryCount+")"),t}_startIdleTimeout(){var t=this;this._clearIdleTimeout(),this._config.pipeline_idle_timeout<=0||(this._idleTimeoutId=setTimeout(function(){if(-1!==[State.WAKE_WORD_DETECTED,State.STT,State.INTENT,State.TTS].indexOf(t._state)){t._log("pipeline","Idle timeout fired but interaction in progress — deferring"),t._resetIdleTimeout();return}if(t._ttsPlaying){t._log("pipeline","Idle timeout fired but TTS playing — deferring"),t._resetIdleTimeout();return}t._log("pipeline","Idle timeout — restarting"),t._restartPipeline(0)},1e3*this._config.pipeline_idle_timeout))}_clearIdleTimeout(){this._idleTimeoutId&&(clearTimeout(this._idleTimeoutId),this._idleTimeoutId=null)}_resetIdleTimeout(){this._startIdleTimeout()}_showStartButton(t){if(!this._globalUI){this._pendingStartButtonReason=t;return}var e=this._globalUI.querySelector(".vs-start-btn");e.classList.add("visible"),"not-allowed"===t?e.title="Tap to enable microphone":"not-found"===t?e.title="No microphone found":"not-readable"===t?e.title="Microphone unavailable - tap to retry":e.title="Tap to start voice assistant"}_hideStartButton(){this._globalUI&&this._globalUI.querySelector(".vs-start-btn").classList.remove("visible")}_showBlurOverlay(){this._globalUI&&this._config.background_blur&&this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible")}_hideBlurOverlay(){this._globalUI&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible")}_showTranscription(t){if(this._config.show_transcription&&this._globalUI){var e=this._globalUI.querySelector(".vs-transcription");e.textContent=t,e.classList.add("visible")}}_hideTranscription(){this._globalUI&&this._globalUI.querySelector(".vs-transcription").classList.remove("visible")}_showResponse(t){if(this._config.show_response&&this._globalUI){var e=this._globalUI.querySelector(".vs-response");e.textContent=t,e.classList.add("visible"),this._globalUI.querySelector(".vs-transcription").classList.add("shifted"),this._recalcShiftedPosition()}}_updateResponse(t){if(this._config.show_response&&this._globalUI){var e=this._globalUI.querySelector(".vs-response");e.textContent=t,e.classList.contains("visible")||(e.classList.add("visible"),this._globalUI.querySelector(".vs-transcription").classList.add("shifted")),this._recalcShiftedPosition()}}_hideResponse(){this._globalUI&&(this._responseTimeout&&clearTimeout(this._responseTimeout),this._globalUI.querySelector(".vs-response").classList.remove("visible"),this._globalUI.querySelector(".vs-transcription").classList.remove("shifted"))}_recalcShiftedPosition(){if(!this._shiftRecalcTimer){var t=this;this._shiftRecalcTimer=requestAnimationFrame(function(){t._shiftRecalcTimer=null;var e=t._globalUI.querySelector(".vs-response"),i=t._config.bar_height||6,s=("bottom"===t._config.bar_position?i+12:12)+e.offsetHeight+10;t._globalUI.style.setProperty("--vs-shifted-bottom",s+"px")})}}_showErrorBar(){if(this._globalUI){var t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("connecting","listening","processing","speaking"),t.classList.add("visible","error-mode"),t.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222)",t.style.backgroundSize="200% 100%"}}_clearErrorBar(){if(this._globalUI){var t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("error-mode"),t.style.background="linear-gradient(90deg, "+this._config.bar_gradient+")",t.style.backgroundSize="200% 100%"}}_playChime(t){try{var e=new(window.AudioContext||window.webkitAudioContext),i=e.createOscillator(),s=e.createGain();i.connect(s),s.connect(e.destination);var o=this._config.chime_volume/100*.5;"wake"===t?(i.type="sine",s.gain.setValueAtTime(o,e.currentTime),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+.25),i.frequency.setValueAtTime(523,e.currentTime),i.frequency.setValueAtTime(659,e.currentTime+.08),i.frequency.setValueAtTime(784,e.currentTime+.16),i.start(),i.stop(e.currentTime+.25)):"error"===t?(i.type="square",s.gain.setValueAtTime(.3*o,e.currentTime),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),i.frequency.setValueAtTime(300,e.currentTime),i.frequency.setValueAtTime(200,e.currentTime+.08),i.start(),i.stop(e.currentTime+.15)):(i.type="sine",s.gain.setValueAtTime(o,e.currentTime),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),i.frequency.setValueAtTime(784,e.currentTime),i.frequency.setValueAtTime(659,e.currentTime+.08),i.start(),i.stop(e.currentTime+.25)),setTimeout(function(){e.close()},500)}catch(r){this._logError("tts","Chime error: "+r)}}_playTTS(t){var e=this,i=this._buildTtsUrl(t);if(this._ttsPlaying=!0,this._config.tts_target&&"browser"!==this._config.tts_target){this._playTTSRemote(i);return}var s=new Audio;s.volume=this._config.tts_volume/100,s.onended=function(){e._log("tts","Playback complete"),e._onTTSComplete()},s.onerror=function(t){e._logError("tts","Playback error: "+t),e._logError("tts","URL: "+i),e._onTTSComplete()},s.src=i,s.play().catch(function(t){e._logError("tts","play() failed: "+t),e._onTTSComplete()}),this._currentAudio=s}_playTTSRemote(t){var e=this,i=this._config.tts_target;this._log("tts","Playing on remote: "+i+" URL: "+t),this._hass.callService("media_player","play_media",{entity_id:i,media_content_id:t,media_content_type:"music"}).catch(function(t){e._logError("tts","Remote play failed: "+t)}),this._ttsEndTimer=setTimeout(function(){e._ttsEndTimer=null,e._onTTSComplete()},2e3)}_onTTSComplete(){if(this._log("tts","Complete — cleaning up UI"),this._currentAudio=null,this._ttsPlaying=!1,this._ttsEndTimer&&(clearTimeout(this._ttsEndTimer),this._ttsEndTimer=null),-1!==[State.WAKE_WORD_DETECTED,State.STT,State.INTENT,State.TTS].indexOf(this._state)){this._log("tts","New interaction in progress — skipping cleanup");return}var t=this._config.tts_target&&"browser"!==this._config.tts_target;this._config.chime_on_request_sent&&!t&&this._playChime("done"),this._hideResponse(),this._hideBlurOverlay(),this._hideTranscription(),this._updateUI()}_stopTTS(){if(this._ttsPlaying=!1,this._ttsEndTimer&&(clearTimeout(this._ttsEndTimer),this._ttsEndTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null),this._config.tts_target&&"browser"!==this._config.tts_target&&this._hass){var t=this;this._hass.callService("media_player","media_stop",{entity_id:this._config.tts_target}).catch(function(e){t._logError("tts","Remote stop failed: "+e)})}}_buildTtsUrl(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;var e=window.location.origin;return t.startsWith("/")||(t="/"+t),e+t}_turnOffWakeWordSwitch(){if(this._config.wake_word_switch&&this._hass){var t=this,e=this._config.wake_word_switch;if(!e.includes(".")){this._log("switch","Invalid entity: "+e);return}this._log("switch","Turning off: "+e),this._hass.callService("homeassistant","turn_off",{entity_id:e}).catch(function(e){t._logError("switch","Failed to turn off: "+e)})}}_setupVisibilityHandler(){document.addEventListener("visibilitychange",this._handleVisibilityChange)}_handleVisibilityChangeFn(){var t=this;this._visibilityDebounceTimer&&clearTimeout(this._visibilityDebounceTimer),document.hidden?this._visibilityDebounceTimer=setTimeout(function(){t._log("visibility","Tab hidden — pausing"),t._pauseMicrophone()},500):(t._log("visibility","Tab visible — resuming"),t._resumeMicrophone())}_pauseMicrophone(){this._isPaused=!0,this._setState(State.PAUSED),this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null),this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(t){t.enabled=!1})}_resumeMicrophone(){if(this._isPaused){this._isPaused=!1,this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(t){t.enabled=!0});var t=this;!this._sendInterval&&this._isStreaming&&(this._sendInterval=setInterval(function(){t._sendAudioBuffer()},100)),this._unsubscribe||this._restartTimeout?this._setState(State.LISTENING):(this._log("visibility","Pipeline subscription lost during pause — restarting"),this._restartPipeline(0))}}async _handleStartClick(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(t){this._logError("mic","Failed to resume AudioContext on click: "+t)}await this._startListening()}}class VoiceSatelliteCardEditor extends HTMLElement{constructor(){super(),this._config={},this._hass=null,this._pipelines=[]}set hass(t){this._hass=t,t&&t.connection&&0===this._pipelines.length&&this._loadPipelines()}setConfig(t){this._config=Object.assign({},DEFAULT_CONFIG,t),this._render()}async _loadPipelines(){try{var t=await this._hass.connection.sendMessagePromise({type:"assist_pipeline/pipeline/list"});this._pipelines=t.pipelines||[],this._render()}catch(e){console.error("[VS][editor] Failed to load pipelines:",e)}}_render(){for(var t=this._config,e='<option value="">Default Pipeline</option>',i=0;i<this._pipelines.length;i++){var s=this._pipelines[i],o=s.id===t.pipeline_id?" selected":"";e+='<option value="'+s.id+'"'+o+">"+(s.name||s.id)+"</option>"}var r='<option value=""'+(t.tts_target?"":" selected")+">Browser (default)</option>";if(this._hass)for(var n=this._hass.states||{},a=Object.keys(n).filter(function(t){return t.startsWith("media_player.")}).sort(),l=0;l<a.length;l++){var c=a[l],h=n[c].attributes.friendly_name||c,d=c===t.tts_target?" selected":"";r+='<option value="'+c+'"'+d+">"+h+"</option>"}this.innerHTML='<style>.vs-editor { padding: 16px; }.vs-section { margin-bottom: 16px; padding: 12px; background: var(--card-background-color, #fff); border-radius: 8px; border: 1px solid var(--divider-color, #e0e0e0); }.vs-section-title { font-weight: bold; font-size: 14px; margin-bottom: 12px; color: var(--primary-color, #03a9f4); }.vs-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; min-height: 36px; }.vs-row label { flex: 1; font-size: 14px; }.vs-row input[type="checkbox"] { width: 20px; height: 20px; }.vs-row input[type="number"], .vs-row input[type="text"], .vs-row input[type="color"], .vs-row select { width: 160px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--divider-color, #ccc); background: var(--card-background-color, #fff); color: var(--primary-text-color, #333); }.vs-row input[type="range"] { width: 120px; }.vs-row .range-val { width: 32px; text-align: right; font-size: 13px; }</style><div class="vs-editor"><div class="vs-section"><div class="vs-section-title">Behavior</div>'+this._selectRow("Pipeline","pipeline_id",e)+this._checkboxRow("Start listening on load","start_listening_on_load")+this._textRow("Wake word switch entity","wake_word_switch","switch.screensaver")+this._checkboxRow("Debug logging","debug")+'</div><div class="vs-section"><div class="vs-section-title">Microphone Processing</div>'+this._checkboxRow("Noise suppression","noise_suppression")+this._checkboxRow("Echo cancellation","echo_cancellation")+this._checkboxRow("Auto gain control","auto_gain_control")+this._checkboxRow("Voice isolation (Chrome only)","voice_isolation")+'</div><div class="vs-section"><div class="vs-section-title">Timeouts</div>'+this._numberRow("Pipeline timeout (s)","pipeline_timeout",0,300)+this._numberRow("Pipeline idle timeout (s)","pipeline_idle_timeout",0,3600)+'</div><div class="vs-section"><div class="vs-section-title">Volume & Chimes</div>'+this._selectRow("TTS output device (Experimental)","tts_target",r)+this._sliderRow("Chime volume","chime_volume",0,100)+this._sliderRow("TTS volume","tts_volume",0,100)+this._checkboxRow("Chime on wake word","chime_on_wake_word")+this._checkboxRow("Chime on request sent","chime_on_request_sent")+'</div><div class="vs-section"><div class="vs-section-title">Rainbow Bar</div>'+this._selectRowRaw("Position","bar_position",'<option value="bottom"'+("bottom"===t.bar_position?" selected":"")+'>Bottom</option><option value="top"'+("top"===t.bar_position?" selected":"")+">Top</option>")+this._sliderRow("Height (px)","bar_height",2,40)+this._textRow("Gradient colors","bar_gradient","#FF7777, #FF9977, ...")+'</div><div class="vs-section"><div class="vs-section-title">Transcription Bubble</div>'+this._checkboxRow("Show transcription","show_transcription")+this._sliderRow("Font size","transcription_font_size",10,48)+this._textRow("Font family","transcription_font_family","inherit")+this._colorRow("Font color","transcription_font_color")+this._checkboxRow("Bold","transcription_font_bold")+this._checkboxRow("Italic","transcription_font_italic")+this._colorRow("Background","transcription_background")+this._textRow("Border color","transcription_border_color","rgba(0,180,255,0.5)")+this._sliderRow("Padding","transcription_padding",0,32)+this._checkboxRow("Rounded corners","transcription_rounded")+'</div><div class="vs-section"><div class="vs-section-title">Response Bubble</div>'+this._checkboxRow("Show response","show_response")+this._checkboxRow("Streaming response","streaming_response")+this._sliderRow("Font size","response_font_size",10,48)+this._textRow("Font family","response_font_family","inherit")+this._colorRow("Font color","response_font_color")+this._checkboxRow("Bold","response_font_bold")+this._checkboxRow("Italic","response_font_italic")+this._colorRow("Background","response_background")+this._textRow("Border color","response_border_color","rgba(100,200,150,0.5)")+this._sliderRow("Padding","response_padding",0,32)+this._checkboxRow("Rounded corners","response_rounded")+'</div><div class="vs-section"><div class="vs-section-title">Background</div>'+this._checkboxRow("Background blur","background_blur")+this._sliderRow("Blur intensity","background_blur_intensity",0,20)+"</div></div>",this._attachListeners()}_checkboxRow(t,e){var i=this._config[e]?" checked":"";return'<div class="vs-row"><label>'+t+'</label><input type="checkbox" data-key="'+e+'"'+i+"></div>"}_textRow(t,e,i){var s=this._config[e]||"";return'<div class="vs-row"><label>'+t+'</label><input type="text" data-key="'+e+'" value="'+this._escAttr(s)+'" placeholder="'+(i||"")+'"></div>'}_numberRow(t,e,i,s){var o=void 0!==this._config[e]?this._config[e]:"";return'<div class="vs-row"><label>'+t+'</label><input type="number" data-key="'+e+'" value="'+o+'" min="'+i+'" max="'+s+'"></div>'}_sliderRow(t,e,i,s){var o=void 0!==this._config[e]?this._config[e]:i;return'<div class="vs-row"><label>'+t+'</label><input type="range" data-key="'+e+'" min="'+i+'" max="'+s+'" value="'+o+'"><span class="range-val" data-range-for="'+e+'">'+o+"</span></div>"}_colorRow(t,e){var i=this._config[e]||"#000000";return'<div class="vs-row"><label>'+t+'</label><input type="color" data-key="'+e+'" value="'+i+'"></div>'}_selectRow(t,e,i){return'<div class="vs-row"><label>'+t+'</label><select data-key="'+e+'">'+i+"</select></div>"}_selectRowRaw(t,e,i){return'<div class="vs-row"><label>'+t+'</label><select data-key="'+e+'">'+i+"</select></div>"}_escAttr(t){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}_attachListeners(){var t=this;this.querySelectorAll('input[type="checkbox"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.checked)})}),this.querySelectorAll('input[type="text"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.value)})}),this.querySelectorAll('input[type="number"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,parseInt(e.value,10)||0)})}),this.querySelectorAll('input[type="range"]').forEach(function(e){e.addEventListener("input",function(){var i=t.querySelector('[data-range-for="'+e.dataset.key+'"]');i&&(i.textContent=e.value)}),e.addEventListener("change",function(){t._updateConfig(e.dataset.key,parseInt(e.value,10))})}),this.querySelectorAll('input[type="color"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.value)})}),this.querySelectorAll("select").forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.value)})})}_updateConfig(t,e){this._config=Object.assign({},this._config),this._config[t]=e;var i=new CustomEvent("config-changed",{detail:{config:this._config},bubbles:!0,composed:!0});this.dispatchEvent(i)}}customElements.define("voice-satellite-card",VoiceSatelliteCard),customElements.define("voice-satellite-card-editor",VoiceSatelliteCardEditor),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v1.18.0 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;");
