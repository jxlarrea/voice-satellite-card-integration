(()=>{"use strict";const t="IDLE",e="LISTENING",i="WAKE_WORD_DETECTED",n="STT",r="INTENT",s="TTS",o=[i,n,r,s],a=["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"],l="pipeline",c="timer",u="announcement",d={start_listening_on_load:!0,satellite_entity:"",tts_target:"",double_tap_cancel:!0,debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,timer_position:"top-right",timer_font_size:20,timer_font_family:"inherit",timer_font_color:"#444444",timer_font_bold:!0,timer_font_italic:!1,timer_background:"#ffffff",timer_border_color:"rgba(100, 200, 150, 0.5)",timer_padding:16,timer_rounded:!0,timer_finished_duration:60,announcement_display_duration:5,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0,bubble_style:"chat",bubble_container_width:85};function h(t){const e=t.split(",").map(t=>t.trim());return e.length>1&&e[0]!==e[e.length-1]&&e.push(e[0]),`linear-gradient(90deg, ${e.join(", ")})`}class _{constructor(){this._debug=!1}set debug(t){this._debug=!!t}log(t,e,i){this._debug&&(void 0!==i?console.log(`[VS][${t}] ${e}`,i):console.log(`[VS][${t}] ${e}`))}error(t,e,i){void 0!==i?console.error(`[VS][${t}] ${e}`,i):console.error(`[VS][${t}] ${e}`)}}class p{constructor(t){this._card=t,this._log=t.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get card(){return this._card}get log(){return this._log}get audioContext(){return this._audioContext}get workletNode(){return this._workletNode}set workletNode(t){this._workletNode=t}get scriptProcessor(){return this._scriptProcessor}set scriptProcessor(t){this._scriptProcessor=t}get audioBuffer(){return this._audioBuffer}set audioBuffer(t){this._audioBuffer=t}get actualSampleRate(){return this._actualSampleRate}async startMicrophone(){await this._ensureAudioContextRunning();const{config:t}=this._card;this._log.log("mic",`AudioContext state=${this._audioContext.state} sampleRate=${this._audioContext.sampleRate}`);const e={sampleRate:16e3,channelCount:1,echoCancellation:t.echo_cancellation,noiseSuppression:t.noise_suppression,autoGainControl:t.auto_gain_control};if(t.voice_isolation&&(e.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:e}),t.debug){const t=this._mediaStream.getAudioTracks();this._log.log("mic",`Got media stream with ${t.length} audio track(s)`),t.length>0&&this._log.log("mic",`Track settings: ${JSON.stringify(t[0].getSettings())}`)}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic",`Actual sample rate: ${this._actualSampleRate}`);try{await async function(t,e){const i=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),n=URL.createObjectURL(i);await t.audioContext.audioWorklet.addModule(n),URL.revokeObjectURL(n),t.workletNode=new AudioWorkletNode(t.audioContext,"voice-satellite-processor"),t.workletNode.port.onmessage=e=>{t.audioBuffer.push(new Float32Array(e.data))},e.connect(t.workletNode),t.workletNode.connect(t.audioContext.destination)}(this,this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}catch(t){this._log.log("mic",`AudioWorklet unavailable (${t.message}), using ScriptProcessor`),i=this,n=this._sourceNode,i.scriptProcessor=i.audioContext.createScriptProcessor(2048,1,1),i.scriptProcessor.onaudioprocess=t=>{const e=t.inputBuffer.getChannelData(0);i.audioBuffer.push(new Float32Array(e))},n.connect(i.scriptProcessor),i.scriptProcessor.connect(i.audioContext.destination),this._log.log("mic","Audio capture via ScriptProcessor")}var i,n}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(t=>t.stop()),this._mediaStream=null),this._audioBuffer=[]}startSending(t){this.stopSending();let e=!1;this._sendInterval=setInterval(()=>{const i=t();!e&&this._audioBuffer.length>0&&(e=!0,this._log.log("mic",`First audio send — handlerId=${i} bufferChunks=${this._audioBuffer.length}`)),function(t,e){if(null==e)return;if(0===t.audioBuffer.length)return;let i=0;for(const e of t.audioBuffer)i+=e.length;const n=new Float32Array(i);let r=0;for(const e of t.audioBuffer)n.set(e,r),r+=e.length;t.audioBuffer=[];const s=function(t){const e=new Int16Array(t.length);for(let i=0;i<t.length;i++){const n=Math.max(-1,Math.min(1,t[i]));e[i]=n<0?32768*n:32767*n}return e}(16e3!==t.actualSampleRate?function(t,e){if(16e3===e)return t;const i=e/16e3,n=Math.round(t.length/i),r=new Float32Array(n);for(let e=0;e<n;e++){const n=e*i,s=Math.floor(n),o=Math.min(s+1,t.length-1),a=n-s;r[e]=t[s]*(1-a)+t[o]*a}return r}(n,t.actualSampleRate):n);!function(t,e,i){const{connection:n}=t;if(!n?.socket)return;if(n.socket.readyState!==WebSocket.OPEN)return;const r=new Uint8Array(1+e.byteLength);r[0]=i,r.set(new Uint8Array(e.buffer),1),n.socket.send(r.buffer)}(t.card,s,e)}(this,i)},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream?.getAudioTracks().forEach(t=>{t.enabled=!1})}async resume(){this._audioBuffer=[],this._mediaStream?.getAudioTracks().forEach(t=>{t.enabled=!0}),"suspended"===this._audioContext?.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume())}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(t){this._log.error("mic",`Failed to resume AudioContext on click: ${t}`)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error(`AudioContext failed to start: ${this._audioContext.state}`)}}const g={type:"single",wave:"sine",notes:[{freq:523,start:0},{freq:659,start:.08},{freq:784,start:.16}],duration:.25},m={type:"single",wave:"sine",notes:[{freq:784,start:0},{freq:659,start:.08}],duration:.25},b={type:"multi",wave:"sine",notes:[{freq:880,start:0,end:.15},{freq:660,start:.18,end:.33},{freq:880,start:.36,end:.55}]};function f(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;const e=window.location.origin;return t.startsWith("/")?e+t:`${e}/${t}`}function y(t,e,{onEnd:i,onError:n,onStart:r}){const s=new Audio;return s.volume=e,s.onended=()=>{i()},s.onerror=t=>{n(t)},s.src=t,s.play().then(()=>{r?.()}).catch(t=>{n(t)}),s}const v={wake:g,error:{type:"single",wave:"square",volumeScale:.3,notes:[{freq:300,start:0},{freq:200,start:.08}],duration:.15},done:m};class A{constructor(t){this._card=t,this._log=t.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null,this._playbackWatchdog=null}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(t){this._streamingUrl=t}play(t){const{config:e}=this._card,i=f(t);if(this._playing=!0,e.tts_target&&"browser"!==e.tts_target)return function(t,e){const i=t.config.tts_target;t.logger.log("tts",`Playing on remote: ${i} URL: ${e}`),t.hass.callService("media_player","play_media",{entity_id:i,media_content_id:e,media_content_type:"music"}).catch(e=>{t.logger.error("tts",`Remote play failed: ${e}`)})}(this._card,i),void(this._endTimer=setTimeout(()=>{this._endTimer=null,this._onComplete()},2e3));this._lastWatchdogTime=0,this._playbackWatchdog=setInterval(()=>{if(!this._playing||!this._currentAudio)return void this._clearWatchdog();const t=this._currentAudio.currentTime;t>this._lastWatchdogTime?this._lastWatchdogTime=t:(this._log.log("tts","Playback watchdog: audio stalled — forcing completion"),this._clearWatchdog(),this._onComplete())},3e4),this._currentAudio=y(i,this._card.mediaPlayer.volume,{onEnd:()=>{this._log.log("tts","Playback complete"),this._clearWatchdog(),this._onComplete()},onError:t=>{this._log.error("tts",`Playback error: ${t}`),this._log.error("tts",`URL: ${i}`),this._clearWatchdog(),this._onComplete(!0)},onStart:()=>{this._log.log("tts","Playback started successfully"),this._card.mediaPlayer.notifyAudioStart("tts")}})}stop(){var t;this._playing=!1,this._clearWatchdog(),this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null),(t=this._card).config.tts_target&&"browser"!==t.config.tts_target&&t.hass&&t.hass.callService("media_player","media_stop",{entity_id:t.config.tts_target}).catch(e=>{t.logger.error("tts",`Remote stop failed: ${e}`)}),this._card.mediaPlayer.notifyAudioEnd("tts")}storeStreamingUrl(t){if(this._streamingUrl=null,t.tts_output?.url&&t.tts_output?.stream_response){const e=t.tts_output.url;this._streamingUrl=e.startsWith("http")?e:window.location.origin+e,this._log.log("tts",`Streaming TTS URL available: ${this._streamingUrl}`)}}playChime(t){const e=v[t]||m;this._card.mediaPlayer.notifyAudioStart("chime"),function(t,e,i){try{const i=new(window.AudioContext||window.webkitAudioContext),n=i.createOscillator(),r=i.createGain();n.connect(r),r.connect(i.destination);const s=.5*t.mediaPlayer.volume*(e.volumeScale||1);n.type=e.wave,r.gain.setValueAtTime(s,i.currentTime),r.gain.exponentialRampToValueAtTime(.001,i.currentTime+e.duration);for(const t of e.notes)n.frequency.setValueAtTime(t.freq,i.currentTime+t.start);n.start(),n.stop(i.currentTime+e.duration),setTimeout(()=>i.close(),500)}catch(t){i?.error("chime",`Chime error: ${t}`)}}(this._card,e,this._log),setTimeout(()=>{this._card.mediaPlayer.notifyAudioEnd("chime")},1e3*(e.duration||.3))}_clearWatchdog(){this._playbackWatchdog&&(clearInterval(this._playbackWatchdog),this._playbackWatchdog=null)}_onComplete(t){this._log.log("tts","Complete — cleaning up UI"+(t?" (playback failed)":"")),this._currentAudio=null,this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.mediaPlayer.notifyAudioEnd("tts"),this._card.onTTSComplete(t)}}function V(t,e,i){if(!t||!e)return;if(t.entities){const n=t.entities[e];if(n?.device_id)for(const[e,r]of Object.entries(t.entities))if(r.device_id===n.device_id&&"voice_satellite"===r.platform&&r.translation_key===i)return"on"===t.states[e]?.state}const n=function(t,e,i){if(!t||!e)return;const n=t.states[e];return n?.attributes?.[i]}(t,e,"mute"===i?"muted":i);return void 0!==n?!0===n:void 0}function w(t,e){try{const t=e.intent_output.response.speech.plain.speech;if(t)return t}catch(t){}try{if(e.intent_output.response.speech.speech)return e.intent_output.response.speech.speech}catch(t){}try{if(e.intent_output.response.plain)return e.intent_output.response.plain}catch(t){}try{if("string"==typeof e.intent_output.response)return e.intent_output.response}catch(t){}return t.log.log("error","Could not extract response text"),null}class T{constructor(t){this._card=t,this._log=t.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1,this._askQuestionCallback=null,this._askQuestionHandled=!1,this._reconnectRef={listener:null},this._muteCheckId=null,this._runStartReceived=!1,this._wakeWordPhase=!1,this._errorReceived=!1,this._pipelineGen=0,this._cancelInit=null}get card(){return this._card}get log(){return this._log}get binaryHandlerId(){return this._binaryHandlerId}set binaryHandlerId(t){this._binaryHandlerId=t}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}set serviceUnavailable(t){this._serviceUnavailable=t}get shouldContinue(){return this._shouldContinue}set shouldContinue(t){this._shouldContinue=t}get continueConversationId(){return this._continueConversationId}set continueConversationId(t){this._continueConversationId=t}get continueMode(){return this._continueMode}set continueMode(t){this._continueMode=t}get retryCount(){return this._retryCount}set retryCount(t){this._retryCount=t}get pendingRunEnd(){return this._pendingRunEnd}set pendingRunEnd(t){this._pendingRunEnd=t}get suppressTTS(){return this._suppressTTS}set suppressTTS(t){this._suppressTTS=t}get recoveryTimeout(){return this._recoveryTimeout}set recoveryTimeout(t){this._recoveryTimeout=t}get intentErrorBarTimeout(){return this._intentErrorBarTimeout}set intentErrorBarTimeout(t){this._intentErrorBarTimeout=t}get askQuestionCallback(){return this._askQuestionCallback}set askQuestionCallback(t){this._askQuestionCallback=t}get askQuestionHandled(){return this._askQuestionHandled}set askQuestionHandled(t){this._askQuestionHandled=t}async start(t){const e=t||{},{connection:i,config:n}=this._card,r=this._pipelineGen;if(!i)throw new Error("No Home Assistant connection available");if(!n.satellite_entity)throw new Error("No satellite_entity configured");if(this._muteCheckId&&(clearTimeout(this._muteCheckId),this._muteCheckId=null),!0===V(this._card.hass,n.satellite_entity,"mute"))return this._log.log("pipeline","Satellite muted — pipeline blocked"),this._card.ui.showErrorBar(),void(this._muteCheckId=setTimeout(()=>{this._muteCheckId=null,this.start(e).catch(()=>{})},2e3));if(this._card.ui.clearErrorBar(),this._unsubscribe){this._log.log("pipeline","Cleaning up previous subscription");try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}this._binaryHandlerId=null,function(t,e,i,n){n.listener||(n.listener=()=>{t.logger.log("pipeline","Connection reconnected — resetting retry state"),e.resetRetryState(),t.ui.clearErrorBar(),t.visibility.isPaused?t.logger.log("pipeline","Tab is paused — deferring restart to resume"):setTimeout(()=>e.restart(0),2e3)},i.addEventListener("ready",n.listener))}(this._card,this,i,this._reconnectRef);const s={start_stage:e.start_stage||"wake_word",end_stage:e.end_stage||"tts",sample_rate:16e3};let o;e.conversation_id&&(s.conversation_id=e.conversation_id),e.extra_system_prompt&&(s.extra_system_prompt=e.extra_system_prompt),this._runStartReceived=!1,this._log.log("pipeline",`Starting pipeline: ${JSON.stringify(s)}`);const a=new Promise(t=>{o=t});this._cancelInit=o;const l=await async function(t,e,i,n){return t.subscribeMessage(n,{type:"voice_satellite/run_pipeline",entity_id:e,...i})}(i,n.satellite_entity,s,t=>{if(this._pipelineGen===r)return"init"===t.type?(this._binaryHandlerId=t.handler_id,this._log.log("pipeline",`Init — handler ID: ${t.handler_id}`),void o()):void this._card.onPipelineMessage(t)});if(this._pipelineGen!==r){this._log.log("pipeline","Aborting stale start() after subscribe — pipeline was stopped");try{l()}catch(t){}return}if(this._unsubscribe=l,this._log.log("pipeline","Pipeline subscribed, waiting for init event..."),await a,this._cancelInit=null,this._pipelineGen!==r){if(this._log.log("pipeline","Aborting stale start() after init — pipeline was stopped"),this._unsubscribe){try{this._unsubscribe()}catch(t){}this._unsubscribe=null}return}this._log.log("pipeline",`Handler ID confirmed: ${this._binaryHandlerId} — starting audio`);const{audio:c}=this._card;c.audioBuffer=[],c.startSending(()=>this._binaryHandlerId),this._isStreaming=!0}async stop(){if(this._pipelineGen++,this._log.log("pipeline",`stop() — gen=${this._pipelineGen}`),this._cancelInit&&(this._cancelInit(),this._cancelInit=null),this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._muteCheckId&&(clearTimeout(this._muteCheckId),this._muteCheckId=null),this._unsubscribe){try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}}restart(t){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this.stop().then(()=>{this._restartTimeout=setTimeout(()=>{this._restartTimeout=null,this._isRestarting=!1,this.start().catch(t=>{const e=t?.message||JSON.stringify(t);this._log.error("pipeline",`Restart failed: ${e}`),this._serviceUnavailable||(this._card.ui.showErrorBar(),this._serviceUnavailable=!0),this.restart(this.calculateRetryDelay())})},t||0)}))}restartContinue(t,e={}){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this._askQuestionCallback=e.onSttEnd||null,this.stop().then(()=>{this._isRestarting=!1,this._continueMode=!0;const i={start_stage:"stt",end_stage:e.end_stage||"tts",conversation_id:t};e.extra_system_prompt&&(i.extra_system_prompt=e.extra_system_prompt),this.start(i).catch(t=>{this._log.error("pipeline",`Continue conversation failed: ${t?.message||JSON.stringify(t)}`),this._askQuestionCallback=null,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this.restart(0)})}))}handleRunStart(t){this._runStartReceived=!0,this._wakeWordPhase=!1,this._errorReceived=!1,function(t,i){if(t.card.tts.storeStreamingUrl(i),t.continueMode)return t.continueMode=!1,t.card.setState(n),t.log.log("pipeline",`Running (continue conversation) — binary handler ID: ${t.binaryHandlerId}`),void t.log.log("pipeline","Listening for speech...");t.card.setState(e),t.log.log("pipeline",`Running — binary handler ID: ${t.binaryHandlerId}`),t.log.log("pipeline","Listening for wake word...")}(this,t)}handleWakeWordStart(){var t;this._wakeWordPhase=!0,(t=this).serviceUnavailable&&(t.recoveryTimeout&&clearTimeout(t.recoveryTimeout),t.recoveryTimeout=setTimeout(()=>{t.serviceUnavailable&&(t.log.log("recovery","Wake word service recovered"),t.serviceUnavailable=!1,t.retryCount=0,t.card.ui.clearErrorBar(),t.card.ui.hideBar())},2e3))}handleWakeWordEnd(t){if(!this._runStartReceived)return void this._log.log("pipeline","Ignoring stale wake_word-end (no run-start received for this subscription)");const e=t?.wake_word_output;e&&e.wake_word_id?(this._wakeWordPhase=!1,function(t,e){const n=e.wake_word_output;if(!n||0===Object.keys(n).length)return t.log.error("error","Wake word service unavailable (empty wake_word_output)"),t.recoveryTimeout&&(clearTimeout(t.recoveryTimeout),t.recoveryTimeout=null),t.binaryHandlerId=null,t.card.ui.showErrorBar(),t.serviceUnavailable=!0,void t.restart(t.calculateRetryDelay());t.recoveryTimeout&&(clearTimeout(t.recoveryTimeout),t.recoveryTimeout=null),t.serviceUnavailable=!1,t.retryCount=0,t.card.ui.clearErrorBar(),t.card.mediaPlayer.interrupt();const{tts:r}=t.card;if(r.isPlaying&&(r.stop(),t.pendingRunEnd=!1),t.intentErrorBarTimeout&&(clearTimeout(t.intentErrorBarTimeout),t.intentErrorBarTimeout=null),t.card.chat.clear(),t.shouldContinue=!1,t.continueConversationId=null,t.card.setState(i),!1!==V(t.card.hass,t.card.config.satellite_entity,"wake_sound")){const e=t.card.audio;e.stopSending(),r.playChime("wake"),setTimeout(()=>{e.audioBuffer=[],t.binaryHandlerId&&e.startSending(()=>t.binaryHandlerId)},1e3*g.duration+50)}t.card.ui.showBlurOverlay(l)}(this,t)):this._log.log("pipeline","Ignoring empty wake_word-end (pipeline stopped during restart)")}handleSttEnd(t){!function(t,e){const i=e.stt_output?.text||"";if(i&&t.card.chat.showTranscription(i),t.askQuestionCallback){const e=t.askQuestionCallback;t.askQuestionCallback=null,t.askQuestionHandled=!0,t.log.log("pipeline",`Ask question STT complete: "${i}"`),e(i)}}(this,t)}handleIntentProgress(t){!function(t,e){const{tts:i}=t.card;if(e.tts_start_streaming&&i.streamingUrl&&!i.isPlaying&&(t.log.log("tts","Streaming TTS started — playing early"),t.card.setState(s),i.play(i.streamingUrl),i.streamingUrl=null),!e.chat_log_delta)return;const n=e.chat_log_delta.content;if("string"!=typeof n)return;const{chat:r}=t.card;r.streamedResponse=(r.streamedResponse||"")+n,r.updateResponse(r.streamedResponse)}(this,t)}handleIntentEnd(t){!function(t,e){let i=null;try{i=e.intent_output.response.response_type}catch(t){}if("error"===i){const i=w(t,e)||"An error occurred";return t.log.error("error",`Intent error: ${i}`),t.card.ui.showErrorBar(),!1!==V(t.card.hass,t.card.config.satellite_entity,"wake_sound")&&t.card.tts.playChime("error"),t.suppressTTS=!0,t.intentErrorBarTimeout&&clearTimeout(t.intentErrorBarTimeout),t.intentErrorBarTimeout=setTimeout(()=>{t.intentErrorBarTimeout=null,t.card.ui.clearErrorBar(),t.card.ui.hideBar()},3e3),void(t.card.chat.streamedResponse="")}const n=w(t,e);n&&t.card.chat.showResponse(n),t.shouldContinue=!1,t.continueConversationId=null;try{!0===e.intent_output.continue_conversation&&(t.shouldContinue=!0,t.continueConversationId=e.intent_output.conversation_id||null,t.log.log("pipeline",`Continue conversation requested — id: ${t.continueConversationId}`))}catch(t){}t.card.chat.streamedResponse="",t.card.chat.streamEl=null}(this,t)}handleTtsEnd(t){!function(t,e){if(t.suppressTTS)return t.suppressTTS=!1,t.log.log("tts","TTS suppressed (intent error)"),void t.restart(0);const{tts:i}=t.card;if(i.isPlaying)return t.log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void t.restart(0);const n=e.tts_output?.url||e.tts_output?.url_path||null;n&&i.play(n),t.restart(0)}(this,t)}handleRunEnd(){if(this._runStartReceived)return this._wakeWordPhase&&!this._errorReceived?(this._log.log("pipeline","run-end during wake_word phase — restarting pipeline"),void this.restart(0)):void function(t){if(t.log.log("pipeline","Run ended"),t.binaryHandlerId=null,!t.isRestarting)return t.askQuestionHandled?(t.log.log("pipeline","Ask question handled — announcement manager owns cleanup"),void(t.askQuestionHandled=!1)):t.serviceUnavailable?(t.log.log("ui","Error recovery handling restart"),void t.card.ui.hideBlurOverlay(l)):t.card.tts.isPlaying?(t.log.log("ui","TTS playing — deferring cleanup"),void(t.pendingRunEnd=!0)):void t.finishRunEnd();t.log.log("pipeline","Restart already in progress — skipping run-end restart")}(this);this._log.log("pipeline","Ignoring stale run-end (no run-start received for this subscription)")}handleError(e){this._runStartReceived?(this._errorReceived=!0,function(e,i){const n=i.code||"",r=i.message||"";if(e.log.log("error",`${n} — ${r}`),e.askQuestionCallback){const t=e.askQuestionCallback;return e.askQuestionCallback=null,e.log.log("pipeline",`Ask question error (${n}) — sending empty answer`),void t("")}if(a.includes(n)){if(e.log.log("pipeline",`Expected error: ${n} — restarting`),o.includes(e.card.currentState)){e.log.log("ui","Cleaning up interaction UI after expected error"),e.card.setState(t),e.card.chat.clear(),e.card.ui.hideBlurOverlay(l),e.shouldContinue=!1,e.continueConversationId=null;const i=e.card.config.tts_target&&"browser"!==e.card.config.tts_target;!1===V(e.card.hass,e.card.config.satellite_entity,"wake_sound")||i||e.card.tts.playChime("done")}return void e.restart(0)}e.log.error("error",`Unexpected: ${n} — ${r}`);const s=o.includes(e.card.currentState);e.binaryHandlerId=null,s&&!1!==V(e.card.hass,e.card.config.satellite_entity,"wake_sound")&&e.card.tts.playChime("error"),e.card.ui.showErrorBar(),e.serviceUnavailable=!0,e.card.chat.clear(),e.card.ui.hideBlurOverlay(l),e.restart(e.calculateRetryDelay())}(this,e)):this._log.log("pipeline","Ignoring stale error (no run-start received for this subscription)")}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}resetRetryState(){this._retryCount=0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._isRestarting&&(this._isRestarting=!1),this._serviceUnavailable=!1}finishRunEnd(){this._pendingRunEnd=!1,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.setState(t),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}calculateRetryDelay(){this._retryCount++;const t=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline",`Retry in ${t}ms (attempt #${this._retryCount})`),t}}function S(t,e,i){t.style.fontSize=e[`${i}_font_size`]+"px",t.style.fontFamily=e[`${i}_font_family`],t.style.color=e[`${i}_font_color`],t.style.fontWeight=e[`${i}_font_bold`]?"bold":"normal",t.style.fontStyle=e[`${i}_font_italic`]?"italic":"normal",t.style.background=e[`${i}_background`],t.style.border=`3px solid ${e[`${i}_border_color`]}`,t.style.padding=e[`${i}_padding`]+"px",t.style.borderRadius=e[`${i}_rounded`]?"12px":"0"}function x(t){const e=Math.max(0,t),i=Math.floor(e/3600),n=Math.floor(e%3600/60),r=e%60;return`${i<10?"0":""}${i}:${n<10?"0":""}${n}:${r<10?"0":""}${r}`}class k{constructor(t){this._card=t,this._log=t.logger,this._globalUI=null,this._pendingStartButtonReason=void 0,this._blurReasons={},this._timerContainer=null,this._timerAlertEl=null}get element(){return this._globalUI}ensureGlobalUI(){const t=document.getElementById("voice-satellite-ui");if(t)return this._globalUI=t,void this._flushPendingStartButton();const e=document.createElement("div");e.id="voice-satellite-ui",e.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(e),this._globalUI=e,this._injectGlobalStyles(),this.applyStyles(),e.querySelector(".vs-start-btn").addEventListener("click",()=>{this._card.onStartClick()});const i=e.querySelector(".vs-start-btn");i.classList.add("visible"),i.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){if(!this._globalUI)return;const t=this._card.config,e=this._globalUI.querySelector(".vs-rainbow-bar");e.style.height=`${t.bar_height}px`,e.style["top"===t.bar_position?"top":"bottom"]="0",e.style["top"===t.bar_position?"bottom":"top"]="auto",e.style.background=h(t.bar_gradient),e.style.backgroundSize="200% 100%";const i=this._globalUI.querySelector(".vs-blur-overlay");t.background_blur?(i.style.backdropFilter=`blur(${t.background_blur_intensity}px)`,i.style.webkitBackdropFilter=`blur(${t.background_blur_intensity}px)`):(i.style.backdropFilter="none",i.style.webkitBackdropFilter="none");const n=t.bar_height||6,r=this._globalUI.querySelector(".vs-chat-container");"bottom"===t.bar_position?(r.style.bottom=`${n+12}px`,r.style.top="auto"):(r.style.bottom="12px",r.style.top="auto");const s="chat"===t.bubble_style;r.style.alignItems=s?"flex-start":"center",r.style.width=`${t.bubble_container_width||80}%`,r.style.maxWidth=`${t.bubble_container_width||80}%`,r.setAttribute("data-bubble-style",t.bubble_style||"centered")}applyBubbleStyle(t,e){S(t,this._card.config,e)}updateForState(t,e,i){if(!this._globalUI)return;if(this._card.announcement.playing||this._card.askQuestion.playing||this._card.startConversation.playing)return;const n={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[t];if(!n)return;if(e&&!n.barVisible)return;if(i&&!n.barVisible)return;const r=this._globalUI.querySelector(".vs-rainbow-bar");n.barVisible?(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.add("visible"),r.classList.remove("connecting","listening","processing","speaking"),n.animation&&r.classList.add(n.animation)):(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.remove("visible","connecting","listening","processing","speaking"))}showStartButton(t){if(!this._globalUI)return void(this._pendingStartButtonReason=t);const e=this._globalUI.querySelector(".vs-start-btn");e.classList.add("visible"),e.title={"not-allowed":"Tap to enable microphone","not-found":"No microphone found","not-readable":"Microphone unavailable - tap to retry"}[t]||"Tap to start voice assistant"}hideStartButton(){this._globalUI?.querySelector(".vs-start-btn")?.classList.remove("visible")}showBlurOverlay(t){this._globalUI&&this._card.config.background_blur&&(this._blurReasons[t||"default"]=!0,this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible"))}hideBlurOverlay(t){this._globalUI&&(delete this._blurReasons[t||"default"],0===Object.keys(this._blurReasons).length&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible"))}showErrorBar(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("connecting","listening","processing","speaking"),t.classList.add("visible","error-mode"),t.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222, #ff4444)",t.style.backgroundSize="200% 100%"}clearErrorBar(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("error-mode"),t.style.background=h(this._card.config.bar_gradient),t.style.backgroundSize="200% 100%"}hideBar(){this._globalUI?.querySelector(".vs-rainbow-bar")?.classList.remove("visible")}showBarSpeaking(){if(!this._globalUI)return!1;const t=this._globalUI.querySelector(".vs-rainbow-bar");if(!t)return!1;const e=t.classList.contains("visible");return t.classList.add("visible","speaking"),e}restoreBar(t){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-rainbow-bar");e&&(e.classList.remove("speaking"),t||e.classList.remove("visible"))}addChatMessage(t,e){if(!this._globalUI)return null;const i=this._globalUI.querySelector(".vs-chat-container");i.classList.add("visible");const n=document.createElement("div");return n.className=`vs-chat-msg ${e}`,n.textContent=t,this.applyBubbleStyle(n,{user:"transcription",assistant:"response",announcement:"response"}[e]||"response"),"announcement"===e&&(n.style.alignSelf="center",n.style.textAlign="center"),i.appendChild(n),n}updateChatText(t,e){t&&(t.textContent=e)}updateChatHtml(t,e){t&&(t.innerHTML=e)}clearChat(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-chat-container");for(;t.firstChild;)t.removeChild(t.firstChild);t.classList.remove("visible")}setAnnouncementMode(t){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-chat-container");e&&e.classList.toggle("announcement-mode",t)}clearAnnouncementBubbles(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-chat-container"),e=t?.querySelectorAll(".vs-chat-msg.announcement")||[];for(const t of e)t.remove();t&&!t.firstChild&&t.classList.remove("visible")}ensureTimerContainer(){if(this._timerContainer&&document.body.contains(this._timerContainer))return;const t=document.createElement("div");t.id="voice-satellite-timers",t.className="vs-timer-container",document.body.appendChild(t),this._timerContainer=t,this.applyTimerPosition()}applyTimerPosition(){if(!this._timerContainer)return;const t=this._card.config,e=t.bar_height||16,i=t.timer_position||"top-right";if(this._timerContainer.style.top="auto",this._timerContainer.style.bottom="auto",this._timerContainer.style.left="auto",this._timerContainer.style.right="auto",i.startsWith("top")){const i="top"===t.bar_position?e+12:12;this._timerContainer.style.top=`${i}px`}else{const i="bottom"===t.bar_position?e+12:12;this._timerContainer.style.bottom=`${i}px`}i.includes("left")?this._timerContainer.style.left="12px":this._timerContainer.style.right="12px"}removeTimerContainer(){this._timerContainer?.parentNode?.removeChild(this._timerContainer),this._timerContainer=null}createTimerPill(t,e){const i=t.totalSeconds>0?Math.max(0,t.secondsLeft/t.totalSeconds*100):0,n=document.createElement("div");n.className="vs-timer-pill",n.setAttribute("data-timer-id",t.id),this.applyBubbleStyle(n,"timer");const r=this._card.config.timer_border_color||"rgba(100, 200, 150, 0.5)";return n.innerHTML=`<div class="vs-timer-progress" style="width:${i}%;background:${r};opacity:0.3"></div><div class="vs-timer-content"><span class="vs-timer-icon">⏱</span><span class="vs-timer-time">${x(t.secondsLeft)}</span></div>`,e&&C(n,e),n}syncTimerPills(t,e){this.ensureTimerContainer();const i=this._timerContainer.querySelectorAll(".vs-timer-pill");for(const e of i){const i=e.getAttribute("data-timer-id");t.some(t=>t.id===i)||e.parentNode.removeChild(e)}for(const i of t)i.el&&this._timerContainer.contains(i.el)||(i.el=this.createTimerPill(i,e(i.id)),this._timerContainer.appendChild(i.el))}updateTimerPill(t,e,i){if(!t)return;const n=t.querySelector(".vs-timer-time");n&&(n.textContent=x(e));const r=t.querySelector(".vs-timer-progress");if(r){const t=i>0?Math.max(0,e/i*100):0;r.style.width=`${t}%`}}expireTimerPill(t,e){if(!this._timerContainer)return;const i=this._timerContainer.querySelector(`.vs-timer-pill[data-timer-id="${t}"]`);i&&(i.classList.add("vs-timer-expired"),setTimeout(()=>i.parentNode?.removeChild(i),e))}showTimerAlert(t){this._timerAlertEl=document.createElement("div"),this._timerAlertEl.className="vs-timer-alert",this.applyBubbleStyle(this._timerAlertEl,"timer"),this._timerAlertEl.innerHTML='<span class="vs-timer-icon">⏱</span><span class="vs-timer-time">00:00:00</span>',document.body.appendChild(this._timerAlertEl),t&&C(this._timerAlertEl,t)}clearTimerAlert(){for(const t of document.querySelectorAll(".vs-timer-alert"))t.parentNode?.removeChild(t);this._timerAlertEl=null}_injectGlobalStyles(){if(document.getElementById("voice-satellite-styles"))return;const t=document.createElement("style");t.id="voice-satellite-styles",t.textContent='/* Voice Satellite Card — Styles */\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(5px);\r\n  -webkit-backdrop-filter: blur(5px);\r\n  background: rgba(0, 0, 0, 0.3);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-flash {\r\n  animation: vs-error-flash 0.15s ease-in-out 3;\r\n}\r\n\r\n@keyframes vs-error-flash {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  max-width: 80%;\r\n  width: 80%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.announcement-mode {\r\n  top: 50% !important;\r\n  bottom: auto !important;\r\n  transform: translate(-50%, -50%);\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  padding: 12px;\r\n  opacity: 0;\r\n  text-align: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg {\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg.user {\r\n  align-self: flex-end;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg.assistant {\r\n  align-self: flex-start;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}\r\n\r\n/* Timer Pills */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: vs-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);\r\n  z-index: 10002;\r\n  animation: vs-timer-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes vs-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.05);\r\n  }\r\n}',document.head.appendChild(t)}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}function C(t,e){let i=0;const n=t=>{const n=Date.now();n-i<400&&n-i>0&&(t.preventDefault(),t.stopPropagation(),e()),i=n};t.addEventListener("touchstart",n,{passive:!1}),t.addEventListener("click",n)}class E{constructor(t){this._card=t,this._log=t.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(t){this._streamEl=t}get streamedResponse(){return this._streamedResponse}set streamedResponse(t){this._streamedResponse=t}showTranscription(t){this.addUser(t)}showResponse(t){this._card.config.show_response&&(this._streamEl?this._card.ui.updateChatText(this._streamEl,t):this.addAssistant(t))}updateResponse(t){this._card.config.show_response&&(this._streamEl?this._updateStreaming(t):this.addAssistant(t))}addUser(t){this._card.ui.addChatMessage(t,"user")}addAssistant(t){this._streamEl=this._card.ui.addChatMessage(t,"assistant")}clear(){this._card.ui.clearChat(),this._streamEl=null,this._streamedResponse=""}_updateStreaming(t){if(!this._streamEl)return;if(t.length<=24)return void this._card.ui.updateChatText(this._streamEl,t);const e=t.slice(0,t.length-24),i=t.slice(t.length-24);let n=M(e);for(let t=0;t<i.length;t++)n+=`<span style="opacity:${((24-t)/24).toFixed(2)}">${M(i[t])}</span>`;this._card.ui.updateChatHtml(this._streamEl,n)}}function M(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}let I=0,B=null,U=null,R=!1;function P(){if("visible"!==document.visibilityState)return;if(!B||!U)return;const t=U,e=B;B=null,U=null,t.logger.log("satellite-notify",`Tab visible — replaying queued event #${e.data.id}`),F(t,e)}function F(t,e){const{type:i,data:n}=e;if("media_player"===i)return void t.mediaPlayer.handleCommand(n);if(!n||!n.id)return;if("hidden"===document.visibilityState)return t.logger.log("satellite-notify",`Event #${n.id} queued — tab hidden`),B=e,U=t,void(R||(R=!0,document.addEventListener("visibilitychange",P)));const r={...n};r.ask_question?$(t.askQuestion,r,"ask-question"):"start_conversation"===i||r.start_conversation?$(t.startConversation,r,"start-conversation"):$(t.announcement,r,"announce")}function $(t,e,i){if(e.id<=I)return;if(t.playing)return void(t.queued&&t.queued.id===e.id||(t.queued=e,t.log.log(i,`Notification #${e.id} queued — still displaying`)));const n=t.card.currentState;"WAKE_WORD_DETECTED"===n||"STT"===n||"INTENT"===n||"TTS"===n||t.card.tts.isPlaying?t.queued&&t.queued.id===e.id||(t.queued=e,t.log.log(i,`Notification #${e.id} queued — pipeline busy (${n})`)):(t.queued=null,I=e.id,t.log.log(i,`New ${i} #${e.id}: message="${e.message||""}" media="${e.media_id||""}"`),q(t,e,e=>t._onComplete(e),i))}function D(t){if(!t.queued)return null;const e=t.queued;return t.queued=null,e.id<=(I||0)||t.playing?null:(I=e.id,e)}function q(t,e,i,n){t.clearTimeoutId&&L(t),t.card.mediaPlayer.interrupt(),t.playing=!0,t.currentAnnounceId=e.id,t.card.ui.showBlurOverlay(u),t.barWasVisible=t.card.ui.showBarSpeaking(),!e.ask_question&&!e.start_conversation&&t.card.ui.setAnnouncementMode(!0),!1===e.preannounce?(t.log.log(n,"Preannounce disabled — skipping chime"),Q(t,e,i,n)):e.preannounce_media_id&&""!==e.preannounce_media_id?(t.log.log(n,`Playing pre-announcement media: ${e.preannounce_media_id}`),N(t,e.preannounce_media_id,n,()=>{Q(t,e,i,n)})):y("data:audio/mpeg;base64,SUQzBAAAAAAAIlRTU0UAAAAOAAADTGF2ZjYyLjMuMTAwAAAAAAAAAAAAAAD/83DAAAAAAAAAAAAAWGluZwAAAA8AAABHAAAJ2wAsNDo6PEJCREdPT1FXV1lfZGRmaWlucXR0dnl5fH6BgYSGhomLi46Rk5OWmZmbnqGho6amqKuurrCzs7a4u7u+wMDDxcXIy83N0NPT1djb293g4OLl6Ojq7e3w8vX1+Pr6/f8AAAAATGF2YzYyLjExAAAAAAAAAAAAAAAAJAJ2AAAAAAAACduXdSMzAAAAAAAAAAAAAAAAAP/zkMQABKACtA1AAAAhIf//////WD7//////+UDBQEFAG8QAAwAA////////4tHrTBwb1nAKAQwAWv4GNQjv/gALnV////////lgLfymat/9gaiyIf/0wgGjEYcAf////////rqE9AlozJOsr////////////Uk5Mol0UiKDADgf/0EwbiN//////////////uLQ4epCADgf/2iAIJ7/////////////1DUUXUCgAcD/+GAlf//////1B6B//dgWCav////////////rTTMQFhiYyognA/2UxiYERBp4DRkFFE2mt////////////1oooFIRghgYkdAKn4ExhoMptbiMZpfCf/zMMTlDsL+0B+AoCQ0KggA4H/9SQDSP//////////////ckC7kabUCgAcD/+JQhb/////////////4gmVMQU0Cgf/zoG0Xgf/UuAxx8P/zIMTrCIKuvAfAkAEd6nQQ///////////+1MwYzXWYJUcJoa0aW/eeGJ2nyIkWlSC8D/r/8xDE8AXyusQWBBeQ1KWbBkEDXKjZ2//////zIMTlBaK2wBYAW4D///////9S0HU0UQCBvOWduMNageQ2nIkcAf/1koCfV///////////8xDE9QN5XtAeAFeA///0E94FTyoMAOB//P/zEMT0BhK2wAYDTZGWE2f///////////////MwxOgM8s6cDgT3kdxwlj0IAOB//dAA5Pf////////////+gHBl1QwA4H/9JATz//////////////MmA4H/8UMKDD/+dBtMQU1FqqoC//MQxPUGOrbUFgNxkIH/8rEFTEFNRVVVVQj/8yDE6QUisuAeAFWAP/5wGKpMQU1FqqqqA4H/8EHVTEFNRVVVVQOB//cJVUxBTUVVVVUD//MQxPgBcVrgGABTgIH/8ME1TEFNRVVVVQL/8yDE/wqSyqgGA3WRgf/ysCFMQU1FMy4xMAw//mwOTEFNRaqqqgKB//KwWkxBTUWqqgOB//MgxPsKMsKoDgU3kf/xwGtVTEFNRVVVVQOB//UJlUxBTUVVVVUDgf/xQYpMQU1FMy4xMP/zEMT5BYqywAYEV5AMP/50J0xBTUUzLjEw//MQxO8FarbUFgBbgAw//k4JTEFNRTMuMTD/8yDE5gWStsAWBA+EMFVVQDVMQU1FMy4xMDBVVYLlTEFNRTMuMTAwVVWEqkxBTUUzLjEw//MQxPYFArLIFgBbgDCqqoaqTEFNRTMuMTD/8xDE7wFZWuQYAE+AMKqqsGJMQU1FMy4xMP/zEMT2AUFa3BAAU4IwqqpgHUxBTUUzLjEw//MQxPgBaVrUGABTgDBVVbGFTEFNRTMuMTD/8xDE+AFJWsgQAFeCMFVVoKpMQU1FMy4xMP/zEMT4AWla0BgAT4AwqqqBqkxBTUUzLjEw//MQxPgBUVrQGABPgDCqqoLVTEFNRTMuMTD/8xDE+AFhWsgYAE+AMFVVg6pMQU1FMy4xMP/zEMT4AXFawBgAU4AwqqpwBUxBTUUzLjEw//MQxPcBOVrEEABNgjBVVWFqTEFNRTMuMTD/8xDE+AFxWrgYAFOAMKqqcGpMQU1FMy4xMP/zEMT5AYletBgAT4AwqqqA1UxBTUUzLjEw//MQxPgBUVq4GABPgDBVVVWKTEFNRTMuMTD/8xDE+AFZWrAYAE+AMFVVVYxMQU1Fqqr////zEMT3AUFarBAAU4L////L1UxBTUVVVf////MQxPcBOVqsEABNgv///8WVTEFNRTMuMTD/8xDE9ABxWqAAAA68MFVVVVVMQU1FMy4xMP/zEMT0AGFaoAAADrwwVVVVVUxBTUUzLjEw//MQxPQAWVqkAAAOvDBVVVVVTEFNRTMuMTD/8xDE9ABRWpwAAA68MFVVVVVMQU1FMy4xMP/zEMT0AHFalAAAErwwVVVVVUxBTUUzLjEw//MQxPQAaVqQAAAMvDBVVVVVTEFNRTMuMTD/8xDE9ABhWogAABK8MFVVVVVMQU1FMy4xMP/zEMT0AGlahAAAErwwVVVVVUxBTUUzLjEw//MQxPQAUVqMAAAKvDBVVVVVTEFNRTMuMTD/8xDE9ABJWowAAAq8MFVVVVVMQU1FMy4xMP/zEMT0AElaiAAACrwwVVVVVUxBTUUzLjEw//MQxPQAaVp8AAAMvDBVVVVVTEFNRTMuMTD/8xDE9ABZWngAAAy8MFVVVVVMQU1FMy4xMP/zEMT0AGFadAAADLwwVVVVVUxBTUUzLjEw//MQxPQASVp8AAAEvDBVVVVVTEFNRTMuMTD/8xDE8wBBWoAAAAS8MFVVVVVMQU1FMy4xMP/zEMTzADlafAAABLwwVVVVVUxBTUUzLjEw//MQxPkBiAKEAAAAADBVVVVVTEFNRTMuMTD/8xDE+QGQAnwAAAAAMFVVVVVMQU1FMy4xMP/zEMTyAAAD/AAAAAAwVVVVVUxBTUUzLjEw//MQxPIAAANIAAAAADBVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVU=",t.card.mediaPlayer.volume,{onEnd:()=>{t.card.mediaPlayer.notifyAudioEnd("announce-chime"),Q(t,e,i,n)},onError:()=>{t.card.mediaPlayer.notifyAudioEnd("announce-chime"),Q(t,e,i,n)},onStart:()=>{t.log.log(n,"Announcement chime playing"),t.card.mediaPlayer.notifyAudioStart("announce-chime")}})}function Q(t,e,i,n){const r=e.media_id||"";if(e.message){const i=!e.ask_question&&!e.start_conversation;t.card.ui.addChatMessage(e.message,i?"announcement":"assistant")}r?(t.log.log(n,`Playing media: ${r}`),N(t,r,n,()=>i(e))):(t.log.log(n,"No media — completing after message display"),setTimeout(()=>i(e),3e3))}function L(t){t.clearTimeoutId&&(clearTimeout(t.clearTimeoutId),t.clearTimeoutId=null),t.card.ui.setAnnouncementMode(!1),t.card.ui.clearAnnouncementBubbles(),t.card.ui.hideBlurOverlay(u),t.card.ui.restoreBar(t.barWasVisible)}function N(t,e,i,n){const r=f(e),s=t.card.mediaPlayer.volume;t.currentAudio=y(r,s,{onEnd:()=>{t.log.log(i,"Media playback complete"),t.currentAudio=null,t.card.mediaPlayer.notifyAudioEnd("notification"),n?.()},onError:e=>{t.log.error(i,`Media playback error: ${e}`),t.currentAudio=null,t.card.mediaPlayer.notifyAudioEnd("notification"),n?.()},onStart:()=>{t.log.log(i,"Media playback started"),t.card.mediaPlayer.notifyAudioStart("notification")}})}function W(t){t.playing=!1,t.currentAudio=null,t.currentAnnounceId=null,t.clearTimeoutId=null,t.barWasVisible=!1,t.queued=null}function z(t,e,i){const{connection:n,config:r}=t;n&&r.satellite_entity?n.sendMessagePromise({type:"voice_satellite/announce_finished",entity_id:r.satellite_entity,announce_id:e}).then(()=>{t.logger.log(i,`ACK sent for #${e}`)}).catch(e=>{t.logger.error(i,`ACK failed: ${e.message||JSON.stringify(e)}`)}):t.logger.error(i,"Cannot ACK — no connection or entity")}class O{constructor(t){this._card=t,this._log=t.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){this._handler=e=>{if(!this._card.config.double_tap_cancel)return;const i=o.includes(this._card.currentState)||this._card.tts.isPlaying,n=this._card.timer.isAlertActive,r=this._card.announcement.playing||this._card.askQuestion.playing||this._card.startConversation.playing||this._card.announcement.clearTimeoutId||this._card.startConversation.clearTimeoutId;if(!i&&!n&&!r)return;if("click"===e.type&&this._lastTapWasTouch)return;this._lastTapWasTouch="touchstart"===e.type;const s=Date.now(),a=s-this._lastTapTime;if(this._lastTapTime=s,a<400&&a>0){if(e.preventDefault(),this._card.timer.isAlertActive)return this._log.log("ui","Double-tap detected — dismissing timer alert"),void this._card.timer.dismissAlert();if(r){this._log.log("ui","Double-tap detected — dismissing notification");for(const t of[this._card.announcement,this._card.askQuestion,this._card.startConversation])(t.playing||t.clearTimeoutId)&&(t.currentAnnounceId&&z(this._card,t.currentAnnounceId,"double-tap"),t.currentAudio&&(t.currentAudio.pause(),t.currentAudio=null),t.playing=!1,t.currentAnnounceId=null,L(t));return this._card.askQuestion.cancel(),void this._card.pipeline.restart(0)}this._log.log("ui","Double-tap detected — cancelling interaction"),this._card.tts.isPlaying&&this._card.tts.stop(),this._card.askQuestion.cancel(),this._card.pipeline.clearContinueState(),this._card.setState(t),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l);const i=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;!1===V(this._card.hass,this._card.config.satellite_entity,"wake_sound")||i||this._card.tts.playChime("done"),this._card.pipeline.restart(0)}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}window.__vsSingleton||(window.__vsSingleton={instance:null,active:!1,starting:!1});const H=window.__vsSingleton;function G(t){return!H.instance||H.instance===t}function j(){return H.active}function Y(){return H.starting}function K(t){H.starting=!!t}let J=null,X=!1,Z=null,tt=null,et=null,it=null;const nt=[2e3,4e3,8e3,16e3,3e4];let rt=0;function st(t,e){const{config:i,connection:n}=t;i.satellite_entity&&n&&G(t)&&(X||(tt=t,et=e,X=!0,ot(t,n,e),Z||(Z=()=>{t.logger.log("satellite-sub","Connection reconnected — re-subscribing"),at();const i=t.connection;i&&(X=!0,ot(t,i,e))},n.addEventListener("ready",Z))))}function ot(t,e,i){e.subscribeMessage(t=>i(t),{type:"voice_satellite/subscribe_events",entity_id:t.config.satellite_entity}).then(e=>{J=e,rt=0,t.logger.log("satellite-sub",`Subscribed to satellite events for ${t.config.satellite_entity}`)}).catch(e=>{t.logger.error("satellite-sub",`Failed to subscribe: ${e}`),X=!1,function(t,e,i){if(it)return;const n=nt[Math.min(rt,nt.length-1)];rt++,t.logger.log("satellite-sub",`Retrying in ${n/1e3}s (attempt ${rt})`),it=setTimeout(()=>{if(it=null,X)return;const e=t.connection;e&&(X=!0,ot(t,e,i))},n)}(t,0,i)})}function at(){if(it&&(clearTimeout(it),it=null),rt=0,J){try{J()}catch(t){}J=null}X=!1}class lt{constructor(t){this._card=t,this._log=t.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){this._handler||(this._handler=()=>this._handleChange(),document.addEventListener("visibilitychange",this._handler))}_handleChange(){this._debounceTimer&&clearTimeout(this._debounceTimer),this._card.isOwner&&(document.hidden?(this._isPaused=!0,this._card.askQuestion.cancel(),o.includes(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(()=>{this._log.log("visibility","Tab hidden — pausing mic"),this._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume()))}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}async _resume(){if(!this._isPaused)return;const{pipeline:t,audio:e}=this._card;t.resetForResume(),await this._card.audio.resume(),this._isPaused=!1,null===B?(tt&&et&&(at(),st(tt,et)),this._log.log("visibility","Resuming — restarting pipeline"),t.restart(0)):this._log.log("visibility","Resuming — satellite event pending, deferring pipeline restart")}}function ct(t,e,i,n,r){e.subscribeEvents(t=>{const{data:e}=t;e&&e.new_state&&e.entity_id===i&&n(e.new_state.attributes||{})},"state_changed").then(e=>{t._unsubscribe=e,t.log.log(r,`Subscribed to state changes for ${i}`);const s=t.card.hass;s?.states?.[i]&&n(s.states[i].attributes||{})}).catch(e=>{t.log.error(r,`Failed to subscribe: ${e}`),t._subscribed=!1})}let ut="";function dt(){ut=""}let ht=null,_t=null;function pt(t){t.card.ui.removeTimerContainer()}function gt(t,e){t.card.ui.expireTimerPill(e,400);const i=t.timers.find(t=>t.id===e);i&&(i.el=null)}function mt(t){(function(t,e,i={}){const{onDone:n,log:r}=i;try{const{ctx:i,owned:r}=function(t){const e=t.audio?.audioContext;return e&&"closed"!==e.state?("suspended"===e.state&&e.resume(),{ctx:e,owned:!1}):{ctx:new(window.AudioContext||window.webkitAudioContext),owned:!0}}(t),s=.25*t.mediaPlayer.volume;for(const t of e.notes){const n=i.createOscillator(),r=i.createGain();n.connect(r),r.connect(i.destination),n.type=e.wave,n.frequency.setValueAtTime(t.freq,i.currentTime+t.start),r.gain.setValueAtTime(0,i.currentTime+t.start),r.gain.linearRampToValueAtTime(s,i.currentTime+t.start+.02),r.gain.exponentialRampToValueAtTime(.001,i.currentTime+t.end),n.start(i.currentTime+t.start),n.stop(i.currentTime+t.end)}e.totalMs||n?setTimeout(()=>{r&&i.close(),n?.()},e.totalMs||600):r&&setTimeout(()=>i.close(),1e3)}catch(t){r?.error("chime",`Chime error: ${t}`),n?.()}})(t.card,b,{log:t.log}),t.log.log("timer","Alert chime played")}class bt{constructor(t){this._card=t,this._log=t.logger,this._timers=[],this._tickInterval=null,this._container=null,this._unsubscribe=null,this._subscribed=!1,this._reconnectListener=null,this._knownTimerIds=[],this._alertActive=!1,this._alertEl=null}update(){if(this._subscribed)return;const{config:t,connection:e}=this._card;t.satellite_entity&&e&&function(t,e,i,n,r){t._subscribed=!0,t._entityId=i,ct(t,e,i,n,r),t._reconnectListener||(t._reconnectListener=()=>{if(!t.card.isOwner)return;if(t.log.log(r,"Connection reconnected — re-subscribing"),t._unsubscribe){try{t._unsubscribe()}catch(t){}t._unsubscribe=null}const e=t.card.connection;e&&ct(t,e,t._entityId,n,r)},e.addEventListener("ready",t._reconnectListener))}(this,e,t.satellite_entity,t=>this.processStateChange(t),"timer")}get card(){return this._card}get log(){return this._log}get timers(){return this._timers}set timers(t){this._timers=t}get knownTimerIds(){return this._knownTimerIds}set knownTimerIds(t){this._knownTimerIds=t}get alertActive(){return this._alertActive}set alertActive(t){this._alertActive=t}get isAlertActive(){return this._alertActive}dismissAlert(){this.clearAlert()}destroy(){var t;this.stopTick(),pt(this),this.clearAlert(),this._timers=[],this._knownTimerIds=[],dt(),(t=this)._unsubscribe&&(t._unsubscribe(),t._unsubscribe=null),t._reconnectListener&&t.card.connection&&(t.card.connection.removeEventListener("ready",t._reconnectListener),t._reconnectListener=null),t._subscribed=!1}processStateChange(t){!function(t,e){let i=e.active_timers;const n=e.last_timer_event;i&&Array.isArray(i)||(i=[]);const r=JSON.stringify(i);if(r===ut)return;t.log.log("timer",`State changed: timers=${r} last_event=${n}`),ut=r;const s=i.map(t=>t.id),o=t.knownTimerIds.filter(t=>!s.includes(t));o.length>0&&"finished"===n&&(t.log.log("timer",`Timer(s) finished: ${o.join(", ")}`),t.alertActive||t.showAlert());for(const e of o)t.removePill(e);t.knownTimerIds=s,t.syncTimers(i)}(this,t)}syncTimers(t){if(0===t.length)return this._timers=[],this.stopTick(),void pt(this);const e=Date.now(),i=[];for(const n of t){const t=this._timers.find(t=>t.id===n.id),r=n.started_at?1e3*n.started_at:e;if(t){if(t.totalSeconds!==n.total_seconds){t.totalSeconds=n.total_seconds,t.startedAt=r;const i=Math.floor((e-r)/1e3);t.secondsLeft=Math.max(0,n.total_seconds-i),t.startHours=n.start_hours||0,t.startMinutes=n.start_minutes||0,t.startSeconds=n.start_seconds||0}i.push(t)}else{const t=Math.floor((e-r)/1e3);i.push({id:n.id,name:n.name||"",totalSeconds:n.total_seconds,secondsLeft:Math.max(0,n.total_seconds-t),startedAt:r,startHours:n.start_hours||0,startMinutes:n.start_minutes||0,startSeconds:n.start_seconds||0,el:null})}}var n;this._timers=i,this.startTick(),(n=this).card.ui.syncTimerPills(n.timers,t=>()=>n.cancelTimer(t))}startTick(){this._tickInterval||(this._tickInterval=setInterval(()=>function(t){const e=Date.now();for(const i of t.timers){const n=Math.floor((e-i.startedAt)/1e3),r=Math.max(0,i.totalSeconds-n);i.secondsLeft=r,t.card.ui.updateTimerPill(i.el,r,i.totalSeconds)}}(this),1e3))}stopTick(){this._tickInterval&&(clearInterval(this._tickInterval),this._tickInterval=null)}showAlert(){!function(t){if(t.alertActive)return void t.log.log("timer","Alert already active, skipping duplicate");t.alertActive=!0,t.log.log("timer","Showing finished alert"),t.card.ui.showBlurOverlay(c),t.card.ui.showTimerAlert(()=>t.clearAlert()),mt(t),ht&&clearInterval(ht),ht=setInterval(()=>mt(t),3e3);const e=t.card.config.timer_finished_duration;e>0&&(_t&&clearTimeout(_t),_t=setTimeout(()=>t.clearAlert(),1e3*e))}(this)}clearAlert(){var t;(t=this).alertActive&&(t.alertActive=!1,ht&&(clearInterval(ht),ht=null),_t&&(clearTimeout(_t),_t=null),t.card.ui.clearTimerAlert(),t.stopTick(),pt(t),t.timers=[],t.card.ui.hideBlurOverlay(c),t.log.log("timer","Alert dismissed"))}removePill(t){gt(this,t)}cancelTimer(t){this._log.log("timer",`Cancelling timer: ${t}`),function(t,e){t.connection&&t.config.satellite_entity&&e&&t.connection.sendMessagePromise({type:"voice_satellite/cancel_timer",entity_id:t.config.satellite_entity,timer_id:e}).then(()=>{t.logger.log("timer",`Cancel timer ${e} succeeded`)}).catch(e=>{t.logger.error("timer",`Cancel timer failed: ${e.message||JSON.stringify(e)}`)})}(this._card,t),gt(this,t);const e=this._timers.findIndex(e=>e.id===t);-1!==e&&this._timers.splice(e,1);const i=this._knownTimerIds.indexOf(t);-1!==i&&this._knownTimerIds.splice(i,1),dt(),0===this._timers.length&&(this.stopTick(),setTimeout(()=>{0===this._timers.length&&pt(this)},500))}}const ft="announce";class yt{constructor(t){this._card=t,this._log=t.logger,W(this)}get card(){return this._card}get log(){return this._log}playQueued(){const t=D(this);t&&(this._log.log(ft,`Playing queued announcement #${t.id}`),this._play(t))}_play(t){q(this,t,t=>this._onComplete(t),ft)}_onComplete(t){this.currentAudio=null,this._log.log(ft,`Announcement #${t.id} playback complete`),z(this._card,t.id,ft),this._card.pipeline.restart(0);const e=1e3*(this._card.config.announcement_display_duration||5);this.clearTimeoutId=setTimeout(()=>{if(L(this),this.playing=!1,this.queued)return void this.playQueued();const t=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;!1===V(this._card.hass,this._card.config.satellite_entity,"wake_sound")||t||this._card.tts.playChime("done")},e)}}function vt(t,e,i,n){const{connection:r,config:s}=t,o=t.logger;if(!r||!s.satellite_entity)return o.error(n,"Cannot send answer — no connection or entity"),Promise.resolve(null);const a={type:"voice_satellite/question_answered",entity_id:s.satellite_entity,announce_id:e,sentence:i||""};return r.sendMessagePromise(a).then(t=>{const r=t?.matched,s=t?.id;return o.log(n,`Answer sent for #${e}: "${i}" — matched: ${r}${s?` (id: ${s})`:""}`),t}).catch(t=>(o.error(n,`Answer failed: ${t.message||JSON.stringify(t)}`),null))}const At="ask-question";class Vt{constructor(t){this._card=t,this._log=t.logger,W(this)}get card(){return this._card}get log(){return this._log}cancel(){this._chimeSettleTimeout&&(clearTimeout(this._chimeSettleTimeout),this._chimeSettleTimeout=null),this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null),this._cleanupTimeout&&(clearTimeout(this._cleanupTimeout),this._cleanupTimeout=null),this.currentAnnounceId&&!this._answerSent&&(this._answerSent=!0,vt(this._card,this.currentAnnounceId,"","double-tap")),this._card.ui.hideBlurOverlay(u),this.playing=!1}playQueued(){const t=D(this);t&&(this._log.log(At,`Playing queued ask_question #${t.id}`),this._play(t))}_play(t){q(this,t,t=>this._onComplete(t),At)}_onComplete(t){this.currentAudio=null,this._log.log(At,`Question #${t.id} playback complete`),z(this._card,t.id,At),this._enterSttMode(t)}_enterSttMode(t){this._log.log(At,"Entering STT-only mode"),this._card.ui.setAnnouncementMode(!1),this._card.ui.showBlurOverlay(l);const{pipeline:e}=this._card;if(!e)return;const i=t.id,n=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;let r=0;n||(this._card.tts.playChime("wake"),r=500),this._answerSent=!1,this._chimeSettleTimeout=setTimeout(()=>{e.restartContinue(null,{end_stage:"stt",onSttEnd:t=>{this._log.log(At,`STT result: "${t}"`),this._answerSent=!0,this._processAnswer(i,t,n)}}),this._sttSafetyTimeout=setTimeout(()=>{this._answerSent||(this._log.log(At,`No STT result for #${i} — sending empty answer to release server`),this._answerSent=!0,this._processAnswer(i,"",n))},3e4)},r)}_processAnswer(t,e,i){this._chimeSettleTimeout&&(clearTimeout(this._chimeSettleTimeout),this._chimeSettleTimeout=null),this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null);const{pipeline:n}=this._card;let r=!1,s=null;this._cleanupTimeout=setTimeout(()=>{r||(r=!0,this._cleanupTimeout=null,null===s||s||this._card.ui.clearErrorBar(),L(this),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this.playing=!1,this.queued?this.playQueued():n.restart(0))},2e3),vt(this._card,t,e,At).then(t=>{const e=t?.matched;if(s=e,i||this._card.tts.playChime(e?"done":"error"),!e){this._card.ui.showErrorBar();const t=this._card.ui.element?this._card.ui.element.querySelector(".vs-rainbow-bar"):null;t&&(t.classList.add("error-flash"),t.addEventListener("animationend",function e(){t.classList.remove("error-flash"),t.removeEventListener("animationend",e)}))}})}}const wt="start-conversation";class Tt{constructor(t){this._card=t,this._log=t.logger,W(this)}get card(){return this._card}get log(){return this._log}playQueued(){const t=D(this);t&&(this._log.log(wt,`Playing queued start_conversation #${t.id}`),this._play(t))}_play(t){q(this,t,t=>this._onComplete(t),wt)}_onComplete(t){this.currentAudio=null,this._log.log(wt,`Prompt #${t.id} playback complete`),z(this._card,t.id,wt),L(this),this.playing=!1,this._card.ui.showBlurOverlay(l);const{pipeline:e}=this._card;e&&e.restartContinue(null,{extra_system_prompt:t.extra_system_prompt||null})}}class St{constructor(t){this._card=t,this._log=t.logger,this._audio=null,this._playing=!1,this._paused=!1,this._volume=1,this._muted=!1,this._mediaId=null,this._volumeSynced=!1,this._activeSources=new Set,this._idleDebounce=null}get isPlaying(){return this._playing}get volume(){return this._syncInitialVolume(),this._muted?0:this._volume*this._volume}notifyAudioStart(t){this._idleDebounce&&(clearTimeout(this._idleDebounce),this._idleDebounce=null),this._activeSources.add(t),this._reportState("playing")}notifyAudioEnd(t){this._activeSources.delete(t),0!==this._activeSources.size||this._playing||this._paused||(this._idleDebounce&&clearTimeout(this._idleDebounce),this._idleDebounce=setTimeout(()=>{this._idleDebounce=null,0!==this._activeSources.size||this._playing||this._paused||this._reportState("idle")},200))}handleCommand(t){const{command:e}=t;switch(this._log.log("media-player",`Command: ${e}`),e){case"play":this._play(t);break;case"pause":this._pause();break;case"resume":this._resume();break;case"stop":this._stop();break;case"volume_set":this._setVolume(t.volume);break;case"volume_mute":this._setMute(t.mute);break;default:this._log.log("media-player",`Unknown command: ${e}`)}}interrupt(){(this._playing||this._paused)&&(this._log.log("media-player","Interrupted"),this._cleanup(),0===this._activeSources.size&&this._reportState("idle"))}_curved(t){return t*t}_effectiveVolume(){return this._muted?0:this._curved(this._volume)}_syncInitialVolume(){if(this._volumeSynced)return;const t=this._getEntityId();if(!t)return;const e=this._card.hass?.states?.[t];if(!e)return;const i=e.attributes?.volume_level;null!=i&&(this._volume=i,this._log.log("media-player",`Synced initial volume from entity: ${i}`));const n=e.attributes?.is_volume_muted;void 0!==n&&(this._muted=n),this._volumeSynced=!0}async _play(t){this._cleanup();const{media_id:e,volume:i}=t;let n;if(null!=i&&(this._volume=i),this._mediaId=e,e.startsWith("http://")||e.startsWith("https://"))n=e;else{const t=this._card.connection;if(t)try{n=f((await t.sendMessagePromise({type:"auth/sign_path",path:e,expires:3600})).path)}catch(t){this._log.error("media-player",`Failed to sign URL: ${t}`),n=f(e)}else n=f(e)}this._playing=!0,this._paused=!1,this._audio=y(n,this._effectiveVolume(),{onEnd:()=>{this._log.log("media-player","Playback complete"),this._playing=!1,this._paused=!1,this._audio=null,0===this._activeSources.size&&this._reportState("idle")},onError:t=>{this._log.error("media-player",`Playback error: ${t}`),this._playing=!1,this._paused=!1,this._audio=null,0===this._activeSources.size&&this._reportState("idle")},onStart:()=>{this._log.log("media-player",`Playing: ${e}`),this._reportState("playing")}})}_pause(){this._audio&&this._playing?(this._audio.pause(),this._playing=!1,this._paused=!0,this._reportState("paused")):this._reportState("idle")}_resume(){this._audio&&this._paused?(this._audio.play().catch(t=>{this._log.error("media-player",`Resume failed: ${t}`),this._cleanup(),this._reportState("idle")}),this._playing=!0,this._paused=!1,this._reportState("playing")):this._reportState("idle")}_stop(){this._audio&&(this._cleanup(),0===this._activeSources.size&&this._reportState("idle"))}_setVolume(t){this._volume=t;const e=this._effectiveVolume();this._audio&&(this._audio.volume=e),this._applyVolumeToExternalAudio(e);const i=this._playing||this._activeSources.size>0?"playing":this._paused?"paused":"idle";this._reportState(i)}_setMute(t){this._muted=t;const e=this._effectiveVolume();this._audio&&(this._audio.volume=e),this._applyVolumeToExternalAudio(e)}_applyVolumeToExternalAudio(t){const e=this._card.tts?._currentAudio;e&&(e.volume=t);for(const e of[this._card.announcement,this._card.askQuestion,this._card.startConversation])e?.currentAudio&&(e.currentAudio.volume=t)}_cleanup(){this._idleDebounce&&(clearTimeout(this._idleDebounce),this._idleDebounce=null),this._audio&&(this._audio.onended=null,this._audio.onerror=null,this._audio.pause(),this._audio.src="",this._audio=null),this._playing=!1,this._paused=!1}_getEntityId(){const t=this._card.hass,e=this._card.config.satellite_entity;if(!t?.entities||!e)return null;const i=t.entities[e];if(!i?.device_id)return null;for(const[e,n]of Object.entries(t.entities))if(n.device_id===i.device_id&&"voice_satellite"===n.platform&&e.startsWith("media_player."))return e;return null}_reportState(t){this._syncInitialVolume();const e=this._getEntityId();if(!e)return void this._log.log("media-player","No media_player entity found — skipping state report");const i=this._card.connection;if(!i)return;const n={type:"voice_satellite/media_player_event",entity_id:e,state:t};this._volumeSynced&&void 0!==this._volume&&(n.volume=this._volume),this._mediaId&&"idle"!==t&&(n.media_id=this._mediaId),i.sendMessagePromise(n).catch(t=>{this._log.error("media-player",`Failed to report state: ${JSON.stringify(t)}`)})}}const xt=[{name:"satellite_entity",required:!0,selector:{entity:{filter:{domain:"assist_satellite",integration:"voice_satellite"}}}},{name:"debug",selector:{boolean:{}}},{type:"expandable",name:"",title:"Microphone Processing",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"noise_suppression",selector:{boolean:{}}},{name:"echo_cancellation",selector:{boolean:{}}},{name:"auto_gain_control",selector:{boolean:{}}},{name:"voice_isolation",selector:{boolean:{}}}]}]}],kt=[{type:"expandable",name:"",title:"TTS Output",flatten:!0,schema:[{name:"tts_target",selector:{entity:{filter:{domain:"media_player"}}}}]},{type:"expandable",name:"",title:"Announcements",flatten:!0,schema:[{name:"announcement_display_duration",selector:{number:{min:1,max:60,step:1,unit_of_measurement:"s",mode:"slider"}}}]}],Ct=[{type:"expandable",name:"",title:"Timer Pill",flatten:!0,schema:[{name:"timer_position",selector:{select:{options:[{value:"top-left",label:"Top Left"},{value:"top-right",label:"Top Right"},{value:"bottom-left",label:"Bottom Left"},{value:"bottom-right",label:"Bottom Right"}],mode:"dropdown"}}},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_color",selector:{text:{}}},{name:"timer_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_bold",selector:{boolean:{}}},{name:"timer_font_italic",selector:{boolean:{}}},{name:"timer_rounded",selector:{boolean:{}}}]},{name:"timer_border_color",selector:{text:{}}},{name:"timer_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_finished_duration",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}}]}],Et=[{type:"expandable",name:"",title:"Activity Bar",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"bar_position",selector:{select:{options:[{value:"bottom",label:"Bottom"},{value:"top",label:"Top"}],mode:"dropdown"}}},{name:"bar_height",selector:{number:{min:2,max:40,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{name:"bar_gradient",selector:{text:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"background_blur",selector:{boolean:{}}},{name:"background_blur_intensity",selector:{number:{min:0,max:20,step:1,mode:"slider"}}}]}]}],Mt=[{type:"expandable",name:"",title:"Bubble Style",flatten:!0,schema:[{name:"bubble_style",selector:{select:{options:[{value:"centered",label:"Centered"},{value:"chat",label:"Chat style"}],mode:"dropdown"}}},{name:"bubble_container_width",selector:{number:{min:40,max:100,step:5,unit_of_measurement:"%",mode:"slider"}}}]},{type:"expandable",name:"",title:"Transcription Bubble",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"transcription_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_color",selector:{text:{}}},{name:"transcription_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_bold",selector:{boolean:{}}},{name:"transcription_font_italic",selector:{boolean:{}}},{name:"transcription_rounded",selector:{boolean:{}}}]},{name:"transcription_border_color",selector:{text:{}}},{name:"transcription_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{type:"expandable",name:"",title:"Response Bubble",flatten:!0,schema:[{name:"show_response",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"response_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_color",selector:{text:{}}},{name:"response_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_bold",selector:{boolean:{}}},{name:"response_font_italic",selector:{boolean:{}}},{name:"response_rounded",selector:{boolean:{}}}]},{name:"response_border_color",selector:{text:{}}},{name:"response_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]}],It=Object.assign({},{satellite_entity:"Satellite entity",debug:"Debug logging",noise_suppression:"Noise suppression",echo_cancellation:"Echo cancellation",auto_gain_control:"Auto gain control",voice_isolation:"Voice isolation (Chrome only)"},{tts_target:"TTS output device",announcement_display_duration:"Announcement display duration"},{timer_position:"Timer position",timer_font_size:"Font size",timer_font_family:"Font family",timer_font_color:"Font color",timer_background:"Background color",timer_font_bold:"Bold",timer_font_italic:"Italic",timer_rounded:"Rounded corners",timer_border_color:"Border color",timer_padding:"Padding",timer_finished_duration:"Auto-dismiss timer"},{bar_position:"Bar position",bar_height:"Bar height",bar_gradient:"Gradient colors",background_blur:"Background blur",background_blur_intensity:"Blur intensity"},{bubble_style:"Bubble layout",bubble_container_width:"Container width",transcription_font_size:"Font size",transcription_font_family:"Font family",transcription_font_color:"Font color",transcription_background:"Background color",transcription_font_bold:"Bold",transcription_font_italic:"Italic",transcription_rounded:"Rounded corners",transcription_border_color:"Border color",transcription_padding:"Padding",show_response:"Show response",response_font_size:"Font size",response_font_family:"Font family",response_font_color:"Font color",response_background:"Background color",response_font_bold:"Bold",response_font_italic:"Italic",response_rounded:"Rounded corners",response_border_color:"Border color",response_padding:"Padding"}),Bt=Object.assign({},{satellite_entity:"Required. Install the Voice Satellite Card Integration: https://github.com/jxlarrea/voice-satellite-card-integration",voice_isolation:"AI-based voice isolation, currently only available in Chrome"},{tts_target:"Leave empty for browser audio, or select a media player entity",announcement_display_duration:"Seconds to show announcement bubble after playback"},{timer_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",timer_border_color:"CSS color value (supports rgba)",timer_finished_duration:"Seconds to show finished timer alert (0 = until dismissed)"},{bar_gradient:"Comma-separated CSS color values"},{bubble_style:"Centered: bubbles centered on screen. Chat: user right, assistant left",bubble_container_width:"Width of the bubble area (useful for large screens)",transcription_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",transcription_border_color:"CSS color value (supports rgba)",response_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",response_border_color:"CSS color value (supports rgba)"});function Ut(t){let e=t;for(let t=0;t<20&&e;t++){const t=e.tagName;if("HUI-CARD-PREVIEW"===t)return!0;if("HUI-CARD"===t&&e.hasAttribute("preview"))return!0;if(t&&t.includes("PREVIEW"))return!0;e=e.parentElement||(e.getRootNode&&e.getRootNode()).host}return!1}function Rt(t,e){const i=Object.assign({},d,e);t.innerHTML='\n    <style>\n      :host {\n        display: block;\n        position: relative;\n        overflow: hidden;\n        border-radius: var(--ha-card-border-radius, 12px);\n        min-height: 380px;\n      }\n      .preview-background {\n        position: absolute;\n        top: 0; left: 0; right: 0; bottom: 0;\n        background-image:\n          linear-gradient(45deg, #e0e0e0 25%, transparent 25%),\n          linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),\n          linear-gradient(45deg, transparent 75%, #e0e0e0 75%),\n          linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);\n        background-size: 20px 20px;\n        background-position: 0 0, 0 10px, 10px -10px, -10px 0;\n        background-color: #f5f5f5;\n      }\n      @media (prefers-color-scheme: dark) {\n        .preview-background {\n          background-image:\n            linear-gradient(45deg, #333 25%, transparent 25%),\n            linear-gradient(-45deg, #333 25%, transparent 25%),\n            linear-gradient(45deg, transparent 75%, #333 75%),\n            linear-gradient(-45deg, transparent 75%, #333 75%);\n          background-color: #222;\n        }\n      }\n      :host-context([data-theme="dark"]) .preview-background,\n      :host-context(.dark) .preview-background {\n        background-image:\n          linear-gradient(45deg, #333 25%, transparent 25%),\n          linear-gradient(-45deg, #333 25%, transparent 25%),\n          linear-gradient(45deg, transparent 75%, #333 75%),\n          linear-gradient(-45deg, transparent 75%, #333 75%);\n        background-color: #222;\n      }\n      .preview-container {\n        position: relative;\n        width: 100%;\n        min-height: 380px;\n        box-sizing: border-box;\n        display: flex;\n        flex-direction: column;\n        justify-content: flex-end;\n        padding: 24px 16px;\n      }\n      .preview-blur {\n        position: absolute;\n        top: 0; left: 0; right: 0; bottom: 0;\n        z-index: 1;\n        pointer-events: none;\n      }\n      .preview-bar {\n        position: absolute;\n        left: 0;\n        right: 0;\n        z-index: 2;\n        background-size: 200% 100%;\n        animation: preview-slide 2s linear infinite;\n      }\n      @keyframes preview-slide {\n        0% { background-position: 200% 0; }\n        100% { background-position: 0% 0; }\n      }\n      .preview-chat {\n        position: relative;\n        z-index: 3;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        width: 80%;\n        margin: 0 auto;\n      }\n      .preview-msg {\n        max-width: 85%;\n        word-wrap: break-word;\n        text-align: center;\n        line-height: 1.0;\n        animation: preview-fade-in 0.3s ease;\n      }\n      .preview-msg.user {\n        align-self: center;\n      }\n      .preview-msg.assistant {\n        align-self: center;\n      }\n      @keyframes preview-fade-in {\n        from { opacity: 0; transform: translateY(8px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      .preview-timer {\n        position: absolute;\n        z-index: 4;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        overflow: hidden;\n      }\n      .preview-timer-progress {\n        position: absolute;\n        top: 0;\n        left: 0;\n        height: 100%;\n        opacity: 0.3;\n        border-radius: inherit;\n      }\n      .preview-timer-content {\n        position: relative;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n      }\n    </style>\n    <div class="preview-background"></div>\n    <div class="preview-container">\n      <div class="preview-blur"></div>\n      <div class="preview-bar"></div>\n      <div class="preview-chat">\n        <div class="preview-msg user"></div>\n        <div class="preview-msg assistant"></div>\n      </div>\n      <div class="preview-timer">\n        <div class="preview-timer-progress"></div>\n        <div class="preview-timer-content">\n          <span>⏱</span>\n          <span class="preview-timer-time">00:04:32</span>\n        </div>\n      </div>\n    </div>\n  ',t.querySelector(".preview-container");const n=t.querySelector(".preview-blur");i.background_blur&&(n.style.backdropFilter=`blur(${i.background_blur_intensity}px)`,n.style.webkitBackdropFilter=`blur(${i.background_blur_intensity}px)`);const r=t.querySelector(".preview-bar");r.style.height=`${i.bar_height}px`,r.style.background=h(i.bar_gradient),r.style.backgroundSize="200% 100%","top"===i.bar_position?(r.style.top="0",r.style.bottom="auto"):(r.style.bottom="0",r.style.top="auto");const s=t.querySelector(".preview-msg.user");s.textContent="What's the temperature outside?",S(s,i,"transcription");const o=t.querySelector(".preview-msg.assistant");i.show_response?(o.textContent="It's currently 75°F and sunny.",S(o,i,"response")):o.style.display="none";const a=t.querySelector(".preview-chat"),l="chat"===i.bubble_style;a.style.width=`${i.bubble_container_width||80}%`,l?(a.style.alignItems="flex-start",s.style.alignSelf="flex-end",s.style.textAlign="left",o.style.alignSelf="flex-start",o.style.textAlign="left"):(a.style.alignItems="center",s.style.alignSelf="center",s.style.textAlign="center",o.style.alignSelf="center",o.style.textAlign="center"),"bottom"===i.bar_position?a.style.marginBottom=`${i.bar_height+8}px`:a.style.marginTop=`${i.bar_height+8}px`;const c=t.querySelector(".preview-timer");S(c,i,"timer");const u=t.querySelector(".preview-timer-progress"),_=i.timer_border_color||"rgba(100, 200, 150, 0.5)";u.style.background=_,u.style.width="65%";const p=i.timer_position||"top-right";c.style.top=p.startsWith("top")?`${i.bar_height+8+4}px`:"auto",c.style.bottom=p.startsWith("top")?"auto":`${i.bar_height+8+4}px`,c.style.left=p.includes("left")?"8px":"auto",c.style.right=p.includes("left")?"auto":"8px"}function Pt(t,e){const i=t.config.satellite_entity;i&&t.hass?.connection&&e!==t.lastSyncedSatelliteState&&(t.lastSyncedSatelliteState=e,t.hass.connection.sendMessagePromise({type:"voice_satellite/update_state",entity_id:i,state:e}).catch(()=>{}))}function Ft(i,n){const r=i.currentState;i.currentState=n,i.logger.log("state",`${r} → ${n}`),i.ui.updateForState(n,i.pipeline.serviceUnavailable,i.tts.isPlaying),(!i.tts.isPlaying||n!==e&&n!==t)&&Pt(i,n)}async function $t(e){if(!j()||G(e))if(Y())e.logger.log("lifecycle","Pipeline already starting globally, skipping");else{K(!0);try{Ft(e,"CONNECTING"),await e.audio.startMicrophone(),await e.pipeline.start(),function(t){H.instance=t,H.active=!0}(e),e.ui.hideStartButton(),e.visibility.setup(),e.timer.update(),st(e,t=>F(e,t)),e.doubleTap.setup()}catch(i){const n=i?.message||JSON.stringify(i);e.logger.error("pipeline",`Failed to start: ${n}`);let r="error";"NotAllowedError"===i.name?(r="not-allowed",e.logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===i.name?(r="not-found",e.logger.error("mic","No microphone found")):"NotReadableError"!==i.name&&"AbortError"!==i.name||(r="not-readable",e.logger.error("mic","Microphone in use or not readable")),"error"!==r?(e.ui.showStartButton(r),Ft(e,t)):(Ft(e,t),e.pipeline.restart(e.pipeline.calculateRetryDelay()))}finally{K(!1)}}else e.logger.log("lifecycle","Another instance is active, skipping")}class Dt extends HTMLElement{constructor(){super(),this._state=t,this._lastSyncedSatelliteState=null,this._config=Object.assign({},d),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new _,this._audio=new p(this),this._tts=new A(this),this._pipeline=new T(this),this._ui=new k(this),this._chat=new E(this),this._doubleTap=new O(this),this._visibility=new lt(this),this._timer=new bt(this),this._announcement=new yt(this),this._askQuestion=new Vt(this),this._startConversation=new Tt(this),this._mediaPlayer=new St(this)}get logger(){return this._logger}get audio(){return this._audio}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get doubleTap(){return this._doubleTap}get visibility(){return this._visibility}get config(){return this._config}get timer(){return this._timer}get announcement(){return this._announcement}get askQuestion(){return this._askQuestion}get startConversation(){return this._startConversation}get mediaPlayer(){return this._mediaPlayer}get currentState(){return this._state}set currentState(t){this._state=t}get lastSyncedSatelliteState(){return this._lastSyncedSatelliteState}set lastSyncedSatelliteState(t){this._lastSyncedSatelliteState=t}get isOwner(){return G(this)}get connection(){return!this._connection&&this._hass?.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render(),requestAnimationFrame(()=>{Ut(this)&&this.shadowRoot?Rt(this.shadowRoot,this._config):this._config.satellite_entity&&(this._ui.ensureGlobalUI(),this._visibility.setup(),!j()&&this._hass?.connection&&$t(this))})}disconnectedCallback(){this._disconnectTimeout=setTimeout(()=>{},100)}setConfig(t){const e=!!this._config.satellite_entity;this._config=Object.assign({},d,t),this._logger.debug=this._config.debug,this._ui.element&&this._ui.applyStyles(),this.shadowRoot&&Ut(this)&&Rt(this.shadowRoot,this._config),H.instance&&H.instance!==this&&H.instance.setConfig(this.config),e||!this._config.satellite_entity||this._hasStarted||!this._hass?.connection||Ut(this)||(this._connection=this._hass.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,$t(this)):(this._hasStarted=!0,this._ui.showStartButton()))}set hass(t){this._hass=t,Ut(this)||(j()&&G(this)&&(this._timer.update(),st(this,t=>F(this,t))),this._hasStarted||t?.connection&&this._config.satellite_entity&&(Y()||j()&&!G(this)||(this._connection=t.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,$t(this)):(this._hasStarted=!0,this._ui.showStartButton()))))}getCardSize(){return 0}static getConfigForm(){return{schema:[...xt,...kt,...Ct,...Et,...Mt],computeLabel:t=>It[t.name]||void 0,computeHelper:t=>Bt[t.name]||void 0}}static getStubConfig(){return{start_listening_on_load:!0}}setState(t){Ft(this,t)}onStartClick(){!async function(t){await t.audio.ensureAudioContextForGesture(),await $t(t)}(this)}onPipelineMessage(e){!function(e,i){if(e.visibility.isPaused)return void e.logger.log("event",`Ignoring event while paused: ${i.type}`);if(e.pipeline.isRestarting)return void e.logger.log("event",`Ignoring event while restarting: ${i.type}`);const o=i.type,a=i.data||{};if(e.config.debug){const t=i.timestamp?i.timestamp.split("T")[1].split(".")[0]:"";e.logger.log("event",`${t} ${o} ${JSON.stringify(a).substring(0,500)}`)}switch(o){case"run-start":e.pipeline.handleRunStart(a);break;case"wake_word-start":e.pipeline.handleWakeWordStart();break;case"wake_word-end":e.pipeline.handleWakeWordEnd(a);break;case"stt-start":Ft(e,n);break;case"stt-vad-start":e.logger.log("event","VAD: speech started");break;case"stt-vad-end":e.logger.log("event","VAD: speech ended");break;case"stt-end":e.pipeline.handleSttEnd(a);break;case"intent-start":Ft(e,r);break;case"intent-progress":e.pipeline.handleIntentProgress(a);break;case"intent-end":e.pipeline.handleIntentEnd(a);break;case"tts-start":Ft(e,s);break;case"tts-end":e.pipeline.handleTtsEnd(a);break;case"run-end":e.pipeline.handleRunEnd();break;case"error":e.pipeline.handleError(a);break;case"displaced":e.logger.error("pipeline","Pipeline displaced — another browser is using this satellite entity"),e.pipeline.stop(),e.audio.stopMicrophone(),e.tts.stop(),e.timer.destroy(),at(),Z&&tt?.connection&&(tt.connection.removeEventListener("ready",Z),Z=null),tt=null,et=null,e.chat.clear(),e.ui.hideBlurOverlay(l),e.ui.hideBlurOverlay(u),H.instance=null,H.active=!1,H.starting=!1,e.currentState=t,e.ui.showStartButton()}}(this,e)}onTTSComplete(t){!function(t,e){if([i,n,r].includes(t.currentState))return void t.logger.log("tts","New interaction in progress — skipping cleanup");if(!e&&t.pipeline.shouldContinue&&t.pipeline.continueConversationId){t.logger.log("pipeline","Continuing conversation — skipping wake word");const e=t.pipeline.continueConversationId;return t.pipeline.clearContinueState(),t.chat.streamEl=null,void t.pipeline.restartContinue(e)}const s=t.config.tts_target&&"browser"!==t.config.tts_target;!1===V(t.hass,t.config.satellite_entity,"wake_sound")||s||t.tts.playChime("done"),t.chat.clear(),t.ui.hideBlurOverlay(l),t.ui.updateForState(t.currentState,t.pipeline.serviceUnavailable,!1),Pt(t,"IDLE"),t.announcement.playQueued(),t.askQuestion.playQueued(),t.startConversation.playQueued()}(this,t)}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),Ut(this)?Rt(this.shadowRoot,this._config):this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}}customElements.define("voice-satellite-card",Dt),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v4.2.2 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();