(()=>{"use strict";const e="IDLE",t="WAKE_WORD_DETECTED",i="STT",n="INTENT",r="TTS",s={start_listening_on_load:!0,wake_word_switch:"",state_entity:"",satellite_entity:"",pipeline_id:"",pipeline_timeout:60,pipeline_idle_timeout:300,chime_on_wake_word:!0,chime_on_request_sent:!0,chime_volume:100,tts_volume:100,tts_target:"",continue_conversation:!0,double_tap_cancel:!0,debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,timer_position:"bottom-right",timer_font_size:20,timer_font_family:"inherit",timer_font_color:"#444444",timer_font_bold:!0,timer_font_italic:!1,timer_background:"#ffffff",timer_border_color:"rgba(100, 200, 150, 0.5)",timer_padding:16,timer_rounded:!0,timer_finished_duration:60,announcement_display_duration:5,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,show_transcription:!0,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,streaming_response:!0,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0};function o(e){var t=e.split(",").map(function(e){return e.trim()});return t.length>1&&t[0]!==t[t.length-1]&&t.push(t[0]),"linear-gradient(90deg, "+t.join(", ")+")"}class a{constructor(){this._debug=!1}set debug(e){this._debug=!!e}log(e,t,i){this._debug&&(void 0!==i?console.log("[VS]["+e+"] "+t,i):console.log("[VS]["+e+"] "+t))}error(e,t,i){void 0!==i?console.error("[VS]["+e+"] "+t,i):console.error("[VS]["+e+"] "+t)}}class l{constructor(e){this._card=e,this._log=e.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get audioContext(){return this._audioContext}get isStreaming(){return!!this._sendInterval}async startMicrophone(){await this._ensureAudioContextRunning();var e=this._card.config;this._log.log("mic","AudioContext state="+this._audioContext.state+" sampleRate="+this._audioContext.sampleRate);var t={sampleRate:16e3,channelCount:1,echoCancellation:e.echo_cancellation,noiseSuppression:e.noise_suppression,autoGainControl:e.auto_gain_control};if(e.voice_isolation&&(t.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:t}),e.debug){var i=this._mediaStream.getAudioTracks();if(this._log.log("mic","Got media stream with "+i.length+" audio track(s)"),i.length>0){var n=i[0].getSettings();this._log.log("mic","Track settings: "+JSON.stringify(n))}}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic","Actual sample rate: "+this._actualSampleRate);try{await this._setupAudioWorklet(this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}catch(e){this._log.log("mic","AudioWorklet unavailable ("+e.message+"), using ScriptProcessor"),this._setupScriptProcessor(this._sourceNode),this._log.log("mic","Audio capture via ScriptProcessor")}}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(function(e){e.stop()}),this._mediaStream=null),this._audioBuffer=[]}startSending(e){var t=this;this.stopSending(),this._sendInterval=setInterval(function(){t._sendAudioBuffer(e())},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(e){e.enabled=!1})}resume(){this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(e){e.enabled=!0})}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(e){this._log.error("mic","Failed to resume AudioContext on click: "+e)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error("AudioContext failed to start: "+this._audioContext.state)}async _setupAudioWorklet(e){var t=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),i=URL.createObjectURL(t);await this._audioContext.audioWorklet.addModule(i),URL.revokeObjectURL(i),this._workletNode=new AudioWorkletNode(this._audioContext,"voice-satellite-processor");var n=this;this._workletNode.port.onmessage=function(e){n._audioBuffer.push(new Float32Array(e.data))},e.connect(this._workletNode),this._workletNode.connect(this._audioContext.destination)}_setupScriptProcessor(e){this._scriptProcessor=this._audioContext.createScriptProcessor(2048,1,1);var t=this;this._scriptProcessor.onaudioprocess=function(e){var i=e.inputBuffer.getChannelData(0);t._audioBuffer.push(new Float32Array(i))},e.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)}_sendAudioBuffer(e){if(null!=e&&0!==this._audioBuffer.length){for(var t=0,i=0;i<this._audioBuffer.length;i++)t+=this._audioBuffer[i].length;var n=new Float32Array(t),r=0;for(i=0;i<this._audioBuffer.length;i++)n.set(this._audioBuffer[i],r),r+=this._audioBuffer[i].length;this._audioBuffer=[],16e3!==this._actualSampleRate&&(n=this._resample(n,this._actualSampleRate,16e3));var s=this._floatTo16BitPCM(n);this._sendBinaryAudio(s,e)}}_resample(e,t,i){if(t===i)return e;for(var n=t/i,r=Math.round(e.length/n),s=new Float32Array(r),o=0;o<r;o++){var a=o*n,l=Math.floor(a),c=Math.min(l+1,e.length-1),_=a-l;s[o]=e[l]*(1-_)+e[c]*_}return s}_floatTo16BitPCM(e){for(var t=new Int16Array(e.length),i=0;i<e.length;i++){var n=Math.max(-1,Math.min(1,e[i]));t[i]=n<0?32768*n:32767*n}return t}_sendBinaryAudio(e,t){var i=this._card.connection;if(i&&i.socket&&i.socket.readyState===WebSocket.OPEN){var n=new Uint8Array(1+e.byteLength);n[0]=t,n.set(new Uint8Array(e.buffer),1),i.socket.send(n.buffer)}}}class c{constructor(e){this._card=e,this._log=e.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null,this._playbackWatchdog=null}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(e){this._streamingUrl=e}play(e){var t=this,i=this._card.config,n=this._buildUrl(e);if(this._playing=!0,i.tts_target&&"browser"!==i.tts_target)this._playRemote(n);else{var r=new Audio;r.volume=i.tts_volume/100,this._playbackWatchdog=setTimeout(function(){t._playbackWatchdog=null,t._playing&&t._currentAudio===r&&(t._log.log("tts","Playback watchdog fired — forcing completion"),t._onComplete())},3e4),r.onended=function(){t._log.log("tts","Playback complete"),t._clearWatchdog(),t._onComplete()},r.onerror=function(e){t._log.error("tts","Playback error: "+e),t._log.error("tts","URL: "+n),t._clearWatchdog(),t._onComplete()},r.src=n,r.play().then(function(){t._log.log("tts","Playback started successfully")}).catch(function(e){t._log.error("tts","play() failed: "+e),t._clearWatchdog(),t._onComplete(!0)}),this._currentAudio=r}}stop(){this._playing=!1,this._clearWatchdog(),this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null);var e=this._card.config;if(e.tts_target&&"browser"!==e.tts_target&&this._card.hass){var t=this;this._card.hass.callService("media_player","media_stop",{entity_id:e.tts_target}).catch(function(e){t._log.error("tts","Remote stop failed: "+e)})}}resetStreamingUrl(){this._streamingUrl=null}storeStreamingUrl(e){if(this._streamingUrl=null,e.tts_output&&e.tts_output.url&&e.tts_output.stream_response){var t=e.tts_output.url;this._streamingUrl=t.startsWith("http")?t:window.location.origin+t,this._log.log("tts","Streaming TTS URL available: "+this._streamingUrl)}}playChime(e){try{var t=new(window.AudioContext||window.webkitAudioContext),i=t.createOscillator(),n=t.createGain();i.connect(n),n.connect(t.destination);var r=this._card.config.chime_volume/100*.5;"wake"===e?(i.type="sine",n.gain.setValueAtTime(r,t.currentTime),n.gain.exponentialRampToValueAtTime(.001,t.currentTime+.25),i.frequency.setValueAtTime(523,t.currentTime),i.frequency.setValueAtTime(659,t.currentTime+.08),i.frequency.setValueAtTime(784,t.currentTime+.16),i.start(),i.stop(t.currentTime+.25)):"error"===e?(i.type="square",n.gain.setValueAtTime(.3*r,t.currentTime),n.gain.exponentialRampToValueAtTime(.001,t.currentTime+.15),i.frequency.setValueAtTime(300,t.currentTime),i.frequency.setValueAtTime(200,t.currentTime+.08),i.start(),i.stop(t.currentTime+.15)):(i.type="sine",n.gain.setValueAtTime(r,t.currentTime),n.gain.exponentialRampToValueAtTime(.001,t.currentTime+.2),i.frequency.setValueAtTime(784,t.currentTime),i.frequency.setValueAtTime(659,t.currentTime+.08),i.start(),i.stop(t.currentTime+.25)),setTimeout(function(){t.close()},500)}catch(e){this._log.error("tts","Chime error: "+e)}}_clearWatchdog(){this._playbackWatchdog&&(clearTimeout(this._playbackWatchdog),this._playbackWatchdog=null)}_playRemote(e){var t=this,i=this._card.config.tts_target;this._log.log("tts","Playing on remote: "+i+" URL: "+e),this._card.hass.callService("media_player","play_media",{entity_id:i,media_content_id:e,media_content_type:"music"}).catch(function(e){t._log.error("tts","Remote play failed: "+e)}),this._endTimer=setTimeout(function(){t._endTimer=null,t._onComplete()},2e3)}_onComplete(e){this._log.log("tts","Complete — cleaning up UI"+(e?" (playback failed)":"")),this._currentAudio=null,this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.onTTSComplete(e)}_buildUrl(e){if(e.startsWith("http://")||e.startsWith("https://"))return e;var t=window.location.origin;return e.startsWith("/")||(e="/"+e),t+e}}class _{constructor(e){this._card=e,this._log=e.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._idleTimeoutId=null,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1}get binaryHandlerId(){return this._binaryHandlerId}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}get shouldContinue(){return this._shouldContinue}get continueConversationId(){return this._continueConversationId}get isStreaming(){return this._isStreaming}async _resolveDeviceId(){var e=this._card.config;if(!e.satellite_entity)return null;var t=this._card.connection;if(!t)return null;try{var i=await t.sendMessagePromise({type:"config/entity_registry/get",entity_id:e.satellite_entity});if(i&&i.device_id)return this._log.log("pipeline","Resolved device_id: "+i.device_id+" from "+e.satellite_entity),i.device_id}catch(t){this._log.error("pipeline","Failed to resolve device_id from "+e.satellite_entity+": "+t)}return null}async start(e){var t=this,i=e||{},n=this._card.connection;if(!n)throw new Error("No Home Assistant connection available");var r=await n.sendMessagePromise({type:"assist_pipeline/pipeline/list"});this._log.log("pipeline","Available: "+r.pipelines.map(function(e){return e.name+" ("+e.id+")"+(e.preferred?" [preferred]":"")}).join(", "));var s=this._card.config,o=s.pipeline_id;if(!o){var a=r.pipelines.find(function(e){return e.preferred});o=a?a.id:r.pipelines[0].id}this._log.log("pipeline","Starting pipeline: "+o);var l=i.start_stage||"wake_word",c={type:"assist_pipeline/run",start_stage:l,end_stage:"tts",input:{sample_rate:16e3,timeout:"wake_word"===l?0:void 0},pipeline:o,timeout:s.pipeline_timeout};i.conversation_id&&(c.conversation_id=i.conversation_id);var _=await this._resolveDeviceId();_&&(c.device_id=_),void 0===c.input.timeout&&delete c.input.timeout,this._log.log("pipeline","Run config: "+JSON.stringify(c)),this._unsubscribe=await n.subscribeMessage(function(e){t._card.onPipelineMessage(e)},c),this._log.log("pipeline","Subscribed, waiting for run-start..."),this._card.audio.startSending(function(){return t._binaryHandlerId}),this._isStreaming=!0,this._startIdleTimeout()}async stop(){if(this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._unsubscribe){try{await this._unsubscribe()}catch(e){}this._unsubscribe=null}this._clearIdleTimeout()}restart(e){var t=this;this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._clearIdleTimeout(),this.stop().then(function(){t._restartTimeout=setTimeout(function(){t._restartTimeout=null,t._isRestarting=!1,t.start().catch(function(e){t._log.error("pipeline","Restart failed: "+e),t._serviceUnavailable||(t._card.ui.showErrorBar(),t._serviceUnavailable=!0),t.restart(t._calculateRetryDelay())})},e||0)}))}restartContinue(e){var t=this;this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this._clearIdleTimeout(),this.stop().then(function(){t._isRestarting=!1,t._continueMode=!0,t.start({start_stage:"stt",conversation_id:e}).catch(function(e){t._log.error("pipeline","Continue conversation failed: "+e),t._card.chat.clear(),t._card.ui.hideBlurOverlay("pipeline"),t.restart(0)})}))}handleRunStart(e){if(this._binaryHandlerId=e.runner_data.stt_binary_handler_id,this._resetIdleTimeout(),this._card.tts.storeStreamingUrl(e),this._continueMode)return this._continueMode=!1,this._card.setState(i),this._log.log("pipeline","Running (continue conversation) — binary handler ID: "+this._binaryHandlerId),void this._log.log("pipeline","Listening for speech...");this._card.setState("LISTENING"),this._log.log("pipeline","Running — binary handler ID: "+this._binaryHandlerId),this._log.log("pipeline","Listening for wake word...")}handleWakeWordStart(){if(this._serviceUnavailable){var e=this;this._recoveryTimeout&&clearTimeout(this._recoveryTimeout),this._recoveryTimeout=setTimeout(function(){e._serviceUnavailable&&(e._log.log("recovery","Wake word service recovered"),e._serviceUnavailable=!1,e._retryCount=0,e._card.ui.clearErrorBar(),e._card.ui.hideBar())},2e3)}}handleWakeWordEnd(e){var i=e.wake_word_output;if(!i||0===Object.keys(i).length)return this._log.error("error","Wake word service unavailable (empty wake_word_output)"),this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._binaryHandlerId=null,this._card.ui.showErrorBar(),this._serviceUnavailable=!0,void this.restart(this._calculateRetryDelay());this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._serviceUnavailable=!1,this._retryCount=0,this._card.ui.clearErrorBar();var n=this._card.tts;n.isPlaying&&(n.stop(),this._pendingRunEnd=!1),this._intentErrorBarTimeout&&(clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=null),this._card.chat.clear(),this._shouldContinue=!1,this._continueConversationId=null,this._card.setState(t),this._resetIdleTimeout(),this._card.config.chime_on_wake_word&&n.playChime("wake"),this._card.turnOffWakeWordSwitch(),this._card.ui.showBlurOverlay("pipeline")}handleSttEnd(e){var t=e.stt_output?e.stt_output.text:"";t&&this._card.chat.showTranscription(t)}handleIntentProgress(e){var t=this._card.tts;if(e.tts_start_streaming&&t.streamingUrl&&!t.isPlaying&&(this._log.log("tts","Streaming TTS started — playing early"),this._card.setState(r),t.play(t.streamingUrl),t.streamingUrl=null),e.chat_log_delta){var i=e.chat_log_delta.content;if("string"==typeof i){var n=this._card.chat;n.streamedResponse=(n.streamedResponse||"")+i,n.updateResponse(n.streamedResponse)}}}handleIntentEnd(e){var t=null;try{t=e.intent_output.response.response_type}catch(e){}if("error"===t){var i=this._extractResponseText(e)||"An error occurred";this._log.error("error","Intent error: "+i),this._card.ui.showErrorBar(),this._card.config.chime_on_wake_word&&this._card.tts.playChime("error"),this._suppressTTS=!0;var n=this;return this._intentErrorBarTimeout&&clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=setTimeout(function(){n._intentErrorBarTimeout=null,n._card.ui.clearErrorBar(),n._card.ui.hideBar()},3e3),void(this._card.chat.streamedResponse="")}var r=this._extractResponseText(e);if(r&&this._card.chat.showResponse(r),this._shouldContinue=!1,this._continueConversationId=null,this._card.config.continue_conversation)try{!0===e.intent_output.continue_conversation&&(this._shouldContinue=!0,this._continueConversationId=e.intent_output.conversation_id||null,this._log.log("pipeline","Continue conversation requested — id: "+this._continueConversationId))}catch(e){}this._card.chat.streamedResponse="",this._card.chat.streamEl=null}handleTtsEnd(e){if(this._suppressTTS)return this._suppressTTS=!1,this._log.log("tts","TTS suppressed (intent error)"),void this.restart(0);var t=this._card.tts;if(t.isPlaying)return this._log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void this.restart(0);var i=e.tts_output?e.tts_output.url||e.tts_output.url_path:null;i&&t.play(i),this.restart(0)}handleRunEnd(){if(this._log.log("pipeline","Run ended"),this._binaryHandlerId=null,!this._isRestarting)return this._serviceUnavailable?(this._log.log("ui","Error recovery handling restart"),void this._card.ui.hideBlurOverlay("pipeline")):this._card.tts.isPlaying?(this._log.log("ui","TTS playing — deferring cleanup"),void(this._pendingRunEnd=!0)):void this._finishRunEnd();this._log.log("pipeline","Restart already in progress — skipping run-end restart")}handleError(s){var o=s.code||"",a=s.message||"";if(this._log.log("error",o+" — "+a),-1===["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"].indexOf(o)){this._log.error("error","Unexpected: "+o+" — "+a);var l=-1!==[t,i,n,r].indexOf(this._card.currentState);this._binaryHandlerId=null,l&&this._card.config.chime_on_wake_word&&this._card.tts.playChime("error"),this._card.ui.showErrorBar(),this._serviceUnavailable=!0,this._card.chat.clear(),this._card.ui.hideBlurOverlay("pipeline"),this.restart(this._calculateRetryDelay())}else{if(this._log.log("pipeline","Expected error: "+o+" — restarting"),-1!==[t,i,n,r].indexOf(this._card.currentState)){this._log.log("ui","Cleaning up interaction UI after expected error"),this._card.setState(e),this._card.chat.clear(),this._card.ui.hideBlurOverlay("pipeline"),this._shouldContinue=!1,this._continueConversationId=null;var c=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;this._card.config.chime_on_request_sent&&!c&&this._card.tts.playChime("done")}this.restart(0)}}finishPendingRunEnd(){this._pendingRunEnd&&this._finishRunEnd()}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}_finishRunEnd(){this._pendingRunEnd=!1,this._card.chat.clear(),this._card.ui.hideBlurOverlay("pipeline"),this._card.setState(e),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}_calculateRetryDelay(){this._retryCount++;var e=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline","Retry in "+e+"ms (attempt #"+this._retryCount+")"),e}_startIdleTimeout(){var e=this;this._clearIdleTimeout(),this._card.config.pipeline_idle_timeout<=0||(this._idleTimeoutId=setTimeout(function(){return-1!==[t,i,n,r].indexOf(e._card.currentState)?(e._log.log("pipeline","Idle timeout fired but interaction in progress — deferring"),void e._resetIdleTimeout()):e._card.tts.isPlaying?(e._log.log("pipeline","Idle timeout fired but TTS playing — deferring"),void e._resetIdleTimeout()):(e._log.log("pipeline","Idle timeout — restarting"),void e.restart(0))},1e3*this._card.config.pipeline_idle_timeout))}_clearIdleTimeout(){this._idleTimeoutId&&(clearTimeout(this._idleTimeoutId),this._idleTimeoutId=null)}_resetIdleTimeout(){this._startIdleTimeout()}_extractResponseText(e){try{var t=e.intent_output.response.speech.plain.speech;if(t)return t}catch(e){}try{if(e.intent_output.response.speech.speech)return e.intent_output.response.speech.speech}catch(e){}try{if(e.intent_output.response.plain)return e.intent_output.response.plain}catch(e){}try{if("string"==typeof e.intent_output.response)return e.intent_output.response}catch(e){}return this._log.log("error","Could not extract response text"),null}}class d{constructor(e){this._card=e,this._log=e.logger,this._globalUI=null,this._pendingStartButtonReason=void 0}get element(){return this._globalUI}ensureGlobalUI(){if(document.getElementById("voice-satellite-ui"))return this._globalUI=document.getElementById("voice-satellite-ui"),void this._flushPendingStartButton();var e=document.createElement("div");e.id="voice-satellite-ui",e.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(e),this._globalUI=e,this._injectGlobalStyles(),this.applyStyles();var t=this;e.querySelector(".vs-start-btn").addEventListener("click",function(){t._card.onStartClick()});var i=e.querySelector(".vs-start-btn");i.classList.add("visible"),i.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){if(this._globalUI){var e=this._card.config,t=this._globalUI.querySelector(".vs-rainbow-bar");t.style.height=e.bar_height+"px",t.style["top"===e.bar_position?"top":"bottom"]="0",t.style["top"===e.bar_position?"bottom":"top"]="auto",t.style.background=o(e.bar_gradient),t.style.backgroundSize="200% 100%";var i=this._globalUI.querySelector(".vs-blur-overlay");e.background_blur?(i.style.backdropFilter="blur("+e.background_blur_intensity+"px)",i.style.webkitBackdropFilter="blur("+e.background_blur_intensity+"px)"):(i.style.backdropFilter="none",i.style.webkitBackdropFilter="none");var n=e.bar_height||6,r=this._globalUI.querySelector(".vs-chat-container");"bottom"===e.bar_position?(r.style.bottom=n+12+"px",r.style.top="auto"):(r.style.bottom="12px",r.style.top="auto")}}updateForState(e,t,i){if(this._globalUI){var n={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[e];if(n&&(!t||n.barVisible)&&(!i||n.barVisible)){var r=this._globalUI.querySelector(".vs-rainbow-bar");n.barVisible?(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.add("visible"),r.classList.remove("connecting","listening","processing","speaking"),n.animation&&r.classList.add(n.animation)):(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.remove("visible","connecting","listening","processing","speaking"))}}}showStartButton(e){if(this._globalUI){var t=this._globalUI.querySelector(".vs-start-btn");t.classList.add("visible"),t.title="not-allowed"===e?"Tap to enable microphone":"not-found"===e?"No microphone found":"not-readable"===e?"Microphone unavailable - tap to retry":"Tap to start voice assistant"}else this._pendingStartButtonReason=e}hideStartButton(){this._globalUI&&this._globalUI.querySelector(".vs-start-btn").classList.remove("visible")}showBlurOverlay(e){this._globalUI&&this._card.config.background_blur&&(this._blurReasons||(this._blurReasons={}),this._blurReasons[e||"default"]=!0,this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible"))}hideBlurOverlay(e){this._globalUI&&(this._blurReasons||(this._blurReasons={}),delete this._blurReasons[e||"default"],0===Object.keys(this._blurReasons).length&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible"))}showErrorBar(){if(this._globalUI){var e=this._globalUI.querySelector(".vs-rainbow-bar");e.classList.remove("connecting","listening","processing","speaking"),e.classList.add("visible","error-mode"),e.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222)",e.style.backgroundSize="200% 100%"}}clearErrorBar(){if(this._globalUI){var e=this._globalUI.querySelector(".vs-rainbow-bar");e.classList.remove("error-mode"),e.style.background=o(this._card.config.bar_gradient),e.style.backgroundSize="200% 100%"}}hideBar(){this._globalUI&&this._globalUI.querySelector(".vs-rainbow-bar").classList.remove("visible")}_injectGlobalStyles(){if(!document.getElementById("voice-satellite-styles")){var e=document.createElement("style");e.id="voice-satellite-styles",e.textContent="/* Voice Satellite Card — Styles */\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(5px);\r\n  -webkit-backdrop-filter: blur(5px);\r\n  background: rgba(0, 0, 0, 0.3);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  max-width: 80%;\r\n  width: 80%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  padding: 12px;\r\n  opacity: 0;\r\n  text-align: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}\r\n\r\n/* Timer Pills */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: vs-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);\r\n  z-index: 10002;\r\n  animation: vs-timer-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes vs-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.05);\r\n  }\r\n}",document.head.appendChild(e)}}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}class u{constructor(e){this._card=e,this._log=e.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(e){this._streamEl=e}get streamedResponse(){return this._streamedResponse}set streamedResponse(e){this._streamedResponse=e}showTranscription(e){this._card.config.show_transcription&&this.addUser(e)}hideTranscription(){}showResponse(e){this._card.config.show_response&&(this._streamEl?this._streamEl.textContent=e:this.addAssistant(e))}updateResponse(e){this._card.config.show_response&&(this._streamEl?this._updateAssistant(e):this.addAssistant(e))}hideResponse(){}addUser(e){var t=this._card.ui.element;if(t){var i=this._card.config,n=t.querySelector(".vs-chat-container");n.classList.add("visible");var r=document.createElement("div");r.className="vs-chat-msg user",r.textContent=e,r.style.fontSize=i.transcription_font_size+"px",r.style.fontFamily=i.transcription_font_family,r.style.color=i.transcription_font_color,r.style.fontWeight=i.transcription_font_bold?"bold":"normal",r.style.fontStyle=i.transcription_font_italic?"italic":"normal",r.style.background=i.transcription_background,r.style.border="3px solid "+i.transcription_border_color,r.style.padding=i.transcription_padding+"px",r.style.borderRadius=i.transcription_rounded?"12px":"0",n.appendChild(r)}}addAssistant(e){var t=this._card.ui.element;if(t){var i=this._card.config,n=t.querySelector(".vs-chat-container");n.classList.add("visible");var r=document.createElement("div");r.className="vs-chat-msg assistant",r.textContent=e,r.style.fontSize=i.response_font_size+"px",r.style.fontFamily=i.response_font_family,r.style.color=i.response_font_color,r.style.fontWeight=i.response_font_bold?"bold":"normal",r.style.fontStyle=i.response_font_italic?"italic":"normal",r.style.background=i.response_background,r.style.border="3px solid "+i.response_border_color,r.style.padding=i.response_padding+"px",r.style.borderRadius=i.response_rounded?"12px":"0",n.appendChild(r),this._streamEl=r}}clear(){var e=this._card.ui.element;if(e){for(var t=e.querySelector(".vs-chat-container");t.firstChild;)t.removeChild(t.firstChild);t.classList.remove("visible"),this._streamEl=null,this._streamedResponse=""}}_updateAssistant(e){if(this._streamEl)if(e.length<=24)this._streamEl.textContent=e;else{for(var t=e.slice(0,e.length-24),i=e.slice(e.length-24),n=this._escapeHtml(t),r=0;r<i.length;r++)n+='<span style="opacity:'+((24-r)/24).toFixed(2)+'">'+this._escapeHtml(i[r])+"</span>";this._streamEl.innerHTML=n}}_escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}class h{constructor(e){this._card=e,this._log=e.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){var s=this;this._handler=function(o){if(s._card.config.double_tap_cancel){var a=-1!==[t,i,n,r].indexOf(s._card.currentState)||s._card.tts.isPlaying,l=s._card.timer.isAlertActive;if((a||l)&&("click"!==o.type||!s._lastTapWasTouch)){s._lastTapWasTouch="touchstart"===o.type;var c=Date.now(),_=c-s._lastTapTime;if(s._lastTapTime=c,_<400&&_>0){if(o.preventDefault(),s._card.timer.isAlertActive)return s._log.log("ui","Double-tap detected — dismissing timer alert"),void s._card.timer.dismissAlert();s._log.log("ui","Double-tap detected — cancelling interaction"),s._card.tts.isPlaying&&s._card.tts.stop(),s._card.pipeline.clearContinueState(),s._card.setState(e),s._card.chat.clear(),s._card.ui.hideBlurOverlay("pipeline"),s._card.updateInteractionState("IDLE");var d=s._card.config.tts_target&&"browser"!==s._card.config.tts_target;s._card.config.chime_on_request_sent&&!d&&s._card.tts.playChime("done"),s._card.pipeline.restart(0)}}}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}class p{constructor(e){this._card=e,this._log=e.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){var e=this;this._handler=function(){e._handleChange()},document.addEventListener("visibilitychange",this._handler)}_handleChange(){var e=this;this._debounceTimer&&clearTimeout(this._debounceTimer),document.hidden?(this._isPaused=!0,-1!==[t,i,n,r].indexOf(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.chat.clear(),this._card.ui.hideBlurOverlay("pipeline"),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(function(){e._log.log("visibility","Tab hidden — pausing mic"),e._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume())}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}_resume(){if(this._isPaused){this._isPaused=!1,this._card.audio.resume();var e=this._card.audio,t=this._card.pipeline;!e.isStreaming&&t.isStreaming&&e.startSending(function(){return t.binaryHandlerId}),t.resetForResume(),this._log.log("visibility","Resuming — restarting pipeline"),t.restart(0)}}}class m{constructor(e){this._card=e,this._log=e.logger,this._timers=[],this._tickInterval=null,this._lastRawJson="",this._container=null,this._unsubscribe=null,this._subscribed=!1,this._knownTimerIds=[],this._alertActive=!1,this._alertEl=null}update(){if(!this._subscribed){var e=this._card.config;if(e.satellite_entity){var t=this._card.connection;t&&this._subscribe(t,e.satellite_entity)}}}get isAlertActive(){return this._alertActive}dismissAlert(){this._clearAlert()}destroy(){this._stopTick(),this._removeContainer(),this._clearAlert(),this._timers=[],this._knownTimerIds=[],this._lastRawJson="",this._unsubscribe&&(this._unsubscribe(),this._unsubscribe=null),this._subscribed=!1}_subscribe(e,t){this._subscribed=!0;var i=this;e.subscribeEvents(function(e){var n=e.data;if(n&&n.new_state&&n.entity_id===t){var r=n.new_state.attributes||{};i._processStateChange(r)}},"state_changed").then(function(e){i._unsubscribe=e,i._log.log("timer","Subscribed to state changes for "+t)}).catch(function(e){i._log.error("timer","Failed to subscribe: "+e),i._subscribed=!1});var n=this._card.hass;if(n&&n.states&&n.states[t]){var r=n.states[t].attributes||{};this._processStateChange(r)}}_processStateChange(e){var t=e.active_timers,i=e.last_timer_event;t&&Array.isArray(t)||(t=[]);var n=JSON.stringify(t);if(n!==this._lastRawJson){this._log.log("timer","State changed: timers="+n+" last_event="+i);for(var r=[],s=0;s<t.length;s++)r.push(t[s].id);var o=[];for(s=0;s<this._knownTimerIds.length;s++)-1===r.indexOf(this._knownTimerIds[s])&&o.push(this._knownTimerIds[s]);for(o.length>0&&"finished"===i&&(this._log.log("timer","Timer(s) finished: "+o.join(", ")),this._alertActive||this._showAlert()),s=0;s<o.length;s++)this._removePill(o[s]);this._lastRawJson=n,this._knownTimerIds=r,this._syncTimers(t)}}_syncTimers(e){if(0===e.length)return this._timers=[],this._stopTick(),void this._removeContainer();for(var t=Date.now(),i=[],n=0;n<e.length;n++){for(var r=e[n],s=null,o=0;o<this._timers.length;o++)if(this._timers[o].id===r.id){s=this._timers[o];break}var a=r.started_at?1e3*r.started_at:t;if(s){if(s.totalSeconds!==r.total_seconds){s.totalSeconds=r.total_seconds,s.startedAt=a;var l=Math.floor((t-a)/1e3);s.secondsLeft=Math.max(0,r.total_seconds-l),s.startHours=r.start_hours||0,s.startMinutes=r.start_minutes||0,s.startSeconds=r.start_seconds||0}i.push(s)}else l=Math.floor((t-a)/1e3),i.push({id:r.id,name:r.name||"",totalSeconds:r.total_seconds,secondsLeft:Math.max(0,r.total_seconds-l),startedAt:a,startHours:r.start_hours||0,startMinutes:r.start_minutes||0,startSeconds:r.start_seconds||0,el:null})}this._timers=i,this._startTick(),this._syncDOM()}_startTick(){if(!this._tickInterval){var e=this;this._tickInterval=setInterval(function(){e._tick()},1e3)}}_stopTick(){this._tickInterval&&(clearInterval(this._tickInterval),this._tickInterval=null)}_tick(){for(var e=Date.now(),t=0;t<this._timers.length;t++){var i=this._timers[t],n=Math.floor((e-i.startedAt)/1e3),r=i.totalSeconds-n;if(r<0&&(r=0),i.secondsLeft=r,i.el){var s=i.el.querySelector(".vs-timer-time");s&&(s.textContent=this._formatTime(r));var o=i.el.querySelector(".vs-timer-progress");if(o){var a=i.totalSeconds>0?Math.max(0,r/i.totalSeconds*100):0;o.style.width=a+"%"}}}}_showAlert(){if(this._alertActive)this._log.log("timer","Alert already active, skipping duplicate");else{this._alertActive=!0;var e=this,t=this._card.config;this._log.log("timer","Showing finished alert"),this._card.ui.showBlurOverlay("timer"),this._alertEl=document.createElement("div"),this._alertEl.className="vs-timer-alert",this._applyPillStyle(this._alertEl),this._alertEl.innerHTML='<span class="vs-timer-icon">⏱</span><span class="vs-timer-time">00:00:00</span>',document.body.appendChild(this._alertEl);var i=0;this._alertEl.addEventListener("touchstart",r,{passive:!1}),this._alertEl.addEventListener("click",r),this._playAlertChime(),window.__vsTimerChimeInterval&&clearInterval(window.__vsTimerChimeInterval),window.__vsTimerChimeInterval=setInterval(function(){e._playAlertChime()},3e3);var n=t.timer_finished_duration;n>0&&(window.__vsTimerDismissTimeout&&clearTimeout(window.__vsTimerDismissTimeout),window.__vsTimerDismissTimeout=setTimeout(function(){e._clearAlert()},1e3*n))}function r(t){var n=Date.now();n-i<400&&n-i>0&&(t.preventDefault(),t.stopPropagation(),e._clearAlert()),i=n}}_clearAlert(){if(this._alertActive){this._alertActive=!1,window.__vsTimerChimeInterval&&(clearInterval(window.__vsTimerChimeInterval),window.__vsTimerChimeInterval=null),window.__vsTimerDismissTimeout&&(clearTimeout(window.__vsTimerDismissTimeout),window.__vsTimerDismissTimeout=null);for(var e=document.querySelectorAll(".vs-timer-alert"),t=0;t<e.length;t++)e[t].parentNode&&e[t].parentNode.removeChild(e[t]);this._alertEl=null,this._stopTick(),this._removeContainer(),this._timers=[],this._card.ui.hideBlurOverlay("timer"),this._log.log("timer","Alert dismissed")}}_playAlertChime(){try{var e,t=this._card.audio?this._card.audio.audioContext:null,i=!1;t&&"closed"!==t.state?"suspended"===(e=t).state&&e.resume():(e=new(window.AudioContext||window.webkitAudioContext),i=!0);for(var n=this._card.config.chime_volume/100*.5,r=[{freq:880,start:0,end:.15},{freq:660,start:.18,end:.33},{freq:880,start:.36,end:.55}],s=0;s<r.length;s++){var o=e.createOscillator(),a=e.createGain();o.connect(a),a.connect(e.destination),o.type="sine",o.frequency.setValueAtTime(r[s].freq,e.currentTime+r[s].start),a.gain.setValueAtTime(0,e.currentTime+r[s].start),a.gain.linearRampToValueAtTime(n,e.currentTime+r[s].start+.02),a.gain.exponentialRampToValueAtTime(.001,e.currentTime+r[s].end),o.start(e.currentTime+r[s].start),o.stop(e.currentTime+r[s].end)}i&&setTimeout(function(){e.close()},1e3),this._log.log("timer","Alert chime played (ctx.state="+e.state+")")}catch(e){this._log.error("timer","Alert chime error: "+e)}}cancelTimer(e){this._log.log("timer","Cancelling timer: "+e);for(var t=null,i=0;i<this._timers.length;i++)if(this._timers[i].id===e){t=this._timers[i];break}this._card.connection;var n=this._card.hass,r=this._card.config;if(n&&r.satellite_entity){var s=this,o="cancel the timer";t&&t.name&&(o="cancel the "+t.name),n.callService("conversation","process",{text:o,agent_id:"conversation.home_assistant"}).then(function(e){s._log.log("timer","Cancel service called successfully")}).catch(function(e){s._log.error("timer","Cancel service failed: "+(e.message||JSON.stringify(e)))})}for(this._removePill(e),i=this._timers.length-1;i>=0;i--)if(this._timers[i].id===e){this._timers.splice(i,1);break}for(i=this._knownTimerIds.length-1;i>=0;i--)if(this._knownTimerIds[i]===e){this._knownTimerIds.splice(i,1);break}this._lastRawJson="",0===this._timers.length&&(this._stopTick(),s=this,setTimeout(function(){0===s._timers.length&&s._removeContainer()},500))}_ensureContainer(){if(!this._container||!document.body.contains(this._container)){var e=document.createElement("div");e.id="voice-satellite-timers",e.className="vs-timer-container",document.body.appendChild(e),this._container=e,this._applyPosition()}}_applyPosition(){if(this._container){var e=this._card.config,t=e.bar_height||16,i=e.timer_position||"bottom-right";if(this._container.style.top="auto",this._container.style.bottom="auto",this._container.style.left="auto",this._container.style.right="auto",0===i.indexOf("top")){var n="top"===e.bar_position?t+12:12;this._container.style.top=n+"px"}else{var r="bottom"===e.bar_position?t+12:12;this._container.style.bottom=r+"px"}-1!==i.indexOf("left")?this._container.style.left="12px":this._container.style.right="12px"}}_removeContainer(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=null}_removePill(e){if(this._container){for(var t=this._container.querySelectorAll(".vs-timer-pill"),i=0;i<t.length;i++)if(t[i].getAttribute("data-timer-id")===e){t[i].classList.add("vs-timer-expired"),function(e){setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},400)}(t[i]);break}for(var n=0;n<this._timers.length;n++)if(this._timers[n].id===e){this._timers[n].el=null;break}}}_syncDOM(){this._ensureContainer();for(var e=this._container.querySelectorAll(".vs-timer-pill"),t=0;t<e.length;t++){for(var i=e[t].getAttribute("data-timer-id"),n=!1,r=0;r<this._timers.length;r++)if(this._timers[r].id===i){n=!0;break}n||e[t].parentNode.removeChild(e[t])}for(t=0;t<this._timers.length;t++){var s=this._timers[t];s.el&&this._container.contains(s.el)||(s.el=this._createPill(s),this._container.appendChild(s.el))}}_applyPillStyle(e){var t=this._card.config;e.style.fontSize=t.timer_font_size+"px",e.style.fontFamily=t.timer_font_family,e.style.color=t.timer_font_color,e.style.fontWeight=t.timer_font_bold?"bold":"normal",e.style.fontStyle=t.timer_font_italic?"italic":"normal",e.style.background=t.timer_background,e.style.border="3px solid "+t.timer_border_color,e.style.padding=t.timer_padding+"px",e.style.borderRadius=t.timer_rounded?"12px":"0"}_createPill(e){var t=e.totalSeconds>0?Math.max(0,e.secondsLeft/e.totalSeconds*100):0,i=document.createElement("div");i.className="vs-timer-pill",i.setAttribute("data-timer-id",e.id),this._applyPillStyle(i);var n=this._card.config.timer_border_color||"rgba(100, 200, 150, 0.5)";i.innerHTML='<div class="vs-timer-progress" style="width:'+t+"%;background:"+n+';opacity:0.3"></div><div class="vs-timer-content"><span class="vs-timer-icon">⏱</span><span class="vs-timer-time">'+this._formatTime(e.secondsLeft)+"</span></div>";var r=this,s=0;function o(t){var i=Date.now();i-s<400&&i-s>0&&(t.preventDefault(),t.stopPropagation(),r.cancelTimer(e.id)),s=i}return i.addEventListener("touchstart",o,{passive:!1}),i.addEventListener("click",o),i}_formatTime(e){e<0&&(e=0);var t=Math.floor(e/3600),i=Math.floor(e%3600/60),n=e%60;return(t<10?"0":"")+t+":"+(i<10?"0":"")+i+":"+(n<10?"0":"")+n}}class g{constructor(e){this._card=e,this._log=e.logger,this._lastAnnounceId=0,this._playing=!1,this._currentAudio=null,this._clearTimeout=null,this._barWasVisible=!1}update(){var e=this._card.hass,t=this._card.config;if(e&&t.satellite_entity){var i=e.states[t.satellite_entity];if(i&&i.attributes&&i.attributes.announcement){var n=i.attributes.announcement;!n.id||n.id<=this._lastAnnounceId||(this._playing?this._log.log("announce","Announcement #"+n.id+" ignored — already playing"):(this._lastAnnounceId=n.id,this._log.log("announce","New announcement #"+n.id+': message="'+(n.message||"")+'" media="'+(n.media_id||"")+'"'),this._playAnnouncement(n)))}}}_playAnnouncement(e){var t=this;if(this._playing=!0,this._card.ui.showBlurOverlay("announcement"),this._card.ui._globalUI){var i=this._card.ui._globalUI.querySelector(".vs-rainbow-bar");i&&(this._barWasVisible=i.classList.contains("visible"),i.classList.add("visible","speaking"))}e.preannounce_media_id&&""!==e.preannounce_media_id?(this._log.log("announce","Playing pre-announcement media: "+e.preannounce_media_id),this._playMedia(e.preannounce_media_id,function(){t._playMainAnnouncement(e)})):this._playAnnouncementChime(function(){t._playMainAnnouncement(e)})}_playMainAnnouncement(e){var t=this,i=e.media_id||"";e.message&&this._showAnnouncementBubble(e.message),i?(this._log.log("announce","Playing announcement media: "+i),this._playMedia(i,function(){t._onAnnouncementComplete(e)})):(this._log.log("announce","No media — completing after message display"),setTimeout(function(){t._onAnnouncementComplete(e)},3e3))}_onAnnouncementComplete(e){this._playing=!1,this._currentAudio=null,this._log.log("announce","Announcement #"+e.id+" playback complete"),this._sendAck(e.id);var t=this,i=1e3*(this._card.config.announcement_display_duration||5);this._clearTimeout=setTimeout(function(){t._clearAnnouncement()},i)}_clearAnnouncement(){this._clearTimeout&&(clearTimeout(this._clearTimeout),this._clearTimeout=null);var e=this._card.ui.element;if(e){for(var t=e.querySelector(".vs-chat-container"),i=t?t.querySelectorAll(".vs-chat-msg.announcement"):[],n=0;n<i.length;n++)i[n].remove();t&&!t.firstChild&&t.classList.remove("visible")}if(this._card.ui.hideBlurOverlay("announcement"),this._card.ui._globalUI){var r=this._card.ui._globalUI.querySelector(".vs-rainbow-bar");r&&(r.classList.remove("speaking"),this._barWasVisible||r.classList.remove("visible"))}}_showAnnouncementBubble(e){var t=this._card.ui.element;if(t){var i=this._card.config,n=t.querySelector(".vs-chat-container");n.classList.add("visible");var r=document.createElement("div");r.className="vs-chat-msg announcement",r.textContent=e,r.style.fontSize=i.response_font_size+"px",r.style.fontFamily=i.response_font_family,r.style.color=i.response_font_color,r.style.fontWeight=i.response_font_bold?"bold":"normal",r.style.fontStyle=i.response_font_italic?"italic":"normal",r.style.background=i.response_background,r.style.border="3px solid "+i.response_border_color,r.style.padding=i.response_padding+"px",r.style.borderRadius=i.response_rounded?"12px":"0",n.appendChild(r)}}_playAnnouncementChime(e){try{var t,i=this._card.audio?this._card.audio.audioContext:null,n=!1;i&&"closed"!==i.state?"suspended"===(t=i).state&&t.resume():(t=new(window.AudioContext||window.webkitAudioContext),n=!0);for(var r=this._card.config.chime_volume/100*.5,s=[{freq:784,start:0,end:.15},{freq:587,start:.18,end:.4}],o=0;o<s.length;o++){var a=t.createOscillator(),l=t.createGain();a.connect(l),l.connect(t.destination),a.type="sine",a.frequency.setValueAtTime(s[o].freq,t.currentTime+s[o].start),l.gain.setValueAtTime(0,t.currentTime+s[o].start),l.gain.linearRampToValueAtTime(r,t.currentTime+s[o].start+.02),l.gain.exponentialRampToValueAtTime(.001,t.currentTime+s[o].end),a.start(t.currentTime+s[o].start),a.stop(t.currentTime+s[o].end)}setTimeout(function(){n&&t.close(),e&&e()},500),this._log.log("announce","Announcement chime played")}catch(t){this._log.error("announce","Chime error: "+t),e&&e()}}_playMedia(e,t){var i=this,n=this._card.config,r=e;r.startsWith("http://")||r.startsWith("https://")||(r.startsWith("/")||(r="/"+r),r=window.location.origin+r);var s=new Audio;s.volume=n.tts_volume/100,s.onended=function(){i._log.log("announce","Media playback complete"),i._currentAudio=null,t&&t()},s.onerror=function(e){i._log.error("announce","Media playback error: "+e),i._currentAudio=null,t&&t()},s.src=r,s.play().then(function(){i._log.log("announce","Media playback started")}).catch(function(e){i._log.error("announce","Media play() failed: "+e),t&&t()}),this._currentAudio=s}_sendAck(e){var t=this._card.connection,i=this._card.config;if(t&&i.satellite_entity){var n=this;t.sendMessagePromise({type:"voice_satellite/announce_finished",entity_id:i.satellite_entity,announce_id:e}).then(function(){n._log.log("announce","ACK sent for announcement #"+e)}).catch(function(e){n._log.error("announce","ACK failed: "+(e.message||JSON.stringify(e)))})}else this._log.error("announce","Cannot ACK — no connection or entity")}}function f(e){for(var t=e,i=0;t&&i<30;){var n=t.tagName?t.tagName.toLowerCase():"";if("hui-card-preview"===n||"hui-card-edit-mode"===n||"hui-dialog-edit-card"===n||"dialog-edit-card"===n)return!0;if(t.parentElement)t=t.parentElement;else{if(!t.getRootNode||t.getRootNode()===t)break;t=t.getRootNode().host}i++}return!1}function v(e,t){var i=t,n=o(i.bar_gradient),r="top"===i.bar_position?"top: 0;":"bottom: 0;",s=i.background_blur?"backdrop-filter: blur("+i.background_blur_intensity+"px); -webkit-backdrop-filter: blur("+i.background_blur_intensity+"px); background: rgba(0,0,0,0.3);":"",a="";i.show_transcription&&(a='<div class="preview-bubble transcription" style="font-size:'+i.transcription_font_size+"px;font-family:"+i.transcription_font_family+";color:"+i.transcription_font_color+";font-weight:"+(i.transcription_font_bold?"bold":"normal")+";font-style:"+(i.transcription_font_italic?"italic":"normal")+";background:"+i.transcription_background+";border: 2px solid "+i.transcription_border_color+";padding:"+i.transcription_padding+"px;"+(i.transcription_rounded?"border-radius: 12px;":"")+"\">What's the weather like?</div>");var l="";i.show_response&&(l='<div class="preview-bubble response" style="font-size:'+i.response_font_size+"px;font-family:"+i.response_font_family+";color:"+i.response_font_color+";font-weight:"+(i.response_font_bold?"bold":"normal")+";font-style:"+(i.response_font_italic?"italic":"normal")+";background:"+i.response_background+";border: 2px solid "+i.response_border_color+";padding:"+i.response_padding+"px;"+(i.response_rounded?"border-radius: 12px;":"")+"\">It's 72°F and sunny.</div>"),e.innerHTML="<style>:host { display: block; }.preview-container {  position: relative;  width: 100%;  height: 180px;  overflow: hidden;  border-radius: var(--ha-card-border-radius, 12px);  background: var(--card-background-color, #1c1c1c);}.preview-bg {  position: absolute;  top: 0; left: 0; right: 0; bottom: 0;  background-image:    radial-gradient(circle at 20% 40%, var(--primary-color, #03a9f4) 0%, transparent 50%),    radial-gradient(circle at 75% 30%, var(--accent-color, #ff9800) 0%, transparent 40%),    radial-gradient(circle at 50% 80%, var(--info-color, #4fc3f7) 0%, transparent 45%);  opacity: 0.5;}.preview-blur {  position: absolute;  top: 0; left: 0; right: 0; bottom: 0;  "+s+"}.preview-bar {  position: absolute;  left: 0; right: 0;  "+r+"  height: "+i.bar_height+"px;  background: "+n+';  background-size: 200% 100%;  animation: preview-flow 3s linear infinite;}.preview-bubbles {  position: absolute;  left: 50%; top: 50%;  transform: translate(-50%, -50%);  display: flex;  flex-direction: column;  align-items: center;  gap: 8px;  width: 85%;}.preview-bubble {  max-width: 90%;  text-align: center;  box-shadow: 0 4px 12px rgba(0,0,0,0.15);}@keyframes preview-flow {  0% { background-position: 0% 50%; }  100% { background-position: 200% 50%; }}</style><div class="preview-container"><div class="preview-bg"></div><div class="preview-blur"></div><div class="preview-bubbles">'+a+l+'</div><div class="preview-bar"></div></div>'}class b extends HTMLElement{constructor(){super(),this._state=e,this._config=Object.assign({},s),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new a,this._audio=new l(this),this._tts=new c(this),this._pipeline=new _(this),this._ui=new d(this),this._chat=new u(this),this._doubleTap=new h(this),this._visibility=new p(this),this._timer=new m(this),this._announcement=new g(this)}get logger(){return this._logger}get audio(){return this._audio}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get config(){return this._config}get timer(){return this._timer}get announcement(){return this._announcement}get currentState(){return this._state}get connection(){return!this._connection&&this._hass&&this._hass.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render();var e=this;requestAnimationFrame(function(){f(e)&&e.shadowRoot?v(e.shadowRoot,e._config):(e._ui.ensureGlobalUI(),e._visibility.setup(),!window._voiceSatelliteActive&&e._hass&&e._hass.connection&&e._startListening())})}disconnectedCallback(){this._disconnectTimeout=setTimeout(function(){window._voiceSatelliteInstance},100)}setConfig(e){this._config=Object.assign({},s,e),this._logger.debug=this._config.debug,this._ui.element&&this._ui.applyStyles(),this.shadowRoot&&f(this)&&v(this.shadowRoot,this._config),window._voiceSatelliteInstance&&window._voiceSatelliteInstance!==this&&(window._voiceSatelliteInstance._config=this._config,window._voiceSatelliteInstance._logger.debug=this._config.debug,window._voiceSatelliteInstance._ui.element&&window._voiceSatelliteInstance._ui.applyStyles())}set hass(e){this._hass=e,window._voiceSatelliteInstance&&window._voiceSatelliteInstance!==this||(this._timer.update(),this._announcement.update()),this._hasStarted||e&&e.connection&&(window._voiceSatelliteStarting||window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this||(this._connection=e.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,this._startListening()):(this._hasStarted=!0,this._ui.showStartButton())))}getCardSize(){return 0}static getConfigForm(){return{schema:[{name:"pipeline_id",selector:{assist_pipeline:{}}},{name:"start_listening_on_load",selector:{boolean:{}}},{name:"wake_word_switch",selector:{entity:{filter:[{domain:"switch"},{domain:"input_boolean"}]}}},{name:"state_entity",selector:{entity:{filter:{domain:"input_text"}}}},{name:"satellite_entity",selector:{entity:{filter:{domain:"assist_satellite"}}}},{name:"continue_conversation",selector:{boolean:{}}},{name:"double_tap_cancel",selector:{boolean:{}}},{name:"debug",selector:{boolean:{}}},{type:"expandable",name:"",title:"Volume & Chimes",flatten:!0,schema:[{name:"tts_target",selector:{entity:{filter:{domain:"media_player"}}}},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}},{name:"tts_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_on_wake_word",selector:{boolean:{}}},{name:"chime_on_request_sent",selector:{boolean:{}}}]}]},{type:"expandable",name:"",title:"Microphone Processing",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"noise_suppression",selector:{boolean:{}}},{name:"echo_cancellation",selector:{boolean:{}}},{name:"auto_gain_control",selector:{boolean:{}}},{name:"voice_isolation",selector:{boolean:{}}}]}]},{type:"expandable",name:"",title:"Timeouts",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"pipeline_timeout",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}},{name:"pipeline_idle_timeout",selector:{number:{min:0,max:3600,step:1,unit_of_measurement:"s",mode:"box"}}}]}]},{type:"expandable",name:"",title:"Timer Pill",flatten:!0,schema:[{name:"timer_position",selector:{select:{options:[{value:"top-left",label:"Top Left"},{value:"top-right",label:"Top Right"},{value:"bottom-left",label:"Bottom Left"},{value:"bottom-right",label:"Bottom Right"}],mode:"dropdown"}}},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_color",selector:{text:{}}},{name:"timer_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_bold",selector:{boolean:{}}},{name:"timer_font_italic",selector:{boolean:{}}},{name:"timer_rounded",selector:{boolean:{}}}]},{name:"timer_border_color",selector:{text:{}}},{name:"timer_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_finished_duration",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}}]},{type:"expandable",name:"",title:"Announcements",flatten:!0,schema:[{name:"announcement_display_duration",selector:{number:{min:1,max:60,step:1,unit_of_measurement:"s",mode:"slider"}}}]},{type:"expandable",name:"",title:"Activity Bar",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"bar_position",selector:{select:{options:[{value:"bottom",label:"Bottom"},{value:"top",label:"Top"}],mode:"dropdown"}}},{name:"bar_height",selector:{number:{min:2,max:40,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{name:"bar_gradient",selector:{text:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"background_blur",selector:{boolean:{}}},{name:"background_blur_intensity",selector:{number:{min:0,max:20,step:1,mode:"slider"}}}]}]},{type:"expandable",name:"",title:"Transcription Bubble",flatten:!0,schema:[{name:"show_transcription",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"transcription_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_color",selector:{text:{}}},{name:"transcription_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_bold",selector:{boolean:{}}},{name:"transcription_font_italic",selector:{boolean:{}}},{name:"transcription_rounded",selector:{boolean:{}}}]},{name:"transcription_border_color",selector:{text:{}}},{name:"transcription_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{type:"expandable",name:"",title:"Response Bubble",flatten:!0,schema:[{name:"show_response",selector:{boolean:{}}},{name:"streaming_response",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"response_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_color",selector:{text:{}}},{name:"response_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_bold",selector:{boolean:{}}},{name:"response_font_italic",selector:{boolean:{}}},{name:"response_rounded",selector:{boolean:{}}}]},{name:"response_border_color",selector:{text:{}}},{name:"response_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]}],computeLabel:function(e){return{pipeline_id:"Assist Pipeline",start_listening_on_load:"Start listening on load",wake_word_switch:"Wake word switch entity",state_entity:"State tracking entity",satellite_entity:"Satellite entity",timer_font_size:"Font size",timer_position:"Timer position",timer_font_family:"Font family",timer_font_color:"Font color",timer_background:"Background color",timer_font_bold:"Bold",timer_font_italic:"Italic",timer_rounded:"Rounded corners",timer_border_color:"Border color",timer_padding:"Padding",timer_finished_duration:"Auto-dismiss timer",announcement_display_duration:"Announcement display duration",continue_conversation:"Continue conversation mode",double_tap_cancel:"Double-tap to cancel interaction",debug:"Debug logging",tts_target:"TTS output device",chime_volume:"Chime volume",tts_volume:"TTS volume",chime_on_wake_word:"Chime on wake word",chime_on_request_sent:"Chime on request sent",noise_suppression:"Noise suppression",echo_cancellation:"Echo cancellation",auto_gain_control:"Auto gain control",voice_isolation:"Voice isolation (Chrome only)",pipeline_timeout:"Pipeline timeout",pipeline_idle_timeout:"Idle restart timeout",bar_position:"Bar position",bar_height:"Bar height",bar_gradient:"Gradient colors",background_blur:"Background blur",background_blur_intensity:"Blur intensity",show_transcription:"Show transcription",transcription_font_size:"Font size",transcription_font_family:"Font family",transcription_font_color:"Font color",transcription_background:"Background color",transcription_font_bold:"Bold",transcription_font_italic:"Italic",transcription_rounded:"Rounded corners",transcription_border_color:"Border color",transcription_padding:"Padding",show_response:"Show response",streaming_response:"Streaming response",response_font_size:"Font size",response_font_family:"Font family",response_font_color:"Font color",response_background:"Background color",response_font_bold:"Bold",response_font_italic:"Italic",response_rounded:"Rounded corners",response_border_color:"Border color",response_padding:"Padding"}[e.name]||void 0},computeHelper:function(e){return{wake_word_switch:"Turn OFF this switch when wake word is detected (e.g., Fully Kiosk screensaver)",state_entity:"Updates with ACTIVE/IDLE for per-device automations",satellite_entity:"Voice Satellite Card Integration entity for timer support",timer_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",timer_border_color:"CSS color value (supports rgba)",timer_finished_duration:"Seconds to show finished timer alert (0 = until dismissed)",announcement_display_duration:"Seconds to show announcement bubble after playback",tts_target:"Leave empty for browser audio, or select a media player entity",pipeline_timeout:"Max seconds to wait for pipeline response (0 = no timeout)",pipeline_idle_timeout:"Seconds before pipeline restarts to keep connection fresh",bar_gradient:"Comma-separated CSS color values",voice_isolation:"AI-based voice isolation, currently only available in Chrome",transcription_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",transcription_border_color:"CSS color value (supports rgba)",response_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",response_border_color:"CSS color value (supports rgba)"}[e.name]||void 0}}}static getStubConfig(){return{start_listening_on_load:!0}}setState(e){var i=this._state;this._state=e,this._logger.log("state",i+" → "+e),this._ui.updateForState(e,this._pipeline.serviceUnavailable,this._tts.isPlaying),e===t&&this.updateInteractionState("ACTIVE")}updateInteractionState(e){var t=this._config.state_entity;if(t&&this._hass){var i=this;this._logger.log("state_entity",t+" → "+e),this._hass.callService("input_text","set_value",{entity_id:t,value:e}).catch(function(e){i._logger.error("state_entity","Failed to update "+t+": "+e)})}}onStartClick(){this._handleStartClick()}onPipelineMessage(e){this._handlePipelineMessage(e)}onTTSComplete(e){if(-1===[t,i,n].indexOf(this._state)){if(!e&&this._pipeline.shouldContinue&&this._pipeline.continueConversationId){this._logger.log("pipeline","Continuing conversation — skipping wake word");var r=this._pipeline.continueConversationId;return this._pipeline.clearContinueState(),this._chat.streamEl=null,void this._pipeline.restartContinue(r)}var s=this._config.tts_target&&"browser"!==this._config.tts_target;this._config.chime_on_request_sent&&!s&&this._tts.playChime("done"),this._chat.clear(),this._ui.hideBlurOverlay("pipeline"),this._ui.updateForState(this._state,this._pipeline.serviceUnavailable,!1),this.updateInteractionState("IDLE")}else this._logger.log("tts","New interaction in progress — skipping cleanup")}turnOffWakeWordSwitch(){if(this._config.wake_word_switch&&this._hass){var e=this,t=this._config.wake_word_switch;t.includes(".")?(this._logger.log("switch","Turning off: "+t),this._hass.callService("homeassistant","turn_off",{entity_id:t}).catch(function(t){e._logger.error("switch","Failed to turn off: "+t)})):this._logger.log("switch","Invalid entity: "+t)}}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),f(this)?v(this.shadowRoot,this._config):this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}async _startListening(){if(window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this)this._logger.log("lifecycle","Another instance is active, skipping");else if(window._voiceSatelliteStarting)this._logger.log("lifecycle","Pipeline already starting globally, skipping");else{window._voiceSatelliteStarting=!0;try{this.setState("CONNECTING"),await this._audio.startMicrophone(),await this._pipeline.start(),window._voiceSatelliteActive=!0,window._voiceSatelliteInstance=this,this._ui.hideStartButton(),this._doubleTap.setup()}catch(i){this._logger.error("pipeline","Failed to start: "+i);var t="error";"NotAllowedError"===i.name?(t="not-allowed",this._logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===i.name?(t="not-found",this._logger.error("mic","No microphone found")):"NotReadableError"!==i.name&&"AbortError"!==i.name||(t="not-readable",this._logger.error("mic","Microphone in use or not readable")),this._ui.showStartButton(t),this.setState(e)}finally{window._voiceSatelliteStarting=!1}}}async _handleStartClick(){await this._audio.ensureAudioContextForGesture(),await this._startListening()}_handlePipelineMessage(e){if(this._visibility.isPaused)this._logger.log("event","Ignoring event while paused: "+e.type);else if(this._pipeline.isRestarting)this._logger.log("event","Ignoring event while restarting: "+e.type);else{var t=e.type,s=e.data||{};if(this._config.debug){var o=e.timestamp?e.timestamp.split("T")[1].split(".")[0]:"";this._logger.log("event",o+" "+t+" "+JSON.stringify(s).substring(0,500))}switch(t){case"run-start":this._pipeline.handleRunStart(s);break;case"wake_word-start":this._pipeline.handleWakeWordStart();break;case"wake_word-end":this._pipeline.handleWakeWordEnd(s);break;case"stt-start":this.setState(i);break;case"stt-vad-start":this._logger.log("event","VAD: speech started");break;case"stt-vad-end":this._logger.log("event","VAD: speech ended");break;case"stt-end":this._pipeline.handleSttEnd(s);break;case"intent-start":this.setState(n);break;case"intent-progress":this._config.streaming_response&&this._pipeline.handleIntentProgress(s);break;case"intent-end":this._pipeline.handleIntentEnd(s);break;case"tts-start":this.setState(r);break;case"tts-end":this._pipeline.handleTtsEnd(s);break;case"run-end":this._pipeline.handleRunEnd();break;case"error":this._pipeline.handleError(s)}}}}customElements.define("voice-satellite-card",b),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v2.9.3 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();