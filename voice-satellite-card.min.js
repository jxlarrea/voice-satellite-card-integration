(()=>{"use strict";const t="IDLE",e="WAKE_WORD_DETECTED",i="STT",s="INTENT",r="TTS",n={start_listening_on_load:!0,wake_word_switch:"",state_entity:"",pipeline_id:"",pipeline_timeout:60,pipeline_idle_timeout:300,chime_on_wake_word:!0,chime_on_request_sent:!0,chime_volume:100,tts_volume:100,tts_target:"",continue_conversation:!0,double_tap_cancel:!0,debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,show_transcription:!0,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,streaming_response:!0,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0};class o{constructor(){this._debug=!1}set debug(t){this._debug=!!t}log(t,e,i){this._debug&&(void 0!==i?console.log("[VS]["+t+"] "+e,i):console.log("[VS]["+t+"] "+e))}error(t,e,i){void 0!==i?console.error("[VS]["+t+"] "+e,i):console.error("[VS]["+t+"] "+e)}}class a{constructor(t){this._card=t,this._log=t.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get audioContext(){return this._audioContext}get isStreaming(){return!!this._sendInterval}async startMicrophone(){await this._ensureAudioContextRunning();var t=this._card.config;this._log.log("mic","AudioContext state="+this._audioContext.state+" sampleRate="+this._audioContext.sampleRate);var e={sampleRate:16e3,channelCount:1,echoCancellation:t.echo_cancellation,noiseSuppression:t.noise_suppression,autoGainControl:t.auto_gain_control};if(t.voice_isolation&&(e.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:e}),t.debug){var i=this._mediaStream.getAudioTracks();if(this._log.log("mic","Got media stream with "+i.length+" audio track(s)"),i.length>0){var s=i[0].getSettings();this._log.log("mic","Track settings: "+JSON.stringify(s))}}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic","Actual sample rate: "+this._actualSampleRate);try{await this._setupAudioWorklet(this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}catch(t){this._log.log("mic","AudioWorklet unavailable ("+t.message+"), using ScriptProcessor"),this._setupScriptProcessor(this._sourceNode),this._log.log("mic","Audio capture via ScriptProcessor")}}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(function(t){t.stop()}),this._mediaStream=null),this._audioBuffer=[]}startSending(t){var e=this;this.stopSending(),this._sendInterval=setInterval(function(){e._sendAudioBuffer(t())},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(t){t.enabled=!1})}resume(){this._mediaStream&&this._mediaStream.getAudioTracks().forEach(function(t){t.enabled=!0})}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(t){this._log.error("mic","Failed to resume AudioContext on click: "+t)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error("AudioContext failed to start: "+this._audioContext.state)}async _setupAudioWorklet(t){var e=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),i=URL.createObjectURL(e);await this._audioContext.audioWorklet.addModule(i),URL.revokeObjectURL(i),this._workletNode=new AudioWorkletNode(this._audioContext,"voice-satellite-processor");var s=this;this._workletNode.port.onmessage=function(t){s._audioBuffer.push(new Float32Array(t.data))},t.connect(this._workletNode),this._workletNode.connect(this._audioContext.destination)}_setupScriptProcessor(t){this._scriptProcessor=this._audioContext.createScriptProcessor(2048,1,1);var e=this;this._scriptProcessor.onaudioprocess=function(t){var i=t.inputBuffer.getChannelData(0);e._audioBuffer.push(new Float32Array(i))},t.connect(this._scriptProcessor),this._scriptProcessor.connect(this._audioContext.destination)}_sendAudioBuffer(t){if(null!=t&&0!==this._audioBuffer.length){for(var e=0,i=0;i<this._audioBuffer.length;i++)e+=this._audioBuffer[i].length;var s=new Float32Array(e),r=0;for(i=0;i<this._audioBuffer.length;i++)s.set(this._audioBuffer[i],r),r+=this._audioBuffer[i].length;this._audioBuffer=[],16e3!==this._actualSampleRate&&(s=this._resample(s,this._actualSampleRate,16e3));var n=this._floatTo16BitPCM(s);this._sendBinaryAudio(n,t)}}_resample(t,e,i){if(e===i)return t;for(var s=e/i,r=Math.round(t.length/s),n=new Float32Array(r),o=0;o<r;o++){var a=o*s,l=Math.floor(a),c=Math.min(l+1,t.length-1),d=a-l;n[o]=t[l]*(1-d)+t[c]*d}return n}_floatTo16BitPCM(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++){var s=Math.max(-1,Math.min(1,t[i]));e[i]=s<0?32768*s:32767*s}return e}_sendBinaryAudio(t,e){var i=this._card.connection;if(i&&i.socket&&i.socket.readyState===WebSocket.OPEN){var s=new Uint8Array(1+t.byteLength);s[0]=e,s.set(new Uint8Array(t.buffer),1),i.socket.send(s.buffer)}}}class l{constructor(t){this._card=t,this._log=t.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(t){this._streamingUrl=t}play(t){var e=this,i=this._card.config,s=this._buildUrl(t);if(this._playing=!0,i.tts_target&&"browser"!==i.tts_target)this._playRemote(s);else{var r=new Audio;r.volume=i.tts_volume/100,r.onended=function(){e._log.log("tts","Playback complete"),e._onComplete()},r.onerror=function(t){e._log.error("tts","Playback error: "+t),e._log.error("tts","URL: "+s),e._onComplete()},r.src=s,r.play().catch(function(t){e._log.error("tts","play() failed: "+t),e._onComplete()}),this._currentAudio=r}}stop(){this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null);var t=this._card.config;if(t.tts_target&&"browser"!==t.tts_target&&this._card.hass){var e=this;this._card.hass.callService("media_player","media_stop",{entity_id:t.tts_target}).catch(function(t){e._log.error("tts","Remote stop failed: "+t)})}}resetStreamingUrl(){this._streamingUrl=null}storeStreamingUrl(t){if(this._streamingUrl=null,t.tts_output&&t.tts_output.url&&t.tts_output.stream_response){var e=t.tts_output.url;this._streamingUrl=e.startsWith("http")?e:window.location.origin+e,this._log.log("tts","Streaming TTS URL available: "+this._streamingUrl)}}playChime(t){try{var e=new(window.AudioContext||window.webkitAudioContext),i=e.createOscillator(),s=e.createGain();i.connect(s),s.connect(e.destination);var r=this._card.config.chime_volume/100*.5;"wake"===t?(i.type="sine",s.gain.setValueAtTime(r,e.currentTime),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+.25),i.frequency.setValueAtTime(523,e.currentTime),i.frequency.setValueAtTime(659,e.currentTime+.08),i.frequency.setValueAtTime(784,e.currentTime+.16),i.start(),i.stop(e.currentTime+.25)):"error"===t?(i.type="square",s.gain.setValueAtTime(.3*r,e.currentTime),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+.15),i.frequency.setValueAtTime(300,e.currentTime),i.frequency.setValueAtTime(200,e.currentTime+.08),i.start(),i.stop(e.currentTime+.15)):(i.type="sine",s.gain.setValueAtTime(r,e.currentTime),s.gain.exponentialRampToValueAtTime(.001,e.currentTime+.2),i.frequency.setValueAtTime(784,e.currentTime),i.frequency.setValueAtTime(659,e.currentTime+.08),i.start(),i.stop(e.currentTime+.25)),setTimeout(function(){e.close()},500)}catch(t){this._log.error("tts","Chime error: "+t)}}_playRemote(t){var e=this,i=this._card.config.tts_target;this._log.log("tts","Playing on remote: "+i+" URL: "+t),this._card.hass.callService("media_player","play_media",{entity_id:i,media_content_id:t,media_content_type:"music"}).catch(function(t){e._log.error("tts","Remote play failed: "+t)}),this._endTimer=setTimeout(function(){e._endTimer=null,e._onComplete()},2e3)}_onComplete(){this._log.log("tts","Complete — cleaning up UI"),this._currentAudio=null,this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.onTTSComplete()}_buildUrl(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;var e=window.location.origin;return t.startsWith("/")||(t="/"+t),e+t}}class c{constructor(t){this._card=t,this._log=t.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._idleTimeoutId=null,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1}get binaryHandlerId(){return this._binaryHandlerId}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}get shouldContinue(){return this._shouldContinue}get continueConversationId(){return this._continueConversationId}get isStreaming(){return this._isStreaming}async start(t){var e=this,i=t||{},s=this._card.connection;if(!s)throw new Error("No Home Assistant connection available");var r=await s.sendMessagePromise({type:"assist_pipeline/pipeline/list"});this._log.log("pipeline","Available: "+r.pipelines.map(function(t){return t.name+" ("+t.id+")"+(t.preferred?" [preferred]":"")}).join(", "));var n=this._card.config,o=n.pipeline_id;if(!o){var a=r.pipelines.find(function(t){return t.preferred});o=a?a.id:r.pipelines[0].id}this._log.log("pipeline","Starting pipeline: "+o);var l=i.start_stage||"wake_word",c={type:"assist_pipeline/run",start_stage:l,end_stage:"tts",input:{sample_rate:16e3,timeout:"wake_word"===l?0:void 0},pipeline:o,timeout:n.pipeline_timeout};i.conversation_id&&(c.conversation_id=i.conversation_id),void 0===c.input.timeout&&delete c.input.timeout,this._log.log("pipeline","Run config: "+JSON.stringify(c)),this._unsubscribe=await s.subscribeMessage(function(t){e._card.onPipelineMessage(t)},c),this._log.log("pipeline","Subscribed, waiting for run-start..."),this._card.audio.startSending(function(){return e._binaryHandlerId}),this._isStreaming=!0,this._startIdleTimeout()}async stop(){if(this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._unsubscribe){try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}this._clearIdleTimeout()}restart(t){var e=this;this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._clearIdleTimeout(),this.stop().then(function(){e._restartTimeout=setTimeout(function(){e._restartTimeout=null,e._isRestarting=!1,e.start().catch(function(t){e._log.error("pipeline","Restart failed: "+t),e._serviceUnavailable||(e._card.ui.showErrorBar(),e._serviceUnavailable=!0),e.restart(e._calculateRetryDelay())})},t||0)}))}restartContinue(t){var e=this;this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this._clearIdleTimeout(),this.stop().then(function(){e._isRestarting=!1,e._continueMode=!0,e.start({start_stage:"stt",conversation_id:t}).catch(function(t){e._log.error("pipeline","Continue conversation failed: "+t),e._card.chat.clear(),e._card.ui.hideBlurOverlay(),e.restart(0)})}))}handleRunStart(t){if(this._binaryHandlerId=t.runner_data.stt_binary_handler_id,this._resetIdleTimeout(),this._card.tts.storeStreamingUrl(t),this._continueMode)return this._continueMode=!1,this._card.setState(i),this._log.log("pipeline","Running (continue conversation) — binary handler ID: "+this._binaryHandlerId),void this._log.log("pipeline","Listening for speech...");this._card.setState("LISTENING"),this._log.log("pipeline","Running — binary handler ID: "+this._binaryHandlerId),this._log.log("pipeline","Listening for wake word...")}handleWakeWordStart(){if(this._serviceUnavailable){var t=this;this._recoveryTimeout&&clearTimeout(this._recoveryTimeout),this._recoveryTimeout=setTimeout(function(){t._serviceUnavailable&&(t._log.log("recovery","Wake word service recovered"),t._serviceUnavailable=!1,t._retryCount=0,t._card.ui.clearErrorBar(),t._card.ui.hideBar())},2e3)}}handleWakeWordEnd(t){var i=t.wake_word_output;if(!i||0===Object.keys(i).length)return this._log.error("error","Wake word service unavailable (empty wake_word_output)"),this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._binaryHandlerId=null,this._card.ui.showErrorBar(),this._serviceUnavailable=!0,void this.restart(this._calculateRetryDelay());this._recoveryTimeout&&(clearTimeout(this._recoveryTimeout),this._recoveryTimeout=null),this._serviceUnavailable=!1,this._retryCount=0,this._card.ui.clearErrorBar();var s=this._card.tts;s.isPlaying&&(s.stop(),this._pendingRunEnd=!1),this._intentErrorBarTimeout&&(clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=null),this._card.chat.clear(),this._shouldContinue=!1,this._continueConversationId=null,this._card.setState(e),this._resetIdleTimeout(),this._card.config.chime_on_wake_word&&s.playChime("wake"),this._card.turnOffWakeWordSwitch(),this._card.ui.showBlurOverlay()}handleSttEnd(t){var e=t.stt_output?t.stt_output.text:"";e&&this._card.chat.showTranscription(e)}handleIntentProgress(t){var e=this._card.tts;if(t.tts_start_streaming&&e.streamingUrl&&!e.isPlaying&&(this._log.log("tts","Streaming TTS started — playing early"),this._card.setState(r),e.play(e.streamingUrl),e.streamingUrl=null),t.chat_log_delta){var i=t.chat_log_delta.content;if("string"==typeof i){var s=this._card.chat;s.streamedResponse=(s.streamedResponse||"")+i,s.updateResponse(s.streamedResponse)}}}handleIntentEnd(t){var e=null;try{e=t.intent_output.response.response_type}catch(t){}if("error"===e){var i=this._extractResponseText(t)||"An error occurred";this._log.error("error","Intent error: "+i),this._card.ui.showErrorBar(),this._card.config.chime_on_wake_word&&this._card.tts.playChime("error"),this._suppressTTS=!0;var s=this;return this._intentErrorBarTimeout&&clearTimeout(this._intentErrorBarTimeout),this._intentErrorBarTimeout=setTimeout(function(){s._intentErrorBarTimeout=null,s._card.ui.clearErrorBar(),s._card.ui.hideBar()},3e3),void(this._card.chat.streamedResponse="")}var r=this._extractResponseText(t);if(r&&this._card.chat.showResponse(r),this._shouldContinue=!1,this._continueConversationId=null,this._card.config.continue_conversation)try{!0===t.intent_output.continue_conversation&&(this._shouldContinue=!0,this._continueConversationId=t.intent_output.conversation_id||null,this._log.log("pipeline","Continue conversation requested — id: "+this._continueConversationId))}catch(t){}this._card.chat.streamedResponse="",this._card.chat.streamEl=null}handleTtsEnd(t){if(this._suppressTTS)return this._suppressTTS=!1,this._log.log("tts","TTS suppressed (intent error)"),void this.restart(0);var e=this._card.tts;if(e.isPlaying)return this._log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void this.restart(0);var i=t.tts_output?t.tts_output.url||t.tts_output.url_path:null;i&&e.play(i),this.restart(0)}handleRunEnd(){if(this._log.log("pipeline","Run ended"),this._binaryHandlerId=null,!this._isRestarting)return this._serviceUnavailable?(this._log.log("ui","Error recovery handling restart"),void this._card.ui.hideBlurOverlay()):this._card.tts.isPlaying?(this._log.log("ui","TTS playing — deferring cleanup"),void(this._pendingRunEnd=!0)):void this._finishRunEnd();this._log.log("pipeline","Restart already in progress — skipping run-end restart")}handleError(n){var o=n.code||"",a=n.message||"";if(this._log.log("error",o+" — "+a),-1===["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"].indexOf(o)){this._log.error("error","Unexpected: "+o+" — "+a);var l=-1!==[e,i,s,r].indexOf(this._card.currentState);this._binaryHandlerId=null,l&&this._card.config.chime_on_wake_word&&this._card.tts.playChime("error"),this._card.ui.showErrorBar(),this._serviceUnavailable=!0,this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this.restart(this._calculateRetryDelay())}else{if(this._log.log("pipeline","Expected error: "+o+" — restarting"),-1!==[e,i,s,r].indexOf(this._card.currentState)){this._log.log("ui","Cleaning up interaction UI after expected error"),this._card.setState(t),this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this._shouldContinue=!1,this._continueConversationId=null;var c=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;this._card.config.chime_on_request_sent&&!c&&this._card.tts.playChime("done")}this.restart(0)}}finishPendingRunEnd(){this._pendingRunEnd&&this._finishRunEnd()}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}_finishRunEnd(){this._pendingRunEnd=!1,this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this._card.setState(t),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}_calculateRetryDelay(){this._retryCount++;var t=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline","Retry in "+t+"ms (attempt #"+this._retryCount+")"),t}_startIdleTimeout(){var t=this;this._clearIdleTimeout(),this._card.config.pipeline_idle_timeout<=0||(this._idleTimeoutId=setTimeout(function(){return-1!==[e,i,s,r].indexOf(t._card.currentState)?(t._log.log("pipeline","Idle timeout fired but interaction in progress — deferring"),void t._resetIdleTimeout()):t._card.tts.isPlaying?(t._log.log("pipeline","Idle timeout fired but TTS playing — deferring"),void t._resetIdleTimeout()):(t._log.log("pipeline","Idle timeout — restarting"),void t.restart(0))},1e3*this._card.config.pipeline_idle_timeout))}_clearIdleTimeout(){this._idleTimeoutId&&(clearTimeout(this._idleTimeoutId),this._idleTimeoutId=null)}_resetIdleTimeout(){this._startIdleTimeout()}_extractResponseText(t){try{var e=t.intent_output.response.speech.plain.speech;if(e)return e}catch(t){}try{if(t.intent_output.response.speech.speech)return t.intent_output.response.speech.speech}catch(t){}try{if(t.intent_output.response.plain)return t.intent_output.response.plain}catch(t){}try{if("string"==typeof t.intent_output.response)return t.intent_output.response}catch(t){}return this._log.log("error","Could not extract response text"),null}}class d{constructor(t){this._card=t,this._log=t.logger,this._globalUI=null,this._pendingStartButtonReason=void 0}get element(){return this._globalUI}ensureGlobalUI(){if(document.getElementById("voice-satellite-ui"))return this._globalUI=document.getElementById("voice-satellite-ui"),void this._flushPendingStartButton();var t=document.createElement("div");t.id="voice-satellite-ui",t.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(t),this._globalUI=t,this._injectGlobalStyles(),this.applyStyles();var e=this;t.querySelector(".vs-start-btn").addEventListener("click",function(){e._card.onStartClick()});var i=t.querySelector(".vs-start-btn");i.classList.add("visible"),i.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){if(this._globalUI){var t=this._card.config,e=this._globalUI.querySelector(".vs-rainbow-bar");e.style.height=t.bar_height+"px",e.style["top"===t.bar_position?"top":"bottom"]="0",e.style["top"===t.bar_position?"bottom":"top"]="auto",e.style.background="linear-gradient(90deg, "+t.bar_gradient+")",e.style.backgroundSize="200% 100%";var i=this._globalUI.querySelector(".vs-blur-overlay");t.background_blur?(i.style.backdropFilter="blur("+t.background_blur_intensity+"px)",i.style.webkitBackdropFilter="blur("+t.background_blur_intensity+"px)"):(i.style.backdropFilter="none",i.style.webkitBackdropFilter="none");var s=t.bar_height||6,r=this._globalUI.querySelector(".vs-chat-container");"bottom"===t.bar_position?(r.style.bottom=s+12+"px",r.style.top="auto"):(r.style.bottom="12px",r.style.top="auto")}}updateForState(t,e,i){if(this._globalUI){var s={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[t];if(s&&(!e||s.barVisible)&&(!i||s.barVisible)){var r=this._globalUI.querySelector(".vs-rainbow-bar");s.barVisible?(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.add("visible"),r.classList.remove("connecting","listening","processing","speaking"),s.animation&&r.classList.add(s.animation)):(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.remove("visible","connecting","listening","processing","speaking"))}}}showStartButton(t){if(this._globalUI){var e=this._globalUI.querySelector(".vs-start-btn");e.classList.add("visible"),e.title="not-allowed"===t?"Tap to enable microphone":"not-found"===t?"No microphone found":"not-readable"===t?"Microphone unavailable - tap to retry":"Tap to start voice assistant"}else this._pendingStartButtonReason=t}hideStartButton(){this._globalUI&&this._globalUI.querySelector(".vs-start-btn").classList.remove("visible")}showBlurOverlay(){this._globalUI&&this._card.config.background_blur&&this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible")}hideBlurOverlay(){this._globalUI&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible")}showErrorBar(){if(this._globalUI){var t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("connecting","listening","processing","speaking"),t.classList.add("visible","error-mode"),t.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222)",t.style.backgroundSize="200% 100%"}}clearErrorBar(){if(this._globalUI){var t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("error-mode"),t.style.background="linear-gradient(90deg, "+this._card.config.bar_gradient+")",t.style.backgroundSize="200% 100%"}}hideBar(){this._globalUI&&this._globalUI.querySelector(".vs-rainbow-bar").classList.remove("visible")}_injectGlobalStyles(){if(!document.getElementById("voice-satellite-styles")){var t=document.createElement("style");t.id="voice-satellite-styles",t.textContent="/* Voice Satellite Card — Styles */\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(5px);\r\n  -webkit-backdrop-filter: blur(5px);\r\n  background: rgba(0, 0, 0, 0.3);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  max-width: 80%;\r\n  width: 80%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  padding: 12px;\r\n  opacity: 0;\r\n  text-align: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}",document.head.appendChild(t)}}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}class h{constructor(t){this._card=t,this._log=t.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(t){this._streamEl=t}get streamedResponse(){return this._streamedResponse}set streamedResponse(t){this._streamedResponse=t}showTranscription(t){this._card.config.show_transcription&&this.addUser(t)}hideTranscription(){}showResponse(t){this._card.config.show_response&&(this._streamEl?this._streamEl.textContent=t:this.addAssistant(t))}updateResponse(t){this._card.config.show_response&&(this._streamEl?this._updateAssistant(t):this.addAssistant(t))}hideResponse(){}addUser(t){var e=this._card.ui.element;if(e){var i=this._card.config,s=e.querySelector(".vs-chat-container");s.classList.add("visible");var r=document.createElement("div");r.className="vs-chat-msg user",r.textContent=t,r.style.fontSize=i.transcription_font_size+"px",r.style.fontFamily=i.transcription_font_family,r.style.color=i.transcription_font_color,r.style.fontWeight=i.transcription_font_bold?"bold":"normal",r.style.fontStyle=i.transcription_font_italic?"italic":"normal",r.style.background=i.transcription_background,r.style.border="3px solid "+i.transcription_border_color,r.style.padding=i.transcription_padding+"px",r.style.borderRadius=i.transcription_rounded?"12px":"0",s.appendChild(r)}}addAssistant(t){var e=this._card.ui.element;if(e){var i=this._card.config,s=e.querySelector(".vs-chat-container");s.classList.add("visible");var r=document.createElement("div");r.className="vs-chat-msg assistant",r.textContent=t,r.style.fontSize=i.response_font_size+"px",r.style.fontFamily=i.response_font_family,r.style.color=i.response_font_color,r.style.fontWeight=i.response_font_bold?"bold":"normal",r.style.fontStyle=i.response_font_italic?"italic":"normal",r.style.background=i.response_background,r.style.border="3px solid "+i.response_border_color,r.style.padding=i.response_padding+"px",r.style.borderRadius=i.response_rounded?"12px":"0",s.appendChild(r),this._streamEl=r}}clear(){var t=this._card.ui.element;if(t){for(var e=t.querySelector(".vs-chat-container");e.firstChild;)e.removeChild(e.firstChild);e.classList.remove("visible"),this._streamEl=null,this._streamedResponse=""}}_updateAssistant(t){if(this._streamEl)if(t.length<=24)this._streamEl.textContent=t;else{for(var e=t.slice(0,t.length-24),i=t.slice(t.length-24),s=this._escapeHtml(e),r=0;r<i.length;r++)s+='<span style="opacity:'+((24-r)/24).toFixed(2)+'">'+this._escapeHtml(i[r])+"</span>";this._streamEl.innerHTML=s}}_escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}class _{constructor(t){this._card=t,this._log=t.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){var n=this;this._handler=function(o){if(n._card.config.double_tap_cancel&&(-1!==[e,i,s,r].indexOf(n._card.currentState)||n._card.tts.isPlaying)&&("click"!==o.type||!n._lastTapWasTouch)){n._lastTapWasTouch="touchstart"===o.type;var a=Date.now(),l=a-n._lastTapTime;if(n._lastTapTime=a,l<400&&l>0){n._log.log("ui","Double-tap detected — cancelling interaction"),o.preventDefault(),n._card.tts.isPlaying&&n._card.tts.stop(),n._card.pipeline.clearContinueState(),n._card.setState(t),n._card.chat.clear(),n._card.ui.hideBlurOverlay(),n._card.updateInteractionState("IDLE");var c=n._card.config.tts_target&&"browser"!==n._card.config.tts_target;n._card.config.chime_on_request_sent&&!c&&n._card.tts.playChime("done"),n._card.pipeline.restart(0)}}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}class u{constructor(t){this._card=t,this._log=t.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){var t=this;this._handler=function(){t._handleChange()},document.addEventListener("visibilitychange",this._handler)}_handleChange(){var t=this;this._debounceTimer&&clearTimeout(this._debounceTimer),document.hidden?(this._isPaused=!0,-1!==[e,i,s,r].indexOf(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.chat.clear(),this._card.ui.hideBlurOverlay(),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(function(){t._log.log("visibility","Tab hidden — pausing mic"),t._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume())}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}_resume(){if(this._isPaused){this._isPaused=!1,this._card.audio.resume();var t=this._card.audio,e=this._card.pipeline;!t.isStreaming&&e.isStreaming&&t.startSending(function(){return e.binaryHandlerId}),e.resetForResume(),this._log.log("visibility","Resuming — restarting pipeline"),e.restart(0)}}}class p extends HTMLElement{constructor(){super(),this._state=t,this._config=Object.assign({},n),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new o,this._audio=new a(this),this._tts=new l(this),this._pipeline=new c(this),this._ui=new d(this),this._chat=new h(this),this._doubleTap=new _(this),this._visibility=new u(this)}get logger(){return this._logger}get audio(){return this._audio}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get config(){return this._config}get currentState(){return this._state}get connection(){return!this._connection&&this._hass&&this._hass.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render(),this._ui.ensureGlobalUI(),this._visibility.setup(),!window._voiceSatelliteActive&&this._hass&&this._hass.connection&&this._startListening()}disconnectedCallback(){this._disconnectTimeout=setTimeout(function(){window._voiceSatelliteInstance},100)}setConfig(t){this._config=Object.assign({},n,t),this._logger.debug=this._config.debug,this._ui.element&&this._ui.applyStyles(),window._voiceSatelliteInstance&&window._voiceSatelliteInstance!==this&&(window._voiceSatelliteInstance._config=this._config,window._voiceSatelliteInstance._logger.debug=this._config.debug,window._voiceSatelliteInstance._ui.element&&window._voiceSatelliteInstance._ui.applyStyles())}set hass(t){this._hass=t,this._hasStarted||t&&t.connection&&(window._voiceSatelliteStarting||window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this||(this._connection=t.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,this._startListening()):(this._hasStarted=!0,this._ui.showStartButton())))}getCardSize(){return 0}static getConfigElement(){return document.createElement("voice-satellite-card-editor")}static getStubConfig(){return{start_listening_on_load:!0}}setState(t){var i=this._state;this._state=t,this._logger.log("state",i+" → "+t),this._ui.updateForState(t,this._pipeline.serviceUnavailable,this._tts.isPlaying),t===e&&this.updateInteractionState("ACTIVE")}updateInteractionState(t){var e=this._config.state_entity;if(e&&this._hass){var i=this;this._logger.log("state_entity",e+" → "+t),this._hass.callService("input_text","set_value",{entity_id:e,value:t}).catch(function(t){i._logger.error("state_entity","Failed to update "+e+": "+t)})}}onStartClick(){this._handleStartClick()}onPipelineMessage(t){this._handlePipelineMessage(t)}onTTSComplete(){if(-1===[e,i,s,r].indexOf(this._state)){if(this._pipeline.shouldContinue&&this._pipeline.continueConversationId){this._logger.log("pipeline","Continuing conversation — skipping wake word");var t=this._pipeline.continueConversationId;return this._pipeline.clearContinueState(),this._chat.streamEl=null,void this._pipeline.restartContinue(t)}var n=this._config.tts_target&&"browser"!==this._config.tts_target;this._config.chime_on_request_sent&&!n&&this._tts.playChime("done"),this._chat.clear(),this._ui.hideBlurOverlay(),this._ui.updateForState(this._state,this._pipeline.serviceUnavailable,!1),this.updateInteractionState("IDLE")}else this._logger.log("tts","New interaction in progress — skipping cleanup")}turnOffWakeWordSwitch(){if(this._config.wake_word_switch&&this._hass){var t=this,e=this._config.wake_word_switch;e.includes(".")?(this._logger.log("switch","Turning off: "+e),this._hass.callService("homeassistant","turn_off",{entity_id:e}).catch(function(e){t._logger.error("switch","Failed to turn off: "+e)})):this._logger.log("switch","Invalid entity: "+e)}}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}async _startListening(){if(window._voiceSatelliteActive&&window._voiceSatelliteInstance!==this)this._logger.log("lifecycle","Another instance is active, skipping");else if(window._voiceSatelliteStarting)this._logger.log("lifecycle","Pipeline already starting globally, skipping");else{window._voiceSatelliteStarting=!0;try{this.setState("CONNECTING"),await this._audio.startMicrophone(),await this._pipeline.start(),window._voiceSatelliteActive=!0,window._voiceSatelliteInstance=this,this._ui.hideStartButton(),this._doubleTap.setup()}catch(i){this._logger.error("pipeline","Failed to start: "+i);var e="error";"NotAllowedError"===i.name?(e="not-allowed",this._logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===i.name?(e="not-found",this._logger.error("mic","No microphone found")):"NotReadableError"!==i.name&&"AbortError"!==i.name||(e="not-readable",this._logger.error("mic","Microphone in use or not readable")),this._ui.showStartButton(e),this.setState(t)}finally{window._voiceSatelliteStarting=!1}}}async _handleStartClick(){await this._audio.ensureAudioContextForGesture(),await this._startListening()}_handlePipelineMessage(t){if(this._visibility.isPaused)this._logger.log("event","Ignoring event while paused: "+t.type);else if(this._pipeline.isRestarting)this._logger.log("event","Ignoring event while restarting: "+t.type);else{var e=t.type,n=t.data||{};if(this._config.debug){var o=t.timestamp?t.timestamp.split("T")[1].split(".")[0]:"";this._logger.log("event",o+" "+e+" "+JSON.stringify(n).substring(0,500))}switch(e){case"run-start":this._pipeline.handleRunStart(n);break;case"wake_word-start":this._pipeline.handleWakeWordStart();break;case"wake_word-end":this._pipeline.handleWakeWordEnd(n);break;case"stt-start":this.setState(i);break;case"stt-vad-start":this._logger.log("event","VAD: speech started");break;case"stt-vad-end":this._logger.log("event","VAD: speech ended");break;case"stt-end":this._pipeline.handleSttEnd(n);break;case"intent-start":this.setState(s);break;case"intent-progress":this._config.streaming_response&&this._pipeline.handleIntentProgress(n);break;case"intent-end":this._pipeline.handleIntentEnd(n);break;case"tts-start":this.setState(r);break;case"tts-end":this._pipeline.handleTtsEnd(n);break;case"run-end":this._pipeline.handleRunEnd();break;case"error":this._pipeline.handleError(n)}}}}class g extends HTMLElement{constructor(){super(),this._config={},this._hass=null,this._pipelines=[]}set hass(t){this._hass=t,t&&t.connection&&0===this._pipelines.length&&this._loadPipelines()}setConfig(t){this._config=Object.assign({},n,t),this._render()}async _loadPipelines(){try{var t=await this._hass.connection.sendMessagePromise({type:"assist_pipeline/pipeline/list"});this._pipelines=t.pipelines||[],this._render()}catch(t){console.error("[VS][editor] Failed to load pipelines:",t)}}_render(){for(var t=this._config,e='<option value="">Default Pipeline</option>',i=0;i<this._pipelines.length;i++){var s=this._pipelines[i],r=s.id===t.pipeline_id?" selected":"";e+='<option value="'+s.id+'"'+r+">"+(s.name||s.id)+"</option>"}var n='<option value=""'+(t.tts_target?"":" selected")+">Browser (default)</option>";if(this._hass)for(var o=this._hass.states||{},a=Object.keys(o).filter(function(t){return t.startsWith("media_player.")}).sort(),l=0;l<a.length;l++){var c=a[l],d=o[c].attributes.friendly_name||c;n+='<option value="'+c+'"'+(c===t.tts_target?" selected":"")+">"+d+"</option>"}var h=this._entityOptions(t.wake_word_switch,["switch.","input_boolean."]),_=this._entityOptions(t.state_entity,["input_text."]);this.innerHTML='<style>.vs-editor { padding: 16px; }.vs-section { margin-bottom: 16px; padding: 12px; background: var(--card-background-color, #fff); border-radius: 8px; border: 1px solid var(--divider-color, #e0e0e0); }.vs-section-title { font-weight: bold; font-size: 14px; margin-bottom: 12px; color: var(--primary-color, #03a9f4); }.vs-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; min-height: 36px; }.vs-row label { flex: 1; font-size: 14px; }.vs-row input[type="checkbox"] { width: 20px; height: 20px; }.vs-row input[type="number"], .vs-row input[type="text"], .vs-row input[type="color"], .vs-row select { width: 160px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--divider-color, #ccc); background: var(--card-background-color, #fff); color: var(--primary-text-color, #333); }.vs-row input[type="range"] { width: 120px; }.vs-row .range-val { width: 32px; text-align: right; font-size: 13px; }</style><div class="vs-editor"><div class="vs-section"><div class="vs-section-title">Behavior</div>'+this._selectRow("Pipeline","pipeline_id",e)+this._checkboxRow("Start listening on load","start_listening_on_load")+this._selectRow("Wake word switch entity","wake_word_switch",h)+this._selectRow("State tracking entity","state_entity",_)+this._checkboxRow("Continue conversation mode","continue_conversation")+this._checkboxRow("Double-tap screen to cancel interaction","double_tap_cancel")+this._checkboxRow("Debug logging","debug")+'</div><div class="vs-section"><div class="vs-section-title">Microphone Processing</div>'+this._checkboxRow("Noise suppression","noise_suppression")+this._checkboxRow("Echo cancellation","echo_cancellation")+this._checkboxRow("Auto gain control","auto_gain_control")+this._checkboxRow("Voice isolation (Chrome only)","voice_isolation")+'</div><div class="vs-section"><div class="vs-section-title">Timeouts</div>'+this._numberRow("Server-side pipeline timeout (s)","pipeline_timeout",0,300)+this._numberRow("Client-side idle restart (s)","pipeline_idle_timeout",0,3600)+'</div><div class="vs-section"><div class="vs-section-title">Volume & Chimes</div>'+this._selectRow("TTS output device (Experimental)","tts_target",n)+this._sliderRow("Chime volume","chime_volume",0,100)+this._sliderRow("TTS volume","tts_volume",0,100)+this._checkboxRow("Chime on wake word","chime_on_wake_word")+this._checkboxRow("Chime on request sent","chime_on_request_sent")+'</div><div class="vs-section"><div class="vs-section-title">Rainbow Bar</div>'+this._selectRowRaw("Position","bar_position",'<option value="bottom"'+("bottom"===t.bar_position?" selected":"")+'>Bottom</option><option value="top"'+("top"===t.bar_position?" selected":"")+">Top</option>")+this._sliderRow("Height (px)","bar_height",2,40)+this._textRow("Gradient colors","bar_gradient","#FF7777, #FF9977, ...")+'</div><div class="vs-section"><div class="vs-section-title">Transcription Bubble</div>'+this._checkboxRow("Show transcription","show_transcription")+this._sliderRow("Font size","transcription_font_size",10,48)+this._textRow("Font family","transcription_font_family","inherit")+this._colorRow("Font color","transcription_font_color")+this._checkboxRow("Bold","transcription_font_bold")+this._checkboxRow("Italic","transcription_font_italic")+this._colorRow("Background","transcription_background")+this._textRow("Border color","transcription_border_color","rgba(0,180,255,0.5)")+this._sliderRow("Padding","transcription_padding",0,32)+this._checkboxRow("Rounded corners","transcription_rounded")+'</div><div class="vs-section"><div class="vs-section-title">Response Bubble</div>'+this._checkboxRow("Show response","show_response")+this._checkboxRow("Streaming response","streaming_response")+this._sliderRow("Font size","response_font_size",10,48)+this._textRow("Font family","response_font_family","inherit")+this._colorRow("Font color","response_font_color")+this._checkboxRow("Bold","response_font_bold")+this._checkboxRow("Italic","response_font_italic")+this._colorRow("Background","response_background")+this._textRow("Border color","response_border_color","rgba(100,200,150,0.5)")+this._sliderRow("Padding","response_padding",0,32)+this._checkboxRow("Rounded corners","response_rounded")+'</div><div class="vs-section"><div class="vs-section-title">Background</div>'+this._checkboxRow("Background blur","background_blur")+this._sliderRow("Blur intensity","background_blur_intensity",0,20)+"</div></div>",this._attachListeners()}_checkboxRow(t,e){return'<div class="vs-row"><label>'+t+'</label><input type="checkbox" data-key="'+e+'"'+(this._config[e]?" checked":"")+"></div>"}_textRow(t,e,i){var s=this._config[e]||"";return'<div class="vs-row"><label>'+t+'</label><input type="text" data-key="'+e+'" value="'+this._escAttr(s)+'" placeholder="'+(i||"")+'"></div>'}_numberRow(t,e,i,s){return'<div class="vs-row"><label>'+t+'</label><input type="number" data-key="'+e+'" value="'+(void 0!==this._config[e]?this._config[e]:"")+'" min="'+i+'" max="'+s+'"></div>'}_sliderRow(t,e,i,s){var r=void 0!==this._config[e]?this._config[e]:i;return'<div class="vs-row"><label>'+t+'</label><input type="range" data-key="'+e+'" min="'+i+'" max="'+s+'" value="'+r+'"><span class="range-val" data-range-for="'+e+'">'+r+"</span></div>"}_colorRow(t,e){return'<div class="vs-row"><label>'+t+'</label><input type="color" data-key="'+e+'" value="'+(this._config[e]||"#000000")+'"></div>'}_selectRow(t,e,i){return'<div class="vs-row"><label>'+t+'</label><select data-key="'+e+'">'+i+"</select></div>"}_selectRowRaw(t,e,i){return'<div class="vs-row"><label>'+t+'</label><select data-key="'+e+'">'+i+"</select></div>"}_entityOptions(t,e){var i='<option value=""'+(t?"":" selected")+">None</option>";if(!this._hass)return i;for(var s=this._hass.states||{},r=Object.keys(s).filter(function(t){for(var i=0;i<e.length;i++)if(t.startsWith(e[i]))return!0;return!1}).sort(),n=0;n<r.length;n++){var o=r[n];i+='<option value="'+o+'"'+(o===t?" selected":"")+">"+(s[o].attributes.friendly_name||o)+"</option>"}return i}_escAttr(t){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}_attachListeners(){var t=this;this.querySelectorAll('input[type="checkbox"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.checked)})}),this.querySelectorAll('input[type="text"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.value)})}),this.querySelectorAll('input[type="number"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,parseInt(e.value,10)||0)})}),this.querySelectorAll('input[type="range"]').forEach(function(e){e.addEventListener("input",function(){var i=t.querySelector('[data-range-for="'+e.dataset.key+'"]');i&&(i.textContent=e.value)}),e.addEventListener("change",function(){t._updateConfig(e.dataset.key,parseInt(e.value,10))})}),this.querySelectorAll('input[type="color"]').forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.value)})}),this.querySelectorAll("select").forEach(function(e){e.addEventListener("change",function(){t._updateConfig(e.dataset.key,e.value)})})}_updateConfig(t,e){this._config=Object.assign({},this._config),this._config[t]=e;var i=new CustomEvent("config-changed",{detail:{config:this._config},bubbles:!0,composed:!0});this.dispatchEvent(i)}}customElements.define("voice-satellite-card",p),customElements.define("voice-satellite-card-editor",g),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant.",preview:!1,documentationURL:"https://github.com/jxlarrea/Voice-Satellite-Card-for-Home-Assistant"}),console.info("%c VOICE-SATELLITE-CARD %c v2.7.0 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();