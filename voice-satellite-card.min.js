(()=>{"use strict";const e="IDLE",t="LISTENING",n="WAKE_WORD_DETECTED",i="STT",r="INTENT",s="TTS",o=[n,i,r,s],a=["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"],l="pipeline",c="timer",d="announcement",u={start_listening_on_load:!0,wake_word_switch:"",state_entity:"",satellite_entity:"",pipeline_id:"",pipeline_timeout:60,pipeline_idle_timeout:300,chime_on_wake_word:!0,chime_on_request_sent:!0,chime_volume:100,tts_volume:100,tts_target:"",continue_conversation:!0,double_tap_cancel:!0,debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,timer_position:"bottom-right",timer_font_size:20,timer_font_family:"inherit",timer_font_color:"#444444",timer_font_bold:!0,timer_font_italic:!1,timer_background:"#ffffff",timer_border_color:"rgba(100, 200, 150, 0.5)",timer_padding:16,timer_rounded:!0,timer_finished_duration:60,announcement_display_duration:5,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,show_transcription:!0,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,streaming_response:!0,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0,bubble_style:"chat",bubble_container_width:85};function h(e){const t=e.split(",").map(e=>e.trim());return t.length>1&&t[0]!==t[t.length-1]&&t.push(t[0]),`linear-gradient(90deg, ${t.join(", ")})`}class _{constructor(){this._debug=!1}set debug(e){this._debug=!!e}log(e,t,n){this._debug&&(void 0!==n?console.log(`[VS][${e}] ${t}`,n):console.log(`[VS][${e}] ${t}`))}error(e,t,n){void 0!==n?console.error(`[VS][${e}] ${t}`,n):console.error(`[VS][${e}] ${t}`)}}class p{constructor(e){this._card=e,this._log=e.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get card(){return this._card}get log(){return this._log}get audioContext(){return this._audioContext}get isStreaming(){return!!this._sendInterval}get workletNode(){return this._workletNode}set workletNode(e){this._workletNode=e}get scriptProcessor(){return this._scriptProcessor}set scriptProcessor(e){this._scriptProcessor=e}get audioBuffer(){return this._audioBuffer}set audioBuffer(e){this._audioBuffer=e}get actualSampleRate(){return this._actualSampleRate}async startMicrophone(){await this._ensureAudioContextRunning();const{config:e}=this._card;this._log.log("mic",`AudioContext state=${this._audioContext.state} sampleRate=${this._audioContext.sampleRate}`);const t={sampleRate:16e3,channelCount:1,echoCancellation:e.echo_cancellation,noiseSuppression:e.noise_suppression,autoGainControl:e.auto_gain_control};if(e.voice_isolation&&(t.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:t}),e.debug){const e=this._mediaStream.getAudioTracks();this._log.log("mic",`Got media stream with ${e.length} audio track(s)`),e.length>0&&this._log.log("mic",`Track settings: ${JSON.stringify(e[0].getSettings())}`)}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic",`Actual sample rate: ${this._actualSampleRate}`);try{await async function(e,t){const n=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),i=URL.createObjectURL(n);await e.audioContext.audioWorklet.addModule(i),URL.revokeObjectURL(i),e.workletNode=new AudioWorkletNode(e.audioContext,"voice-satellite-processor"),e.workletNode.port.onmessage=t=>{e.audioBuffer.push(new Float32Array(t.data))},t.connect(e.workletNode),e.workletNode.connect(e.audioContext.destination)}(this,this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}catch(e){this._log.log("mic",`AudioWorklet unavailable (${e.message}), using ScriptProcessor`),n=this,i=this._sourceNode,n.scriptProcessor=n.audioContext.createScriptProcessor(2048,1,1),n.scriptProcessor.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);n.audioBuffer.push(new Float32Array(t))},i.connect(n.scriptProcessor),n.scriptProcessor.connect(n.audioContext.destination),this._log.log("mic","Audio capture via ScriptProcessor")}var n,i}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(e=>e.stop()),this._mediaStream=null),this._audioBuffer=[]}startSending(e){this.stopSending(),this._sendInterval=setInterval(()=>{!function(e,t){if(null==t)return;if(0===e.audioBuffer.length)return;let n=0;for(const t of e.audioBuffer)n+=t.length;const i=new Float32Array(n);let r=0;for(const t of e.audioBuffer)i.set(t,r),r+=t.length;e.audioBuffer=[];const s=function(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){const i=Math.max(-1,Math.min(1,e[n]));t[n]=i<0?32768*i:32767*i}return t}(16e3!==e.actualSampleRate?function(e,t){if(16e3===t)return e;const n=t/16e3,i=Math.round(e.length/n),r=new Float32Array(i);for(let t=0;t<i;t++){const i=t*n,s=Math.floor(i),o=Math.min(s+1,e.length-1),a=i-s;r[t]=e[s]*(1-a)+e[o]*a}return r}(i,e.actualSampleRate):i);!function(e,t,n){const{connection:i}=e;if(!i?.socket)return;if(i.socket.readyState!==WebSocket.OPEN)return;const r=new Uint8Array(1+t.byteLength);r[0]=n,r.set(new Uint8Array(t.buffer),1),i.socket.send(r.buffer)}(e.card,s,t)}(this,e())},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream?.getAudioTracks().forEach(e=>{e.enabled=!1})}resume(){this._mediaStream?.getAudioTracks().forEach(e=>{e.enabled=!0})}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(e){this._log.error("mic",`Failed to resume AudioContext on click: ${e}`)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error(`AudioContext failed to start: ${this._audioContext.state}`)}}const m={type:"single",wave:"sine",notes:[{freq:784,start:0},{freq:659,start:.08}],duration:.25},g={type:"multi",wave:"sine",notes:[{freq:784,start:0,end:.15},{freq:587,start:.18,end:.4}],totalMs:500},b={type:"multi",wave:"sine",notes:[{freq:880,start:0,end:.15},{freq:660,start:.18,end:.33},{freq:880,start:.36,end:.55}]};function f(e,t,n={}){const{onDone:i,log:r}=n;try{const{ctx:n,owned:r}=function(e){const t=e.audio?.audioContext;return t&&"closed"!==t.state?("suspended"===t.state&&t.resume(),{ctx:t,owned:!1}):{ctx:new(window.AudioContext||window.webkitAudioContext),owned:!0}}(e),s=e.config.chime_volume/100*.5;for(const e of t.notes){const i=n.createOscillator(),r=n.createGain();i.connect(r),r.connect(n.destination),i.type=t.wave,i.frequency.setValueAtTime(e.freq,n.currentTime+e.start),r.gain.setValueAtTime(0,n.currentTime+e.start),r.gain.linearRampToValueAtTime(s,n.currentTime+e.start+.02),r.gain.exponentialRampToValueAtTime(.001,n.currentTime+e.end),i.start(n.currentTime+e.start),i.stop(n.currentTime+e.end)}t.totalMs||i?setTimeout(()=>{r&&n.close(),i?.()},t.totalMs||600):r&&setTimeout(()=>n.close(),1e3)}catch(e){r?.error("chime",`Chime error: ${e}`),i?.()}}function v(e){if(e.startsWith("http://")||e.startsWith("https://"))return e;const t=window.location.origin;return e.startsWith("/")?t+e:`${t}/${e}`}function y(e,t,{onEnd:n,onError:i,onStart:r}){const s=new Audio;return s.volume=t,s.onended=()=>{n()},s.onerror=e=>{i(e)},s.src=e,s.play().then(()=>{r?.()}).catch(e=>{i(e)}),s}const w={wake:{type:"single",wave:"sine",notes:[{freq:523,start:0},{freq:659,start:.08},{freq:784,start:.16}],duration:.25},error:{type:"single",wave:"square",volumeScale:.3,notes:[{freq:300,start:0},{freq:200,start:.08}],duration:.15},done:m};class S{constructor(e){this._card=e,this._log=e.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null,this._playbackWatchdog=null}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(e){this._streamingUrl=e}play(e){const{config:t}=this._card,n=v(e);if(this._playing=!0,t.tts_target&&"browser"!==t.tts_target)return function(e,t){const n=e.config.tts_target;e.logger.log("tts",`Playing on remote: ${n} URL: ${t}`),e.hass.callService("media_player","play_media",{entity_id:n,media_content_id:t,media_content_type:"music"}).catch(t=>{e.logger.error("tts",`Remote play failed: ${t}`)})}(this._card,n),void(this._endTimer=setTimeout(()=>{this._endTimer=null,this._onComplete()},2e3));this._playbackWatchdog=setTimeout(()=>{this._playbackWatchdog=null,this._playing&&this._currentAudio&&(this._log.log("tts","Playback watchdog fired — forcing completion"),this._onComplete())},3e4),this._currentAudio=y(n,t.tts_volume/100,{onEnd:()=>{this._log.log("tts","Playback complete"),this._clearWatchdog(),this._onComplete()},onError:e=>{this._log.error("tts",`Playback error: ${e}`),this._log.error("tts",`URL: ${n}`),this._clearWatchdog(),this._onComplete(!0)},onStart:()=>{this._log.log("tts","Playback started successfully")}})}stop(){var e;this._playing=!1,this._clearWatchdog(),this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null),(e=this._card).config.tts_target&&"browser"!==e.config.tts_target&&e.hass&&e.hass.callService("media_player","media_stop",{entity_id:e.config.tts_target}).catch(t=>{e.logger.error("tts",`Remote stop failed: ${t}`)})}resetStreamingUrl(){this._streamingUrl=null}storeStreamingUrl(e){if(this._streamingUrl=null,e.tts_output?.url&&e.tts_output?.stream_response){const t=e.tts_output.url;this._streamingUrl=t.startsWith("http")?t:window.location.origin+t,this._log.log("tts",`Streaming TTS URL available: ${this._streamingUrl}`)}}playChime(e){const t=w[e]||m;!function(e,t,n){try{const n=new(window.AudioContext||window.webkitAudioContext),i=n.createOscillator(),r=n.createGain();i.connect(r),r.connect(n.destination);const s=e.config.chime_volume/100*.5*(t.volumeScale||1);i.type=t.wave,r.gain.setValueAtTime(s,n.currentTime),r.gain.exponentialRampToValueAtTime(.001,n.currentTime+t.duration);for(const e of t.notes)i.frequency.setValueAtTime(e.freq,n.currentTime+e.start);i.start(),i.stop(n.currentTime+t.duration),setTimeout(()=>n.close(),500)}catch(e){n?.error("chime",`Chime error: ${e}`)}}(this._card,t,this._log)}_clearWatchdog(){this._playbackWatchdog&&(clearTimeout(this._playbackWatchdog),this._playbackWatchdog=null)}_onComplete(e){this._log.log("tts","Complete — cleaning up UI"+(e?" (playback failed)":"")),this._currentAudio=null,this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.onTTSComplete(e)}}function k(e,t){try{const e=t.intent_output.response.speech.plain.speech;if(e)return e}catch(e){}try{if(t.intent_output.response.speech.speech)return t.intent_output.response.speech.speech}catch(e){}try{if(t.intent_output.response.plain)return t.intent_output.response.plain}catch(e){}try{if("string"==typeof t.intent_output.response)return t.intent_output.response}catch(e){}return e.log.log("error","Could not extract response text"),null}class T{constructor(e){this._card=e,this._log=e.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._idleTimeoutId=null,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1,this._askQuestionCallback=null,this._askQuestionHandled=!1,this._reconnectRef={listener:null}}get card(){return this._card}get log(){return this._log}get binaryHandlerId(){return this._binaryHandlerId}set binaryHandlerId(e){this._binaryHandlerId=e}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}set serviceUnavailable(e){this._serviceUnavailable=e}get shouldContinue(){return this._shouldContinue}set shouldContinue(e){this._shouldContinue=e}get continueConversationId(){return this._continueConversationId}set continueConversationId(e){this._continueConversationId=e}get continueMode(){return this._continueMode}set continueMode(e){this._continueMode=e}get isStreaming(){return this._isStreaming}get retryCount(){return this._retryCount}set retryCount(e){this._retryCount=e}get pendingRunEnd(){return this._pendingRunEnd}set pendingRunEnd(e){this._pendingRunEnd=e}get suppressTTS(){return this._suppressTTS}set suppressTTS(e){this._suppressTTS=e}get recoveryTimeout(){return this._recoveryTimeout}set recoveryTimeout(e){this._recoveryTimeout=e}get intentErrorBarTimeout(){return this._intentErrorBarTimeout}set intentErrorBarTimeout(e){this._intentErrorBarTimeout=e}get askQuestionCallback(){return this._askQuestionCallback}set askQuestionCallback(e){this._askQuestionCallback=e}get askQuestionHandled(){return this._askQuestionHandled}set askQuestionHandled(e){this._askQuestionHandled=e}async start(e){const t=e||{},{connection:n}=this._card;if(!n)throw new Error("No Home Assistant connection available");!function(e,t,n,i){i.listener||(i.listener=()=>{e.logger.log("pipeline","Connection reconnected — resetting retry state"),t.resetRetryState(),e.ui.clearErrorBar(),setTimeout(()=>t.restart(0),2e3)},n.addEventListener("ready",i.listener))}(this._card,this,n,this._reconnectRef);const i=await async function(e){return e.sendMessagePromise({type:"assist_pipeline/pipeline/list"})}(n);this._log.log("pipeline","Available: "+i.pipelines.map(e=>`${e.name} (${e.id})${e.preferred?" [preferred]":""}`).join(", "));const{config:r}=this._card;let s=r.pipeline_id;if(!s){const e=i.pipelines.find(e=>e.preferred);s=e?e.id:i.pipelines[0].id}this._log.log("pipeline",`Starting pipeline: ${s}`);const o=t.start_stage||"wake_word",a={type:"assist_pipeline/run",start_stage:o,end_stage:t.end_stage||"tts",input:{sample_rate:16e3,timeout:"wake_word"===o?0:void 0},pipeline:s,timeout:r.pipeline_timeout};t.conversation_id&&(a.conversation_id=t.conversation_id),this._log.log("pipeline","Resolving device_id...");const l=await async function(e){const{config:t,connection:n}=e;if(!t.satellite_entity||!n)return null;try{e.logger.log("pipeline",`Looking up entity registry for: ${t.satellite_entity}`);const i=await n.sendMessagePromise({type:"config/entity_registry/get",entity_id:t.satellite_entity});if(e.logger.log("pipeline","Entity registry response received"),i?.device_id)return e.logger.log("pipeline",`Resolved device_id: ${i.device_id} from ${t.satellite_entity}`),i.device_id;e.logger.log("pipeline",`Entity found but no device_id: ${JSON.stringify(i)}`)}catch(n){const i=n?.message||JSON.stringify(n);e.logger.error("pipeline",`Failed to resolve device_id from ${t.satellite_entity}: ${i}`)}return null}(this._card);l?a.device_id=l:this._log.log("pipeline","No device_id resolved (satellite_entity not configured or lookup failed)"),void 0===a.input.timeout&&delete a.input.timeout,this._log.log("pipeline",`Run config: ${JSON.stringify(a)}`),this._log.log("pipeline","Subscribing to pipeline..."),this._unsubscribe=await async function(e,t,n){return e.subscribeMessage(n,t)}(n,a,e=>this._card.onPipelineMessage(e)),this._log.log("pipeline","Subscribed, waiting for run-start...");const{audio:c}=this._card;c.startSending(()=>this._binaryHandlerId),this._isStreaming=!0,this.startIdleTimeout()}async stop(){if(this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._unsubscribe){try{await this._unsubscribe()}catch(e){}this._unsubscribe=null}this.clearIdleTimeout()}restart(e){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this.clearIdleTimeout(),this.stop().then(()=>{this._restartTimeout=setTimeout(()=>{this._restartTimeout=null,this._isRestarting=!1,this.start().catch(e=>{const t=e?.message||JSON.stringify(e);this._log.error("pipeline",`Restart failed: ${t}`),this._serviceUnavailable||(this._card.ui.showErrorBar(),this._serviceUnavailable=!0),this.restart(this.calculateRetryDelay())})},e||0)}))}restartContinue(e,t={}){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this.clearIdleTimeout(),this._askQuestionCallback=t.onSttEnd||null,this.stop().then(()=>{this._isRestarting=!1,this._continueMode=!0,this.start({start_stage:"stt",end_stage:t.end_stage||"tts",conversation_id:e}).catch(e=>{this._log.error("pipeline",`Continue conversation failed: ${e?.message||JSON.stringify(e)}`),this._askQuestionCallback=null,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this.restart(0)})}))}handleRunStart(e){!function(e,n){if(e.binaryHandlerId=n.runner_data.stt_binary_handler_id,e.resetIdleTimeout(),e.card.tts.storeStreamingUrl(n),e.continueMode)return e.continueMode=!1,e.card.setState(i),e.log.log("pipeline",`Running (continue conversation) — binary handler ID: ${e.binaryHandlerId}`),void e.log.log("pipeline","Listening for speech...");e.card.setState(t),e.log.log("pipeline",`Running — binary handler ID: ${e.binaryHandlerId}`),e.log.log("pipeline","Listening for wake word...")}(this,e)}handleWakeWordStart(){var e;(e=this).serviceUnavailable&&(e.recoveryTimeout&&clearTimeout(e.recoveryTimeout),e.recoveryTimeout=setTimeout(()=>{e.serviceUnavailable&&(e.log.log("recovery","Wake word service recovered"),e.serviceUnavailable=!1,e.retryCount=0,e.card.ui.clearErrorBar(),e.card.ui.hideBar())},2e3))}handleWakeWordEnd(e){!function(e,t){const i=t.wake_word_output;if(!i||0===Object.keys(i).length)return e.log.error("error","Wake word service unavailable (empty wake_word_output)"),e.recoveryTimeout&&(clearTimeout(e.recoveryTimeout),e.recoveryTimeout=null),e.binaryHandlerId=null,e.card.ui.showErrorBar(),e.serviceUnavailable=!0,void e.restart(e.calculateRetryDelay());e.recoveryTimeout&&(clearTimeout(e.recoveryTimeout),e.recoveryTimeout=null),e.serviceUnavailable=!1,e.retryCount=0,e.card.ui.clearErrorBar();const{tts:r}=e.card;r.isPlaying&&(r.stop(),e.pendingRunEnd=!1),e.intentErrorBarTimeout&&(clearTimeout(e.intentErrorBarTimeout),e.intentErrorBarTimeout=null),e.card.chat.clear(),e.shouldContinue=!1,e.continueConversationId=null,e.card.setState(n),e.resetIdleTimeout(),e.card.config.chime_on_wake_word&&r.playChime("wake"),e.card.startWakeSwitchKeepAlive(),e.card.ui.showBlurOverlay(l)}(this,e)}handleSttEnd(e){!function(e,t){const n=t.stt_output?.text||"";if(n&&e.card.chat.showTranscription(n),e.askQuestionCallback){const t=e.askQuestionCallback;e.askQuestionCallback=null,e.askQuestionHandled=!0,e.log.log("pipeline",`Ask question STT complete: "${n}"`),t(n)}}(this,e)}handleIntentProgress(e){!function(e,t){const{tts:n}=e.card;if(t.tts_start_streaming&&n.streamingUrl&&!n.isPlaying&&(e.log.log("tts","Streaming TTS started — playing early"),e.card.setState(s),n.play(n.streamingUrl),n.streamingUrl=null),!t.chat_log_delta)return;const i=t.chat_log_delta.content;if("string"!=typeof i)return;const{chat:r}=e.card;r.streamedResponse=(r.streamedResponse||"")+i,r.updateResponse(r.streamedResponse)}(this,e)}handleIntentEnd(e){!function(e,t){let n=null;try{n=t.intent_output.response.response_type}catch(e){}if("error"===n){const n=k(e,t)||"An error occurred";return e.log.error("error",`Intent error: ${n}`),e.card.ui.showErrorBar(),e.card.config.chime_on_wake_word&&e.card.tts.playChime("error"),e.suppressTTS=!0,e.intentErrorBarTimeout&&clearTimeout(e.intentErrorBarTimeout),e.intentErrorBarTimeout=setTimeout(()=>{e.intentErrorBarTimeout=null,e.card.ui.clearErrorBar(),e.card.ui.hideBar()},3e3),void(e.card.chat.streamedResponse="")}const i=k(e,t);if(i&&e.card.chat.showResponse(i),e.shouldContinue=!1,e.continueConversationId=null,e.card.config.continue_conversation)try{!0===t.intent_output.continue_conversation&&(e.shouldContinue=!0,e.continueConversationId=t.intent_output.conversation_id||null,e.log.log("pipeline",`Continue conversation requested — id: ${e.continueConversationId}`))}catch(e){}e.card.chat.streamedResponse="",e.card.chat.streamEl=null}(this,e)}handleTtsEnd(e){!function(e,t){if(e.suppressTTS)return e.suppressTTS=!1,e.log.log("tts","TTS suppressed (intent error)"),void e.restart(0);const{tts:n}=e.card;if(n.isPlaying)return e.log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void e.restart(0);const i=t.tts_output?.url||t.tts_output?.url_path||null;i&&n.play(i),e.restart(0)}(this,e)}handleRunEnd(){!function(e){if(e.log.log("pipeline","Run ended"),e.binaryHandlerId=null,!e.isRestarting)return e.askQuestionHandled?(e.log.log("pipeline","Ask question handled — announcement manager owns cleanup"),void(e.askQuestionHandled=!1)):e.serviceUnavailable?(e.log.log("ui","Error recovery handling restart"),void e.card.ui.hideBlurOverlay(l)):e.card.tts.isPlaying?(e.log.log("ui","TTS playing — deferring cleanup"),void(e.pendingRunEnd=!0)):void e.finishRunEnd();e.log.log("pipeline","Restart already in progress — skipping run-end restart")}(this)}handleError(t){!function(t,n){const i=n.code||"",r=n.message||"";if(t.log.log("error",`${i} — ${r}`),t.askQuestionCallback){const e=t.askQuestionCallback;return t.askQuestionCallback=null,t.log.log("pipeline",`Ask question error (${i}) — sending empty answer`),void e("")}if(a.includes(i)){if(t.log.log("pipeline",`Expected error: ${i} — restarting`),o.includes(t.card.currentState)){t.log.log("ui","Cleaning up interaction UI after expected error"),t.card.stopWakeSwitchKeepAlive(),t.card.setState(e),t.card.chat.clear(),t.card.ui.hideBlurOverlay(l),t.shouldContinue=!1,t.continueConversationId=null;const n=t.card.config.tts_target&&"browser"!==t.card.config.tts_target;t.card.config.chime_on_request_sent&&!n&&t.card.tts.playChime("done")}return void t.restart(0)}t.log.error("error",`Unexpected: ${i} — ${r}`);const s=o.includes(t.card.currentState);s&&t.card.stopWakeSwitchKeepAlive(),t.binaryHandlerId=null,s&&t.card.config.chime_on_wake_word&&t.card.tts.playChime("error"),t.card.ui.showErrorBar(),t.serviceUnavailable=!0,t.card.chat.clear(),t.card.ui.hideBlurOverlay(l),t.restart(t.calculateRetryDelay())}(this,t)}finishPendingRunEnd(){this._pendingRunEnd&&this.finishRunEnd()}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}resetRetryState(){this._retryCount=0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._isRestarting&&(this._isRestarting=!1),this._serviceUnavailable=!1}finishRunEnd(){this._pendingRunEnd=!1,this._card.stopWakeSwitchKeepAlive(),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.setState(e),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}calculateRetryDelay(){this._retryCount++;const e=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline",`Retry in ${e}ms (attempt #${this._retryCount})`),e}startIdleTimeout(){this.clearIdleTimeout(),this._card.config.pipeline_idle_timeout<=0||(this._idleTimeoutId=setTimeout(()=>o.includes(this._card.currentState)?(this._log.log("pipeline","Idle timeout fired but interaction in progress — deferring"),void this.resetIdleTimeout()):this._card.tts.isPlaying?(this._log.log("pipeline","Idle timeout fired but TTS playing — deferring"),void this.resetIdleTimeout()):(this._log.log("pipeline","Idle timeout — restarting"),void this.restart(0)),1e3*this._card.config.pipeline_idle_timeout))}clearIdleTimeout(){this._idleTimeoutId&&(clearTimeout(this._idleTimeoutId),this._idleTimeoutId=null)}resetIdleTimeout(){this.startIdleTimeout()}}function C(e,t,n){e.style.fontSize=t[`${n}_font_size`]+"px",e.style.fontFamily=t[`${n}_font_family`],e.style.color=t[`${n}_font_color`],e.style.fontWeight=t[`${n}_font_bold`]?"bold":"normal",e.style.fontStyle=t[`${n}_font_italic`]?"italic":"normal",e.style.background=t[`${n}_background`],e.style.border=`3px solid ${t[`${n}_border_color`]}`,e.style.padding=t[`${n}_padding`]+"px",e.style.borderRadius=t[`${n}_rounded`]?"12px":"0"}function x(e){const t=Math.max(0,e),n=Math.floor(t/3600),i=Math.floor(t%3600/60),r=t%60;return`${n<10?"0":""}${n}:${i<10?"0":""}${i}:${r<10?"0":""}${r}`}class A{constructor(e){this._card=e,this._log=e.logger,this._globalUI=null,this._pendingStartButtonReason=void 0,this._blurReasons={},this._timerContainer=null,this._timerAlertEl=null}get element(){return this._globalUI}ensureGlobalUI(){const e=document.getElementById("voice-satellite-ui");if(e)return this._globalUI=e,void this._flushPendingStartButton();const t=document.createElement("div");t.id="voice-satellite-ui",t.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(t),this._globalUI=t,this._injectGlobalStyles(),this.applyStyles(),t.querySelector(".vs-start-btn").addEventListener("click",()=>{this._card.onStartClick()});const n=t.querySelector(".vs-start-btn");n.classList.add("visible"),n.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){if(!this._globalUI)return;const e=this._card.config,t=this._globalUI.querySelector(".vs-rainbow-bar");t.style.height=`${e.bar_height}px`,t.style["top"===e.bar_position?"top":"bottom"]="0",t.style["top"===e.bar_position?"bottom":"top"]="auto",t.style.background=h(e.bar_gradient),t.style.backgroundSize="200% 100%";const n=this._globalUI.querySelector(".vs-blur-overlay");e.background_blur?(n.style.backdropFilter=`blur(${e.background_blur_intensity}px)`,n.style.webkitBackdropFilter=`blur(${e.background_blur_intensity}px)`):(n.style.backdropFilter="none",n.style.webkitBackdropFilter="none");const i=e.bar_height||6,r=this._globalUI.querySelector(".vs-chat-container");"bottom"===e.bar_position?(r.style.bottom=`${i+12}px`,r.style.top="auto"):(r.style.bottom="12px",r.style.top="auto");const s="chat"===e.bubble_style;r.style.alignItems=s?"flex-start":"center",r.style.width=`${e.bubble_container_width||80}%`,r.style.maxWidth=`${e.bubble_container_width||80}%`,r.setAttribute("data-bubble-style",e.bubble_style||"centered")}applyBubbleStyle(e,t){C(e,this._card.config,t)}updateForState(e,t,n){if(!this._globalUI)return;const i={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[e];if(!i)return;if(t&&!i.barVisible)return;if(n&&!i.barVisible)return;const r=this._globalUI.querySelector(".vs-rainbow-bar");i.barVisible?(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.add("visible"),r.classList.remove("connecting","listening","processing","speaking"),i.animation&&r.classList.add(i.animation)):(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.remove("visible","connecting","listening","processing","speaking"))}showStartButton(e){if(!this._globalUI)return void(this._pendingStartButtonReason=e);const t=this._globalUI.querySelector(".vs-start-btn");t.classList.add("visible"),t.title={"not-allowed":"Tap to enable microphone","not-found":"No microphone found","not-readable":"Microphone unavailable - tap to retry"}[e]||"Tap to start voice assistant"}hideStartButton(){this._globalUI?.querySelector(".vs-start-btn")?.classList.remove("visible")}showBlurOverlay(e){this._globalUI&&this._card.config.background_blur&&(this._blurReasons[e||"default"]=!0,this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible"))}hideBlurOverlay(e){this._globalUI&&(delete this._blurReasons[e||"default"],0===Object.keys(this._blurReasons).length&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible"))}showErrorBar(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-rainbow-bar");e.classList.remove("connecting","listening","processing","speaking"),e.classList.add("visible","error-mode"),e.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222, #ff4444)",e.style.backgroundSize="200% 100%"}clearErrorBar(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-rainbow-bar");e.classList.remove("error-mode"),e.style.background=h(this._card.config.bar_gradient),e.style.backgroundSize="200% 100%"}hideBar(){this._globalUI?.querySelector(".vs-rainbow-bar")?.classList.remove("visible")}flashErrorBar(){this.showErrorBar();const e=this._globalUI?.querySelector(".vs-rainbow-bar");e&&(e.classList.add("error-flash"),e.addEventListener("animationend",function t(){e.classList.remove("error-flash"),e.removeEventListener("animationend",t)}))}showBarSpeaking(){if(!this._globalUI)return!1;const e=this._globalUI.querySelector(".vs-rainbow-bar");if(!e)return!1;const t=e.classList.contains("visible");return e.classList.add("visible","speaking"),t}restoreBar(e){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-rainbow-bar");t&&(t.classList.remove("speaking"),e||t.classList.remove("visible"))}addChatMessage(e,t){if(!this._globalUI)return null;const n=this._globalUI.querySelector(".vs-chat-container");n.classList.add("visible");const i=document.createElement("div");return i.className=`vs-chat-msg ${t}`,i.textContent=e,this.applyBubbleStyle(i,{user:"transcription",assistant:"response",announcement:"response"}[t]||"response"),"announcement"===t&&(i.style.alignSelf="center",i.style.textAlign="center"),n.appendChild(i),i}updateChatText(e,t){e&&(e.textContent=t)}updateChatHtml(e,t){e&&(e.innerHTML=t)}clearChat(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-chat-container");for(;e.firstChild;)e.removeChild(e.firstChild);e.classList.remove("visible")}setAnnouncementMode(e){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-chat-container");t&&t.classList.toggle("announcement-mode",e)}clearAnnouncementBubbles(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-chat-container"),t=e?.querySelectorAll(".vs-chat-msg.announcement")||[];for(const e of t)e.remove();e&&!e.firstChild&&e.classList.remove("visible")}ensureTimerContainer(){if(this._timerContainer&&document.body.contains(this._timerContainer))return;const e=document.createElement("div");e.id="voice-satellite-timers",e.className="vs-timer-container",document.body.appendChild(e),this._timerContainer=e,this.applyTimerPosition()}applyTimerPosition(){if(!this._timerContainer)return;const e=this._card.config,t=e.bar_height||16,n=e.timer_position||"bottom-right";if(this._timerContainer.style.top="auto",this._timerContainer.style.bottom="auto",this._timerContainer.style.left="auto",this._timerContainer.style.right="auto",n.startsWith("top")){const n="top"===e.bar_position?t+12:12;this._timerContainer.style.top=`${n}px`}else{const n="bottom"===e.bar_position?t+12:12;this._timerContainer.style.bottom=`${n}px`}n.includes("left")?this._timerContainer.style.left="12px":this._timerContainer.style.right="12px"}removeTimerContainer(){this._timerContainer?.parentNode?.removeChild(this._timerContainer),this._timerContainer=null}createTimerPill(e,t){const n=e.totalSeconds>0?Math.max(0,e.secondsLeft/e.totalSeconds*100):0,i=document.createElement("div");i.className="vs-timer-pill",i.setAttribute("data-timer-id",e.id),this.applyBubbleStyle(i,"timer");const r=this._card.config.timer_border_color||"rgba(100, 200, 150, 0.5)";return i.innerHTML=`<div class="vs-timer-progress" style="width:${n}%;background:${r};opacity:0.3"></div><div class="vs-timer-content"><span class="vs-timer-icon">⏱</span><span class="vs-timer-time">${x(e.secondsLeft)}</span></div>`,t&&E(i,t),i}syncTimerPills(e,t){this.ensureTimerContainer();const n=this._timerContainer.querySelectorAll(".vs-timer-pill");for(const t of n){const n=t.getAttribute("data-timer-id");e.some(e=>e.id===n)||t.parentNode.removeChild(t)}for(const n of e)n.el&&this._timerContainer.contains(n.el)||(n.el=this.createTimerPill(n,t(n.id)),this._timerContainer.appendChild(n.el))}updateTimerPill(e,t,n){if(!e)return;const i=e.querySelector(".vs-timer-time");i&&(i.textContent=x(t));const r=e.querySelector(".vs-timer-progress");if(r){const e=n>0?Math.max(0,t/n*100):0;r.style.width=`${e}%`}}expireTimerPill(e,t){if(!this._timerContainer)return;const n=this._timerContainer.querySelector(`.vs-timer-pill[data-timer-id="${e}"]`);n&&(n.classList.add("vs-timer-expired"),setTimeout(()=>n.parentNode?.removeChild(n),t))}showTimerAlert(e){this._timerAlertEl=document.createElement("div"),this._timerAlertEl.className="vs-timer-alert",this.applyBubbleStyle(this._timerAlertEl,"timer"),this._timerAlertEl.innerHTML='<span class="vs-timer-icon">⏱</span><span class="vs-timer-time">00:00:00</span>',document.body.appendChild(this._timerAlertEl),e&&E(this._timerAlertEl,e)}clearTimerAlert(){for(const e of document.querySelectorAll(".vs-timer-alert"))e.parentNode?.removeChild(e);this._timerAlertEl=null}_injectGlobalStyles(){if(document.getElementById("voice-satellite-styles"))return;const e=document.createElement("style");e.id="voice-satellite-styles",e.textContent='/* Voice Satellite Card — Styles */\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(5px);\r\n  -webkit-backdrop-filter: blur(5px);\r\n  background: rgba(0, 0, 0, 0.3);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-flash {\r\n  animation: vs-error-flash 0.15s ease-in-out 3;\r\n}\r\n\r\n@keyframes vs-error-flash {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  max-width: 80%;\r\n  width: 80%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.announcement-mode {\r\n  top: 50% !important;\r\n  bottom: auto !important;\r\n  transform: translate(-50%, -50%);\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  padding: 12px;\r\n  opacity: 0;\r\n  text-align: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg {\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg.user {\r\n  align-self: flex-end;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg.assistant {\r\n  align-self: flex-start;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}\r\n\r\n/* Timer Pills */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: vs-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);\r\n  z-index: 10002;\r\n  animation: vs-timer-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes vs-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.05);\r\n  }\r\n}',document.head.appendChild(e)}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}const I=400;function E(e,t){let n=0;const i=e=>{const i=Date.now();i-n<I&&i-n>0&&(e.preventDefault(),e.stopPropagation(),t()),n=i};e.addEventListener("touchstart",i,{passive:!1}),e.addEventListener("click",i)}class ${constructor(e){this._card=e,this._log=e.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(e){this._streamEl=e}get streamedResponse(){return this._streamedResponse}set streamedResponse(e){this._streamedResponse=e}showTranscription(e){this._card.config.show_transcription&&this.addUser(e)}hideTranscription(){}showResponse(e){this._card.config.show_response&&(this._streamEl?this._card.ui.updateChatText(this._streamEl,e):this.addAssistant(e))}updateResponse(e){this._card.config.show_response&&(this._streamEl?this._updateStreaming(e):this.addAssistant(e))}hideResponse(){}addUser(e){this._card.ui.addChatMessage(e,"user")}addAssistant(e){this._streamEl=this._card.ui.addChatMessage(e,"assistant")}clear(){this._card.ui.clearChat(),this._streamEl=null,this._streamedResponse=""}_updateStreaming(e){if(!this._streamEl)return;if(e.length<=24)return void this._card.ui.updateChatText(this._streamEl,e);const t=e.slice(0,e.length-24),n=e.slice(e.length-24);let i=R(t);for(let e=0;e<n.length;e++)i+=`<span style="opacity:${((24-e)/24).toFixed(2)}">${R(n[e])}</span>`;this._card.ui.updateChatHtml(this._streamEl,i)}}function R(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}class B{constructor(e){this._card=e,this._log=e.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){this._handler=t=>{if(!this._card.config.double_tap_cancel)return;const n=o.includes(this._card.currentState)||this._card.tts.isPlaying,i=this._card.timer.isAlertActive;if(!n&&!i)return;if("click"===t.type&&this._lastTapWasTouch)return;this._lastTapWasTouch="touchstart"===t.type;const r=Date.now(),s=r-this._lastTapTime;if(this._lastTapTime=r,s<400&&s>0){if(t.preventDefault(),this._card.timer.isAlertActive)return this._log.log("ui","Double-tap detected — dismissing timer alert"),void this._card.timer.dismissAlert();this._log.log("ui","Double-tap detected — cancelling interaction"),this._card.tts.isPlaying&&this._card.tts.stop(),this._card.stopWakeSwitchKeepAlive(),this._card.pipeline.clearContinueState(),this._card.setState(e),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.updateInteractionState("IDLE");const n=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;this._card.config.chime_on_request_sent&&!n&&this._card.tts.playChime("done"),this._card.pipeline.restart(0)}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}class U{constructor(e){this._card=e,this._log=e.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){this._handler=()=>this._handleChange(),document.addEventListener("visibilitychange",this._handler)}_handleChange(){this._debounceTimer&&clearTimeout(this._debounceTimer),document.hidden?(this._isPaused=!0,o.includes(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.stopWakeSwitchKeepAlive(),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(()=>{this._log.log("visibility","Tab hidden — pausing mic"),this._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume())}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}_resume(){if(!this._isPaused)return;this._isPaused=!1,this._card.audio.resume();const{audio:e,pipeline:t}=this._card;!e.isStreaming&&t.isStreaming&&e.startSending(()=>t.binaryHandlerId),t.resetForResume(),this._log.log("visibility","Resuming — restarting pipeline"),t.restart(0)}}function P(e,t,n,i,r){e._subscribed=!0,e._entityId=n,q(e,t,n,i,r),e._reconnectListener||(e._reconnectListener=()=>{if(!e.card.isOwner)return;if(e.log.log(r,"Connection reconnected — re-subscribing"),e._unsubscribe){try{e._unsubscribe()}catch(e){}e._unsubscribe=null}const t=e.card.connection;t&&q(e,t,e._entityId,i,r)},t.addEventListener("ready",e._reconnectListener))}function q(e,t,n,i,r){t.subscribeEvents(e=>{const{data:t}=e;t&&t.new_state&&t.entity_id===n&&i(t.new_state.attributes||{})},"state_changed").then(t=>{e._unsubscribe=t,e.log.log(r,`Subscribed to state changes for ${n}`);const s=e.card.hass;s?.states?.[n]&&i(s.states[n].attributes||{})}).catch(t=>{e.log.error(r,`Failed to subscribe: ${t}`),e._subscribed=!1})}function L(e){e._unsubscribe&&(e._unsubscribe(),e._unsubscribe=null),e._reconnectListener&&e.card.connection&&(e.card.connection.removeEventListener("ready",e._reconnectListener),e._reconnectListener=null),e._subscribed=!1}window.__vsSingleton||(window.__vsSingleton={instance:null,active:!1,starting:!1});const N=window.__vsSingleton;function M(e){return!N.instance||N.instance===e}function W(){return N.active}function F(){return N.starting}function O(e){N.starting=!!e}let D="";function V(){D=""}let z=null,H=null;function Q(e){e.card.ui.removeTimerContainer()}function K(e,t){e.card.ui.expireTimerPill(t,400);const n=e.timers.find(e=>e.id===t);n&&(n.el=null)}function j(e){f(e.card,b,{log:e.log}),e.log.log("timer","Alert chime played")}class G{constructor(e){this._card=e,this._log=e.logger,this._timers=[],this._tickInterval=null,this._container=null,this._unsubscribe=null,this._subscribed=!1,this._reconnectListener=null,this._knownTimerIds=[],this._alertActive=!1,this._alertEl=null}update(){if(this._subscribed)return;const{config:e,connection:t}=this._card;e.satellite_entity&&t&&P(this,t,e.satellite_entity,e=>this.processStateChange(e),"timer")}get card(){return this._card}get log(){return this._log}get timers(){return this._timers}set timers(e){this._timers=e}get knownTimerIds(){return this._knownTimerIds}set knownTimerIds(e){this._knownTimerIds=e}get alertActive(){return this._alertActive}set alertActive(e){this._alertActive=e}get isAlertActive(){return this._alertActive}dismissAlert(){this.clearAlert()}destroy(){this.stopTick(),Q(this),this.clearAlert(),this._timers=[],this._knownTimerIds=[],V(),L(this)}processStateChange(e){!function(e,t){let n=t.active_timers;const i=t.last_timer_event;n&&Array.isArray(n)||(n=[]);const r=JSON.stringify(n);if(r===D)return;e.log.log("timer",`State changed: timers=${r} last_event=${i}`),D=r;const s=n.map(e=>e.id),o=e.knownTimerIds.filter(e=>!s.includes(e));o.length>0&&"finished"===i&&(e.log.log("timer",`Timer(s) finished: ${o.join(", ")}`),e.alertActive||e.showAlert());for(const t of o)e.removePill(t);e.knownTimerIds=s,e.syncTimers(n)}(this,e)}syncTimers(e){if(0===e.length)return this._timers=[],this.stopTick(),void Q(this);const t=Date.now(),n=[];for(const i of e){const e=this._timers.find(e=>e.id===i.id),r=i.started_at?1e3*i.started_at:t;if(e){if(e.totalSeconds!==i.total_seconds){e.totalSeconds=i.total_seconds,e.startedAt=r;const n=Math.floor((t-r)/1e3);e.secondsLeft=Math.max(0,i.total_seconds-n),e.startHours=i.start_hours||0,e.startMinutes=i.start_minutes||0,e.startSeconds=i.start_seconds||0}n.push(e)}else{const e=Math.floor((t-r)/1e3);n.push({id:i.id,name:i.name||"",totalSeconds:i.total_seconds,secondsLeft:Math.max(0,i.total_seconds-e),startedAt:r,startHours:i.start_hours||0,startMinutes:i.start_minutes||0,startSeconds:i.start_seconds||0,el:null})}}var i;this._timers=n,this.startTick(),(i=this).card.ui.syncTimerPills(i.timers,e=>()=>i.cancelTimer(e))}startTick(){this._tickInterval||(this._tickInterval=setInterval(()=>function(e){const t=Date.now();for(const n of e.timers){const i=Math.floor((t-n.startedAt)/1e3),r=Math.max(0,n.totalSeconds-i);n.secondsLeft=r,e.card.ui.updateTimerPill(n.el,r,n.totalSeconds)}}(this),1e3))}stopTick(){this._tickInterval&&(clearInterval(this._tickInterval),this._tickInterval=null)}showAlert(){!function(e){if(e.alertActive)return void e.log.log("timer","Alert already active, skipping duplicate");e.alertActive=!0,e.log.log("timer","Showing finished alert"),e.card.ui.showBlurOverlay(c),e.card.startWakeSwitchKeepAlive(),e.card.ui.showTimerAlert(()=>e.clearAlert()),j(e),z&&clearInterval(z),z=setInterval(()=>j(e),3e3);const t=e.card.config.timer_finished_duration;t>0&&(H&&clearTimeout(H),H=setTimeout(()=>e.clearAlert(),1e3*t))}(this)}clearAlert(){var e;(e=this).alertActive&&(e.alertActive=!1,e.card.stopWakeSwitchKeepAlive(),z&&(clearInterval(z),z=null),H&&(clearTimeout(H),H=null),e.card.ui.clearTimerAlert(),e.stopTick(),Q(e),e.timers=[],e.card.ui.hideBlurOverlay(c),e.log.log("timer","Alert dismissed"))}removePill(e){K(this,e)}cancelTimer(e){this._log.log("timer",`Cancelling timer: ${e}`);const t=this._timers.find(t=>t.id===e);!function(e,t){if(!e.hass||!e.config.satellite_entity)return;const n=t?`cancel the ${t}`:"cancel the timer";e.hass.callService("conversation","process",{text:n,agent_id:"conversation.home_assistant"}).then(()=>{e.logger.log("timer","Cancel service called successfully")}).catch(t=>{e.logger.error("timer",`Cancel service failed: ${t.message||JSON.stringify(t)}`)})}(this._card,t?.name),K(this,e);const n=this._timers.findIndex(t=>t.id===e);-1!==n&&this._timers.splice(n,1);const i=this._knownTimerIds.indexOf(e);-1!==i&&this._knownTimerIds.splice(i,1),V(),0===this._timers.length&&(this.stopTick(),setTimeout(()=>{0===this._timers.length&&Q(this)},500))}}let J=0;function Y(e,t,n){const{config:i,connection:r}=e.card;i.satellite_entity&&M(e.card)&&(e._subscribed||r&&P(e,r,i.satellite_entity,t,n))}function X(e){L(e)}function Z(e,t,n){if(!t.announcement)return null;const i=t.announcement;if(!i.id)return null;if(i.id<=J)return null;if(e.playing)return e.log.log(n,`Notification #${i.id} ignored - already playing`),null;const r=e.card.currentState;return"WAKE_WORD_DETECTED"===r||"STT"===r||"INTENT"===r||"TTS"===r||e.card.tts.isPlaying?(e.queued&&e.queued.id===i.id||(e.queued=i,e.log.log(n,`Notification #${i.id} queued - pipeline busy (${r})`)),null):(e.queued=null,i)}function ee(e){J=e}function te(e){if(!e.queued)return null;const t=e.queued;return e.queued=null,t.id<=(J||0)||e.playing?null:(J=t.id,t)}function ne(e,t,n,i){e.playing=!0,e.card.ui.showBlurOverlay(d),e.card.startWakeSwitchKeepAlive(),e.barWasVisible=e.card.ui.showBarSpeaking(),!t.ask_question&&!t.start_conversation&&e.card.ui.setAnnouncementMode(!0),!1===t.preannounce?(e.log.log(i,"Preannounce disabled — skipping chime"),ie(e,t,n,i)):t.preannounce_media_id&&""!==t.preannounce_media_id?(e.log.log(i,`Playing pre-announcement media: ${t.preannounce_media_id}`),se(e,t.preannounce_media_id,i,()=>{ie(e,t,n,i)})):(f(e.card,g,{onDone:()=>ie(e,t,n,i),log:e.log}),e.log.log(i,"Announcement chime played"))}function ie(e,t,n,i){const r=t.media_id||"";if(t.message){const n=!t.ask_question&&!t.start_conversation;e.card.ui.addChatMessage(t.message,n?"announcement":"assistant")}r?(e.log.log(i,`Playing media: ${r}`),se(e,r,i,()=>n(t))):(e.log.log(i,"No media — completing after message display"),setTimeout(()=>n(t),3e3))}function re(e){e.clearTimeoutId&&(clearTimeout(e.clearTimeoutId),e.clearTimeoutId=null),e.card.ui.setAnnouncementMode(!1),e.card.ui.clearAnnouncementBubbles(),e.card.ui.hideBlurOverlay(d),e.card.ui.restoreBar(e.barWasVisible)}function se(e,t,n,i){const r=v(t),s=e.card.config.tts_volume/100;e.currentAudio=y(r,s,{onEnd:()=>{e.log.log(n,"Media playback complete"),e.currentAudio=null,i?.()},onError:t=>{e.log.error(n,`Media playback error: ${t}`),e.currentAudio=null,i?.()},onStart:()=>{e.log.log(n,"Media playback started")}})}function oe(e){e.playing=!1,e.currentAudio=null,e.clearTimeoutId=null,e.barWasVisible=!1,e.queued=null}function ae(e,t,n){const{connection:i,config:r}=e;i&&r.satellite_entity?i.sendMessagePromise({type:"voice_satellite/announce_finished",entity_id:r.satellite_entity,announce_id:t}).then(()=>{e.logger.log(n,`ACK sent for #${t}`)}).catch(t=>{e.logger.error(n,`ACK failed: ${t.message||JSON.stringify(t)}`)}):e.logger.error(n,"Cannot ACK — no connection or entity")}const le="announce";class ce{constructor(e){this._card=e,this._log=e.logger,oe(this)}get card(){return this._card}get log(){return this._log}update(){Y(this,e=>this._onStateChange(e),le)}destroy(){X(this)}playQueued(){const e=te(this);e&&(this._log.log(le,`Playing queued announcement #${e.id}`),this._play(e))}_onStateChange(e){const t=Z(this,e,le);t&&(t.ask_question||t.start_conversation||(ee(t.id),this._log.log(le,`New announcement #${t.id}: message="${t.message||""}" media="${t.media_id||""}"`),this._play(t)))}_play(e){ne(this,e,e=>this._onComplete(e),le)}_onComplete(e){this.playing=!1,this.currentAudio=null,this._log.log(le,`Announcement #${e.id} playback complete`),ae(this._card,e.id,le);const t=1e3*(this._card.config.announcement_display_duration||5);this.clearTimeoutId=setTimeout(()=>re(this),t)}}const de="ask-question";class ue{constructor(e){this._card=e,this._log=e.logger,oe(this)}get card(){return this._card}get log(){return this._log}update(){Y(this,e=>this._onStateChange(e),de)}destroy(){X(this)}playQueued(){const e=te(this);e&&(this._log.log(de,`Playing queued ask_question #${e.id}`),this._play(e))}_onStateChange(e){const t=Z(this,e,de);t&&t.ask_question&&(ee(t.id),this._log.log(de,`New ask_question #${t.id}: message="${t.message||""}" media="${t.media_id||""}"`),this._play(t))}_play(e){ne(this,e,e=>this._onComplete(e),de)}_onComplete(e){this.playing=!1,this.currentAudio=null,this._log.log(de,`Question #${e.id} playback complete`),ae(this._card,e.id,de),this._enterSttMode(e)}_enterSttMode(e){this._log.log(de,"Entering STT-only mode"),this._card.ui.setAnnouncementMode(!1),this._card.ui.showBlurOverlay(l);const{pipeline:t}=this._card;if(!t)return;const n=e.id,i=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;i||this._card.tts.playChime("wake"),this._answerSent=!1,t.restartContinue(null,{end_stage:"stt",onSttEnd:e=>{this._log.log(de,`STT result: "${e}"`),this._answerSent=!0,this._processAnswer(n,e,i)}}),this._sttSafetyTimeout=setTimeout(()=>{this._answerSent||(this._log.log(de,`No STT result for #${n} — sending empty answer to release server`),this._answerSent=!0,this._processAnswer(n,"",i))},3e4)}_processAnswer(e,t,n){this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null);const{pipeline:i}=this._card;let r=!1,s=null;setTimeout(()=>{r||(r=!0,this._card.stopWakeSwitchKeepAlive(),null===s||s||this._card.ui.clearErrorBar(),re(this),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),i.restart(0))},2e3),function(e,t,n,i){const{connection:r,config:s}=e,o=e.logger;if(!r||!s.satellite_entity)return o.error(i,"Cannot send answer — no connection or entity"),Promise.resolve(null);const a={type:"voice_satellite/question_answered",entity_id:s.satellite_entity,announce_id:t,sentence:n||""};return r.sendMessagePromise(a).then(e=>{const r=e?.matched,s=e?.id;return o.log(i,`Answer sent for #${t}: "${n}" — matched: ${r}${s?` (id: ${s})`:""}`),e}).catch(e=>(o.error(i,`Answer failed: ${e.message||JSON.stringify(e)}`),null))}(this._card,e,t,de).then(e=>{const t=e?.matched;if(s=t,n||this._card.tts.playChime(t?"done":"error"),!t){this._card.ui.showErrorBar();const e=this._card.ui.element?this._card.ui.element.querySelector(".vs-rainbow-bar"):null;e&&(e.classList.add("error-flash"),e.addEventListener("animationend",function t(){e.classList.remove("error-flash"),e.removeEventListener("animationend",t)}))}})}}const he="start-conversation";class _e{constructor(e){this._card=e,this._log=e.logger,oe(this)}get card(){return this._card}get log(){return this._log}update(){Y(this,e=>this._onStateChange(e),he)}destroy(){X(this)}playQueued(){const e=te(this);e&&(this._log.log(he,`Playing queued start_conversation #${e.id}`),this._play(e))}_onStateChange(e){const t=Z(this,e,he);t&&t.start_conversation&&(ee(t.id),this._log.log(he,`New start_conversation #${t.id}: message="${t.message||""}" media="${t.media_id||""}"`),this._play(t))}_play(e){ne(this,e,e=>this._onComplete(e),he)}_onComplete(e){this.playing=!1,this.currentAudio=null,this._log.log(he,`Prompt #${e.id} playback complete`),ae(this._card,e.id,he),re(this),this._card.ui.showBlurOverlay(l);const{pipeline:t}=this._card;t&&t.restartContinue(null)}}const pe=[{name:"pipeline_id",selector:{assist_pipeline:{}}},{name:"satellite_entity",selector:{entity:{filter:{domain:"assist_satellite",integration:"voice_satellite"}}}},{name:"state_entity",selector:{entity:{filter:{domain:"input_text"}}}},{name:"wake_word_switch",selector:{entity:{filter:[{domain:"switch"},{domain:"input_boolean"}]}}},{name:"continue_conversation",selector:{boolean:{}}},{name:"debug",selector:{boolean:{}}},{type:"expandable",name:"",title:"Microphone Processing",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"noise_suppression",selector:{boolean:{}}},{name:"echo_cancellation",selector:{boolean:{}}},{name:"auto_gain_control",selector:{boolean:{}}},{name:"voice_isolation",selector:{boolean:{}}}]}]},{type:"expandable",name:"",title:"Timeouts",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"pipeline_timeout",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}},{name:"pipeline_idle_timeout",selector:{number:{min:0,max:3600,step:1,unit_of_measurement:"s",mode:"box"}}}]}]}],me=[{type:"expandable",name:"",title:"Volume & Chimes",flatten:!0,schema:[{name:"tts_target",selector:{entity:{filter:{domain:"media_player"}}}},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}},{name:"tts_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_on_wake_word",selector:{boolean:{}}},{name:"chime_on_request_sent",selector:{boolean:{}}}]}]},{type:"expandable",name:"",title:"Announcements (requires integration)",flatten:!0,schema:[{name:"announcement_display_duration",selector:{number:{min:1,max:60,step:1,unit_of_measurement:"s",mode:"slider"}}}]}],ge=[{type:"expandable",name:"",title:"Timer Pill (requires integration)",flatten:!0,schema:[{name:"timer_position",selector:{select:{options:[{value:"top-left",label:"Top Left"},{value:"top-right",label:"Top Right"},{value:"bottom-left",label:"Bottom Left"},{value:"bottom-right",label:"Bottom Right"}],mode:"dropdown"}}},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_color",selector:{text:{}}},{name:"timer_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_bold",selector:{boolean:{}}},{name:"timer_font_italic",selector:{boolean:{}}},{name:"timer_rounded",selector:{boolean:{}}}]},{name:"timer_border_color",selector:{text:{}}},{name:"timer_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_finished_duration",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}}]}],be=[{type:"expandable",name:"",title:"Activity Bar",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"bar_position",selector:{select:{options:[{value:"bottom",label:"Bottom"},{value:"top",label:"Top"}],mode:"dropdown"}}},{name:"bar_height",selector:{number:{min:2,max:40,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{name:"bar_gradient",selector:{text:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"background_blur",selector:{boolean:{}}},{name:"background_blur_intensity",selector:{number:{min:0,max:20,step:1,mode:"slider"}}}]}]}],fe=[{type:"expandable",name:"",title:"Bubble Style",flatten:!0,schema:[{name:"bubble_style",selector:{select:{options:[{value:"centered",label:"Centered"},{value:"chat",label:"Chat style"}],mode:"dropdown"}}},{name:"bubble_container_width",selector:{number:{min:40,max:100,step:5,unit_of_measurement:"%",mode:"slider"}}}]},{type:"expandable",name:"",title:"Transcription Bubble",flatten:!0,schema:[{name:"show_transcription",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"transcription_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_color",selector:{text:{}}},{name:"transcription_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_bold",selector:{boolean:{}}},{name:"transcription_font_italic",selector:{boolean:{}}},{name:"transcription_rounded",selector:{boolean:{}}}]},{name:"transcription_border_color",selector:{text:{}}},{name:"transcription_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{type:"expandable",name:"",title:"Response Bubble",flatten:!0,schema:[{name:"show_response",selector:{boolean:{}}},{name:"streaming_response",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"response_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_color",selector:{text:{}}},{name:"response_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_bold",selector:{boolean:{}}},{name:"response_font_italic",selector:{boolean:{}}},{name:"response_rounded",selector:{boolean:{}}}]},{name:"response_border_color",selector:{text:{}}},{name:"response_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]}],ve=Object.assign({},{pipeline_id:"Assist Pipeline",wake_word_switch:"Wake word switch entity",state_entity:"State tracking entity",satellite_entity:"Satellite entity",continue_conversation:"Continue conversation mode",debug:"Debug logging",noise_suppression:"Noise suppression",echo_cancellation:"Echo cancellation",auto_gain_control:"Auto gain control",voice_isolation:"Voice isolation (Chrome only)",pipeline_timeout:"Pipeline timeout",pipeline_idle_timeout:"Idle restart timeout"},{tts_target:"TTS output device",chime_volume:"Chime volume",tts_volume:"TTS volume",chime_on_wake_word:"Chime on wake word",chime_on_request_sent:"Chime on request sent",announcement_display_duration:"Announcement display duration"},{timer_position:"Timer position",timer_font_size:"Font size",timer_font_family:"Font family",timer_font_color:"Font color",timer_background:"Background color",timer_font_bold:"Bold",timer_font_italic:"Italic",timer_rounded:"Rounded corners",timer_border_color:"Border color",timer_padding:"Padding",timer_finished_duration:"Auto-dismiss timer"},{bar_position:"Bar position",bar_height:"Bar height",bar_gradient:"Gradient colors",background_blur:"Background blur",background_blur_intensity:"Blur intensity"},{bubble_style:"Bubble layout",bubble_container_width:"Container width",show_transcription:"Show transcription",transcription_font_size:"Font size",transcription_font_family:"Font family",transcription_font_color:"Font color",transcription_background:"Background color",transcription_font_bold:"Bold",transcription_font_italic:"Italic",transcription_rounded:"Rounded corners",transcription_border_color:"Border color",transcription_padding:"Padding",show_response:"Show response",streaming_response:"Streaming response",response_font_size:"Font size",response_font_family:"Font family",response_font_color:"Font color",response_background:"Background color",response_font_bold:"Bold",response_font_italic:"Italic",response_rounded:"Rounded corners",response_border_color:"Border color",response_padding:"Padding"}),ye=Object.assign({},{wake_word_switch:"Turn OFF this switch when wake word is detected (e.g., Fully Kiosk screensaver)",state_entity:"Updates with ACTIVE/IDLE for per-device automations",satellite_entity:"Requires Voice Satellite Card Integration. Enables timers and announcements. https://github.com/jxlarrea/voice-satellite-card-integration",pipeline_timeout:"Max seconds to wait for pipeline response (0 = no timeout)",pipeline_idle_timeout:"Seconds before pipeline restarts to keep connection fresh",voice_isolation:"AI-based voice isolation, currently only available in Chrome"},{tts_target:"Leave empty for browser audio, or select a media player entity",announcement_display_duration:"Seconds to show announcement bubble after playback"},{timer_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",timer_border_color:"CSS color value (supports rgba)",timer_finished_duration:"Seconds to show finished timer alert (0 = until dismissed)"},{bar_gradient:"Comma-separated CSS color values"},{bubble_style:"Centered: bubbles centered on screen. Chat: user right, assistant left",bubble_container_width:"Width of the bubble area (useful for large screens)",transcription_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",transcription_border_color:"CSS color value (supports rgba)",response_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",response_border_color:"CSS color value (supports rgba)"});function we(e){let t=e;for(let e=0;e<20&&t;e++){const e=t.tagName;if("HUI-CARD-PREVIEW"===e)return!0;if("HUI-CARD"===e&&t.hasAttribute("preview"))return!0;if(e&&e.includes("PREVIEW"))return!0;t=t.parentElement||(t.getRootNode&&t.getRootNode()).host}return!1}function Se(e,t){const n=Object.assign({},u,t);e.innerHTML='\n    <style>\n      :host {\n        display: block;\n        position: relative;\n        overflow: hidden;\n        border-radius: var(--ha-card-border-radius, 12px);\n        min-height: 280px;\n      }\n      .preview-background {\n        position: absolute;\n        top: 0; left: 0; right: 0; bottom: 0;\n        background-image:\n          linear-gradient(45deg, #e0e0e0 25%, transparent 25%),\n          linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),\n          linear-gradient(45deg, transparent 75%, #e0e0e0 75%),\n          linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);\n        background-size: 20px 20px;\n        background-position: 0 0, 0 10px, 10px -10px, -10px 0;\n        background-color: #f5f5f5;\n      }\n      @media (prefers-color-scheme: dark) {\n        .preview-background {\n          background-image:\n            linear-gradient(45deg, #333 25%, transparent 25%),\n            linear-gradient(-45deg, #333 25%, transparent 25%),\n            linear-gradient(45deg, transparent 75%, #333 75%),\n            linear-gradient(-45deg, transparent 75%, #333 75%);\n          background-color: #222;\n        }\n      }\n      :host-context([data-theme="dark"]) .preview-background,\n      :host-context(.dark) .preview-background {\n        background-image:\n          linear-gradient(45deg, #333 25%, transparent 25%),\n          linear-gradient(-45deg, #333 25%, transparent 25%),\n          linear-gradient(45deg, transparent 75%, #333 75%),\n          linear-gradient(-45deg, transparent 75%, #333 75%);\n        background-color: #222;\n      }\n      .preview-container {\n        position: relative;\n        width: 100%;\n        min-height: 280px;\n        box-sizing: border-box;\n        display: flex;\n        flex-direction: column;\n        justify-content: center;\n        padding: 24px 16px;\n      }\n      .preview-blur {\n        position: absolute;\n        top: 0; left: 0; right: 0; bottom: 0;\n        z-index: 1;\n        pointer-events: none;\n      }\n      .preview-bar {\n        position: absolute;\n        left: 0;\n        right: 0;\n        z-index: 2;\n        background-size: 200% 100%;\n        animation: preview-slide 2s linear infinite;\n      }\n      @keyframes preview-slide {\n        0% { background-position: 200% 0; }\n        100% { background-position: 0% 0; }\n      }\n      .preview-chat {\n        position: relative;\n        z-index: 3;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        width: 80%;\n        margin: 0 auto;\n      }\n      .preview-msg {\n        max-width: 85%;\n        word-wrap: break-word;\n        text-align: center;\n        line-height: 1.0;\n        animation: preview-fade-in 0.3s ease;\n      }\n      .preview-msg.user {\n        align-self: center;\n      }\n      .preview-msg.assistant {\n        align-self: center;\n      }\n      @keyframes preview-fade-in {\n        from { opacity: 0; transform: translateY(8px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      .preview-timer {\n        position: absolute;\n        z-index: 4;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        overflow: hidden;\n      }\n      .preview-timer-progress {\n        position: absolute;\n        top: 0;\n        left: 0;\n        height: 100%;\n        opacity: 0.3;\n        border-radius: inherit;\n      }\n      .preview-timer-content {\n        position: relative;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n      }\n    </style>\n    <div class="preview-background"></div>\n    <div class="preview-container">\n      <div class="preview-blur"></div>\n      <div class="preview-bar"></div>\n      <div class="preview-chat">\n        <div class="preview-msg user"></div>\n        <div class="preview-msg assistant"></div>\n      </div>\n      <div class="preview-timer">\n        <div class="preview-timer-progress"></div>\n        <div class="preview-timer-content">\n          <span>⏱</span>\n          <span class="preview-timer-time">00:04:32</span>\n        </div>\n      </div>\n    </div>\n  ',e.querySelector(".preview-container");const i=e.querySelector(".preview-blur");n.background_blur&&(i.style.backdropFilter=`blur(${n.background_blur_intensity}px)`,i.style.webkitBackdropFilter=`blur(${n.background_blur_intensity}px)`);const r=e.querySelector(".preview-bar");r.style.height=`${n.bar_height}px`,r.style.background=h(n.bar_gradient),r.style.backgroundSize="200% 100%","top"===n.bar_position?(r.style.top="0",r.style.bottom="auto"):(r.style.bottom="0",r.style.top="auto");const s=e.querySelector(".preview-msg.user");n.show_transcription?(s.textContent="What's the temperature outside?",C(s,n,"transcription")):s.style.display="none";const o=e.querySelector(".preview-msg.assistant");n.show_response?(o.textContent="It's currently 75°F and sunny.",C(o,n,"response")):o.style.display="none";const a=e.querySelector(".preview-chat"),l="chat"===n.bubble_style;a.style.width=`${n.bubble_container_width||80}%`,l?(a.style.alignItems="flex-start",s.style.alignSelf="flex-end",s.style.textAlign="left",o.style.alignSelf="flex-start",o.style.textAlign="left"):(a.style.alignItems="center",s.style.alignSelf="center",s.style.textAlign="center",o.style.alignSelf="center",o.style.textAlign="center"),"bottom"===n.bar_position?a.style.marginBottom=`${n.bar_height+8}px`:a.style.marginTop=`${n.bar_height+8}px`;const c=e.querySelector(".preview-timer");if(n.satellite_entity){C(c,n,"timer");const t=e.querySelector(".preview-timer-progress"),i=n.timer_border_color||"rgba(100, 200, 150, 0.5)";t.style.background=i,t.style.width="65%";const r=8,s=n.timer_position||"bottom-right";c.style.top=s.startsWith("top")?`${n.bar_height+r+4}px`:"auto",c.style.bottom=s.startsWith("top")?"auto":`${n.bar_height+r+4}px`,c.style.left=s.includes("left")?`${r}px`:"auto",c.style.right=s.includes("left")?"auto":`${r}px`}else c.style.display="none"}function ke(e,t){const n=e.config.satellite_entity;n&&e.hass?.connection&&t!==e.lastSyncedSatelliteState&&(e.lastSyncedSatelliteState=t,e.hass.connection.sendMessagePromise({type:"voice_satellite/update_state",entity_id:n,state:t}).catch(()=>{}))}function Te(e,t){const n=e.config.state_entity;n&&e.hass&&(e.logger.log("state_entity",`${n} → ${t}`),e.hass.callService("input_text","set_value",{entity_id:n,value:t}).catch(t=>{e.logger.error("state_entity",`Failed to update ${n}: ${t}`)}))}function Ce(e){if(!e.config.wake_word_switch||!e.hass)return;const t=e.config.wake_word_switch;t.includes(".")?(e.logger.log("switch",`Turning off: ${t}`),e.hass.callService("homeassistant","turn_off",{entity_id:t}).catch(t=>{e.logger.error("switch",`Failed to turn off: ${t}`)})):e.logger.log("switch",`Invalid entity: ${t}`)}let xe=null;function Ae(i,r){const s=i.currentState;i.currentState=r,i.logger.log("state",`${s} → ${r}`),i.ui.updateForState(r,i.pipeline.serviceUnavailable,i.tts.isPlaying),o.includes(r)&&Ce(i),r===n&&Te(i,"ACTIVE"),(!i.tts.isPlaying||r!==t&&r!==e)&&ke(i,r)}async function Ie(t){if(!W()||M(t))if(F())t.logger.log("lifecycle","Pipeline already starting globally, skipping");else{O(!0);try{Ae(t,"CONNECTING"),await t.audio.startMicrophone(),await t.pipeline.start(),function(e){N.instance=e,N.active=!0}(t),t.ui.hideStartButton(),t.timer.update(),t.announcement.update(),t.askQuestion.update(),t.startConversation.update(),t.doubleTap.setup()}catch(n){const i=n?.message||JSON.stringify(n);t.logger.error("pipeline",`Failed to start: ${i}`);let r="error";"NotAllowedError"===n.name?(r="not-allowed",t.logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===n.name?(r="not-found",t.logger.error("mic","No microphone found")):"NotReadableError"!==n.name&&"AbortError"!==n.name||(r="not-readable",t.logger.error("mic","Microphone in use or not readable")),"error"!==r?(t.ui.showStartButton(r),Ae(t,e)):(Ae(t,e),t.pipeline.restart(t.pipeline.calculateRetryDelay()))}finally{O(!1)}}else t.logger.log("lifecycle","Another instance is active, skipping")}class Ee extends HTMLElement{constructor(){super(),this._state=e,this._lastSyncedSatelliteState=null,this._config=Object.assign({},u),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new _,this._audio=new p(this),this._tts=new S(this),this._pipeline=new T(this),this._ui=new A(this),this._chat=new $(this),this._doubleTap=new B(this),this._visibility=new U(this),this._timer=new G(this),this._announcement=new ce(this),this._askQuestion=new ue(this),this._startConversation=new _e(this)}get logger(){return this._logger}get audio(){return this._audio}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get doubleTap(){return this._doubleTap}get visibility(){return this._visibility}get config(){return this._config}get timer(){return this._timer}get announcement(){return this._announcement}get askQuestion(){return this._askQuestion}get startConversation(){return this._startConversation}get currentState(){return this._state}set currentState(e){this._state=e}get lastSyncedSatelliteState(){return this._lastSyncedSatelliteState}set lastSyncedSatelliteState(e){this._lastSyncedSatelliteState=e}get isOwner(){return M(this)}get connection(){return!this._connection&&this._hass?.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render(),requestAnimationFrame(()=>{we(this)&&this.shadowRoot?Se(this.shadowRoot,this._config):(this._ui.ensureGlobalUI(),this._visibility.setup(),!W()&&this._hass?.connection&&Ie(this))})}disconnectedCallback(){this._disconnectTimeout=setTimeout(()=>{},100)}setConfig(e){this._config=Object.assign({},u,e),this._logger.debug=this._config.debug,this._ui.element&&this._ui.applyStyles(),this.shadowRoot&&we(this)&&Se(this.shadowRoot,this._config),N.instance&&N.instance!==this&&N.instance.setConfig(this.config)}set hass(e){this._hass=e,we(this)||(W()&&M(this)&&(this._timer.update(),this._announcement.update(),this._askQuestion.update(),this._startConversation.update()),this._hasStarted||e?.connection&&(F()||W()&&!M(this)||(this._connection=e.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,Ie(this)):(this._hasStarted=!0,this._ui.showStartButton()))))}getCardSize(){return 0}static getConfigForm(){return{schema:[...pe,...me,...ge,...be,...fe],computeLabel:e=>ve[e.name]||void 0,computeHelper:e=>ye[e.name]||void 0}}static getStubConfig(){return{start_listening_on_load:!0}}setState(e){Ae(this,e)}onStartClick(){!async function(e){await e.audio.ensureAudioContextForGesture(),await Ie(e)}(this)}onPipelineMessage(e){!function(e,t){if(e.visibility.isPaused)return void e.logger.log("event",`Ignoring event while paused: ${t.type}`);if(e.pipeline.isRestarting)return void e.logger.log("event",`Ignoring event while restarting: ${t.type}`);const n=t.type,o=t.data||{};if(e.config.debug){const i=t.timestamp?t.timestamp.split("T")[1].split(".")[0]:"";e.logger.log("event",`${i} ${n} ${JSON.stringify(o).substring(0,500)}`)}switch(n){case"run-start":e.pipeline.handleRunStart(o);break;case"wake_word-start":e.pipeline.handleWakeWordStart();break;case"wake_word-end":e.pipeline.handleWakeWordEnd(o);break;case"stt-start":Ae(e,i);break;case"stt-vad-start":e.logger.log("event","VAD: speech started");break;case"stt-vad-end":e.logger.log("event","VAD: speech ended");break;case"stt-end":e.pipeline.handleSttEnd(o);break;case"intent-start":Ae(e,r);break;case"intent-progress":e.config.streaming_response&&e.pipeline.handleIntentProgress(o);break;case"intent-end":e.pipeline.handleIntentEnd(o);break;case"tts-start":Ae(e,s);break;case"tts-end":e.pipeline.handleTtsEnd(o);break;case"run-end":e.pipeline.handleRunEnd();break;case"error":e.pipeline.handleError(o)}}(this,e)}onTTSComplete(e){!function(e,t){if([n,i,r].includes(e.currentState))return void e.logger.log("tts","New interaction in progress — skipping cleanup");if(!t&&e.pipeline.shouldContinue&&e.pipeline.continueConversationId){e.logger.log("pipeline","Continuing conversation — skipping wake word");const t=e.pipeline.continueConversationId;return e.pipeline.clearContinueState(),e.chat.streamEl=null,void e.pipeline.restartContinue(t)}const s=e.config.tts_target&&"browser"!==e.config.tts_target;e.config.chime_on_request_sent&&!s&&e.tts.playChime("done"),e.stopWakeSwitchKeepAlive(),e.chat.clear(),e.ui.hideBlurOverlay(l),e.ui.updateForState(e.currentState,e.pipeline.serviceUnavailable,!1),Te(e,"IDLE"),ke(e,"IDLE"),e.announcement.playQueued(),e.askQuestion.playQueued(),e.startConversation.playQueued()}(this,e)}turnOffWakeWordSwitch(){Ce(this)}startWakeSwitchKeepAlive(){var e;e=this,xe||(Ce(e),xe=setInterval(()=>Ce(e),5e3))}stopWakeSwitchKeepAlive(){xe&&(clearInterval(xe),xe=null)}updateInteractionState(e){Te(this,e)}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),we(this)?Se(this.shadowRoot,this._config):this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}}customElements.define("voice-satellite-card",Ee),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v3.3.2 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();