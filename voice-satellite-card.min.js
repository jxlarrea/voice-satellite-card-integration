(()=>{"use strict";const e="IDLE",t="LISTENING",n="WAKE_WORD_DETECTED",r="STT",i="INTENT",s="TTS",a=[n,r,i,s],o=["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"],l="pipeline",c="timer",d="announcement",u={satellite_entity:"",debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,skin:"default",custom_css:"",text_scale:100,reactive_bar:!0},h={id:"default",name:"Default",css:"/* Default Skin */\r\n\r\n/* Font */\r\n#voice-satellite-ui {\r\n  font-family: Roboto, Noto, sans-serif;\r\n}\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(4px);\r\n  -webkit-backdrop-filter: blur(4px);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  height: 16px;\r\n  background: linear-gradient(90deg, #FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC, #FF7777);\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  background: linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222, #ff4444);\r\n  background-size: 200% 100%;\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-flash {\r\n  animation: vs-error-flash 0.15s ease-in-out 3;\r\n}\r\n\r\n/* Reactive Bar — audio-driven height and glow, speed varies by state */\r\n#voice-satellite-ui .vs-rainbow-bar.reactive {\r\n  transition: height 0.05s linear, box-shadow 0.05s linear;\r\n  height: calc(16px + 8px * var(--vs-audio-level, 0));\r\n  box-shadow:\r\n    0 0 calc(5px + 20px * var(--vs-audio-level, 0)) calc(2px + 8px * var(--vs-audio-level, 0)) rgba(200, 170, 255, calc(0.15 + 0.4 * var(--vs-audio-level, 0))),\r\n    0 0 calc(8px + 30px * var(--vs-audio-level, 0)) calc(4px + 12px * var(--vs-audio-level, 0)) rgba(240, 240, 255, calc(0.1 + 0.25 * var(--vs-audio-level, 0)));\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n@keyframes vs-error-flash {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  bottom: 56px;\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: flex-start;\r\n  gap: 14px;\r\n  max-width: 85%;\r\n  width: 85%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui.reactive-mode .vs-chat-container {\r\n  bottom: 80px;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.announcement-mode {\r\n  top: 50% !important;\r\n  bottom: auto !important;\r\n  transform: translate(-50%, -50%);\r\n}\r\n\r\n/* Chat Messages */\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  opacity: 0;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.user {\r\n  font-size: calc(30px * var(--vs-text-scale, 1));\r\n  color: #444444;\r\n  font-weight: normal;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(0, 180, 255, 0.5);\r\n  padding: 16px 36px 16px 16px;\r\n  border-radius: 12px;\r\n  align-self: flex-end;\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.assistant {\r\n  font-size: calc(30px * var(--vs-text-scale, 1));\r\n  color: #444444;\r\n  font-weight: normal;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(100, 200, 150, 0.5);\r\n  padding: 16px 36px 16px 16px;\r\n  border-radius: 12px;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.announcement {\r\n  font-size: calc(30px * var(--vs-text-scale, 1));\r\n  color: #444444;\r\n  font-weight: normal;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(100, 200, 150, 0.5);\r\n  padding: 16px;\r\n  border-radius: 12px;\r\n  align-self: center;\r\n  text-align: center;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}\r\n\r\n/* Timer Container */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  top: 12px;\r\n  right: 12px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  font-family: Roboto, Noto, sans-serif;\r\n}\r\n\r\n/* Timer Pills */\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  font-size: calc(30px * var(--vs-text-scale, 1));\r\n  color: #444444;\r\n  font-weight: bold;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(0, 180, 255, 0.5);\r\n  padding: 16px;\r\n  border-radius: 12px;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  background: rgba(0, 180, 255, 0.5);\r\n  opacity: 0.3;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: vs-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  font-size: calc(30px * var(--vs-text-scale, 1));\r\n  font-family: Roboto, Noto, sans-serif;\r\n  color: #444444;\r\n  font-weight: bold;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(0, 180, 255, 0.5);\r\n  padding: 16px;\r\n  border-radius: 12px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);\r\n  z-index: 10002;\r\n  animation: vs-timer-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes vs-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.05);\r\n  }\r\n}\r\n",reactiveBar:!0,overlayColor:[0,0,0],defaultOpacity:.3,previewCSS:"/* Default Skin — Editor Preview Overrides */\r\n\r\n.preview-container {\r\n  font-family: Roboto, Noto, sans-serif;\r\n}\r\n\r\n.preview-bar {\r\n  height: 16px;\r\n  background: linear-gradient(90deg, #FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC, #FF7777);\r\n  background-size: 200% 100%;\r\n}\r\n\r\n.preview-chat {\r\n  align-items: flex-start;\r\n}\r\n\r\n.preview-msg {\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n}\r\n\r\n.preview-msg.user {\r\n  font-size: 30px;\r\n  color: #444444;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(0, 180, 255, 0.5);\r\n  padding: 16px;\r\n  border-radius: 12px;\r\n  align-self: flex-end;\r\n  text-align: left;\r\n}\r\n\r\n.preview-msg.assistant {\r\n  font-size: 30px;\r\n  color: #444444;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(100, 200, 150, 0.5);\r\n  padding: 16px;\r\n  border-radius: 12px;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n\r\n.preview-timer {\r\n  color: #444444;\r\n  background: #ffffff;\r\n  border: 3px solid rgba(0, 180, 255, 0.5);\r\n  border-radius: 12px;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n}\r\n\r\n.preview-timer-progress {\r\n  background: rgba(0, 180, 255, 0.5);\r\n  opacity: 0.3;\r\n}\r\n\r\n.preview-label {\r\n  color: rgba(0, 0, 0, 0.35);\r\n}\r\n"},p={id:"alexa",name:"Alexa",css:'/* Alexa Skin */\r\n\r\n/* Font */\r\n#voice-satellite-ui {\r\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n/* Blur Overlay — darker, heavier blur for Alexa\'s dark aesthetic */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(8px);\r\n  -webkit-backdrop-filter: blur(8px);\r\n  opacity: 0;\r\n  transition: opacity 0.4s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button — cyan Alexa accent */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: #00CAFF;\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 16px rgba(0, 202, 255, 0.4);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: alexa-btn-pulse 2.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 24px rgba(0, 202, 255, 0.6);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes alexa-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 16px rgba(0, 202, 255, 0.4);\r\n  }\r\n  50% {\r\n    transform: scale(1.06);\r\n    box-shadow: 0 6px 28px rgba(0, 202, 255, 0.7);\r\n  }\r\n}\r\n\r\n/* Bottom Glow — full-width bar with strong glow */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  height: 6px;\r\n  border-radius: 3px 3px 0 0;\r\n  background: linear-gradient(90deg, #00CAFF, #00E5FF, #00CAFF);\r\n  background-size: 200% 100%;\r\n  box-shadow: 0 0 20px 6px rgba(0, 202, 255, 0.5), 0 0 40px 12px rgba(0, 202, 255, 0.2);\r\n  opacity: 0;\r\n  transition: opacity 0.4s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: alexa-breathe 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: alexa-glow 2s ease-in-out infinite, alexa-shimmer 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: alexa-glow 0.6s ease-in-out infinite, alexa-shimmer 1s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: alexa-speak 1.5s ease-in-out infinite, alexa-shimmer 4s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  background: #FF3B30;\r\n  box-shadow: 0 0 20px 5px rgba(255, 59, 48, 0.5);\r\n  animation: alexa-glow-red 1.5s ease-in-out infinite;\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-flash {\r\n  animation: alexa-error-flash 0.15s ease-in-out 3;\r\n}\r\n\r\n/* Reactive Bar — audio-driven glow, speed varies by state */\r\n#voice-satellite-ui .vs-rainbow-bar.reactive {\r\n  transition: box-shadow 0.05s linear;\r\n  box-shadow:\r\n    0 0 calc(10px + 35px * var(--vs-audio-level, 0)) calc(3px + 10px * var(--vs-audio-level, 0)) rgba(0, 202, 255, calc(0.3 + 0.5 * var(--vs-audio-level, 0))),\r\n    0 0 calc(16px + 40px * var(--vs-audio-level, 0)) calc(5px + 14px * var(--vs-audio-level, 0)) rgba(0, 202, 255, calc(0.1 + 0.25 * var(--vs-audio-level, 0)));\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.listening {\r\n  animation: alexa-shimmer 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.processing {\r\n  animation: alexa-shimmer 1s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.speaking {\r\n  animation: alexa-shimmer 4s linear infinite;\r\n}\r\n\r\n@keyframes alexa-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n    box-shadow: 0 0 12px 4px rgba(0, 202, 255, 0.2);\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n    box-shadow: 0 0 24px 8px rgba(0, 202, 255, 0.5);\r\n  }\r\n}\r\n\r\n@keyframes alexa-glow {\r\n  0%, 100% {\r\n    box-shadow: 0 0 20px 6px rgba(0, 202, 255, 0.5), 0 0 40px 12px rgba(0, 202, 255, 0.2);\r\n  }\r\n  50% {\r\n    box-shadow: 0 0 40px 14px rgba(0, 202, 255, 0.8), 0 0 60px 20px rgba(0, 202, 255, 0.3);\r\n  }\r\n}\r\n\r\n@keyframes alexa-speak {\r\n  0%, 100% {\r\n    box-shadow: 0 0 16px 5px rgba(0, 202, 255, 0.5), 0 0 30px 10px rgba(0, 202, 255, 0.2);\r\n  }\r\n  50% {\r\n    box-shadow: 0 0 30px 10px rgba(0, 202, 255, 0.7), 0 0 50px 16px rgba(0, 202, 255, 0.3);\r\n  }\r\n}\r\n\r\n@keyframes alexa-shimmer {\r\n  0% { background-position: 200% 0; }\r\n  100% { background-position: -200% 0; }\r\n}\r\n\r\n@keyframes alexa-glow-red {\r\n  0%, 100% {\r\n    box-shadow: 0 0 15px 3px rgba(255, 59, 48, 0.4);\r\n  }\r\n  50% {\r\n    box-shadow: 0 0 30px 8px rgba(255, 59, 48, 0.7);\r\n  }\r\n}\r\n\r\n@keyframes alexa-error-flash {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  bottom: 76px;\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 10px;\r\n  max-width: 85%;\r\n  width: 85%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui.reactive-mode .vs-chat-container {\r\n  bottom: 90px;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.announcement-mode {\r\n  top: 50% !important;\r\n  bottom: auto !important;\r\n  transform: translate(-50%, -50%);\r\n}\r\n\r\n/* Chat Messages — clean text on dark background, no bubbles */\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  opacity: 0;\r\n  animation: alexa-fade-in 0.35s ease forwards;\r\n  word-wrap: break-word;\r\n  background: none;\r\n  border: none;\r\n  box-shadow: none;\r\n  font-size: calc(36px * var(--vs-text-scale, 1));\r\n  font-weight: normal;\r\n  font-style: normal;\r\n  padding: 4px 0;\r\n  border-radius: 0;\r\n  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.user {\r\n  font-size: calc(32px * var(--vs-text-scale, 1));\r\n  color: rgba(255, 255, 255, 0.55);\r\n  font-weight: 300;\r\n  align-self: center;\r\n  text-align: center;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.assistant {\r\n  font-size: calc(42px * var(--vs-text-scale, 1));\r\n  color: #FFFFFF;\r\n  font-weight: bold;\r\n  align-self: center;\r\n  text-align: center;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.announcement {\r\n  font-size: calc(42px * var(--vs-text-scale, 1));\r\n  color: #FFFFFF;\r\n  font-weight: bold;\r\n  align-self: center;\r\n  text-align: center;\r\n}\r\n\r\n/* Animations */\r\n@keyframes alexa-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(10px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n/* Timer Container — top-right */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  top: 12px;\r\n  right: 12px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n/* Timer Pills — dark with cyan accent */\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  font-size: calc(34px * var(--vs-text-scale, 1));\r\n  color: #FFFFFF;\r\n  font-weight: bold;\r\n  font-style: normal;\r\n  background: rgba(10, 22, 40, 0.9);\r\n  border: 2px solid rgba(0, 202, 255, 0.35);\r\n  padding: 14px 18px;\r\n  border-radius: 16px;\r\n  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);\r\n  animation: alexa-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  background: rgba(0, 202, 255, 0.25);\r\n  opacity: 1;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: alexa-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert — dark with cyan glow */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  font-size: calc(34px * var(--vs-text-scale, 1));\r\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\r\n  color: #FFFFFF;\r\n  font-weight: bold;\r\n  font-style: normal;\r\n  background: rgba(10, 22, 40, 0.95);\r\n  border: 2px solid rgba(0, 202, 255, 0.4);\r\n  padding: 18px 24px;\r\n  border-radius: 16px;\r\n  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 202, 255, 0.2);\r\n  z-index: 10002;\r\n  animation: alexa-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes alexa-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes alexa-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes alexa-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 202, 255, 0.2);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.03);\r\n    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), 0 0 30px rgba(0, 202, 255, 0.4);\r\n  }\r\n}\r\n',reactiveBar:!0,overlayColor:[0,8,20],defaultOpacity:.7,previewCSS:'/* Alexa Skin — Editor Preview Overrides */\r\n\r\n.preview-container {\r\n  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\r\n}\r\n\r\n.preview-label {\r\n  color: rgba(255, 255, 255, 0.3);\r\n}\r\n.preview-blur {\r\n  background: rgba(0, 8, 20, 0.7);\r\n}\r\n.preview-bar {\r\n  height: 6px;\r\n  border-radius: 3px 3px 0 0;\r\n  background: linear-gradient(90deg, #00CAFF, #00E5FF, #00CAFF);\r\n  background-size: 200% 100%;\r\n  box-shadow: 0 0 20px 6px rgba(0, 202, 255, 0.5), 0 0 40px 12px rgba(0, 202, 255, 0.2);\r\n}\r\n.preview-chat {\r\n  align-items: center;\r\n}\r\n.preview-msg {\r\n  box-shadow: none;\r\n  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);\r\n}\r\n.preview-msg.user {\r\n  font-size: 32px;\r\n  color: rgba(255, 255, 255, 0.55);\r\n  font-weight: 300;\r\n  background: none;\r\n  border: none;\r\n  padding: 4px 0;\r\n  border-radius: 0;\r\n  align-self: center;\r\n  text-align: center;\r\n}\r\n.preview-msg.assistant {\r\n  font-size: 42px;\r\n  color: #FFFFFF;\r\n  font-weight: bold;\r\n  background: none;\r\n  border: none;\r\n  padding: 4px 0;\r\n  border-radius: 0;\r\n  align-self: center;\r\n  text-align: center;\r\n}\r\n.preview-timer {\r\n  color: #FFFFFF;\r\n  background: rgba(10, 22, 40, 0.9);\r\n  border: 2px solid rgba(0, 202, 255, 0.35);\r\n  border-radius: 16px;\r\n  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);\r\n}\r\n.preview-timer-progress {\r\n  background: rgba(0, 202, 255, 0.25);\r\n  opacity: 1;\r\n}\r\n'},g={id:"google-home",name:"Google Home",css:'/* Google Home Skin */\r\n\r\n/* Font */\r\n#voice-satellite-ui {\r\n  font-family: "Google Sans", Roboto, Noto, sans-serif;\r\n}\r\n\r\n/* Blur Overlay — light, frosted glass */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(6px);\r\n  -webkit-backdrop-filter: blur(6px);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button — Google Blue with material shadow */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: #4285F4;\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3), 0 4px 16px rgba(0, 0, 0, 0.15);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: google-btn-pulse 2.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 4px 12px rgba(66, 133, 244, 0.5), 0 6px 20px rgba(0, 0, 0, 0.2);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes google-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3), 0 4px 16px rgba(0, 0, 0, 0.15);\r\n  }\r\n  50% {\r\n    transform: scale(1.06);\r\n    box-shadow: 0 4px 16px rgba(66, 133, 244, 0.5), 0 6px 24px rgba(0, 0, 0, 0.2);\r\n  }\r\n}\r\n\r\n/* Google Bar — 4-color gradient, 60% width, floating above bottom */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 20%;\r\n  right: 20%;\r\n  bottom: 24px;\r\n  height: 4px;\r\n  border-radius: 2px;\r\n  background: linear-gradient(90deg, #4285F4, #4285F4 25%, #EA4335 25%, #EA4335 50%, #FBBC05 50%, #FBBC05 75%, #34A853 75%, #34A853);\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: google-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: google-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: google-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: google-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  background: linear-gradient(90deg, #EA4335, #d93025, #EA4335, #d93025);\r\n  background-size: 200% 100%;\r\n  animation: google-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-flash {\r\n  animation: google-error-flash 0.15s ease-in-out 3;\r\n}\r\n\r\n/* Reactive Bar — audio-driven pulsation, speed varies by state */\r\n#voice-satellite-ui .vs-rainbow-bar.reactive {\r\n  transition: height 0.05s linear, box-shadow 0.05s linear;\r\n  height: calc(4px + 12px * var(--vs-audio-level, 0));\r\n  box-shadow:\r\n    0 0 calc(4px + 14px * var(--vs-audio-level, 0)) calc(1px + 5px * var(--vs-audio-level, 0)) rgba(66, 133, 244, calc(0.15 + 0.35 * var(--vs-audio-level, 0)));\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.listening {\r\n  animation: google-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.processing {\r\n  animation: google-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.reactive.speaking {\r\n  animation: google-flow 2s linear infinite;\r\n}\r\n\r\n@keyframes google-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}\r\n\r\n@keyframes google-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes google-error-flash {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n\r\n/* Chat Container — left-aligned, Nest Hub style */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  bottom: 72px;\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: flex-start;\r\n  gap: 8px;\r\n  max-width: 85%;\r\n  width: 85%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui.reactive-mode .vs-chat-container {\r\n  bottom: 80px;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.announcement-mode {\r\n  top: 50% !important;\r\n  bottom: auto !important;\r\n  transform: translate(-50%, -50%);\r\n}\r\n\r\n/* Chat Messages — left-aligned text, no bubbles (Nest Hub style) */\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  opacity: 0;\r\n  animation: google-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n  background: none;\r\n  border: none;\r\n  box-shadow: none;\r\n  padding: 4px 0;\r\n  border-radius: 0;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.user {\r\n  font-size: calc(32px * var(--vs-text-scale, 1));\r\n  color: rgba(32, 33, 36, 0.5);\r\n  font-weight: normal;\r\n  font-style: normal;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.assistant {\r\n  font-size: calc(36px * var(--vs-text-scale, 1));\r\n  color: #202124;\r\n  font-weight: 400;\r\n  font-style: normal;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg.announcement {\r\n  font-size: calc(36px * var(--vs-text-scale, 1));\r\n  color: #202124;\r\n  font-weight: 400;\r\n  font-style: normal;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n\r\n/* Animations */\r\n@keyframes google-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n/* Timer Container */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  top: 12px;\r\n  right: 12px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  font-family: "Google Sans", Roboto, Noto, sans-serif;\r\n}\r\n\r\n/* Timer Pills — white material cards with Google Blue progress */\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  font-size: calc(28px * var(--vs-text-scale, 1));\r\n  color: #3c4043;\r\n  font-weight: bold;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: none;\r\n  padding: 14px 18px;\r\n  border-radius: 18px;\r\n  box-shadow: 0 1px 3px rgba(60, 64, 67, 0.15), 0 4px 8px rgba(60, 64, 67, 0.1);\r\n  animation: google-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  background: rgba(66, 133, 244, 0.15);\r\n  opacity: 1;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: google-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert — white card with Google Blue accent */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  font-size: calc(28px * var(--vs-text-scale, 1));\r\n  font-family: "Google Sans", Roboto, Noto, sans-serif;\r\n  color: #202124;\r\n  font-weight: bold;\r\n  font-style: normal;\r\n  background: #ffffff;\r\n  border: none;\r\n  padding: 18px 24px;\r\n  border-radius: 18px;\r\n  box-shadow: 0 2px 6px rgba(60, 64, 67, 0.15), 0 8px 24px rgba(60, 64, 67, 0.15);\r\n  z-index: 10002;\r\n  animation: google-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes google-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes google-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes google-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.04);\r\n    box-shadow: 0 2px 6px rgba(60, 64, 67, 0.15), 0 12px 32px rgba(66, 133, 244, 0.2);\r\n  }\r\n}\r\n',reactiveBar:!0,overlayColor:[255,255,255],defaultOpacity:.75,previewCSS:'/* Google Home Skin — Editor Preview Overrides */\r\n\r\n.preview-container {\r\n  font-family: "Google Sans", Roboto, Noto, sans-serif;\r\n}\r\n\r\n.preview-blur {\r\n  background: rgba(255, 255, 255, 0.75);\r\n}\r\n.preview-bar {\r\n  left: 20%;\r\n  right: 20%;\r\n  bottom: 24px;\r\n  height: 4px;\r\n  border-radius: 2px;\r\n  background: linear-gradient(90deg, #4285F4, #4285F4 25%, #EA4335 25%, #EA4335 50%, #FBBC05 50%, #FBBC05 75%, #34A853 75%, #34A853);\r\n  background-size: 200% 100%;\r\n}\r\n.preview-chat {\r\n  align-items: flex-start;\r\n}\r\n.preview-msg {\r\n  box-shadow: none;\r\n}\r\n.preview-msg.user {\r\n  font-size: 32px;\r\n  color: rgba(32, 33, 36, 0.5);\r\n  background: none;\r\n  border: none;\r\n  padding: 4px 0;\r\n  border-radius: 0;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n.preview-msg.assistant {\r\n  font-size: 36px;\r\n  color: #202124;\r\n  font-weight: 400;\r\n  background: none;\r\n  border: none;\r\n  padding: 4px 0;\r\n  border-radius: 0;\r\n  align-self: flex-start;\r\n  text-align: left;\r\n}\r\n.preview-timer {\r\n  color: #3c4043;\r\n  background: #ffffff;\r\n  border: none;\r\n  border-radius: 18px;\r\n  box-shadow: 0 1px 3px rgba(60, 64, 67, 0.15), 0 4px 8px rgba(60, 64, 67, 0.1);\r\n}\r\n.preview-timer-progress {\r\n  background: rgba(66, 133, 244, 0.15);\r\n  opacity: 1;\r\n}\r\n\r\n.preview-label {\r\n  color: rgba(0, 0, 0, 0.35);\r\n}\r\n'},_={[h.id]:h,[p.id]:p,[g.id]:g};function m(e){return _[e]||_.default}class v{constructor(){this._debug=!1}set debug(e){this._debug=!!e}log(e,t,n){this._debug&&(void 0!==n?console.log(`[VS][${e}] ${t}`,n):console.log(`[VS][${e}] ${t}`))}error(e,t,n){void 0!==n?console.error(`[VS][${e}] ${t}`,n):console.error(`[VS][${e}] ${t}`)}}class f{constructor(e){this._card=e,this._log=e.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get card(){return this._card}get log(){return this._log}get audioContext(){return this._audioContext}get workletNode(){return this._workletNode}set workletNode(e){this._workletNode=e}get audioBuffer(){return this._audioBuffer}set audioBuffer(e){this._audioBuffer=e}get actualSampleRate(){return this._actualSampleRate}async startMicrophone(){await this._ensureAudioContextRunning();const{config:e}=this._card;this._log.log("mic",`AudioContext state=${this._audioContext.state} sampleRate=${this._audioContext.sampleRate}`);const t={sampleRate:16e3,channelCount:1,echoCancellation:e.echo_cancellation,noiseSuppression:e.noise_suppression,autoGainControl:e.auto_gain_control};if(e.voice_isolation&&(t.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:t}),e.debug){const e=this._mediaStream.getAudioTracks();this._log.log("mic",`Got media stream with ${e.length} audio track(s)`),e.length>0&&this._log.log("mic",`Track settings: ${JSON.stringify(e[0].getSettings())}`)}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic",`Actual sample rate: ${this._actualSampleRate}`),this._card._activeSkin?.reactiveBar&&!1!==this._card.config.reactive_bar&&this._card.analyser.attachMic(this._sourceNode,this._audioContext),await async function(e,t){const n=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),r=URL.createObjectURL(n);await e.audioContext.audioWorklet.addModule(r),URL.revokeObjectURL(r),e.workletNode=new AudioWorkletNode(e.audioContext,"voice-satellite-processor"),e.workletNode.port.onmessage=t=>{e.audioBuffer.push(new Float32Array(t.data))},t.connect(e.workletNode);const i=e.audioContext.createGain();i.gain.value=0,e.workletNode.connect(i),i.connect(e.audioContext.destination)}(this,this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._sourceNode&&(this._card.analyser.detachMic(this._sourceNode),this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(e=>e.stop()),this._mediaStream=null),this._audioBuffer=[]}startSending(e){this.stopSending();let t=!1;this._sendInterval=setInterval(()=>{const n=e();!t&&this._audioBuffer.length>0&&(t=!0,this._log.log("mic",`First audio send — handlerId=${n} bufferChunks=${this._audioBuffer.length}`)),function(e,t){if(null==t)return;if(0===e.audioBuffer.length)return;let n=0;for(const t of e.audioBuffer)n+=t.length;const r=new Float32Array(n);let i=0;for(const t of e.audioBuffer)r.set(t,i),i+=t.length;e.audioBuffer=[];const s=function(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){const r=Math.max(-1,Math.min(1,e[n]));t[n]=r<0?32768*r:32767*r}return t}(16e3!==e.actualSampleRate?function(e,t){if(16e3===t)return e;const n=t/16e3,r=Math.round(e.length/n),i=new Float32Array(r);for(let t=0;t<r;t++){const r=t*n,s=Math.floor(r),a=Math.min(s+1,e.length-1),o=r-s;i[t]=e[s]*(1-o)+e[a]*o}return i}(r,e.actualSampleRate):r);!function(e,t,n){const{connection:r}=e;if(!r?.socket)return;if(r.socket.readyState!==WebSocket.OPEN)return;const i=new Uint8Array(1+t.byteLength);i[0]=n,i.set(new Uint8Array(t.buffer),1),r.socket.send(i.buffer)}(e.card,s,t)}(this,n)},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream?.getAudioTracks().forEach(e=>{e.enabled=!1})}async resume(){this._audioBuffer=[],this._mediaStream?.getAudioTracks().forEach(e=>{e.enabled=!0}),"suspended"===this._audioContext?.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume())}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(e){this._log.error("mic",`Failed to resume AudioContext on click: ${e}`)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error(`AudioContext failed to start: ${this._audioContext.state}`)}}class b{constructor(e){this._card=e,this._log=e.logger,this._analyser=null,this._dataArray=null,this._rafId=null,this._barEl=null,this._mediaSourceNode=null,this._micSourceNode=null,this._connectedToDestination=!1}attachMic(e,t){this._ensureAnalyser(t),this._micSourceNode=e;try{e.connect(this._analyser)}catch(e){this._log.log("analyser",`Failed to attach mic: ${e.message}`)}}detachMic(e){if(this._micSourceNode=null,this._analyser)try{e.disconnect(this._analyser)}catch{}}attachAudio(e,t){if(e&&t){if(this._ensureAnalyser(t),this._detachAudio(),this._micSourceNode)try{this._micSourceNode.disconnect(this._analyser)}catch{}try{this._mediaSourceNode=t.createMediaElementSource(e),this._mediaSourceNode.connect(this._analyser),this._connectedToDestination||(this._analyser.connect(t.destination),this._connectedToDestination=!0)}catch(e){if(this._micSourceNode)try{this._micSourceNode.connect(this._analyser)}catch{}this._log.log("analyser",`Failed to attach audio: ${e.message}`),this._mediaSourceNode=null}}}detachAudio(){this._detachAudio()}start(e){this._barEl=e,this._rafId||this._tick()}stop(){this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this._barEl&&(this._barEl.style.setProperty("--vs-audio-level","0"),this._barEl=null)}_ensureAnalyser(e){this._analyser||(this._analyser=e.createAnalyser(),this._analyser.fftSize=256,this._analyser.smoothingTimeConstant=.6,this._dataArray=new Uint8Array(this._analyser.frequencyBinCount))}reconnectMic(){if(this._micSourceNode&&this._analyser)try{this._micSourceNode.connect(this._analyser)}catch{}}_detachAudio(){if(this._mediaSourceNode){try{this._mediaSourceNode.disconnect()}catch{}this._mediaSourceNode=null}if(this._connectedToDestination&&this._analyser){try{this._analyser.disconnect()}catch{}this._connectedToDestination=!1}}_tick(){if(!this._barEl||!this._analyser)return void(this._rafId=null);this._analyser.getByteFrequencyData(this._dataArray);let e=0;for(let t=0;t<this._dataArray.length;t++){const n=this._dataArray[t]/255;e+=n*n}const t=Math.sqrt(e/this._dataArray.length),n=Math.min(1,2*t);this._barEl.style.setProperty("--vs-audio-level",n.toFixed(3)),this._rafId=requestAnimationFrame(()=>this._tick())}}const y={type:"single",wave:"sine",notes:[{freq:523,start:0},{freq:659,start:.08},{freq:784,start:.16}],duration:.25},x={type:"single",wave:"sine",notes:[{freq:784,start:0},{freq:659,start:.08}],duration:.25},A={type:"multi",wave:"sine",notes:[{freq:880,start:0,end:.15},{freq:660,start:.18,end:.33},{freq:880,start:.36,end:.55}]};function w(e){if(e.startsWith("http://")||e.startsWith("https://"))return e;const t=window.location.origin;return e.startsWith("/")?t+e:`${t}/${e}`}function V(e,t,{onEnd:n,onError:r,onStart:i}){const s=new Audio;return s.volume=t,s.onended=()=>{n()},s.onerror=e=>{r(e)},s.src=e,s.play().then(()=>{i?.()}).catch(e=>{r(e)}),s}const T={wake:y,error:{type:"single",wave:"square",volumeScale:.3,notes:[{freq:300,start:0},{freq:200,start:.08}],duration:.15},done:x};class k{constructor(e){this._card=e,this._log=e.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null,this._playbackWatchdog=null,this._remoteTarget=null,this._remoteSawPlaying=!1}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(e){this._streamingUrl=e}play(e){const t=w(e);this._playing=!0;const n=this._card.ttsTarget;if(n)return this._remoteTarget=n,this._remoteSawPlaying=!1,function(e,t){const n=e.ttsTarget;e.logger.log("tts",`Playing on remote: ${n} URL: ${t}`),e.hass.callService("media_player","play_media",{entity_id:n,media_content_id:t,media_content_type:"music"}).catch(t=>{e.logger.error("tts",`Remote play failed: ${t}`)})}(this._card,t),void(this._endTimer=setTimeout(()=>{this._endTimer=null,this._log.log("tts","Remote safety timeout — forcing completion"),this._onComplete()},12e4));this._lastWatchdogTime=0,this._playbackWatchdog=setInterval(()=>{if(!this._playing||!this._currentAudio)return void this._clearWatchdog();const e=this._currentAudio.currentTime;e>this._lastWatchdogTime?this._lastWatchdogTime=e:(this._log.log("tts","Playback watchdog: audio stalled — forcing completion"),this._clearWatchdog(),this._onComplete())},3e4),this._currentAudio=V(t,this._card.mediaPlayer.volume,{onEnd:()=>{this._log.log("tts","Playback complete"),this._clearWatchdog(),this._onComplete()},onError:e=>{this._log.error("tts",`Playback error: ${e}`),this._log.error("tts",`URL: ${t}`),this._clearWatchdog(),this._onComplete(!0)},onStart:()=>{this._log.log("tts","Playback started successfully"),this._card.mediaPlayer.notifyAudioStart("tts"),this._card._activeSkin?.reactiveBar&&!1!==this._card.config.reactive_bar&&this._currentAudio&&this._card.analyser.attachAudio(this._currentAudio,this._card.audio.audioContext)}})}stop(){var e;this._playing=!1,this._remoteTarget=null,this._remoteSawPlaying=!1,this._clearWatchdog(),this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.analyser.detachAudio(),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null),(e=this._card).ttsTarget&&e.hass&&e.hass.callService("media_player","media_stop",{entity_id:e.ttsTarget}).catch(t=>{e.logger.error("tts",`Remote stop failed: ${t}`)}),this._card.mediaPlayer.notifyAudioEnd("tts")}storeStreamingUrl(e){if(this._streamingUrl=null,e.tts_output?.url&&e.tts_output?.stream_response){const t=e.tts_output.url;this._streamingUrl=t.startsWith("http")?t:window.location.origin+t,this._log.log("tts",`Streaming TTS URL available: ${this._streamingUrl}`)}}playChime(e){const t=T[e]||x;this._card.mediaPlayer.notifyAudioStart("chime"),function(e,t,n){try{const n=new(window.AudioContext||window.webkitAudioContext),r=n.createOscillator(),i=n.createGain();r.connect(i),i.connect(n.destination);const s=.5*e.mediaPlayer.volume*(t.volumeScale||1);r.type=t.wave,i.gain.setValueAtTime(s,n.currentTime),i.gain.exponentialRampToValueAtTime(.001,n.currentTime+t.duration);for(const e of t.notes)r.frequency.setValueAtTime(e.freq,n.currentTime+e.start);r.start(),r.stop(n.currentTime+t.duration),setTimeout(()=>n.close(),500)}catch(e){n?.error("chime",`Chime error: ${e}`)}}(this._card,t,this._log),setTimeout(()=>{this._card.mediaPlayer.notifyAudioEnd("chime")},1e3*(t.duration||.3))}checkRemotePlayback(e){if(!this._playing||!this._remoteTarget)return;const t=e.states?.[this._remoteTarget];if(!t)return;const n=t.state;"playing"!==n&&"buffering"!==n?this._remoteSawPlaying&&(this._log.log("tts",`Remote player stopped (state: ${n}) — completing`),this._onComplete()):this._remoteSawPlaying=!0}_clearWatchdog(){this._playbackWatchdog&&(clearInterval(this._playbackWatchdog),this._playbackWatchdog=null)}_onComplete(e){this._log.log("tts","Complete — cleaning up UI"+(e?" (playback failed)":"")),this._card.analyser.detachAudio(),this._currentAudio=null,this._playing=!1,this._remoteTarget=null,this._remoteSawPlaying=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.mediaPlayer.notifyAudioEnd("tts"),this._card.onTTSComplete(e)}}function S(e,t,n){if(!e||!t)return;if(e.entities){const r=e.entities[t];if(r?.device_id)for(const[t,i]of Object.entries(e.entities))if(i.device_id===r.device_id&&"voice_satellite"===i.platform&&i.translation_key===n)return"on"===e.states[t]?.state}const r=function(e,t,n){if(!e||!t)return;const r=e.states[t];return r?.attributes?.[n]}(e,t,"mute"===n?"muted":n);return void 0!==r?!0===r:void 0}function C(e,t){try{const e=t.intent_output.response.speech.plain.speech;if(e)return e}catch(e){}try{if(t.intent_output.response.speech.speech)return t.intent_output.response.speech.speech}catch(e){}try{if(t.intent_output.response.plain)return t.intent_output.response.plain}catch(e){}try{if("string"==typeof t.intent_output.response)return t.intent_output.response}catch(e){}return e.log.log("error","Could not extract response text"),null}class E{constructor(e){this._card=e,this._log=e.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1,this._askQuestionCallback=null,this._askQuestionHandled=!1,this._reconnectRef={listener:null},this._muteCheckId=null,this._runStartReceived=!1,this._wakeWordPhase=!1,this._errorReceived=!1,this._pipelineGen=0,this._cancelInit=null}get card(){return this._card}get log(){return this._log}get binaryHandlerId(){return this._binaryHandlerId}set binaryHandlerId(e){this._binaryHandlerId=e}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}set serviceUnavailable(e){this._serviceUnavailable=e}get shouldContinue(){return this._shouldContinue}set shouldContinue(e){this._shouldContinue=e}get continueConversationId(){return this._continueConversationId}set continueConversationId(e){this._continueConversationId=e}get continueMode(){return this._continueMode}set continueMode(e){this._continueMode=e}get retryCount(){return this._retryCount}set retryCount(e){this._retryCount=e}get pendingRunEnd(){return this._pendingRunEnd}set pendingRunEnd(e){this._pendingRunEnd=e}get suppressTTS(){return this._suppressTTS}set suppressTTS(e){this._suppressTTS=e}get recoveryTimeout(){return this._recoveryTimeout}set recoveryTimeout(e){this._recoveryTimeout=e}get intentErrorBarTimeout(){return this._intentErrorBarTimeout}set intentErrorBarTimeout(e){this._intentErrorBarTimeout=e}get askQuestionCallback(){return this._askQuestionCallback}set askQuestionCallback(e){this._askQuestionCallback=e}get askQuestionHandled(){return this._askQuestionHandled}set askQuestionHandled(e){this._askQuestionHandled=e}async start(e){const t=e||{},{connection:n,config:r}=this._card,i=this._pipelineGen;if(!n)throw new Error("No Home Assistant connection available");if(!r.satellite_entity)throw new Error("No satellite_entity configured");if(this._muteCheckId&&(clearTimeout(this._muteCheckId),this._muteCheckId=null),!0===S(this._card.hass,r.satellite_entity,"mute"))return this._log.log("pipeline","Satellite muted — pipeline blocked"),this._card.ui.showErrorBar(),void(this._muteCheckId=setTimeout(()=>{this._muteCheckId=null,this.start(t).catch(()=>{})},2e3));if(this._card.ui.clearErrorBar(),this._unsubscribe){this._log.log("pipeline","Cleaning up previous subscription");try{await this._unsubscribe()}catch(e){}this._unsubscribe=null}this._binaryHandlerId=null,function(e,t,n,r){r.listener||(r.listener=()=>{e.logger.log("pipeline","Connection reconnected — resetting retry state"),t.resetRetryState(),e.ui.clearErrorBar(),e.visibility.isPaused?e.logger.log("pipeline","Tab is paused — deferring restart to resume"):setTimeout(()=>t.restart(0),2e3)},n.addEventListener("ready",r.listener))}(this._card,this,n,this._reconnectRef);const s={start_stage:t.start_stage||"wake_word",end_stage:t.end_stage||"tts",sample_rate:16e3};let a;t.conversation_id&&(s.conversation_id=t.conversation_id),t.extra_system_prompt&&(s.extra_system_prompt=t.extra_system_prompt),this._runStartReceived=!1,this._log.log("pipeline",`Starting pipeline: ${JSON.stringify(s)}`);const o=new Promise(e=>{a=e});this._cancelInit=a;const l=await async function(e,t,n,r){return e.subscribeMessage(r,{type:"voice_satellite/run_pipeline",entity_id:t,...n})}(n,r.satellite_entity,s,e=>{if(this._pipelineGen===i)return"init"===e.type?(this._binaryHandlerId=e.handler_id,this._log.log("pipeline",`Init — handler ID: ${e.handler_id}`),void a()):void this._card.onPipelineMessage(e)});if(this._pipelineGen!==i){this._log.log("pipeline","Aborting stale start() after subscribe — pipeline was stopped");try{l()}catch(e){}return}if(this._unsubscribe=l,this._log.log("pipeline","Pipeline subscribed, waiting for init event..."),await o,this._cancelInit=null,this._pipelineGen!==i){if(this._log.log("pipeline","Aborting stale start() after init — pipeline was stopped"),this._unsubscribe){try{this._unsubscribe()}catch(e){}this._unsubscribe=null}return}this._log.log("pipeline",`Handler ID confirmed: ${this._binaryHandlerId} — starting audio`);const{audio:c}=this._card;c.audioBuffer=[],c.startSending(()=>this._binaryHandlerId),this._isStreaming=!0}async stop(){if(this._pipelineGen++,this._log.log("pipeline",`stop() — gen=${this._pipelineGen}`),this._cancelInit&&(this._cancelInit(),this._cancelInit=null),this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._muteCheckId&&(clearTimeout(this._muteCheckId),this._muteCheckId=null),this._unsubscribe){try{await this._unsubscribe()}catch(e){}this._unsubscribe=null}}restart(e){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this.stop().then(()=>{this._restartTimeout=setTimeout(()=>{this._restartTimeout=null,this._isRestarting=!1,this.start().catch(e=>{const t=e?.message||JSON.stringify(e);this._log.error("pipeline",`Restart failed: ${t}`),this._serviceUnavailable||(this._card.ui.showErrorBar(),this._serviceUnavailable=!0),this.restart(this.calculateRetryDelay())})},e||0)}))}restartContinue(e,t={}){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this._askQuestionCallback=t.onSttEnd||null,this.stop().then(()=>{this._isRestarting=!1,this._continueMode=!0;const n={start_stage:"stt",end_stage:t.end_stage||"tts",conversation_id:e};t.extra_system_prompt&&(n.extra_system_prompt=t.extra_system_prompt),this.start(n).catch(e=>{this._log.error("pipeline",`Continue conversation failed: ${e?.message||JSON.stringify(e)}`),this._askQuestionCallback=null,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this.restart(0)})}))}handleRunStart(e){this._runStartReceived=!0,this._wakeWordPhase=!1,this._errorReceived=!1,function(e,n){if(e.card.tts.storeStreamingUrl(n),e.continueMode)return e.continueMode=!1,e.card.setState(r),e.log.log("pipeline",`Running (continue conversation) — binary handler ID: ${e.binaryHandlerId}`),void e.log.log("pipeline","Listening for speech...");e.card.setState(t),e.log.log("pipeline",`Running — binary handler ID: ${e.binaryHandlerId}`),e.log.log("pipeline","Listening for wake word...")}(this,e)}handleWakeWordStart(){var e;this._wakeWordPhase=!0,(e=this).serviceUnavailable&&(e.recoveryTimeout&&clearTimeout(e.recoveryTimeout),e.recoveryTimeout=setTimeout(()=>{e.serviceUnavailable&&(e.log.log("recovery","Wake word service recovered"),e.serviceUnavailable=!1,e.retryCount=0,e.card.ui.clearErrorBar(),e.card.ui.hideBar())},2e3))}handleWakeWordEnd(e){if(!this._runStartReceived)return void this._log.log("pipeline","Ignoring stale wake_word-end (no run-start received for this subscription)");const t=e?.wake_word_output;t&&t.wake_word_id?(this._wakeWordPhase=!1,function(e,t){const r=t.wake_word_output;if(!r||0===Object.keys(r).length)return e.log.error("error","Wake word service unavailable (empty wake_word_output)"),e.recoveryTimeout&&(clearTimeout(e.recoveryTimeout),e.recoveryTimeout=null),e.binaryHandlerId=null,e.card.ui.showErrorBar(),e.serviceUnavailable=!0,void e.restart(e.calculateRetryDelay());e.recoveryTimeout&&(clearTimeout(e.recoveryTimeout),e.recoveryTimeout=null),e.serviceUnavailable=!1,e.retryCount=0,e.card.ui.clearErrorBar(),e.card.mediaPlayer.interrupt();const{tts:i}=e.card;if(i.isPlaying&&(i.stop(),e.pendingRunEnd=!1),e.intentErrorBarTimeout&&(clearTimeout(e.intentErrorBarTimeout),e.intentErrorBarTimeout=null),e.card.chat.clear(),e.shouldContinue=!1,e.continueConversationId=null,e.card.setState(n),!1!==S(e.card.hass,e.card.config.satellite_entity,"wake_sound")){const t=e.card.audio;t.stopSending(),i.playChime("wake"),setTimeout(()=>{t.audioBuffer=[],e.binaryHandlerId&&t.startSending(()=>e.binaryHandlerId)},1e3*y.duration+50)}e.card.ui.showBlurOverlay(l)}(this,e)):this._log.log("pipeline","Ignoring empty wake_word-end (pipeline stopped during restart)")}handleSttEnd(e){!function(e,t){const n=t.stt_output?.text||"";if(n&&e.card.chat.showTranscription(n),e.askQuestionCallback){const t=e.askQuestionCallback;e.askQuestionCallback=null,e.askQuestionHandled=!0,e.log.log("pipeline",`Ask question STT complete: "${n}"`),t(n)}}(this,e)}handleIntentProgress(e){!function(e,t){const{tts:n}=e.card;if(t.tts_start_streaming&&n.streamingUrl&&!n.isPlaying&&(e.log.log("tts","Streaming TTS started — playing early"),e.card.setState(s),n.play(n.streamingUrl),n.streamingUrl=null),!t.chat_log_delta)return;const r=t.chat_log_delta.content;if("string"!=typeof r)return;const{chat:i}=e.card;i.streamedResponse=(i.streamedResponse||"")+r,i.updateResponse(i.streamedResponse)}(this,e)}handleIntentEnd(e){!function(e,t){let n=null;try{n=t.intent_output.response.response_type}catch(e){}if("error"===n){const n=C(e,t)||"An error occurred";return e.log.error("error",`Intent error: ${n}`),e.card.ui.showErrorBar(),!1!==S(e.card.hass,e.card.config.satellite_entity,"wake_sound")&&e.card.tts.playChime("error"),e.suppressTTS=!0,e.intentErrorBarTimeout&&clearTimeout(e.intentErrorBarTimeout),e.intentErrorBarTimeout=setTimeout(()=>{e.intentErrorBarTimeout=null,e.card.ui.clearErrorBar(),e.card.ui.hideBar()},3e3),void(e.card.chat.streamedResponse="")}const r=C(e,t);r&&e.card.chat.showResponse(r),e.shouldContinue=!1,e.continueConversationId=null;try{!0===t.intent_output.continue_conversation&&(e.shouldContinue=!0,e.continueConversationId=t.intent_output.conversation_id||null,e.log.log("pipeline",`Continue conversation requested — id: ${e.continueConversationId}`))}catch(e){}e.card.chat.streamedResponse="",e.card.chat.streamEl=null}(this,e)}handleTtsEnd(e){!function(e,t){if(e.suppressTTS)return e.suppressTTS=!1,e.log.log("tts","TTS suppressed (intent error)"),void e.restart(0);const{tts:n}=e.card;if(n.isPlaying)return e.log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void e.restart(0);const r=t.tts_output?.url||t.tts_output?.url_path||null;r&&n.play(r),e.restart(0)}(this,e)}handleRunEnd(){if(this._runStartReceived)return this._wakeWordPhase&&!this._errorReceived?(this._log.log("pipeline","run-end during wake_word phase — restarting pipeline"),void this.restart(0)):void function(e){if(e.log.log("pipeline","Run ended"),e.binaryHandlerId=null,!e.isRestarting)return e.askQuestionHandled?(e.log.log("pipeline","Ask question handled — announcement manager owns cleanup"),void(e.askQuestionHandled=!1)):e.serviceUnavailable?(e.log.log("ui","Error recovery handling restart"),void e.card.ui.hideBlurOverlay(l)):e.card.tts.isPlaying?(e.log.log("ui","TTS playing — deferring cleanup"),void(e.pendingRunEnd=!0)):void e.finishRunEnd();e.log.log("pipeline","Restart already in progress — skipping run-end restart")}(this);this._log.log("pipeline","Ignoring stale run-end (no run-start received for this subscription)")}handleError(t){this._runStartReceived?(this._errorReceived=!0,function(t,n){const r=n.code||"",i=n.message||"";if(t.log.log("error",`${r} — ${i}`),t.askQuestionCallback){const e=t.askQuestionCallback;return t.askQuestionCallback=null,t.log.log("pipeline",`Ask question error (${r}) — sending empty answer`),void e("")}if(o.includes(r)){if(t.log.log("pipeline",`Expected error: ${r} — restarting`),a.includes(t.card.currentState)){t.log.log("ui","Cleaning up interaction UI after expected error"),t.card.setState(e),t.card.chat.clear(),t.card.ui.hideBlurOverlay(l),t.shouldContinue=!1,t.continueConversationId=null;const n=!!t.card.ttsTarget;!1===S(t.card.hass,t.card.config.satellite_entity,"wake_sound")||n||t.card.tts.playChime("done")}return void t.restart(0)}t.log.error("error",`Unexpected: ${r} — ${i}`);const s=a.includes(t.card.currentState);t.binaryHandlerId=null,s&&!1!==S(t.card.hass,t.card.config.satellite_entity,"wake_sound")&&t.card.tts.playChime("error"),t.card.ui.showErrorBar(),t.serviceUnavailable=!0,t.card.chat.clear(),t.card.ui.hideBlurOverlay(l),t.restart(t.calculateRetryDelay())}(this,t)):this._log.log("pipeline","Ignoring stale error (no run-start received for this subscription)")}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}resetRetryState(){this._retryCount=0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._isRestarting&&(this._isRestarting=!1),this._serviceUnavailable=!1}finishRunEnd(){this._pendingRunEnd=!1,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.setState(e),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}calculateRetryDelay(){this._retryCount++;const e=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline",`Retry in ${e}ms (attempt #${this._retryCount})`),e}}function M(e){const t=Math.max(0,e),n=Math.floor(t/3600),r=Math.floor(t%3600/60),i=t%60;return`${n<10?"0":""}${n}:${r<10?"0":""}${r}:${i<10?"0":""}${i}`}class I{constructor(e){this._card=e,this._log=e.logger,this._globalUI=null,this._pendingStartButtonReason=void 0,this._blurReasons={},this._timerContainer=null,this._timerAlertEl=null}get element(){return this._globalUI}ensureGlobalUI(){const e=document.getElementById("voice-satellite-ui");if(e)return this._globalUI=e,this.applyStyles(),void this._flushPendingStartButton();const t=document.createElement("div");t.id="voice-satellite-ui",t.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(t),this._globalUI=t,this._injectSkinCSS(),this._applyCustomCSS(),this._applyTextScale(),this._applyBackgroundOpacity(),t.querySelector(".vs-start-btn").addEventListener("click",()=>{this._card.onStartClick()});const n=t.querySelector(".vs-start-btn");n.classList.add("visible"),n.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){this._globalUI&&(this._injectSkinCSS(),this._applyCustomCSS(),this._applyTextScale(),this._applyBackgroundOpacity())}updateForState(e,t,n){if(!this._globalUI)return;if(this._card.announcement.playing||this._card.askQuestion.playing||this._card.startConversation.playing)return;const r={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[e];if(!r)return;if(t&&!r.barVisible)return;if(n&&!r.barVisible)return;const i=this._globalUI.querySelector(".vs-rainbow-bar"),s=this._card._activeSkin?.reactiveBar&&!1!==this._card.config.reactive_bar;r.barVisible?(i.classList.contains("error-mode")&&this.clearErrorBar(),i.classList.add("visible"),i.classList.remove("connecting","listening","processing","speaking","reactive"),r.animation&&i.classList.add(r.animation),s&&(i.classList.add("reactive"),this._globalUI.classList.add("reactive-mode"),this._card.analyser.reconnectMic(),this._card.analyser.start(i))):(i.classList.contains("error-mode")&&this.clearErrorBar(),i.classList.remove("visible","connecting","listening","processing","speaking","reactive"),this._globalUI.classList.remove("reactive-mode"),s&&this._card.analyser.stop())}showStartButton(e){if(!this._globalUI)return void(this._pendingStartButtonReason=e);const t=this._globalUI.querySelector(".vs-start-btn");t.classList.add("visible"),t.title={"not-allowed":"Tap to enable microphone","not-found":"No microphone found","not-readable":"Microphone unavailable - tap to retry"}[e]||"Tap to start voice assistant"}hideStartButton(){this._globalUI?.querySelector(".vs-start-btn")?.classList.remove("visible")}showBlurOverlay(e){this._globalUI&&(this._blurReasons[e||"default"]=!0,this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible"))}hideBlurOverlay(e){this._globalUI&&(delete this._blurReasons[e||"default"],0===Object.keys(this._blurReasons).length&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible"))}showErrorBar(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-rainbow-bar");e.classList.remove("connecting","listening","processing","speaking"),e.classList.add("visible","error-mode")}clearErrorBar(){this._globalUI&&this._globalUI.querySelector(".vs-rainbow-bar").classList.remove("error-mode")}hideBar(){this._globalUI?.querySelector(".vs-rainbow-bar")?.classList.remove("visible")}showBarSpeaking(){if(!this._globalUI)return!1;const e=this._globalUI.querySelector(".vs-rainbow-bar");if(!e)return!1;const t=e.classList.contains("visible"),n=this._card._activeSkin?.reactiveBar&&!1!==this._card.config.reactive_bar;return e.classList.add("visible","speaking"),n&&(e.classList.add("reactive"),this._globalUI.classList.add("reactive-mode"),this._card.analyser.start(e)),t}restoreBar(e){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-rainbow-bar");t&&(t.classList.remove("speaking","reactive"),this._globalUI.classList.remove("reactive-mode"),this._card._activeSkin?.reactiveBar&&!1!==this._card.config.reactive_bar&&this._card.analyser.stop(),e||t.classList.remove("visible"))}addChatMessage(e,t){if(!this._globalUI)return null;const n=this._globalUI.querySelector(".vs-chat-container");n.classList.add("visible");const r=document.createElement("div");return r.className=`vs-chat-msg ${t}`,r.textContent=e,n.appendChild(r),r}updateChatText(e,t){e&&(e.textContent=t)}updateChatHtml(e,t){e&&(e.innerHTML=t)}clearChat(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-chat-container");for(;e.firstChild;)e.removeChild(e.firstChild);e.classList.remove("visible")}setAnnouncementMode(e){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-chat-container");t&&t.classList.toggle("announcement-mode",e)}clearAnnouncementBubbles(){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-chat-container"),t=e?.querySelectorAll(".vs-chat-msg.announcement")||[];for(const e of t)e.remove();e&&!e.firstChild&&e.classList.remove("visible")}ensureTimerContainer(){if(this._timerContainer&&document.body.contains(this._timerContainer))return;const e=document.createElement("div");e.id="voice-satellite-timers",e.className="vs-timer-container",document.body.appendChild(e),this._timerContainer=e}removeTimerContainer(){this._timerContainer?.parentNode?.removeChild(this._timerContainer),this._timerContainer=null}createTimerPill(e,t){const n=e.totalSeconds>0?Math.max(0,e.secondsLeft/e.totalSeconds*100):0,r=document.createElement("div");return r.className="vs-timer-pill",r.setAttribute("data-timer-id",e.id),r.innerHTML=`<div class="vs-timer-progress" style="width:${n}%"></div><div class="vs-timer-content"><span class="vs-timer-icon">⏱</span><span class="vs-timer-time">${M(e.secondsLeft)}</span></div>`,t&&B(r,t),r}syncTimerPills(e,t){this.ensureTimerContainer();const n=this._timerContainer.querySelectorAll(".vs-timer-pill");for(const t of n){const n=t.getAttribute("data-timer-id");e.some(e=>e.id===n)||t.parentNode.removeChild(t)}for(const n of e)n.el&&this._timerContainer.contains(n.el)||(n.el=this.createTimerPill(n,t(n.id)),this._timerContainer.appendChild(n.el))}updateTimerPill(e,t,n){if(!e)return;const r=e.querySelector(".vs-timer-time");r&&(r.textContent=M(t));const i=e.querySelector(".vs-timer-progress");if(i){const e=n>0?Math.max(0,t/n*100):0;i.style.width=`${e}%`}}expireTimerPill(e,t){if(!this._timerContainer)return;const n=this._timerContainer.querySelector(`.vs-timer-pill[data-timer-id="${e}"]`);n&&(n.classList.add("vs-timer-expired"),setTimeout(()=>n.parentNode?.removeChild(n),t))}showTimerAlert(e){this._timerAlertEl=document.createElement("div"),this._timerAlertEl.className="vs-timer-alert",this._timerAlertEl.innerHTML='<span class="vs-timer-icon">⏱</span><span class="vs-timer-time">00:00:00</span>',document.body.appendChild(this._timerAlertEl),e&&B(this._timerAlertEl,e)}clearTimerAlert(){for(const e of document.querySelectorAll(".vs-timer-alert"))e.parentNode?.removeChild(e);this._timerAlertEl=null}_injectSkinCSS(){const e=this._card._activeSkin;if(!e?.css)return;let t=document.getElementById("voice-satellite-styles");t||(t=document.createElement("style"),t.id="voice-satellite-styles",document.head.appendChild(t)),t.textContent=e.css}_applyTextScale(){const e=(this._card.config.text_scale||100)/100;document.documentElement.style.setProperty("--vs-text-scale",e)}_applyBackgroundOpacity(){const e=this._globalUI?.querySelector(".vs-blur-overlay");if(!e)return;const t=this._card._activeSkin,n=t?.overlayColor;if(n){const r=Math.round(100*(t.defaultOpacity??1)),i=(this._card.config.background_opacity??r)/100;e.style.background=`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${i})`}}_applyCustomCSS(){const e=this._card.config.custom_css||"";let t=document.getElementById("voice-satellite-custom-css");e?(t||(t=document.createElement("style"),t.id="voice-satellite-custom-css",document.head.appendChild(t)),t.textContent=e):t&&t.remove()}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}function B(e,t){let n=0;const r=e=>{const r=Date.now();r-n<400&&r-n>0&&(e.preventDefault(),e.stopPropagation(),t()),n=r};e.addEventListener("touchstart",r,{passive:!1}),e.addEventListener("click",r)}class F{constructor(e){this._card=e,this._log=e.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(e){this._streamEl=e}get streamedResponse(){return this._streamedResponse}set streamedResponse(e){this._streamedResponse=e}showTranscription(e){this.addUser(e)}showResponse(e){this._streamEl?this._card.ui.updateChatText(this._streamEl,e):this.addAssistant(e)}updateResponse(e){this._streamEl?this._updateStreaming(e):this.addAssistant(e)}addUser(e){this._card.ui.addChatMessage(e,"user")}addAssistant(e){this._streamEl=this._card.ui.addChatMessage(e,"assistant")}clear(){this._card.ui.clearChat(),this._streamEl=null,this._streamedResponse=""}_updateStreaming(e){if(!this._streamEl)return;if(e.length<=24)return void this._card.ui.updateChatText(this._streamEl,e);const t=e.slice(0,e.length-24),n=e.slice(e.length-24);let r=U(t);for(let e=0;e<n.length;e++)r+=`<span style="opacity:${((24-e)/24).toFixed(2)}">${U(n[e])}</span>`;this._card.ui.updateChatHtml(this._streamEl,r)}}function U(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}let R=0,P=null,D=null,N=!1;function q(){if("visible"!==document.visibilityState)return;if(!P||!D)return;const e=D,t=P;P=null,D=null,e.logger.log("satellite-notify",`Tab visible — replaying queued event #${t.data.id}`),$(e,t)}function $(e,t){const{type:n,data:r}=t;if("media_player"===n)return void e.mediaPlayer.handleCommand(r);if(!r||!r.id)return;if("hidden"===document.visibilityState)return e.logger.log("satellite-notify",`Event #${r.id} queued — tab hidden`),P=t,D=e,void(N||(N=!0,document.addEventListener("visibilitychange",q)));const i={...r};i.ask_question?z(e.askQuestion,i,"ask-question"):"start_conversation"===n||i.start_conversation?z(e.startConversation,i,"start-conversation"):z(e.announcement,i,"announce")}function z(e,t,n){if(t.id<=R)return;if(e.playing)return void(e.queued&&e.queued.id===t.id||(e.queued=t,e.log.log(n,`Notification #${t.id} queued — still displaying`)));const r=e.card.currentState;"WAKE_WORD_DETECTED"===r||"STT"===r||"INTENT"===r||"TTS"===r||e.card.tts.isPlaying?e.queued&&e.queued.id===t.id||(e.queued=t,e.log.log(n,`Notification #${t.id} queued — pipeline busy (${r})`)):(e.queued=null,R=t.id,e.log.log(n,`New ${n} #${t.id}: message="${t.message||""}" media="${t.media_id||""}"`),L(e,t,t=>e._onComplete(t),n))}function Q(e){if(!e.queued)return null;const t=e.queued;return e.queued=null,t.id<=(R||0)||e.playing?null:(R=t.id,t)}function L(e,t,n,r){e.clearTimeoutId&&W(e),e.card.mediaPlayer.interrupt(),e.playing=!0,e.currentAnnounceId=t.id,e.card.ui.showBlurOverlay(d),e.barWasVisible=e.card.ui.showBarSpeaking(),!t.ask_question&&!t.start_conversation&&e.card.ui.setAnnouncementMode(!0),!1===t.preannounce?(e.log.log(r,"Preannounce disabled — skipping chime"),O(e,t,n,r)):t.preannounce_media_id&&""!==t.preannounce_media_id?(e.log.log(r,`Playing pre-announcement media: ${t.preannounce_media_id}`),H(e,t.preannounce_media_id,r,()=>{O(e,t,n,r)})):V("data:audio/mpeg;base64,SUQzBAAAAAAAIlRTU0UAAAAOAAADTGF2ZjYyLjMuMTAwAAAAAAAAAAAAAAD/83DAAAAAAAAAAAAAWGluZwAAAA8AAABHAAAJ2wAsNDo6PEJCREdPT1FXV1lfZGRmaWlucXR0dnl5fH6BgYSGhomLi46Rk5OWmZmbnqGho6amqKuurrCzs7a4u7u+wMDDxcXIy83N0NPT1djb293g4OLl6Ojq7e3w8vX1+Pr6/f8AAAAATGF2YzYyLjExAAAAAAAAAAAAAAAAJAJ2AAAAAAAACduXdSMzAAAAAAAAAAAAAAAAAP/zkMQABKACtA1AAAAhIf//////WD7//////+UDBQEFAG8QAAwAA////////4tHrTBwb1nAKAQwAWv4GNQjv/gALnV////////lgLfymat/9gaiyIf/0wgGjEYcAf////////rqE9AlozJOsr////////////Uk5Mol0UiKDADgf/0EwbiN//////////////uLQ4epCADgf/2iAIJ7/////////////1DUUXUCgAcD/+GAlf//////1B6B//dgWCav////////////rTTMQFhiYyognA/2UxiYERBp4DRkFFE2mt////////////1oooFIRghgYkdAKn4ExhoMptbiMZpfCf/zMMTlDsL+0B+AoCQ0KggA4H/9SQDSP//////////////ckC7kabUCgAcD/+JQhb/////////////4gmVMQU0Cgf/zoG0Xgf/UuAxx8P/zIMTrCIKuvAfAkAEd6nQQ///////////+1MwYzXWYJUcJoa0aW/eeGJ2nyIkWlSC8D/r/8xDE8AXyusQWBBeQ1KWbBkEDXKjZ2//////zIMTlBaK2wBYAW4D///////9S0HU0UQCBvOWduMNageQ2nIkcAf/1koCfV///////////8xDE9QN5XtAeAFeA///0E94FTyoMAOB//P/zEMT0BhK2wAYDTZGWE2f///////////////MwxOgM8s6cDgT3kdxwlj0IAOB//dAA5Pf////////////+gHBl1QwA4H/9JATz//////////////MmA4H/8UMKDD/+dBtMQU1FqqoC//MQxPUGOrbUFgNxkIH/8rEFTEFNRVVVVQj/8yDE6QUisuAeAFWAP/5wGKpMQU1FqqqqA4H/8EHVTEFNRVVVVQOB//cJVUxBTUVVVVUD//MQxPgBcVrgGABTgIH/8ME1TEFNRVVVVQL/8yDE/wqSyqgGA3WRgf/ysCFMQU1FMy4xMAw//mwOTEFNRaqqqgKB//KwWkxBTUWqqgOB//MgxPsKMsKoDgU3kf/xwGtVTEFNRVVVVQOB//UJlUxBTUVVVVUDgf/xQYpMQU1FMy4xMP/zEMT5BYqywAYEV5AMP/50J0xBTUUzLjEw//MQxO8FarbUFgBbgAw//k4JTEFNRTMuMTD/8yDE5gWStsAWBA+EMFVVQDVMQU1FMy4xMDBVVYLlTEFNRTMuMTAwVVWEqkxBTUUzLjEw//MQxPYFArLIFgBbgDCqqoaqTEFNRTMuMTD/8xDE7wFZWuQYAE+AMKqqsGJMQU1FMy4xMP/zEMT2AUFa3BAAU4IwqqpgHUxBTUUzLjEw//MQxPgBaVrUGABTgDBVVbGFTEFNRTMuMTD/8xDE+AFJWsgQAFeCMFVVoKpMQU1FMy4xMP/zEMT4AWla0BgAT4AwqqqBqkxBTUUzLjEw//MQxPgBUVrQGABPgDCqqoLVTEFNRTMuMTD/8xDE+AFhWsgYAE+AMFVVg6pMQU1FMy4xMP/zEMT4AXFawBgAU4AwqqpwBUxBTUUzLjEw//MQxPcBOVrEEABNgjBVVWFqTEFNRTMuMTD/8xDE+AFxWrgYAFOAMKqqcGpMQU1FMy4xMP/zEMT5AYletBgAT4AwqqqA1UxBTUUzLjEw//MQxPgBUVq4GABPgDBVVVWKTEFNRTMuMTD/8xDE+AFZWrAYAE+AMFVVVYxMQU1Fqqr////zEMT3AUFarBAAU4L////L1UxBTUVVVf////MQxPcBOVqsEABNgv///8WVTEFNRTMuMTD/8xDE9ABxWqAAAA68MFVVVVVMQU1FMy4xMP/zEMT0AGFaoAAADrwwVVVVVUxBTUUzLjEw//MQxPQAWVqkAAAOvDBVVVVVTEFNRTMuMTD/8xDE9ABRWpwAAA68MFVVVVVMQU1FMy4xMP/zEMT0AHFalAAAErwwVVVVVUxBTUUzLjEw//MQxPQAaVqQAAAMvDBVVVVVTEFNRTMuMTD/8xDE9ABhWogAABK8MFVVVVVMQU1FMy4xMP/zEMT0AGlahAAAErwwVVVVVUxBTUUzLjEw//MQxPQAUVqMAAAKvDBVVVVVTEFNRTMuMTD/8xDE9ABJWowAAAq8MFVVVVVMQU1FMy4xMP/zEMT0AElaiAAACrwwVVVVVUxBTUUzLjEw//MQxPQAaVp8AAAMvDBVVVVVTEFNRTMuMTD/8xDE9ABZWngAAAy8MFVVVVVMQU1FMy4xMP/zEMT0AGFadAAADLwwVVVVVUxBTUUzLjEw//MQxPQASVp8AAAEvDBVVVVVTEFNRTMuMTD/8xDE8wBBWoAAAAS8MFVVVVVMQU1FMy4xMP/zEMTzADlafAAABLwwVVVVVUxBTUUzLjEw//MQxPkBiAKEAAAAADBVVVVVTEFNRTMuMTD/8xDE+QGQAnwAAAAAMFVVVVVMQU1FMy4xMP/zEMTyAAAD/AAAAAAwVVVVVUxBTUUzLjEw//MQxPIAAANIAAAAADBVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVX/8xDE8gAAA0gAAAAAVVVVVVVVVVVVVVVVVf/zEMTyAAADSAAAAABVVVVVVVVVVVVVVVVV//MQxPIAAANIAAAAAFVVVVVVVVVVVVVVVVU=",e.card.mediaPlayer.volume,{onEnd:()=>{e.card.mediaPlayer.notifyAudioEnd("announce-chime"),O(e,t,n,r)},onError:()=>{e.card.mediaPlayer.notifyAudioEnd("announce-chime"),O(e,t,n,r)},onStart:()=>{e.log.log(r,"Announcement chime playing"),e.card.mediaPlayer.notifyAudioStart("announce-chime")}})}function O(e,t,n,r){const i=t.media_id||"";if(t.message){const n=!t.ask_question&&!t.start_conversation;e.card.ui.addChatMessage(t.message,n?"announcement":"assistant")}i?(e.log.log(r,`Playing media: ${i}`),H(e,i,r,()=>n(t))):(e.log.log(r,"No media — completing after message display"),setTimeout(()=>n(t),3e3))}function W(e){e.clearTimeoutId&&(clearTimeout(e.clearTimeoutId),e.clearTimeoutId=null),e.card.ui.setAnnouncementMode(!1),e.card.ui.clearAnnouncementBubbles(),e.card.ui.hideBlurOverlay(d),e.card.ui.restoreBar(e.barWasVisible)}function H(e,t,n,r){const i=w(t),s=e.card.mediaPlayer.volume;e.currentAudio=V(i,s,{onEnd:()=>{e.log.log(n,"Media playback complete"),e.currentAudio=null,e.card.analyser.detachAudio(),e.card.mediaPlayer.notifyAudioEnd("notification"),r?.()},onError:t=>{e.log.error(n,`Media playback error: ${t}`),e.currentAudio=null,e.card.analyser.detachAudio(),e.card.mediaPlayer.notifyAudioEnd("notification"),r?.()},onStart:()=>{e.log.log(n,"Media playback started"),e.card.mediaPlayer.notifyAudioStart("notification"),e.card._activeSkin?.reactiveBar&&!1!==e.card.config.reactive_bar&&e.currentAudio&&e.card.analyser.attachAudio(e.currentAudio,e.card.audio.audioContext)}})}function G(e){e.playing=!1,e.currentAudio=null,e.currentAnnounceId=null,e.clearTimeoutId=null,e.barWasVisible=!1,e.queued=null}function j(e,t,n){const{connection:r,config:i}=e;r&&i.satellite_entity?r.sendMessagePromise({type:"voice_satellite/announce_finished",entity_id:i.satellite_entity,announce_id:t}).then(()=>{e.logger.log(n,`ACK sent for #${t}`)}).catch(t=>{e.logger.error(n,`ACK failed: ${t.message||JSON.stringify(t)}`)}):e.logger.error(n,"Cannot ACK — no connection or entity")}class Y{constructor(e){this._card=e,this._log=e.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){this._handler=t=>{const n=a.includes(this._card.currentState)||this._card.tts.isPlaying,r=this._card.timer.isAlertActive,i=this._card.announcement.playing||this._card.askQuestion.playing||this._card.startConversation.playing||this._card.announcement.clearTimeoutId||this._card.startConversation.clearTimeoutId;if(!n&&!r&&!i)return;if("click"===t.type&&this._lastTapWasTouch)return;this._lastTapWasTouch="touchstart"===t.type;const s=Date.now(),o=s-this._lastTapTime;if(this._lastTapTime=s,o<400&&o>0){if(t.preventDefault(),this._card.timer.isAlertActive)return this._log.log("ui","Double-tap detected — dismissing timer alert"),void this._card.timer.dismissAlert();if(i){this._log.log("ui","Double-tap detected — dismissing notification");for(const e of[this._card.announcement,this._card.askQuestion,this._card.startConversation])(e.playing||e.clearTimeoutId)&&(e.currentAnnounceId&&j(this._card,e.currentAnnounceId,"double-tap"),e.currentAudio&&(e.currentAudio.pause(),e.currentAudio=null),e.playing=!1,e.currentAnnounceId=null,W(e));return this._card.askQuestion.cancel(),void this._card.pipeline.restart(0)}this._log.log("ui","Double-tap detected — cancelling interaction"),this._card.tts.isPlaying&&this._card.tts.stop(),this._card.askQuestion.cancel(),this._card.pipeline.clearContinueState(),this._card.setState(e),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l);const n=!!this._card.ttsTarget;!1===S(this._card.hass,this._card.config.satellite_entity,"wake_sound")||n||this._card.tts.playChime("done"),this._card.pipeline.restart(0)}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}window.__vsSingleton||(window.__vsSingleton={instance:null,active:!1,starting:!1});const K=window.__vsSingleton;function J(e){return!K.instance||K.instance===e}function X(){return K.active}function Z(){return K.starting}function ee(e){K.starting=!!e}let te=null,ne=!1,re=null,ie=null,se=null,ae=null;const oe=[2e3,4e3,8e3,16e3,3e4];let le=0;function ce(e,t){const{config:n,connection:r}=e;n.satellite_entity&&r&&J(e)&&(ne||(ie=e,se=t,ne=!0,de(e,r,t),re||(re=()=>{e.logger.log("satellite-sub","Connection reconnected — re-subscribing"),ue();const n=e.connection;n&&(ne=!0,de(e,n,t))},r.addEventListener("ready",re))))}function de(e,t,n){t.subscribeMessage(e=>n(e),{type:"voice_satellite/subscribe_events",entity_id:e.config.satellite_entity}).then(t=>{te=t,le=0,e.logger.log("satellite-sub",`Subscribed to satellite events for ${e.config.satellite_entity}`)}).catch(t=>{e.logger.error("satellite-sub",`Failed to subscribe: ${t}`),ne=!1,function(e,t,n){if(ae)return;const r=oe[Math.min(le,oe.length-1)];le++,e.logger.log("satellite-sub",`Retrying in ${r/1e3}s (attempt ${le})`),ae=setTimeout(()=>{if(ae=null,ne)return;const t=e.connection;t&&(ne=!0,de(e,t,n))},r)}(e,0,n)})}function ue(){if(ae&&(clearTimeout(ae),ae=null),le=0,te){try{te()}catch(e){}te=null}ne=!1}class he{constructor(e){this._card=e,this._log=e.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){this._handler||(this._handler=()=>this._handleChange(),document.addEventListener("visibilitychange",this._handler))}_handleChange(){this._debounceTimer&&clearTimeout(this._debounceTimer),this._card.isOwner&&(document.hidden?(this._isPaused=!0,this._card.askQuestion.cancel(),a.includes(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(()=>{this._log.log("visibility","Tab hidden — pausing mic"),this._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume()))}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}async _resume(){if(!this._isPaused)return;const{pipeline:e,audio:t}=this._card;e.resetForResume(),await this._card.audio.resume(),this._isPaused=!1,null===P?(ie&&se&&(ue(),ce(ie,se)),this._log.log("visibility","Resuming — restarting pipeline"),e.restart(0)):this._log.log("visibility","Resuming — satellite event pending, deferring pipeline restart")}}function pe(e,t,n,r,i){t.subscribeEvents(e=>{const{data:t}=e;t&&t.new_state&&t.entity_id===n&&r(t.new_state.attributes||{})},"state_changed").then(t=>{e._unsubscribe=t,e.log.log(i,`Subscribed to state changes for ${n}`);const s=e.card.hass;s?.states?.[n]&&r(s.states[n].attributes||{})}).catch(t=>{e.log.error(i,`Failed to subscribe: ${t}`),e._subscribed=!1})}let ge="";function _e(){ge=""}let me=null,ve=null;function fe(e){e.card.ui.removeTimerContainer()}function be(e,t){e.card.ui.expireTimerPill(t,400);const n=e.timers.find(e=>e.id===t);n&&(n.el=null)}function ye(e){(function(e,t,n={}){const{onDone:r,log:i}=n;try{const{ctx:n,owned:i}=function(e){const t=e.audio?.audioContext;return t&&"closed"!==t.state?("suspended"===t.state&&t.resume(),{ctx:t,owned:!1}):{ctx:new(window.AudioContext||window.webkitAudioContext),owned:!0}}(e),s=.25*e.mediaPlayer.volume;for(const e of t.notes){const r=n.createOscillator(),i=n.createGain();r.connect(i),i.connect(n.destination),r.type=t.wave,r.frequency.setValueAtTime(e.freq,n.currentTime+e.start),i.gain.setValueAtTime(0,n.currentTime+e.start),i.gain.linearRampToValueAtTime(s,n.currentTime+e.start+.02),i.gain.exponentialRampToValueAtTime(.001,n.currentTime+e.end),r.start(n.currentTime+e.start),r.stop(n.currentTime+e.end)}t.totalMs||r?setTimeout(()=>{i&&n.close(),r?.()},t.totalMs||600):i&&setTimeout(()=>n.close(),1e3)}catch(e){i?.error("chime",`Chime error: ${e}`),r?.()}})(e.card,A,{log:e.log}),e.log.log("timer","Alert chime played")}class xe{constructor(e){this._card=e,this._log=e.logger,this._timers=[],this._tickInterval=null,this._container=null,this._unsubscribe=null,this._subscribed=!1,this._reconnectListener=null,this._knownTimerIds=[],this._alertActive=!1,this._alertEl=null}update(){if(this._subscribed)return;const{config:e,connection:t}=this._card;e.satellite_entity&&t&&function(e,t,n,r,i){e._subscribed=!0,e._entityId=n,pe(e,t,n,r,i),e._reconnectListener||(e._reconnectListener=()=>{if(!e.card.isOwner)return;if(e.log.log(i,"Connection reconnected — re-subscribing"),e._unsubscribe){try{e._unsubscribe()}catch(e){}e._unsubscribe=null}const t=e.card.connection;t&&pe(e,t,e._entityId,r,i)},t.addEventListener("ready",e._reconnectListener))}(this,t,e.satellite_entity,e=>this.processStateChange(e),"timer")}get card(){return this._card}get log(){return this._log}get timers(){return this._timers}set timers(e){this._timers=e}get knownTimerIds(){return this._knownTimerIds}set knownTimerIds(e){this._knownTimerIds=e}get alertActive(){return this._alertActive}set alertActive(e){this._alertActive=e}get isAlertActive(){return this._alertActive}dismissAlert(){this.clearAlert()}destroy(){var e;this.stopTick(),fe(this),this.clearAlert(),this._timers=[],this._knownTimerIds=[],_e(),(e=this)._unsubscribe&&(e._unsubscribe(),e._unsubscribe=null),e._reconnectListener&&e.card.connection&&(e.card.connection.removeEventListener("ready",e._reconnectListener),e._reconnectListener=null),e._subscribed=!1}processStateChange(e){!function(e,t){let n=t.active_timers;const r=t.last_timer_event;n&&Array.isArray(n)||(n=[]);const i=JSON.stringify(n);if(i===ge)return;e.log.log("timer",`State changed: timers=${i} last_event=${r}`),ge=i;const s=n.map(e=>e.id),a=e.knownTimerIds.filter(e=>!s.includes(e));a.length>0&&"finished"===r&&(e.log.log("timer",`Timer(s) finished: ${a.join(", ")}`),e.alertActive||e.showAlert());for(const t of a)e.removePill(t);e.knownTimerIds=s,e.syncTimers(n)}(this,e)}syncTimers(e){if(0===e.length)return this._timers=[],this.stopTick(),void fe(this);const t=Date.now(),n=[];for(const r of e){const e=this._timers.find(e=>e.id===r.id),i=r.started_at?1e3*r.started_at:t;if(e){if(e.totalSeconds!==r.total_seconds){e.totalSeconds=r.total_seconds,e.startedAt=i;const n=Math.floor((t-i)/1e3);e.secondsLeft=Math.max(0,r.total_seconds-n),e.startHours=r.start_hours||0,e.startMinutes=r.start_minutes||0,e.startSeconds=r.start_seconds||0}n.push(e)}else{const e=Math.floor((t-i)/1e3);n.push({id:r.id,name:r.name||"",totalSeconds:r.total_seconds,secondsLeft:Math.max(0,r.total_seconds-e),startedAt:i,startHours:r.start_hours||0,startMinutes:r.start_minutes||0,startSeconds:r.start_seconds||0,el:null})}}var r;this._timers=n,this.startTick(),(r=this).card.ui.syncTimerPills(r.timers,e=>()=>r.cancelTimer(e))}startTick(){this._tickInterval||(this._tickInterval=setInterval(()=>function(e){const t=Date.now();for(const n of e.timers){const r=Math.floor((t-n.startedAt)/1e3),i=Math.max(0,n.totalSeconds-r);n.secondsLeft=i,e.card.ui.updateTimerPill(n.el,i,n.totalSeconds)}}(this),1e3))}stopTick(){this._tickInterval&&(clearInterval(this._tickInterval),this._tickInterval=null)}showAlert(){var e;(e=this).alertActive?e.log.log("timer","Alert already active, skipping duplicate"):(e.alertActive=!0,e.log.log("timer","Showing finished alert"),e.card.ui.showBlurOverlay(c),e.card.ui.showTimerAlert(()=>e.clearAlert()),ye(e),me&&clearInterval(me),me=setInterval(()=>ye(e),3e3),ve&&clearTimeout(ve),ve=setTimeout(()=>e.clearAlert(),6e4))}clearAlert(){var e;(e=this).alertActive&&(e.alertActive=!1,me&&(clearInterval(me),me=null),ve&&(clearTimeout(ve),ve=null),e.card.ui.clearTimerAlert(),e.stopTick(),fe(e),e.timers=[],e.card.ui.hideBlurOverlay(c),e.log.log("timer","Alert dismissed"))}removePill(e){be(this,e)}cancelTimer(e){this._log.log("timer",`Cancelling timer: ${e}`),function(e,t){e.connection&&e.config.satellite_entity&&t&&e.connection.sendMessagePromise({type:"voice_satellite/cancel_timer",entity_id:e.config.satellite_entity,timer_id:t}).then(()=>{e.logger.log("timer",`Cancel timer ${t} succeeded`)}).catch(t=>{e.logger.error("timer",`Cancel timer failed: ${t.message||JSON.stringify(t)}`)})}(this._card,e),be(this,e);const t=this._timers.findIndex(t=>t.id===e);-1!==t&&this._timers.splice(t,1);const n=this._knownTimerIds.indexOf(e);-1!==n&&this._knownTimerIds.splice(n,1),_e(),0===this._timers.length&&(this.stopTick(),setTimeout(()=>{0===this._timers.length&&fe(this)},500))}}const Ae="announce";class we{constructor(e){this._card=e,this._log=e.logger,G(this)}get card(){return this._card}get log(){return this._log}playQueued(){const e=Q(this);e&&(this._log.log(Ae,`Playing queued announcement #${e.id}`),this._play(e))}_play(e){L(this,e,e=>this._onComplete(e),Ae)}_onComplete(e){this.currentAudio=null,this._log.log(Ae,`Announcement #${e.id} playback complete`),j(this._card,e.id,Ae),this._card.pipeline.restart(0);const t=1e3*(this._card.announcementDisplayDuration||3.5);this.clearTimeoutId=setTimeout(()=>{if(W(this),this.playing=!1,this.queued)return void this.playQueued();const e=!!this._card.ttsTarget;!1===S(this._card.hass,this._card.config.satellite_entity,"wake_sound")||e||this._card.tts.playChime("done")},t)}}function Ve(e,t,n,r){const{connection:i,config:s}=e,a=e.logger;if(!i||!s.satellite_entity)return a.error(r,"Cannot send answer — no connection or entity"),Promise.resolve(null);const o={type:"voice_satellite/question_answered",entity_id:s.satellite_entity,announce_id:t,sentence:n||""};return i.sendMessagePromise(o).then(e=>{const i=e?.matched,s=e?.id;return a.log(r,`Answer sent for #${t}: "${n}" — matched: ${i}${s?` (id: ${s})`:""}`),e}).catch(e=>(a.error(r,`Answer failed: ${e.message||JSON.stringify(e)}`),null))}const Te="ask-question";class ke{constructor(e){this._card=e,this._log=e.logger,G(this)}get card(){return this._card}get log(){return this._log}cancel(){this._chimeSettleTimeout&&(clearTimeout(this._chimeSettleTimeout),this._chimeSettleTimeout=null),this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null),this._cleanupTimeout&&(clearTimeout(this._cleanupTimeout),this._cleanupTimeout=null),this.currentAnnounceId&&!this._answerSent&&(this._answerSent=!0,Ve(this._card,this.currentAnnounceId,"","double-tap")),this._card.ui.hideBlurOverlay(d),this.playing=!1}playQueued(){const e=Q(this);e&&(this._log.log(Te,`Playing queued ask_question #${e.id}`),this._play(e))}_play(e){L(this,e,e=>this._onComplete(e),Te)}_onComplete(e){this.currentAudio=null,this._log.log(Te,`Question #${e.id} playback complete`),j(this._card,e.id,Te),this._enterSttMode(e)}_enterSttMode(e){this._log.log(Te,"Entering STT-only mode"),this._card.ui.setAnnouncementMode(!1),this._card.ui.showBlurOverlay(l);const{pipeline:t}=this._card;if(!t)return;const n=e.id,r=!!this._card.ttsTarget;this._card.analyser.reconnectMic();let i=0;r||(this._card.tts.playChime("wake"),i=500),this._answerSent=!1,this._chimeSettleTimeout=setTimeout(()=>{t.restartContinue(null,{end_stage:"stt",onSttEnd:e=>{this._log.log(Te,`STT result: "${e}"`),this._answerSent=!0,this._processAnswer(n,e,r)}}),this._sttSafetyTimeout=setTimeout(()=>{this._answerSent||(this._log.log(Te,`No STT result for #${n} — sending empty answer to release server`),this._answerSent=!0,this._processAnswer(n,"",r))},3e4)},i)}_processAnswer(e,t,n){this._chimeSettleTimeout&&(clearTimeout(this._chimeSettleTimeout),this._chimeSettleTimeout=null),this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null);const{pipeline:r}=this._card;let i=!1,s=null;this._cleanupTimeout=setTimeout(()=>{i||(i=!0,this._cleanupTimeout=null,null===s||s||this._card.ui.clearErrorBar(),W(this),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this.playing=!1,this.queued?this.playQueued():r.restart(0))},2e3),Ve(this._card,e,t,Te).then(e=>{const t=e?.matched;if(s=t,n||this._card.tts.playChime(t?"done":"error"),!t){this._card.ui.showErrorBar();const e=this._card.ui.element?this._card.ui.element.querySelector(".vs-rainbow-bar"):null;e&&(e.classList.add("error-flash"),e.addEventListener("animationend",function t(){e.classList.remove("error-flash"),e.removeEventListener("animationend",t)}))}})}}const Se="start-conversation";class Ce{constructor(e){this._card=e,this._log=e.logger,G(this)}get card(){return this._card}get log(){return this._log}playQueued(){const e=Q(this);e&&(this._log.log(Se,`Playing queued start_conversation #${e.id}`),this._play(e))}_play(e){L(this,e,e=>this._onComplete(e),Se)}_onComplete(e){this.currentAudio=null,this._log.log(Se,`Prompt #${e.id} playback complete`),j(this._card,e.id,Se),W(this),this.playing=!1,this._card.ui.showBlurOverlay(l);const{pipeline:t}=this._card;t&&t.restartContinue(null,{extra_system_prompt:e.extra_system_prompt||null})}}class Ee{constructor(e){this._card=e,this._log=e.logger,this._audio=null,this._playing=!1,this._paused=!1,this._volume=1,this._muted=!1,this._mediaId=null,this._volumeSynced=!1,this._activeSources=new Set,this._idleDebounce=null}get isPlaying(){return this._playing}get volume(){return this._syncInitialVolume(),this._muted?0:this._volume*this._volume}notifyAudioStart(e){this._idleDebounce&&(clearTimeout(this._idleDebounce),this._idleDebounce=null),this._activeSources.add(e),this._reportState("playing")}notifyAudioEnd(e){this._activeSources.delete(e),0!==this._activeSources.size||this._playing||this._paused||(this._idleDebounce&&clearTimeout(this._idleDebounce),this._idleDebounce=setTimeout(()=>{this._idleDebounce=null,0!==this._activeSources.size||this._playing||this._paused||this._reportState("idle")},200))}handleCommand(e){const{command:t}=e;switch(this._log.log("media-player",`Command: ${t}`),t){case"play":this._play(e);break;case"pause":this._pause();break;case"resume":this._resume();break;case"stop":this._stop();break;case"volume_set":this._setVolume(e.volume);break;case"volume_mute":this._setMute(e.mute);break;default:this._log.log("media-player",`Unknown command: ${t}`)}}interrupt(){(this._playing||this._paused)&&(this._log.log("media-player","Interrupted"),this._cleanup(),0===this._activeSources.size&&this._reportState("idle"))}_curved(e){return e*e}_effectiveVolume(){return this._muted?0:this._curved(this._volume)}_syncInitialVolume(){if(this._volumeSynced)return;const e=this._getEntityId();if(!e)return;const t=this._card.hass?.states?.[e];if(!t)return;const n=t.attributes?.volume_level;null!=n&&(this._volume=n,this._log.log("media-player",`Synced initial volume from entity: ${n}`));const r=t.attributes?.is_volume_muted;void 0!==r&&(this._muted=r),this._volumeSynced=!0}async _play(e){this._cleanup();const{media_id:t,volume:n}=e;let r;if(null!=n&&(this._volume=n),this._mediaId=t,t.startsWith("http://")||t.startsWith("https://"))r=t;else{const e=this._card.connection;if(e)try{r=w((await e.sendMessagePromise({type:"auth/sign_path",path:t,expires:3600})).path)}catch(e){this._log.error("media-player",`Failed to sign URL: ${e}`),r=w(t)}else r=w(t)}this._playing=!0,this._paused=!1,this._audio=V(r,this._effectiveVolume(),{onEnd:()=>{this._log.log("media-player","Playback complete"),this._playing=!1,this._paused=!1,this._audio=null,0===this._activeSources.size&&this._reportState("idle")},onError:e=>{this._log.error("media-player",`Playback error: ${e}`),this._playing=!1,this._paused=!1,this._audio=null,0===this._activeSources.size&&this._reportState("idle")},onStart:()=>{this._log.log("media-player",`Playing: ${t}`),this._reportState("playing")}})}_pause(){this._audio&&this._playing?(this._audio.pause(),this._playing=!1,this._paused=!0,this._reportState("paused")):this._reportState("idle")}_resume(){this._audio&&this._paused?(this._audio.play().catch(e=>{this._log.error("media-player",`Resume failed: ${e}`),this._cleanup(),this._reportState("idle")}),this._playing=!0,this._paused=!1,this._reportState("playing")):this._reportState("idle")}_stop(){this._audio&&(this._cleanup(),0===this._activeSources.size&&this._reportState("idle"))}_setVolume(e){this._volume=e;const t=this._effectiveVolume();this._audio&&(this._audio.volume=t),this._applyVolumeToExternalAudio(t);const n=this._playing||this._activeSources.size>0?"playing":this._paused?"paused":"idle";this._reportState(n)}_setMute(e){this._muted=e;const t=this._effectiveVolume();this._audio&&(this._audio.volume=t),this._applyVolumeToExternalAudio(t)}_applyVolumeToExternalAudio(e){const t=this._card.tts?._currentAudio;t&&(t.volume=e);for(const t of[this._card.announcement,this._card.askQuestion,this._card.startConversation])t?.currentAudio&&(t.currentAudio.volume=e)}_cleanup(){this._idleDebounce&&(clearTimeout(this._idleDebounce),this._idleDebounce=null),this._audio&&(this._audio.onended=null,this._audio.onerror=null,this._audio.pause(),this._audio.src="",this._audio=null),this._playing=!1,this._paused=!1}_getEntityId(){const e=this._card.hass,t=this._card.config.satellite_entity;if(!e?.entities||!t)return null;const n=e.entities[t];if(!n?.device_id)return null;for(const[t,r]of Object.entries(e.entities))if(r.device_id===n.device_id&&"voice_satellite"===r.platform&&t.startsWith("media_player."))return t;return null}_reportState(e){this._syncInitialVolume();const t=this._getEntityId();if(!t)return void this._log.log("media-player","No media_player entity found — skipping state report");const n=this._card.connection;if(!n)return;const r={type:"voice_satellite/media_player_event",entity_id:t,state:e};this._volumeSynced&&void 0!==this._volume&&(r.volume=this._volume),this._mediaId&&"idle"!==e&&(r.media_id=this._mediaId),n.sendMessagePromise(r).catch(e=>{this._log.error("media-player",`Failed to report state: ${JSON.stringify(e)}`)})}}const Me=[{name:"satellite_entity",required:!0,selector:{entity:{filter:{domain:"assist_satellite",integration:"voice_satellite"}}}}],Ie=[{type:"expandable",name:"",title:"Microphone Processing",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"noise_suppression",selector:{boolean:{}}},{name:"echo_cancellation",selector:{boolean:{}}},{name:"auto_gain_control",selector:{boolean:{}}},{name:"voice_isolation",selector:{boolean:{}}}]}]}],Be=[{name:"debug",selector:{boolean:{}}}],Fe=[{type:"expandable",name:"",title:"Appearance",flatten:!0,schema:[{name:"skin",default:"default",selector:{select:{options:Object.values(_).map(e=>({value:e.id,label:e.name})),mode:"dropdown"}}},{name:"reactive_bar",selector:{boolean:{}}},{name:"text_scale",default:100,selector:{number:{min:50,max:200,step:5,mode:"slider",unit_of_measurement:"%"}}},{name:"background_opacity",default:100,selector:{number:{min:0,max:100,step:5,mode:"slider",unit_of_measurement:"%"}}},{name:"custom_css",selector:{text:{multiline:!0}}}]}],Ue=Object.assign({},{satellite_entity:"Satellite entity",debug:"Debug logging",noise_suppression:"Noise suppression",echo_cancellation:"Echo cancellation",auto_gain_control:"Auto gain control",voice_isolation:"Voice isolation (Chrome only)"},{skin:"Skin",text_scale:"Text Scale",background_opacity:"Background Opacity",reactive_bar:"Reactive activity bar",custom_css:"Custom CSS"}),Re=Object.assign({},{satellite_entity:"Required. Install the Voice Satellite Card Integration: https://github.com/jxlarrea/voice-satellite-card-integration",voice_isolation:"AI-based voice isolation, currently only available in Chrome"},{background_opacity:"If not set, the skin's default opacity level will be used",reactive_bar:"Activity bar reacts to audio levels. Disable on slow devices to save resources.",custom_css:"Advanced: CSS overrides applied on top of the selected skin"});function Pe(e){let t=e;for(let e=0;e<20&&t;e++){const e=t.tagName;if("HUI-CARD-PREVIEW"===e)return!0;if("HUI-CARD"===e&&(t.hasAttribute("preview")||t.preview))return!0;if("HUI-DIALOG-EDIT-CARD"===e)return!0;if(e&&e.includes("PREVIEW"))return!0;t=t.parentElement||(t.getRootNode&&t.getRootNode()).host}return!1}function De(e,t){const n=m(t.skin||"default");e.innerHTML=`\n    <style>\n      /* Editor Preview — Base Layout & Shared Styles */\r\n\r\n:host {\r\n  display: block;\r\n  position: relative;\r\n  overflow: hidden;\r\n  border-radius: var(--ha-card-border-radius, 12px);\r\n  min-height: 380px;\r\n}\r\n\r\n.preview-background {\r\n  position: absolute;\r\n  top: 0; left: 0; right: 0; bottom: 0;\r\n  background-image:\r\n    linear-gradient(45deg, #e0e0e0 25%, transparent 25%),\r\n    linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),\r\n    linear-gradient(45deg, transparent 75%, #e0e0e0 75%),\r\n    linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);\r\n  background-size: 20px 20px;\r\n  background-position: 0 0, 0 10px, 10px -10px, -10px 0;\r\n  background-color: #f5f5f5;\r\n}\r\n\r\n@media (prefers-color-scheme: dark) {\r\n  .preview-background {\r\n    background-image:\r\n      linear-gradient(45deg, #333 25%, transparent 25%),\r\n      linear-gradient(-45deg, #333 25%, transparent 25%),\r\n      linear-gradient(45deg, transparent 75%, #333 75%),\r\n      linear-gradient(-45deg, transparent 75%, #333 75%);\r\n    background-color: #222;\r\n  }\r\n}\r\n\r\n:host-context([data-theme="dark"]) .preview-background,\r\n:host-context(.dark) .preview-background {\r\n  background-image:\r\n    linear-gradient(45deg, #333 25%, transparent 25%),\r\n    linear-gradient(-45deg, #333 25%, transparent 25%),\r\n    linear-gradient(45deg, transparent 75%, #333 75%),\r\n    linear-gradient(-45deg, transparent 75%, #333 75%);\r\n  background-color: #222;\r\n}\r\n\r\n.preview-container {\r\n  position: relative;\r\n  width: 100%;\r\n  min-height: 380px;\r\n  box-sizing: border-box;\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: flex-end;\r\n  padding: 24px 16px;\r\n}\r\n\r\n.preview-blur {\r\n  position: absolute;\r\n  top: 0; left: 0; right: 0; bottom: 0;\r\n  backdrop-filter: blur(4px);\r\n  -webkit-backdrop-filter: blur(4px);\r\n  z-index: 1;\r\n  pointer-events: none;\r\n}\r\n\r\n.preview-bar {\r\n  position: absolute;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  z-index: 2;\r\n  animation: preview-slide 2s linear infinite;\r\n}\r\n\r\n@keyframes preview-slide {\r\n  0% { background-position: 200% 0; }\r\n  100% { background-position: 0% 0; }\r\n}\r\n\r\n.preview-chat {\r\n  position: relative;\r\n  z-index: 3;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  width: 85%;\r\n  margin: 0 auto 24px;\r\n}\r\n\r\n.preview-msg {\r\n  max-width: 85%;\r\n  line-height: 1.2;\r\n  word-wrap: break-word;\r\n  animation: preview-fade-in 0.3s ease;\r\n}\r\n\r\n@keyframes preview-fade-in {\r\n  from { opacity: 0; transform: translateY(8px); }\r\n  to { opacity: 1; transform: translateY(0); }\r\n}\r\n\r\n.preview-timer {\r\n  position: absolute;\r\n  top: 12px;\r\n  right: 12px;\r\n  z-index: 4;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  overflow: hidden;\r\n  font-size: 30px;\r\n  font-weight: bold;\r\n  padding: 16px;\r\n}\r\n\r\n.preview-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  width: 65%;\r\n  height: 100%;\r\n  border-radius: inherit;\r\n}\r\n\r\n.preview-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n\r\n.preview-label {\r\n  position: absolute;\r\n  top: 12px;\r\n  left: 14px;\r\n  z-index: 5;\r\n  font-size: 11px;\r\n  font-weight: 500;\r\n  letter-spacing: 0.5px;\r\n  text-transform: uppercase;\r\n  pointer-events: none;\r\n}\r\n\n      ${n.previewCSS||""}\n    </style>\n    <div class="preview-background"></div>\n    <div class="preview-container">\n      <div class="preview-label">Preview</div>\n      <div class="preview-blur"></div>\n      <div class="preview-bar"></div>\n      <div class="preview-chat">\n        <div class="preview-msg user">What's the temperature outside?</div>\n        <div class="preview-msg assistant">It's currently 75°F and sunny.</div>\n      </div>\n      <div class="preview-timer">\n        <div class="preview-timer-progress"></div>\n        <div class="preview-timer-content">\n          <span>⏱</span>\n          <span class="preview-timer-time">00:04:32</span>\n        </div>\n      </div>\n    </div>\n  `}function Ne(e,t){const n=e.config.satellite_entity;n&&e.hass?.connection&&t!==e.lastSyncedSatelliteState&&(e.lastSyncedSatelliteState=t,e.hass.connection.sendMessagePromise({type:"voice_satellite/update_state",entity_id:n,state:t}).catch(()=>{}))}function qe(n,r){const i=n.currentState;n.currentState=r,n.logger.log("state",`${i} → ${r}`),n.ui.updateForState(r,n.pipeline.serviceUnavailable,n.tts.isPlaying),(!n.tts.isPlaying||r!==t&&r!==e)&&Ne(n,r)}async function $e(t){if(!X()||J(t))if(Z())t.logger.log("lifecycle","Pipeline already starting globally, skipping");else{ee(!0);try{qe(t,"CONNECTING"),await t.audio.startMicrophone(),await t.pipeline.start(),function(e){K.instance=e,K.active=!0}(t),t.ui.hideStartButton(),t.visibility.setup(),t.timer.update(),ce(t,e=>$(t,e)),t.doubleTap.setup()}catch(n){const r=n?.message||JSON.stringify(n);t.logger.error("pipeline",`Failed to start: ${r}`);let i="error";"NotAllowedError"===n.name?(i="not-allowed",t.logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===n.name?(i="not-found",t.logger.error("mic","No microphone found")):"NotReadableError"!==n.name&&"AbortError"!==n.name||(i="not-readable",t.logger.error("mic","Microphone in use or not readable")),"error"!==i?(t.ui.showStartButton(i),qe(t,e)):(qe(t,e),t.pipeline.restart(t.pipeline.calculateRetryDelay()))}finally{ee(!1)}}else t.logger.log("lifecycle","Another instance is active, skipping")}class ze extends HTMLElement{constructor(){super(),this._state=e,this._lastSyncedSatelliteState=null,this._config=Object.assign({},u),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new v,this._audio=new f(this),this._analyser=new b(this),this._tts=new k(this),this._pipeline=new E(this),this._ui=new I(this),this._chat=new F(this),this._doubleTap=new Y(this),this._visibility=new he(this),this._timer=new xe(this),this._announcement=new we(this),this._askQuestion=new ke(this),this._startConversation=new Ce(this),this._mediaPlayer=new Ee(this)}get logger(){return this._logger}get audio(){return this._audio}get analyser(){return this._analyser}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get doubleTap(){return this._doubleTap}get visibility(){return this._visibility}get config(){return this._config}get timer(){return this._timer}get announcement(){return this._announcement}get askQuestion(){return this._askQuestion}get startConversation(){return this._startConversation}get mediaPlayer(){return this._mediaPlayer}get currentState(){return this._state}set currentState(e){this._state=e}get lastSyncedSatelliteState(){return this._lastSyncedSatelliteState}set lastSyncedSatelliteState(e){this._lastSyncedSatelliteState=e}get isOwner(){return J(this)}get connection(){return!this._connection&&this._hass?.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}get ttsTarget(){return function(e,t){if(!e?.entities||!t)return;const n=e.entities[t];if(n?.device_id)for(const[t,r]of Object.entries(e.entities))if(r.device_id===n.device_id&&"voice_satellite"===r.platform&&"tts_output"===r.translation_key)return e.states[t]?.attributes?.entity_id||""}(this._hass,this._config.satellite_entity)||""}get announcementDisplayDuration(){return function(e,t,n,r){if(!e?.entities||!t)return r;const i=e.entities[t];if(!i?.device_id)return r;for(const[t,n]of Object.entries(e.entities))if(n.device_id===i.device_id&&"voice_satellite"===n.platform&&"announcement_display_duration"===n.translation_key){const n=parseFloat(e.states[t]?.state);return isNaN(n)?r:n}return r}(this._hass,this._config.satellite_entity,0,3.5)}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render(),requestAnimationFrame(()=>{Pe(this)&&this.shadowRoot?De(this.shadowRoot,this._config):this._config.satellite_entity&&(this._ui.ensureGlobalUI(),this._visibility.setup(),!X()&&this._hass?.connection&&$e(this))})}disconnectedCallback(){this._disconnectTimeout=setTimeout(()=>{},100)}setConfig(e){const t=!!this._config.satellite_entity,n=m(e.skin||"default");if(this._config=Object.assign({},u,e),this._activeSkin=n,this._logger.debug=this._config.debug,this._ui.element){this._ui.applyStyles();const e=n.reactiveBar&&!1!==this._config.reactive_bar;e&&this._audio._sourceNode&&this._audio._audioContext?this._analyser.attachMic(this._audio._sourceNode,this._audio._audioContext):e||(this._audio._sourceNode&&this._analyser.detachMic(this._audio._sourceNode),this._analyser.stop()),this._ui.updateForState(this._state,this._pipeline?.serviceUnavailable,this._tts?.isPlaying)}this.shadowRoot&&Pe(this)&&De(this.shadowRoot,this._config),K.instance&&K.instance!==this&&K.instance.setConfig(this.config),t||!this._config.satellite_entity||this._hasStarted||!this._hass?.connection||Pe(this)||(this._connection=this._hass.connection,this._ui.ensureGlobalUI(),this._hasStarted=!0,$e(this))}set hass(e){this._hass=e,Pe(this)||(X()&&J(this)&&(this._timer.update(),this._tts.checkRemotePlayback(e),ce(this,e=>$(this,e))),this._hasStarted||e?.connection&&this._config.satellite_entity&&(Z()||X()&&!J(this)||(this._connection=e.connection,this._ui.ensureGlobalUI(),this._hasStarted=!0,$e(this))))}getCardSize(){return 0}static getConfigForm(){return{schema:[...Me,...Fe,...Ie,...Be],assertConfig(e){const t=this;Promise.resolve().then(()=>{t._config=Object.assign({},u,e)})},computeLabel:e=>Ue[e.name]||void 0,computeHelper:e=>Re[e.name]||void 0}}static getStubConfig(){return{skin:"default",text_scale:100}}setState(e){qe(this,e)}onStartClick(){!async function(e){await e.audio.ensureAudioContextForGesture(),await $e(e)}(this)}onPipelineMessage(t){!function(t,n){if(t.visibility.isPaused)return void t.logger.log("event",`Ignoring event while paused: ${n.type}`);if(t.pipeline.isRestarting)return void t.logger.log("event",`Ignoring event while restarting: ${n.type}`);const a=n.type,o=n.data||{};if(t.config.debug){const e=n.timestamp?n.timestamp.split("T")[1].split(".")[0]:"";t.logger.log("event",`${e} ${a} ${JSON.stringify(o).substring(0,500)}`)}switch(a){case"run-start":t.pipeline.handleRunStart(o);break;case"wake_word-start":t.pipeline.handleWakeWordStart();break;case"wake_word-end":t.pipeline.handleWakeWordEnd(o);break;case"stt-start":qe(t,r);break;case"stt-vad-start":t.logger.log("event","VAD: speech started");break;case"stt-vad-end":t.logger.log("event","VAD: speech ended");break;case"stt-end":t.pipeline.handleSttEnd(o);break;case"intent-start":qe(t,i);break;case"intent-progress":t.pipeline.handleIntentProgress(o);break;case"intent-end":t.pipeline.handleIntentEnd(o);break;case"tts-start":qe(t,s);break;case"tts-end":t.pipeline.handleTtsEnd(o);break;case"run-end":t.pipeline.handleRunEnd();break;case"error":t.pipeline.handleError(o);break;case"displaced":t.logger.error("pipeline","Pipeline displaced — another browser is using this satellite entity"),t.pipeline.stop(),t.audio.stopMicrophone(),t.tts.stop(),t.timer.destroy(),ue(),re&&ie?.connection&&(ie.connection.removeEventListener("ready",re),re=null),ie=null,se=null,t.chat.clear(),t.ui.hideBlurOverlay(l),t.ui.hideBlurOverlay(d),K.instance=null,K.active=!1,K.starting=!1,t.currentState=e,t.ui.showStartButton()}}(this,t)}onTTSComplete(e){!function(e,t){if([n,r,i].includes(e.currentState))return void e.logger.log("tts","New interaction in progress — skipping cleanup");if(!t&&e.pipeline.shouldContinue&&e.pipeline.continueConversationId){e.logger.log("pipeline","Continuing conversation — skipping wake word");const t=e.pipeline.continueConversationId;return e.pipeline.clearContinueState(),e.chat.streamEl=null,void e.pipeline.restartContinue(t)}const s=!!e.ttsTarget;!1===S(e.hass,e.config.satellite_entity,"wake_sound")||s||e.tts.playChime("done"),e.chat.clear(),e.ui.hideBlurOverlay(l),e.ui.updateForState(e.currentState,e.pipeline.serviceUnavailable,!1),Ne(e,"IDLE"),e.announcement.playQueued(),e.askQuestion.playQueued(),e.startConversation.playQueued()}(this,e)}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),Pe(this)?De(this.shadowRoot,this._config):this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}}customElements.define("voice-satellite-card",ze),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v4.2.2 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();