(()=>{"use strict";const t="IDLE",e="LISTENING",n="WAKE_WORD_DETECTED",i="STT",r="INTENT",s="TTS",o=[n,i,r,s],a=["timeout","wake-word-timeout","stt-no-text-recognized","duplicate_wake_up_detected"],l="pipeline",c="timer",u="announcement",d={start_listening_on_load:!0,satellite_entity:"",chime_volume:100,tts_volume:100,tts_target:"",double_tap_cancel:!0,debug:!1,noise_suppression:!0,echo_cancellation:!0,auto_gain_control:!0,voice_isolation:!1,timer_position:"top-right",timer_font_size:20,timer_font_family:"inherit",timer_font_color:"#444444",timer_font_bold:!0,timer_font_italic:!1,timer_background:"#ffffff",timer_border_color:"rgba(100, 200, 150, 0.5)",timer_padding:16,timer_rounded:!0,timer_finished_duration:60,announcement_display_duration:5,bar_position:"bottom",bar_height:16,bar_gradient:"#FF7777, #FF9977, #FFCC77, #CCFF77, #77FFAA, #77DDFF, #77AAFF, #AA77FF, #FF77CC",background_blur:!0,background_blur_intensity:5,transcription_font_size:20,transcription_font_family:"inherit",transcription_font_color:"#444444",transcription_font_bold:!0,transcription_font_italic:!1,transcription_background:"#ffffff",transcription_border_color:"rgba(0, 180, 255, 0.5)",transcription_padding:16,transcription_rounded:!0,show_response:!0,response_font_size:20,response_font_family:"inherit",response_font_color:"#444444",response_font_bold:!0,response_font_italic:!1,response_background:"#ffffff",response_border_color:"rgba(100, 200, 150, 0.5)",response_padding:16,response_rounded:!0,bubble_style:"chat",bubble_container_width:85};function h(t){const e=t.split(",").map(t=>t.trim());return e.length>1&&e[0]!==e[e.length-1]&&e.push(e[0]),`linear-gradient(90deg, ${e.join(", ")})`}class _{constructor(){this._debug=!1}set debug(t){this._debug=!!t}log(t,e,n){this._debug&&(void 0!==n?console.log(`[VS][${t}] ${e}`,n):console.log(`[VS][${t}] ${e}`))}error(t,e,n){void 0!==n?console.error(`[VS][${t}] ${e}`,n):console.error(`[VS][${t}] ${e}`)}}class p{constructor(t){this._card=t,this._log=t.logger,this._audioContext=null,this._mediaStream=null,this._sourceNode=null,this._workletNode=null,this._scriptProcessor=null,this._audioBuffer=[],this._sendInterval=null,this._actualSampleRate=16e3}get card(){return this._card}get log(){return this._log}get audioContext(){return this._audioContext}get workletNode(){return this._workletNode}set workletNode(t){this._workletNode=t}get scriptProcessor(){return this._scriptProcessor}set scriptProcessor(t){this._scriptProcessor=t}get audioBuffer(){return this._audioBuffer}set audioBuffer(t){this._audioBuffer=t}get actualSampleRate(){return this._actualSampleRate}async startMicrophone(){await this._ensureAudioContextRunning();const{config:t}=this._card;this._log.log("mic",`AudioContext state=${this._audioContext.state} sampleRate=${this._audioContext.sampleRate}`);const e={sampleRate:16e3,channelCount:1,echoCancellation:t.echo_cancellation,noiseSuppression:t.noise_suppression,autoGainControl:t.auto_gain_control};if(t.voice_isolation&&(e.advanced=[{voiceIsolation:!0}]),this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:e}),t.debug){const t=this._mediaStream.getAudioTracks();this._log.log("mic",`Got media stream with ${t.length} audio track(s)`),t.length>0&&this._log.log("mic",`Track settings: ${JSON.stringify(t[0].getSettings())}`)}this._sourceNode=this._audioContext.createMediaStreamSource(this._mediaStream),this._actualSampleRate=this._audioContext.sampleRate,this._log.log("mic",`Actual sample rate: ${this._actualSampleRate}`);try{await async function(t,e){const n=new Blob(['class VoiceSatelliteProcessor extends AudioWorkletProcessor {constructor() { super(); this.buffer = []; }process(inputs, outputs, parameters) {var input = inputs[0];if (input && input[0]) {var channelData = new Float32Array(input[0]);this.port.postMessage(channelData);}return true;}}registerProcessor("voice-satellite-processor", VoiceSatelliteProcessor);'],{type:"application/javascript"}),i=URL.createObjectURL(n);await t.audioContext.audioWorklet.addModule(i),URL.revokeObjectURL(i),t.workletNode=new AudioWorkletNode(t.audioContext,"voice-satellite-processor"),t.workletNode.port.onmessage=e=>{t.audioBuffer.push(new Float32Array(e.data))},e.connect(t.workletNode),t.workletNode.connect(t.audioContext.destination)}(this,this._sourceNode),this._log.log("mic","Audio capture via AudioWorklet")}catch(t){this._log.log("mic",`AudioWorklet unavailable (${t.message}), using ScriptProcessor`),n=this,i=this._sourceNode,n.scriptProcessor=n.audioContext.createScriptProcessor(2048,1,1),n.scriptProcessor.onaudioprocess=t=>{const e=t.inputBuffer.getChannelData(0);n.audioBuffer.push(new Float32Array(e))},i.connect(n.scriptProcessor),n.scriptProcessor.connect(n.audioContext.destination),this._log.log("mic","Audio capture via ScriptProcessor")}var n,i}stopMicrophone(){this.stopSending(),this._workletNode&&(this._workletNode.disconnect(),this._workletNode=null),this._scriptProcessor&&(this._scriptProcessor.disconnect(),this._scriptProcessor=null),this._sourceNode&&(this._sourceNode.disconnect(),this._sourceNode=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(t=>t.stop()),this._mediaStream=null),this._audioBuffer=[]}startSending(t){this.stopSending(),this._sendInterval=setInterval(()=>{!function(t,e){if(null==e)return;if(0===t.audioBuffer.length)return;let n=0;for(const e of t.audioBuffer)n+=e.length;const i=new Float32Array(n);let r=0;for(const e of t.audioBuffer)i.set(e,r),r+=e.length;t.audioBuffer=[];const s=function(t){const e=new Int16Array(t.length);for(let n=0;n<t.length;n++){const i=Math.max(-1,Math.min(1,t[n]));e[n]=i<0?32768*i:32767*i}return e}(16e3!==t.actualSampleRate?function(t,e){if(16e3===e)return t;const n=e/16e3,i=Math.round(t.length/n),r=new Float32Array(i);for(let e=0;e<i;e++){const i=e*n,s=Math.floor(i),o=Math.min(s+1,t.length-1),a=i-s;r[e]=t[s]*(1-a)+t[o]*a}return r}(i,t.actualSampleRate):i);!function(t,e,n){const{connection:i}=t;if(!i?.socket)return;if(i.socket.readyState!==WebSocket.OPEN)return;const r=new Uint8Array(1+e.byteLength);r[0]=n,r.set(new Uint8Array(e.buffer),1),i.socket.send(r.buffer)}(t.card,s,e)}(this,t())},100)}stopSending(){this._sendInterval&&(clearInterval(this._sendInterval),this._sendInterval=null)}pause(){this.stopSending(),this._mediaStream?.getAudioTracks().forEach(t=>{t.enabled=!1})}async resume(){this._audioBuffer=[],this._mediaStream?.getAudioTracks().forEach(t=>{t.enabled=!0}),"suspended"===this._audioContext?.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume())}async ensureAudioContextForGesture(){try{this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&await this._audioContext.resume()}catch(t){this._log.error("mic",`Failed to resume AudioContext on click: ${t}`)}}async _ensureAudioContextRunning(){if(this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),"suspended"===this._audioContext.state&&(this._log.log("mic","Resuming suspended AudioContext"),await this._audioContext.resume()),"running"!==this._audioContext.state)throw new Error(`AudioContext failed to start: ${this._audioContext.state}`)}}const g={type:"single",wave:"sine",notes:[{freq:784,start:0},{freq:659,start:.08}],duration:.25},m={type:"multi",wave:"sine",notes:[{freq:784,start:0,end:.15},{freq:587,start:.18,end:.4}],totalMs:500},b={type:"multi",wave:"sine",notes:[{freq:880,start:0,end:.15},{freq:660,start:.18,end:.33},{freq:880,start:.36,end:.55}]};function f(t,e,n={}){const{onDone:i,log:r}=n;try{const{ctx:n,owned:r}=function(t){const e=t.audio?.audioContext;return e&&"closed"!==e.state?("suspended"===e.state&&e.resume(),{ctx:e,owned:!1}):{ctx:new(window.AudioContext||window.webkitAudioContext),owned:!0}}(t),s=t.config.chime_volume/100*.5;for(const t of e.notes){const i=n.createOscillator(),r=n.createGain();i.connect(r),r.connect(n.destination),i.type=e.wave,i.frequency.setValueAtTime(t.freq,n.currentTime+t.start),r.gain.setValueAtTime(0,n.currentTime+t.start),r.gain.linearRampToValueAtTime(s,n.currentTime+t.start+.02),r.gain.exponentialRampToValueAtTime(.001,n.currentTime+t.end),i.start(n.currentTime+t.start),i.stop(n.currentTime+t.end)}e.totalMs||i?setTimeout(()=>{r&&n.close(),i?.()},e.totalMs||600):r&&setTimeout(()=>n.close(),1e3)}catch(t){r?.error("chime",`Chime error: ${t}`),i?.()}}function y(t){if(t.startsWith("http://")||t.startsWith("https://"))return t;const e=window.location.origin;return t.startsWith("/")?e+t:`${e}/${t}`}function v(t,e,{onEnd:n,onError:i,onStart:r}){const s=new Audio;return s.volume=e,s.onended=()=>{n()},s.onerror=t=>{i(t)},s.src=t,s.play().then(()=>{r?.()}).catch(t=>{i(t)}),s}const w={wake:{type:"single",wave:"sine",notes:[{freq:523,start:0},{freq:659,start:.08},{freq:784,start:.16}],duration:.25},error:{type:"single",wave:"square",volumeScale:.3,notes:[{freq:300,start:0},{freq:200,start:.08}],duration:.15},done:g};class S{constructor(t){this._card=t,this._log=t.logger,this._currentAudio=null,this._playing=!1,this._endTimer=null,this._streamingUrl=null,this._playbackWatchdog=null}get isPlaying(){return this._playing}get streamingUrl(){return this._streamingUrl}set streamingUrl(t){this._streamingUrl=t}play(t){const{config:e}=this._card,n=y(t);if(this._playing=!0,e.tts_target&&"browser"!==e.tts_target)return function(t,e){const n=t.config.tts_target;t.logger.log("tts",`Playing on remote: ${n} URL: ${e}`),t.hass.callService("media_player","play_media",{entity_id:n,media_content_id:e,media_content_type:"music"}).catch(e=>{t.logger.error("tts",`Remote play failed: ${e}`)})}(this._card,n),void(this._endTimer=setTimeout(()=>{this._endTimer=null,this._onComplete()},2e3));this._playbackWatchdog=setTimeout(()=>{this._playbackWatchdog=null,this._playing&&this._currentAudio&&(this._log.log("tts","Playback watchdog fired — forcing completion"),this._onComplete())},3e4),this._currentAudio=v(n,e.tts_volume/100,{onEnd:()=>{this._log.log("tts","Playback complete"),this._clearWatchdog(),this._onComplete()},onError:t=>{this._log.error("tts",`Playback error: ${t}`),this._log.error("tts",`URL: ${n}`),this._clearWatchdog(),this._onComplete(!0)},onStart:()=>{this._log.log("tts","Playback started successfully")}})}stop(){var t;this._playing=!1,this._clearWatchdog(),this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._currentAudio&&(this._currentAudio.onended=null,this._currentAudio.onerror=null,this._currentAudio.pause(),this._currentAudio.src="",this._currentAudio=null),(t=this._card).config.tts_target&&"browser"!==t.config.tts_target&&t.hass&&t.hass.callService("media_player","media_stop",{entity_id:t.config.tts_target}).catch(e=>{t.logger.error("tts",`Remote stop failed: ${e}`)})}storeStreamingUrl(t){if(this._streamingUrl=null,t.tts_output?.url&&t.tts_output?.stream_response){const e=t.tts_output.url;this._streamingUrl=e.startsWith("http")?e:window.location.origin+e,this._log.log("tts",`Streaming TTS URL available: ${this._streamingUrl}`)}}playChime(t){const e=w[t]||g;!function(t,e,n){try{const n=new(window.AudioContext||window.webkitAudioContext),i=n.createOscillator(),r=n.createGain();i.connect(r),r.connect(n.destination);const s=t.config.chime_volume/100*.5*(e.volumeScale||1);i.type=e.wave,r.gain.setValueAtTime(s,n.currentTime),r.gain.exponentialRampToValueAtTime(.001,n.currentTime+e.duration);for(const t of e.notes)i.frequency.setValueAtTime(t.freq,n.currentTime+t.start);i.start(),i.stop(n.currentTime+e.duration),setTimeout(()=>n.close(),500)}catch(t){n?.error("chime",`Chime error: ${t}`)}}(this._card,e,this._log)}_clearWatchdog(){this._playbackWatchdog&&(clearTimeout(this._playbackWatchdog),this._playbackWatchdog=null)}_onComplete(t){this._log.log("tts","Complete — cleaning up UI"+(t?" (playback failed)":"")),this._currentAudio=null,this._playing=!1,this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null),this._card.onTTSComplete(t)}}function T(t,e,n){if(!t||!e)return;if(t.entities){const i=t.entities[e];if(i?.device_id)for(const[e,r]of Object.entries(t.entities))if(r.device_id===i.device_id&&"voice_satellite"===r.platform&&r.translation_key===n)return"on"===t.states[e]?.state}const i=function(t,e,n){if(!t||!e)return;const i=t.states[e];return i?.attributes?.[n]}(t,e,"mute"===n?"muted":n);return void 0!==i?!0===i:void 0}function k(t,e){try{const t=e.intent_output.response.speech.plain.speech;if(t)return t}catch(t){}try{if(e.intent_output.response.speech.speech)return e.intent_output.response.speech.speech}catch(t){}try{if(e.intent_output.response.plain)return e.intent_output.response.plain}catch(t){}try{if("string"==typeof e.intent_output.response)return e.intent_output.response}catch(t){}return t.log.log("error","Could not extract response text"),null}class C{constructor(t){this._card=t,this._log=t.logger,this._unsubscribe=null,this._binaryHandlerId=null,this._retryCount=0,this._serviceUnavailable=!1,this._restartTimeout=null,this._isRestarting=!1,this._pendingRunEnd=!1,this._recoveryTimeout=null,this._suppressTTS=!1,this._intentErrorBarTimeout=null,this._continueConversationId=null,this._shouldContinue=!1,this._continueMode=!1,this._isStreaming=!1,this._askQuestionCallback=null,this._askQuestionHandled=!1,this._reconnectRef={listener:null},this._muteCheckId=null,this._runStartReceived=!1,this._wakeWordPhase=!1,this._errorReceived=!1}get card(){return this._card}get log(){return this._log}get binaryHandlerId(){return this._binaryHandlerId}set binaryHandlerId(t){this._binaryHandlerId=t}get isRestarting(){return this._isRestarting}get serviceUnavailable(){return this._serviceUnavailable}set serviceUnavailable(t){this._serviceUnavailable=t}get shouldContinue(){return this._shouldContinue}set shouldContinue(t){this._shouldContinue=t}get continueConversationId(){return this._continueConversationId}set continueConversationId(t){this._continueConversationId=t}get continueMode(){return this._continueMode}set continueMode(t){this._continueMode=t}get retryCount(){return this._retryCount}set retryCount(t){this._retryCount=t}get pendingRunEnd(){return this._pendingRunEnd}set pendingRunEnd(t){this._pendingRunEnd=t}get suppressTTS(){return this._suppressTTS}set suppressTTS(t){this._suppressTTS=t}get recoveryTimeout(){return this._recoveryTimeout}set recoveryTimeout(t){this._recoveryTimeout=t}get intentErrorBarTimeout(){return this._intentErrorBarTimeout}set intentErrorBarTimeout(t){this._intentErrorBarTimeout=t}get askQuestionCallback(){return this._askQuestionCallback}set askQuestionCallback(t){this._askQuestionCallback=t}get askQuestionHandled(){return this._askQuestionHandled}set askQuestionHandled(t){this._askQuestionHandled=t}async start(t){const e=t||{},{connection:n,config:i}=this._card;if(!n)throw new Error("No Home Assistant connection available");if(!i.satellite_entity)throw new Error("No satellite_entity configured");if(this._muteCheckId&&(clearTimeout(this._muteCheckId),this._muteCheckId=null),!0===T(this._card.hass,i.satellite_entity,"mute"))return this._log.log("pipeline","Satellite muted — pipeline blocked"),this._card.ui.showErrorBar(),void(this._muteCheckId=setTimeout(()=>{this._muteCheckId=null,this.start(e).catch(()=>{})},2e3));if(this._card.ui.clearErrorBar(),this._unsubscribe){this._log.log("pipeline","Cleaning up previous subscription");try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}this._binaryHandlerId=null,function(t,e,n,i){i.listener||(i.listener=()=>{t.logger.log("pipeline","Connection reconnected — resetting retry state"),e.resetRetryState(),t.ui.clearErrorBar(),t.visibility.isPaused?t.logger.log("pipeline","Tab is paused — deferring restart to resume"):setTimeout(()=>e.restart(0),2e3)},n.addEventListener("ready",i.listener))}(this._card,this,n,this._reconnectRef);const r={start_stage:e.start_stage||"wake_word",end_stage:e.end_stage||"tts",sample_rate:16e3};let s;e.conversation_id&&(r.conversation_id=e.conversation_id),e.extra_system_prompt&&(r.extra_system_prompt=e.extra_system_prompt),this._runStartReceived=!1,this._log.log("pipeline",`Starting pipeline: ${JSON.stringify(r)}`);const o=new Promise(t=>{s=t});this._unsubscribe=await async function(t,e,n,i){return t.subscribeMessage(i,{type:"voice_satellite/run_pipeline",entity_id:e,...n})}(n,i.satellite_entity,r,t=>{if("init"===t.type)return this._binaryHandlerId=t.handler_id,this._log.log("pipeline",`Init — handler ID: ${t.handler_id}`),void s();this._card.onPipelineMessage(t)}),this._log.log("pipeline","Pipeline subscribed, waiting for init event..."),await o,this._log.log("pipeline",`Handler ID confirmed: ${this._binaryHandlerId} — starting audio`);const{audio:a}=this._card;a.startSending(()=>this._binaryHandlerId),this._isStreaming=!0}async stop(){if(this._card.audio.stopSending(),this._binaryHandlerId=null,this._isStreaming=!1,this._muteCheckId&&(clearTimeout(this._muteCheckId),this._muteCheckId=null),this._unsubscribe){try{await this._unsubscribe()}catch(t){}this._unsubscribe=null}}restart(t){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping"):(this._isRestarting=!0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this.stop().then(()=>{this._restartTimeout=setTimeout(()=>{this._restartTimeout=null,this._isRestarting=!1,this.start().catch(t=>{const e=t?.message||JSON.stringify(t);this._log.error("pipeline",`Restart failed: ${e}`),this._serviceUnavailable||(this._card.ui.showErrorBar(),this._serviceUnavailable=!0),this.restart(this.calculateRetryDelay())})},t||0)}))}restartContinue(t,e={}){this._isRestarting?this._log.log("pipeline","Restart already in progress — skipping continue"):(this._isRestarting=!0,this._askQuestionCallback=e.onSttEnd||null,this.stop().then(()=>{this._isRestarting=!1,this._continueMode=!0;const n={start_stage:"stt",end_stage:e.end_stage||"tts",conversation_id:t};e.extra_system_prompt&&(n.extra_system_prompt=e.extra_system_prompt),this.start(n).catch(t=>{this._log.error("pipeline",`Continue conversation failed: ${t?.message||JSON.stringify(t)}`),this._askQuestionCallback=null,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this.restart(0)})}))}handleRunStart(t){this._runStartReceived=!0,this._wakeWordPhase=!1,this._errorReceived=!1,function(t,n){if(t.card.tts.storeStreamingUrl(n),t.continueMode)return t.continueMode=!1,t.card.setState(i),t.log.log("pipeline",`Running (continue conversation) — binary handler ID: ${t.binaryHandlerId}`),void t.log.log("pipeline","Listening for speech...");t.card.setState(e),t.log.log("pipeline",`Running — binary handler ID: ${t.binaryHandlerId}`),t.log.log("pipeline","Listening for wake word...")}(this,t)}handleWakeWordStart(){var t;this._wakeWordPhase=!0,(t=this).serviceUnavailable&&(t.recoveryTimeout&&clearTimeout(t.recoveryTimeout),t.recoveryTimeout=setTimeout(()=>{t.serviceUnavailable&&(t.log.log("recovery","Wake word service recovered"),t.serviceUnavailable=!1,t.retryCount=0,t.card.ui.clearErrorBar(),t.card.ui.hideBar())},2e3))}handleWakeWordEnd(t){if(!this._runStartReceived)return void this._log.log("pipeline","Ignoring stale wake_word-end (no run-start received for this subscription)");const e=t?.wake_word_output;e&&e.wake_word_id?(this._wakeWordPhase=!1,function(t,e){const i=e.wake_word_output;if(!i||0===Object.keys(i).length)return t.log.error("error","Wake word service unavailable (empty wake_word_output)"),t.recoveryTimeout&&(clearTimeout(t.recoveryTimeout),t.recoveryTimeout=null),t.binaryHandlerId=null,t.card.ui.showErrorBar(),t.serviceUnavailable=!0,void t.restart(t.calculateRetryDelay());t.recoveryTimeout&&(clearTimeout(t.recoveryTimeout),t.recoveryTimeout=null),t.serviceUnavailable=!1,t.retryCount=0,t.card.ui.clearErrorBar();const{tts:r}=t.card;r.isPlaying&&(r.stop(),t.pendingRunEnd=!1),t.intentErrorBarTimeout&&(clearTimeout(t.intentErrorBarTimeout),t.intentErrorBarTimeout=null),t.card.chat.clear(),t.shouldContinue=!1,t.continueConversationId=null,t.card.setState(n),!1!==T(t.card.hass,t.card.config.satellite_entity,"wake_sound")&&r.playChime("wake"),t.card.ui.showBlurOverlay(l)}(this,t)):this._log.log("pipeline","Ignoring empty wake_word-end (pipeline stopped during restart)")}handleSttEnd(t){!function(t,e){const n=e.stt_output?.text||"";if(n&&t.card.chat.showTranscription(n),t.askQuestionCallback){const e=t.askQuestionCallback;t.askQuestionCallback=null,t.askQuestionHandled=!0,t.log.log("pipeline",`Ask question STT complete: "${n}"`),e(n)}}(this,t)}handleIntentProgress(t){!function(t,e){const{tts:n}=t.card;if(e.tts_start_streaming&&n.streamingUrl&&!n.isPlaying&&(t.log.log("tts","Streaming TTS started — playing early"),t.card.setState(s),n.play(n.streamingUrl),n.streamingUrl=null),!e.chat_log_delta)return;const i=e.chat_log_delta.content;if("string"!=typeof i)return;const{chat:r}=t.card;r.streamedResponse=(r.streamedResponse||"")+i,r.updateResponse(r.streamedResponse)}(this,t)}handleIntentEnd(t){!function(t,e){let n=null;try{n=e.intent_output.response.response_type}catch(t){}if("error"===n){const n=k(t,e)||"An error occurred";return t.log.error("error",`Intent error: ${n}`),t.card.ui.showErrorBar(),!1!==T(t.card.hass,t.card.config.satellite_entity,"wake_sound")&&t.card.tts.playChime("error"),t.suppressTTS=!0,t.intentErrorBarTimeout&&clearTimeout(t.intentErrorBarTimeout),t.intentErrorBarTimeout=setTimeout(()=>{t.intentErrorBarTimeout=null,t.card.ui.clearErrorBar(),t.card.ui.hideBar()},3e3),void(t.card.chat.streamedResponse="")}const i=k(t,e);i&&t.card.chat.showResponse(i),t.shouldContinue=!1,t.continueConversationId=null;try{!0===e.intent_output.continue_conversation&&(t.shouldContinue=!0,t.continueConversationId=e.intent_output.conversation_id||null,t.log.log("pipeline",`Continue conversation requested — id: ${t.continueConversationId}`))}catch(t){}t.card.chat.streamedResponse="",t.card.chat.streamEl=null}(this,t)}handleTtsEnd(t){!function(t,e){if(t.suppressTTS)return t.suppressTTS=!1,t.log.log("tts","TTS suppressed (intent error)"),void t.restart(0);const{tts:n}=t.card;if(n.isPlaying)return t.log.log("tts","Streaming TTS already playing — skipping duplicate playback"),void t.restart(0);const i=e.tts_output?.url||e.tts_output?.url_path||null;i&&n.play(i),t.restart(0)}(this,t)}handleRunEnd(){this._runStartReceived?!this._wakeWordPhase||this._errorReceived?function(t){if(t.log.log("pipeline","Run ended"),t.binaryHandlerId=null,!t.isRestarting)return t.askQuestionHandled?(t.log.log("pipeline","Ask question handled — announcement manager owns cleanup"),void(t.askQuestionHandled=!1)):t.serviceUnavailable?(t.log.log("ui","Error recovery handling restart"),void t.card.ui.hideBlurOverlay(l)):t.card.tts.isPlaying?(t.log.log("ui","TTS playing — deferring cleanup"),void(t.pendingRunEnd=!0)):void t.finishRunEnd();t.log.log("pipeline","Restart already in progress — skipping run-end restart")}(this):this._log.log("pipeline","Ignoring stale run-end (still in wake_word phase, no error)"):this._log.log("pipeline","Ignoring stale run-end (no run-start received for this subscription)")}handleError(e){this._runStartReceived?(this._errorReceived=!0,function(e,n){const i=n.code||"",r=n.message||"";if(e.log.log("error",`${i} — ${r}`),e.askQuestionCallback){const t=e.askQuestionCallback;return e.askQuestionCallback=null,e.log.log("pipeline",`Ask question error (${i}) — sending empty answer`),void t("")}if(a.includes(i)){if(e.log.log("pipeline",`Expected error: ${i} — restarting`),o.includes(e.card.currentState)){e.log.log("ui","Cleaning up interaction UI after expected error"),e.card.setState(t),e.card.chat.clear(),e.card.ui.hideBlurOverlay(l),e.shouldContinue=!1,e.continueConversationId=null;const n=e.card.config.tts_target&&"browser"!==e.card.config.tts_target;!1===T(e.card.hass,e.card.config.satellite_entity,"wake_sound")||n||e.card.tts.playChime("done")}return void e.restart(0)}e.log.error("error",`Unexpected: ${i} — ${r}`);const s=o.includes(e.card.currentState);e.binaryHandlerId=null,s&&!1!==T(e.card.hass,e.card.config.satellite_entity,"wake_sound")&&e.card.tts.playChime("error"),e.card.ui.showErrorBar(),e.serviceUnavailable=!0,e.card.chat.clear(),e.card.ui.hideBlurOverlay(l),e.restart(e.calculateRetryDelay())}(this,e)):this._log.log("pipeline","Ignoring stale error (no run-start received for this subscription)")}clearContinueState(){this._shouldContinue=!1,this._continueConversationId=null}resetForResume(){this._isRestarting=!1,this._continueMode=!1,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null)}resetRetryState(){this._retryCount=0,this._restartTimeout&&(clearTimeout(this._restartTimeout),this._restartTimeout=null),this._isRestarting&&(this._isRestarting=!1),this._serviceUnavailable=!1}finishRunEnd(){this._pendingRunEnd=!1,this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.setState(t),this._serviceUnavailable?this._log.log("ui","Retry already scheduled — skipping restart"):this.restart(0)}calculateRetryDelay(){this._retryCount++;const t=Math.min(5e3*this._retryCount,3e4);return this._log.log("pipeline",`Retry in ${t}ms (attempt #${this._retryCount})`),t}}function x(t,e,n){t.style.fontSize=e[`${n}_font_size`]+"px",t.style.fontFamily=e[`${n}_font_family`],t.style.color=e[`${n}_font_color`],t.style.fontWeight=e[`${n}_font_bold`]?"bold":"normal",t.style.fontStyle=e[`${n}_font_italic`]?"italic":"normal",t.style.background=e[`${n}_background`],t.style.border=`3px solid ${e[`${n}_border_color`]}`,t.style.padding=e[`${n}_padding`]+"px",t.style.borderRadius=e[`${n}_rounded`]?"12px":"0"}function A(t){const e=Math.max(0,t),n=Math.floor(e/3600),i=Math.floor(e%3600/60),r=e%60;return`${n<10?"0":""}${n}:${i<10?"0":""}${i}:${r<10?"0":""}${r}`}class I{constructor(t){this._card=t,this._log=t.logger,this._globalUI=null,this._pendingStartButtonReason=void 0,this._blurReasons={},this._timerContainer=null,this._timerAlertEl=null}get element(){return this._globalUI}ensureGlobalUI(){const t=document.getElementById("voice-satellite-ui");if(t)return this._globalUI=t,void this._flushPendingStartButton();const e=document.createElement("div");e.id="voice-satellite-ui",e.innerHTML='<div class="vs-blur-overlay"></div><button class="vs-start-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg></button><div class="vs-chat-container"></div><div class="vs-rainbow-bar"></div>',document.body.appendChild(e),this._globalUI=e,this._injectGlobalStyles(),this.applyStyles(),e.querySelector(".vs-start-btn").addEventListener("click",()=>{this._card.onStartClick()});const n=e.querySelector(".vs-start-btn");n.classList.add("visible"),n.title="Tap to start voice assistant",this._flushPendingStartButton()}applyStyles(){if(!this._globalUI)return;const t=this._card.config,e=this._globalUI.querySelector(".vs-rainbow-bar");e.style.height=`${t.bar_height}px`,e.style["top"===t.bar_position?"top":"bottom"]="0",e.style["top"===t.bar_position?"bottom":"top"]="auto",e.style.background=h(t.bar_gradient),e.style.backgroundSize="200% 100%";const n=this._globalUI.querySelector(".vs-blur-overlay");t.background_blur?(n.style.backdropFilter=`blur(${t.background_blur_intensity}px)`,n.style.webkitBackdropFilter=`blur(${t.background_blur_intensity}px)`):(n.style.backdropFilter="none",n.style.webkitBackdropFilter="none");const i=t.bar_height||6,r=this._globalUI.querySelector(".vs-chat-container");"bottom"===t.bar_position?(r.style.bottom=`${i+12}px`,r.style.top="auto"):(r.style.bottom="12px",r.style.top="auto");const s="chat"===t.bubble_style;r.style.alignItems=s?"flex-start":"center",r.style.width=`${t.bubble_container_width||80}%`,r.style.maxWidth=`${t.bubble_container_width||80}%`,r.setAttribute("data-bubble-style",t.bubble_style||"centered")}applyBubbleStyle(t,e){x(t,this._card.config,e)}updateForState(t,e,n){if(!this._globalUI)return;if(this._card.announcement.playing||this._card.askQuestion.playing||this._card.startConversation.playing)return;const i={IDLE:{barVisible:!1},CONNECTING:{barVisible:!1},LISTENING:{barVisible:!1},PAUSED:{barVisible:!1},WAKE_WORD_DETECTED:{barVisible:!0,animation:"listening"},STT:{barVisible:!0,animation:"listening"},INTENT:{barVisible:!0,animation:"processing"},TTS:{barVisible:!0,animation:"speaking"},ERROR:{barVisible:!1}}[t];if(!i)return;if(e&&!i.barVisible)return;if(n&&!i.barVisible)return;const r=this._globalUI.querySelector(".vs-rainbow-bar");i.barVisible?(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.add("visible"),r.classList.remove("connecting","listening","processing","speaking"),i.animation&&r.classList.add(i.animation)):(r.classList.contains("error-mode")&&this.clearErrorBar(),r.classList.remove("visible","connecting","listening","processing","speaking"))}showStartButton(t){if(!this._globalUI)return void(this._pendingStartButtonReason=t);const e=this._globalUI.querySelector(".vs-start-btn");e.classList.add("visible"),e.title={"not-allowed":"Tap to enable microphone","not-found":"No microphone found","not-readable":"Microphone unavailable - tap to retry"}[t]||"Tap to start voice assistant"}hideStartButton(){this._globalUI?.querySelector(".vs-start-btn")?.classList.remove("visible")}showBlurOverlay(t){this._globalUI&&this._card.config.background_blur&&(this._blurReasons[t||"default"]=!0,this._globalUI.querySelector(".vs-blur-overlay").classList.add("visible"))}hideBlurOverlay(t){this._globalUI&&(delete this._blurReasons[t||"default"],0===Object.keys(this._blurReasons).length&&this._globalUI.querySelector(".vs-blur-overlay").classList.remove("visible"))}showErrorBar(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("connecting","listening","processing","speaking"),t.classList.add("visible","error-mode"),t.style.background="linear-gradient(90deg, #ff4444, #ff6666, #cc2222, #ff4444, #ff6666, #cc2222, #ff4444)",t.style.backgroundSize="200% 100%"}clearErrorBar(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-rainbow-bar");t.classList.remove("error-mode"),t.style.background=h(this._card.config.bar_gradient),t.style.backgroundSize="200% 100%"}hideBar(){this._globalUI?.querySelector(".vs-rainbow-bar")?.classList.remove("visible")}showBarSpeaking(){if(!this._globalUI)return!1;const t=this._globalUI.querySelector(".vs-rainbow-bar");if(!t)return!1;const e=t.classList.contains("visible");return t.classList.add("visible","speaking"),e}restoreBar(t){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-rainbow-bar");e&&(e.classList.remove("speaking"),t||e.classList.remove("visible"))}addChatMessage(t,e){if(!this._globalUI)return null;const n=this._globalUI.querySelector(".vs-chat-container");n.classList.add("visible");const i=document.createElement("div");return i.className=`vs-chat-msg ${e}`,i.textContent=t,this.applyBubbleStyle(i,{user:"transcription",assistant:"response",announcement:"response"}[e]||"response"),"announcement"===e&&(i.style.alignSelf="center",i.style.textAlign="center"),n.appendChild(i),i}updateChatText(t,e){t&&(t.textContent=e)}updateChatHtml(t,e){t&&(t.innerHTML=e)}clearChat(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-chat-container");for(;t.firstChild;)t.removeChild(t.firstChild);t.classList.remove("visible")}setAnnouncementMode(t){if(!this._globalUI)return;const e=this._globalUI.querySelector(".vs-chat-container");e&&e.classList.toggle("announcement-mode",t)}clearAnnouncementBubbles(){if(!this._globalUI)return;const t=this._globalUI.querySelector(".vs-chat-container"),e=t?.querySelectorAll(".vs-chat-msg.announcement")||[];for(const t of e)t.remove();t&&!t.firstChild&&t.classList.remove("visible")}ensureTimerContainer(){if(this._timerContainer&&document.body.contains(this._timerContainer))return;const t=document.createElement("div");t.id="voice-satellite-timers",t.className="vs-timer-container",document.body.appendChild(t),this._timerContainer=t,this.applyTimerPosition()}applyTimerPosition(){if(!this._timerContainer)return;const t=this._card.config,e=t.bar_height||16,n=t.timer_position||"top-right";if(this._timerContainer.style.top="auto",this._timerContainer.style.bottom="auto",this._timerContainer.style.left="auto",this._timerContainer.style.right="auto",n.startsWith("top")){const n="top"===t.bar_position?e+12:12;this._timerContainer.style.top=`${n}px`}else{const n="bottom"===t.bar_position?e+12:12;this._timerContainer.style.bottom=`${n}px`}n.includes("left")?this._timerContainer.style.left="12px":this._timerContainer.style.right="12px"}removeTimerContainer(){this._timerContainer?.parentNode?.removeChild(this._timerContainer),this._timerContainer=null}createTimerPill(t,e){const n=t.totalSeconds>0?Math.max(0,t.secondsLeft/t.totalSeconds*100):0,i=document.createElement("div");i.className="vs-timer-pill",i.setAttribute("data-timer-id",t.id),this.applyBubbleStyle(i,"timer");const r=this._card.config.timer_border_color||"rgba(100, 200, 150, 0.5)";return i.innerHTML=`<div class="vs-timer-progress" style="width:${n}%;background:${r};opacity:0.3"></div><div class="vs-timer-content"><span class="vs-timer-icon">⏱</span><span class="vs-timer-time">${A(t.secondsLeft)}</span></div>`,e&&E(i,e),i}syncTimerPills(t,e){this.ensureTimerContainer();const n=this._timerContainer.querySelectorAll(".vs-timer-pill");for(const e of n){const n=e.getAttribute("data-timer-id");t.some(t=>t.id===n)||e.parentNode.removeChild(e)}for(const n of t)n.el&&this._timerContainer.contains(n.el)||(n.el=this.createTimerPill(n,e(n.id)),this._timerContainer.appendChild(n.el))}updateTimerPill(t,e,n){if(!t)return;const i=t.querySelector(".vs-timer-time");i&&(i.textContent=A(e));const r=t.querySelector(".vs-timer-progress");if(r){const t=n>0?Math.max(0,e/n*100):0;r.style.width=`${t}%`}}expireTimerPill(t,e){if(!this._timerContainer)return;const n=this._timerContainer.querySelector(`.vs-timer-pill[data-timer-id="${t}"]`);n&&(n.classList.add("vs-timer-expired"),setTimeout(()=>n.parentNode?.removeChild(n),e))}showTimerAlert(t){this._timerAlertEl=document.createElement("div"),this._timerAlertEl.className="vs-timer-alert",this.applyBubbleStyle(this._timerAlertEl,"timer"),this._timerAlertEl.innerHTML='<span class="vs-timer-icon">⏱</span><span class="vs-timer-time">00:00:00</span>',document.body.appendChild(this._timerAlertEl),t&&E(this._timerAlertEl,t)}clearTimerAlert(){for(const t of document.querySelectorAll(".vs-timer-alert"))t.parentNode?.removeChild(t);this._timerAlertEl=null}_injectGlobalStyles(){if(document.getElementById("voice-satellite-styles"))return;const t=document.createElement("style");t.id="voice-satellite-styles",t.textContent='/* Voice Satellite Card — Styles */\r\n\r\n/* Blur Overlay */\r\n#voice-satellite-ui .vs-blur-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  backdrop-filter: blur(5px);\r\n  -webkit-backdrop-filter: blur(5px);\r\n  background: rgba(0, 0, 0, 0.3);\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 9999;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-blur-overlay.visible {\r\n  opacity: 1;\r\n}\r\n\r\n/* Start Button */\r\n#voice-satellite-ui .vs-start-btn {\r\n  position: fixed;\r\n  bottom: 20px;\r\n  right: 20px;\r\n  width: 56px;\r\n  height: 56px;\r\n  border-radius: 50%;\r\n  background: var(--primary-color, #03a9f4);\r\n  border: none;\r\n  cursor: pointer;\r\n  display: none;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  z-index: 10001;\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn.visible {\r\n  display: flex;\r\n  animation: vs-btn-pulse 2s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn:hover {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\r\n  animation: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-start-btn svg {\r\n  width: 28px;\r\n  height: 28px;\r\n  fill: white;\r\n}\r\n\r\n@keyframes vs-btn-pulse {\r\n  0%, 100% {\r\n    transform: scale(1);\r\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\r\n  }\r\n  50% {\r\n    transform: scale(1.08);\r\n    box-shadow: 0 6px 20px rgba(3, 169, 244, 0.5);\r\n  }\r\n}\r\n\r\n/* Rainbow Bar */\r\n#voice-satellite-ui .vs-rainbow-bar {\r\n  position: fixed;\r\n  left: 0;\r\n  right: 0;\r\n  background-size: 200% 100%;\r\n  opacity: 0;\r\n  transition: opacity 0.3s ease;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.visible {\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.connecting {\r\n  animation: vs-bar-breathe 1.5s ease-in-out infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.listening {\r\n  animation: vs-gradient-flow 3s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.processing {\r\n  animation: vs-gradient-flow 0.5s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.speaking {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-mode {\r\n  animation: vs-gradient-flow 2s linear infinite;\r\n  opacity: 1;\r\n}\r\n\r\n#voice-satellite-ui .vs-rainbow-bar.error-flash {\r\n  animation: vs-error-flash 0.15s ease-in-out 3;\r\n}\r\n\r\n@keyframes vs-error-flash {\r\n  0%, 100% { opacity: 1; }\r\n  50% { opacity: 0.3; }\r\n}\r\n\r\n/* Chat Container */\r\n#voice-satellite-ui .vs-chat-container {\r\n  position: fixed;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: none;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  max-width: 80%;\r\n  width: 80%;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n  overflow: visible;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.visible {\r\n  display: flex;\r\n  pointer-events: auto;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container.announcement-mode {\r\n  top: 50% !important;\r\n  bottom: auto !important;\r\n  transform: translate(-50%, -50%);\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-msg {\r\n  max-width: 85%;\r\n  padding: 12px;\r\n  opacity: 0;\r\n  text-align: center;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-chat-fade-in 0.3s ease forwards;\r\n  word-wrap: break-word;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg {\r\n  text-align: left;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg.user {\r\n  align-self: flex-end;\r\n}\r\n\r\n#voice-satellite-ui .vs-chat-container[data-bubble-style="chat"] .vs-chat-msg.assistant {\r\n  align-self: flex-start;\r\n}\r\n\r\n/* Animations */\r\n@keyframes vs-chat-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-gradient-flow {\r\n  0% {\r\n    background-position: 0% 50%;\r\n  }\r\n  100% {\r\n    background-position: 200% 50%;\r\n  }\r\n}\r\n\r\n@keyframes vs-bar-breathe {\r\n  0%, 100% {\r\n    opacity: 0.3;\r\n  }\r\n  50% {\r\n    opacity: 0.7;\r\n  }\r\n}\r\n\r\n/* Timer Pills */\r\n.vs-timer-container {\r\n  position: fixed;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  z-index: 10001;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-pill {\r\n  position: relative;\r\n  overflow: hidden;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\r\n  animation: vs-timer-fade-in 0.3s ease forwards;\r\n  pointer-events: auto;\r\n  cursor: default;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-progress {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  height: 100%;\r\n  transition: width 1s linear;\r\n  pointer-events: none;\r\n}\r\n\r\n.vs-timer-content {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.vs-timer-icon {\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-time {\r\n  font-variant-numeric: tabular-nums;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.vs-timer-pill.vs-timer-expired {\r\n  animation: vs-timer-fade-out 0.4s ease forwards;\r\n}\r\n\r\n/* Timer Finished Alert */\r\n.vs-timer-alert {\r\n  position: fixed;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);\r\n  z-index: 10002;\r\n  animation: vs-timer-alert-pulse 1.5s ease-in-out infinite;\r\n  user-select: none;\r\n  -webkit-user-select: none;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-icon {\r\n  font-size: 1.5em;\r\n}\r\n\r\n.vs-timer-alert .vs-timer-time {\r\n  font-size: 1.2em;\r\n}\r\n\r\n@keyframes vs-timer-fade-in {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-fade-out {\r\n  0% {\r\n    opacity: 1;\r\n    transform: translateY(0);\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    transform: translateY(8px);\r\n  }\r\n}\r\n\r\n@keyframes vs-timer-alert-pulse {\r\n  0%, 100% {\r\n    transform: translate(-50%, -50%) scale(1);\r\n  }\r\n  50% {\r\n    transform: translate(-50%, -50%) scale(1.05);\r\n  }\r\n}',document.head.appendChild(t)}_flushPendingStartButton(){void 0!==this._pendingStartButtonReason&&(this.showStartButton(this._pendingStartButtonReason),this._pendingStartButtonReason=void 0)}}function E(t,e){let n=0;const i=t=>{const i=Date.now();i-n<400&&i-n>0&&(t.preventDefault(),t.stopPropagation(),e()),n=i};t.addEventListener("touchstart",i,{passive:!1}),t.addEventListener("click",i)}class R{constructor(t){this._card=t,this._log=t.logger,this._streamEl=null,this._streamedResponse=""}get streamEl(){return this._streamEl}set streamEl(t){this._streamEl=t}get streamedResponse(){return this._streamedResponse}set streamedResponse(t){this._streamedResponse=t}showTranscription(t){this.addUser(t)}showResponse(t){this._card.config.show_response&&(this._streamEl?this._card.ui.updateChatText(this._streamEl,t):this.addAssistant(t))}updateResponse(t){this._card.config.show_response&&(this._streamEl?this._updateStreaming(t):this.addAssistant(t))}addUser(t){this._card.ui.addChatMessage(t,"user")}addAssistant(t){this._streamEl=this._card.ui.addChatMessage(t,"assistant")}clear(){this._card.ui.clearChat(),this._streamEl=null,this._streamedResponse=""}_updateStreaming(t){if(!this._streamEl)return;if(t.length<=24)return void this._card.ui.updateChatText(this._streamEl,t);const e=t.slice(0,t.length-24),n=t.slice(t.length-24);let i=$(e);for(let t=0;t<n.length;t++)i+=`<span style="opacity:${((24-t)/24).toFixed(2)}">${$(n[t])}</span>`;this._card.ui.updateChatHtml(this._streamEl,i)}}function $(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}let B=0,P=null,U=null,q=!1;function L(){if("visible"!==document.visibilityState)return;if(!P||!U)return;const t=U,e=P;P=null,U=null,t.logger.log("satellite-notify",`Tab visible — replaying queued event #${e.data.id}`),N(t,e)}function N(t,e){const{type:n,data:i}=e;if(!i||!i.id)return;if("hidden"===document.visibilityState)return t.logger.log("satellite-notify",`Event #${i.id} queued — tab hidden`),P=e,U=t,void(q||(q=!0,document.addEventListener("visibilitychange",L)));const r={...i};r.ask_question?M(t.askQuestion,r,"ask-question"):"start_conversation"===n||r.start_conversation?M(t.startConversation,r,"start-conversation"):M(t.announcement,r,"announce")}function M(t,e,n){if(e.id<=B)return;if(t.playing)return void t.log.log(n,`Notification #${e.id} ignored — already playing`);const i=t.card.currentState;"WAKE_WORD_DETECTED"===i||"STT"===i||"INTENT"===i||"TTS"===i||t.card.tts.isPlaying?t.queued&&t.queued.id===e.id||(t.queued=e,t.log.log(n,`Notification #${e.id} queued — pipeline busy (${i})`)):(t.queued=null,B=e.id,t.log.log(n,`New ${n} #${e.id}: message="${e.message||""}" media="${e.media_id||""}"`),W(t,e,e=>t._onComplete(e),n))}function F(t){if(!t.queued)return null;const e=t.queued;return t.queued=null,e.id<=(B||0)||t.playing?null:(B=e.id,e)}function W(t,e,n,i){t.playing=!0,t.currentAnnounceId=e.id,t.card.ui.showBlurOverlay(u),t.barWasVisible=t.card.ui.showBarSpeaking(),!e.ask_question&&!e.start_conversation&&t.card.ui.setAnnouncementMode(!0),!1===e.preannounce?(t.log.log(i,"Preannounce disabled — skipping chime"),O(t,e,n,i)):e.preannounce_media_id&&""!==e.preannounce_media_id?(t.log.log(i,`Playing pre-announcement media: ${e.preannounce_media_id}`),H(t,e.preannounce_media_id,i,()=>{O(t,e,n,i)})):(f(t.card,m,{onDone:()=>O(t,e,n,i),log:t.log}),t.log.log(i,"Announcement chime played"))}function O(t,e,n,i){const r=e.media_id||"";if(e.message){const n=!e.ask_question&&!e.start_conversation;t.card.ui.addChatMessage(e.message,n?"announcement":"assistant")}r?(t.log.log(i,`Playing media: ${r}`),H(t,r,i,()=>n(e))):(t.log.log(i,"No media — completing after message display"),setTimeout(()=>n(e),3e3))}function D(t){t.clearTimeoutId&&(clearTimeout(t.clearTimeoutId),t.clearTimeoutId=null),t.card.ui.setAnnouncementMode(!1),t.card.ui.clearAnnouncementBubbles(),t.card.ui.hideBlurOverlay(u),t.card.ui.restoreBar(t.barWasVisible)}function H(t,e,n,i){const r=y(e),s=t.card.config.tts_volume/100;t.currentAudio=v(r,s,{onEnd:()=>{t.log.log(n,"Media playback complete"),t.currentAudio=null,i?.()},onError:e=>{t.log.error(n,`Media playback error: ${e}`),t.currentAudio=null,i?.()},onStart:()=>{t.log.log(n,"Media playback started")}})}function V(t){t.playing=!1,t.currentAudio=null,t.currentAnnounceId=null,t.clearTimeoutId=null,t.barWasVisible=!1,t.queued=null}function Q(t,e,n){const{connection:i,config:r}=t;i&&r.satellite_entity?i.sendMessagePromise({type:"voice_satellite/announce_finished",entity_id:r.satellite_entity,announce_id:e}).then(()=>{t.logger.log(n,`ACK sent for #${e}`)}).catch(e=>{t.logger.error(n,`ACK failed: ${e.message||JSON.stringify(e)}`)}):t.logger.error(n,"Cannot ACK — no connection or entity")}class z{constructor(t){this._card=t,this._log=t.logger,this._lastTapTime=0,this._lastTapWasTouch=!1,this._handler=null}setup(){this._handler=e=>{if(!this._card.config.double_tap_cancel)return;const n=o.includes(this._card.currentState)||this._card.tts.isPlaying,i=this._card.timer.isAlertActive,r=this._card.announcement.playing||this._card.askQuestion.playing||this._card.startConversation.playing||this._card.announcement.clearTimeoutId||this._card.startConversation.clearTimeoutId;if(!n&&!i&&!r)return;if("click"===e.type&&this._lastTapWasTouch)return;this._lastTapWasTouch="touchstart"===e.type;const s=Date.now(),a=s-this._lastTapTime;if(this._lastTapTime=s,a<400&&a>0){if(e.preventDefault(),this._card.timer.isAlertActive)return this._log.log("ui","Double-tap detected — dismissing timer alert"),void this._card.timer.dismissAlert();if(r){this._log.log("ui","Double-tap detected — dismissing notification");for(const t of[this._card.announcement,this._card.askQuestion,this._card.startConversation])(t.playing||t.clearTimeoutId)&&(t.currentAnnounceId&&Q(this._card,t.currentAnnounceId,"double-tap"),t.currentAudio&&(t.currentAudio.pause(),t.currentAudio=null),t.playing=!1,t.currentAnnounceId=null,D(t));return this._card.askQuestion.cancel(),void this._card.pipeline.restart(0)}this._log.log("ui","Double-tap detected — cancelling interaction"),this._card.tts.isPlaying&&this._card.tts.stop(),this._card.askQuestion.cancel(),this._card.pipeline.clearContinueState(),this._card.setState(t),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l);const n=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;!1===T(this._card.hass,this._card.config.satellite_entity,"wake_sound")||n||this._card.tts.playChime("done"),this._card.pipeline.restart(0)}},document.addEventListener("touchstart",this._handler,{passive:!1}),document.addEventListener("click",this._handler)}}window.__vsSingleton||(window.__vsSingleton={instance:null,active:!1,starting:!1});const j=window.__vsSingleton;function G(t){return!j.instance||j.instance===t}function J(){return j.active}function Y(){return j.starting}function K(t){j.starting=!!t}let X=null,Z=!1,tt=null,et=null,nt=null;function it(t,e){const{config:n,connection:i}=t;n.satellite_entity&&i&&G(t)&&(Z||(et=t,nt=e,Z=!0,rt(t,i,e),tt||(tt=()=>{t.logger.log("satellite-sub","Connection reconnected — re-subscribing"),st();const n=t.connection;n&&(Z=!0,rt(t,n,e))},i.addEventListener("ready",tt))))}function rt(t,e,n){e.subscribeMessage(t=>n(t),{type:"voice_satellite/subscribe_events",entity_id:t.config.satellite_entity}).then(e=>{X=e,t.logger.log("satellite-sub",`Subscribed to satellite events for ${t.config.satellite_entity}`)}).catch(e=>{t.logger.error("satellite-sub",`Failed to subscribe: ${e}`),Z=!1})}function st(){if(X){try{X()}catch(t){}X=null}Z=!1}class ot{constructor(t){this._card=t,this._log=t.logger,this._isPaused=!1,this._debounceTimer=null,this._handler=null}get isPaused(){return this._isPaused}setup(){this._handler=()=>this._handleChange(),document.addEventListener("visibilitychange",this._handler)}_handleChange(){this._debounceTimer&&clearTimeout(this._debounceTimer),document.hidden?(this._isPaused=!0,this._card.askQuestion.cancel(),o.includes(this._card.currentState)&&(this._log.log("visibility","Tab hidden during interaction — cleaning up UI"),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),this._card.pipeline.clearContinueState(),this._card.tts.isPlaying&&this._card.tts.stop()),this._debounceTimer=setTimeout(()=>{this._log.log("visibility","Tab hidden — pausing mic"),this._pause()},500)):(this._log.log("visibility","Tab visible — resuming"),this._resume())}_pause(){this._isPaused=!0,this._card.setState("PAUSED"),this._card.audio.pause()}async _resume(){if(!this._isPaused)return;await this._card.audio.resume(),this._isPaused=!1;const{pipeline:t}=this._card;t.resetForResume(),null===P?(et&&nt&&(st(),it(et,nt)),this._log.log("visibility","Resuming — restarting pipeline"),t.restart(0)):this._log.log("visibility","Resuming — satellite event pending, deferring pipeline restart")}}function at(t,e,n,i,r){e.subscribeEvents(t=>{const{data:e}=t;e&&e.new_state&&e.entity_id===n&&i(e.new_state.attributes||{})},"state_changed").then(e=>{t._unsubscribe=e,t.log.log(r,`Subscribed to state changes for ${n}`);const s=t.card.hass;s?.states?.[n]&&i(s.states[n].attributes||{})}).catch(e=>{t.log.error(r,`Failed to subscribe: ${e}`),t._subscribed=!1})}let lt="";function ct(){lt=""}let ut=null,dt=null;function ht(t){t.card.ui.removeTimerContainer()}function _t(t,e){t.card.ui.expireTimerPill(e,400);const n=t.timers.find(t=>t.id===e);n&&(n.el=null)}function pt(t){f(t.card,b,{log:t.log}),t.log.log("timer","Alert chime played")}class gt{constructor(t){this._card=t,this._log=t.logger,this._timers=[],this._tickInterval=null,this._container=null,this._unsubscribe=null,this._subscribed=!1,this._reconnectListener=null,this._knownTimerIds=[],this._alertActive=!1,this._alertEl=null}update(){if(this._subscribed)return;const{config:t,connection:e}=this._card;t.satellite_entity&&e&&function(t,e,n,i,r){t._subscribed=!0,t._entityId=n,at(t,e,n,i,r),t._reconnectListener||(t._reconnectListener=()=>{if(!t.card.isOwner)return;if(t.log.log(r,"Connection reconnected — re-subscribing"),t._unsubscribe){try{t._unsubscribe()}catch(t){}t._unsubscribe=null}const e=t.card.connection;e&&at(t,e,t._entityId,i,r)},e.addEventListener("ready",t._reconnectListener))}(this,e,t.satellite_entity,t=>this.processStateChange(t),"timer")}get card(){return this._card}get log(){return this._log}get timers(){return this._timers}set timers(t){this._timers=t}get knownTimerIds(){return this._knownTimerIds}set knownTimerIds(t){this._knownTimerIds=t}get alertActive(){return this._alertActive}set alertActive(t){this._alertActive=t}get isAlertActive(){return this._alertActive}dismissAlert(){this.clearAlert()}destroy(){var t;this.stopTick(),ht(this),this.clearAlert(),this._timers=[],this._knownTimerIds=[],ct(),(t=this)._unsubscribe&&(t._unsubscribe(),t._unsubscribe=null),t._reconnectListener&&t.card.connection&&(t.card.connection.removeEventListener("ready",t._reconnectListener),t._reconnectListener=null),t._subscribed=!1}processStateChange(t){!function(t,e){let n=e.active_timers;const i=e.last_timer_event;n&&Array.isArray(n)||(n=[]);const r=JSON.stringify(n);if(r===lt)return;t.log.log("timer",`State changed: timers=${r} last_event=${i}`),lt=r;const s=n.map(t=>t.id),o=t.knownTimerIds.filter(t=>!s.includes(t));o.length>0&&"finished"===i&&(t.log.log("timer",`Timer(s) finished: ${o.join(", ")}`),t.alertActive||t.showAlert());for(const e of o)t.removePill(e);t.knownTimerIds=s,t.syncTimers(n)}(this,t)}syncTimers(t){if(0===t.length)return this._timers=[],this.stopTick(),void ht(this);const e=Date.now(),n=[];for(const i of t){const t=this._timers.find(t=>t.id===i.id),r=i.started_at?1e3*i.started_at:e;if(t){if(t.totalSeconds!==i.total_seconds){t.totalSeconds=i.total_seconds,t.startedAt=r;const n=Math.floor((e-r)/1e3);t.secondsLeft=Math.max(0,i.total_seconds-n),t.startHours=i.start_hours||0,t.startMinutes=i.start_minutes||0,t.startSeconds=i.start_seconds||0}n.push(t)}else{const t=Math.floor((e-r)/1e3);n.push({id:i.id,name:i.name||"",totalSeconds:i.total_seconds,secondsLeft:Math.max(0,i.total_seconds-t),startedAt:r,startHours:i.start_hours||0,startMinutes:i.start_minutes||0,startSeconds:i.start_seconds||0,el:null})}}var i;this._timers=n,this.startTick(),(i=this).card.ui.syncTimerPills(i.timers,t=>()=>i.cancelTimer(t))}startTick(){this._tickInterval||(this._tickInterval=setInterval(()=>function(t){const e=Date.now();for(const n of t.timers){const i=Math.floor((e-n.startedAt)/1e3),r=Math.max(0,n.totalSeconds-i);n.secondsLeft=r,t.card.ui.updateTimerPill(n.el,r,n.totalSeconds)}}(this),1e3))}stopTick(){this._tickInterval&&(clearInterval(this._tickInterval),this._tickInterval=null)}showAlert(){!function(t){if(t.alertActive)return void t.log.log("timer","Alert already active, skipping duplicate");t.alertActive=!0,t.log.log("timer","Showing finished alert"),t.card.ui.showBlurOverlay(c),t.card.ui.showTimerAlert(()=>t.clearAlert()),pt(t),ut&&clearInterval(ut),ut=setInterval(()=>pt(t),3e3);const e=t.card.config.timer_finished_duration;e>0&&(dt&&clearTimeout(dt),dt=setTimeout(()=>t.clearAlert(),1e3*e))}(this)}clearAlert(){var t;(t=this).alertActive&&(t.alertActive=!1,ut&&(clearInterval(ut),ut=null),dt&&(clearTimeout(dt),dt=null),t.card.ui.clearTimerAlert(),t.stopTick(),ht(t),t.timers=[],t.card.ui.hideBlurOverlay(c),t.log.log("timer","Alert dismissed"))}removePill(t){_t(this,t)}cancelTimer(t){this._log.log("timer",`Cancelling timer: ${t}`),function(t,e){t.connection&&t.config.satellite_entity&&e&&t.connection.sendMessagePromise({type:"voice_satellite/cancel_timer",entity_id:t.config.satellite_entity,timer_id:e}).then(()=>{t.logger.log("timer",`Cancel timer ${e} succeeded`)}).catch(e=>{t.logger.error("timer",`Cancel timer failed: ${e.message||JSON.stringify(e)}`)})}(this._card,t),_t(this,t);const e=this._timers.findIndex(e=>e.id===t);-1!==e&&this._timers.splice(e,1);const n=this._knownTimerIds.indexOf(t);-1!==n&&this._knownTimerIds.splice(n,1),ct(),0===this._timers.length&&(this.stopTick(),setTimeout(()=>{0===this._timers.length&&ht(this)},500))}}const mt="announce";class bt{constructor(t){this._card=t,this._log=t.logger,V(this)}get card(){return this._card}get log(){return this._log}playQueued(){const t=F(this);t&&(this._log.log(mt,`Playing queued announcement #${t.id}`),this._play(t))}_play(t){W(this,t,t=>this._onComplete(t),mt)}_onComplete(t){this.playing=!1,this.currentAudio=null,this._log.log(mt,`Announcement #${t.id} playback complete`),Q(this._card,t.id,mt),this._card.pipeline.restart(0);const e=1e3*(this._card.config.announcement_display_duration||5);this.clearTimeoutId=setTimeout(()=>{const t=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;!1===T(this._card.hass,this._card.config.satellite_entity,"wake_sound")||t||this._card.tts.playChime("done"),D(this)},e)}}function ft(t,e,n,i){const{connection:r,config:s}=t,o=t.logger;if(!r||!s.satellite_entity)return o.error(i,"Cannot send answer — no connection or entity"),Promise.resolve(null);const a={type:"voice_satellite/question_answered",entity_id:s.satellite_entity,announce_id:e,sentence:n||""};return r.sendMessagePromise(a).then(t=>{const r=t?.matched,s=t?.id;return o.log(i,`Answer sent for #${e}: "${n}" — matched: ${r}${s?` (id: ${s})`:""}`),t}).catch(t=>(o.error(i,`Answer failed: ${t.message||JSON.stringify(t)}`),null))}const yt="ask-question";class vt{constructor(t){this._card=t,this._log=t.logger,V(this)}get card(){return this._card}get log(){return this._log}cancel(){this._chimeSettleTimeout&&(clearTimeout(this._chimeSettleTimeout),this._chimeSettleTimeout=null),this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null),this._cleanupTimeout&&(clearTimeout(this._cleanupTimeout),this._cleanupTimeout=null),this.currentAnnounceId&&!this._answerSent&&(this._answerSent=!0,ft(this._card,this.currentAnnounceId,"","double-tap")),this._card.ui.hideBlurOverlay(u)}playQueued(){const t=F(this);t&&(this._log.log(yt,`Playing queued ask_question #${t.id}`),this._play(t))}_play(t){W(this,t,t=>this._onComplete(t),yt)}_onComplete(t){this.playing=!1,this.currentAudio=null,this._log.log(yt,`Question #${t.id} playback complete`),Q(this._card,t.id,yt),this._enterSttMode(t)}_enterSttMode(t){this._log.log(yt,"Entering STT-only mode"),this._card.ui.setAnnouncementMode(!1),this._card.ui.showBlurOverlay(l);const{pipeline:e}=this._card;if(!e)return;const n=t.id,i=this._card.config.tts_target&&"browser"!==this._card.config.tts_target;let r=0;i||(this._card.tts.playChime("wake"),r=500),this._answerSent=!1,this._chimeSettleTimeout=setTimeout(()=>{e.restartContinue(null,{end_stage:"stt",onSttEnd:t=>{this._log.log(yt,`STT result: "${t}"`),this._answerSent=!0,this._processAnswer(n,t,i)}}),this._sttSafetyTimeout=setTimeout(()=>{this._answerSent||(this._log.log(yt,`No STT result for #${n} — sending empty answer to release server`),this._answerSent=!0,this._processAnswer(n,"",i))},3e4)},r)}_processAnswer(t,e,n){this._chimeSettleTimeout&&(clearTimeout(this._chimeSettleTimeout),this._chimeSettleTimeout=null),this._sttSafetyTimeout&&(clearTimeout(this._sttSafetyTimeout),this._sttSafetyTimeout=null);const{pipeline:i}=this._card;let r=!1,s=null;this._cleanupTimeout=setTimeout(()=>{r||(r=!0,this._cleanupTimeout=null,null===s||s||this._card.ui.clearErrorBar(),D(this),this._card.chat.clear(),this._card.ui.hideBlurOverlay(l),i.restart(0))},2e3),ft(this._card,t,e,yt).then(t=>{const e=t?.matched;if(s=e,n||this._card.tts.playChime(e?"done":"error"),!e){this._card.ui.showErrorBar();const t=this._card.ui.element?this._card.ui.element.querySelector(".vs-rainbow-bar"):null;t&&(t.classList.add("error-flash"),t.addEventListener("animationend",function e(){t.classList.remove("error-flash"),t.removeEventListener("animationend",e)}))}})}}const wt="start-conversation";class St{constructor(t){this._card=t,this._log=t.logger,V(this)}get card(){return this._card}get log(){return this._log}playQueued(){const t=F(this);t&&(this._log.log(wt,`Playing queued start_conversation #${t.id}`),this._play(t))}_play(t){W(this,t,t=>this._onComplete(t),wt)}_onComplete(t){this.playing=!1,this.currentAudio=null,this._log.log(wt,`Prompt #${t.id} playback complete`),Q(this._card,t.id,wt),D(this),this._card.ui.showBlurOverlay(l);const{pipeline:e}=this._card;e&&e.restartContinue(null,{extra_system_prompt:t.extra_system_prompt||null})}}const Tt=[{name:"satellite_entity",required:!0,selector:{entity:{filter:{domain:"assist_satellite",integration:"voice_satellite"}}}},{name:"debug",selector:{boolean:{}}},{type:"expandable",name:"",title:"Microphone Processing",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"noise_suppression",selector:{boolean:{}}},{name:"echo_cancellation",selector:{boolean:{}}},{name:"auto_gain_control",selector:{boolean:{}}},{name:"voice_isolation",selector:{boolean:{}}}]}]}],kt=[{type:"expandable",name:"",title:"Volume & Chimes",flatten:!0,schema:[{name:"tts_target",selector:{entity:{filter:{domain:"media_player"}}}},{type:"grid",name:"",flatten:!0,schema:[{name:"chime_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}},{name:"tts_volume",selector:{number:{min:0,max:100,step:1,unit_of_measurement:"%",mode:"slider"}}}]}]},{type:"expandable",name:"",title:"Announcements",flatten:!0,schema:[{name:"announcement_display_duration",selector:{number:{min:1,max:60,step:1,unit_of_measurement:"s",mode:"slider"}}}]}],Ct=[{type:"expandable",name:"",title:"Timer Pill",flatten:!0,schema:[{name:"timer_position",selector:{select:{options:[{value:"top-left",label:"Top Left"},{value:"top-right",label:"Top Right"},{value:"bottom-left",label:"Bottom Left"},{value:"bottom-right",label:"Bottom Right"}],mode:"dropdown"}}},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_color",selector:{text:{}}},{name:"timer_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"timer_font_bold",selector:{boolean:{}}},{name:"timer_font_italic",selector:{boolean:{}}},{name:"timer_rounded",selector:{boolean:{}}}]},{name:"timer_border_color",selector:{text:{}}},{name:"timer_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"timer_finished_duration",selector:{number:{min:0,max:300,step:1,unit_of_measurement:"s",mode:"box"}}}]}],xt=[{type:"expandable",name:"",title:"Activity Bar",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"bar_position",selector:{select:{options:[{value:"bottom",label:"Bottom"},{value:"top",label:"Top"}],mode:"dropdown"}}},{name:"bar_height",selector:{number:{min:2,max:40,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{name:"bar_gradient",selector:{text:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"background_blur",selector:{boolean:{}}},{name:"background_blur_intensity",selector:{number:{min:0,max:20,step:1,mode:"slider"}}}]}]}],At=[{type:"expandable",name:"",title:"Bubble Style",flatten:!0,schema:[{name:"bubble_style",selector:{select:{options:[{value:"centered",label:"Centered"},{value:"chat",label:"Chat style"}],mode:"dropdown"}}},{name:"bubble_container_width",selector:{number:{min:40,max:100,step:5,unit_of_measurement:"%",mode:"slider"}}}]},{type:"expandable",name:"",title:"Transcription Bubble",flatten:!0,schema:[{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"transcription_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_color",selector:{text:{}}},{name:"transcription_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"transcription_font_bold",selector:{boolean:{}}},{name:"transcription_font_italic",selector:{boolean:{}}},{name:"transcription_rounded",selector:{boolean:{}}}]},{name:"transcription_border_color",selector:{text:{}}},{name:"transcription_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]},{type:"expandable",name:"",title:"Response Bubble",flatten:!0,schema:[{name:"show_response",selector:{boolean:{}}},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_size",selector:{number:{min:10,max:48,step:1,unit_of_measurement:"px",mode:"slider"}}},{name:"response_font_family",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_color",selector:{text:{}}},{name:"response_background",selector:{text:{}}}]},{type:"grid",name:"",flatten:!0,schema:[{name:"response_font_bold",selector:{boolean:{}}},{name:"response_font_italic",selector:{boolean:{}}},{name:"response_rounded",selector:{boolean:{}}}]},{name:"response_border_color",selector:{text:{}}},{name:"response_padding",selector:{number:{min:0,max:32,step:1,unit_of_measurement:"px",mode:"slider"}}}]}],It=Object.assign({},{satellite_entity:"Satellite entity",debug:"Debug logging",noise_suppression:"Noise suppression",echo_cancellation:"Echo cancellation",auto_gain_control:"Auto gain control",voice_isolation:"Voice isolation (Chrome only)"},{tts_target:"TTS output device",chime_volume:"Chime volume",tts_volume:"TTS volume",announcement_display_duration:"Announcement display duration"},{timer_position:"Timer position",timer_font_size:"Font size",timer_font_family:"Font family",timer_font_color:"Font color",timer_background:"Background color",timer_font_bold:"Bold",timer_font_italic:"Italic",timer_rounded:"Rounded corners",timer_border_color:"Border color",timer_padding:"Padding",timer_finished_duration:"Auto-dismiss timer"},{bar_position:"Bar position",bar_height:"Bar height",bar_gradient:"Gradient colors",background_blur:"Background blur",background_blur_intensity:"Blur intensity"},{bubble_style:"Bubble layout",bubble_container_width:"Container width",transcription_font_size:"Font size",transcription_font_family:"Font family",transcription_font_color:"Font color",transcription_background:"Background color",transcription_font_bold:"Bold",transcription_font_italic:"Italic",transcription_rounded:"Rounded corners",transcription_border_color:"Border color",transcription_padding:"Padding",show_response:"Show response",response_font_size:"Font size",response_font_family:"Font family",response_font_color:"Font color",response_background:"Background color",response_font_bold:"Bold",response_font_italic:"Italic",response_rounded:"Rounded corners",response_border_color:"Border color",response_padding:"Padding"}),Et=Object.assign({},{satellite_entity:"Required. Install the Voice Satellite Card Integration: https://github.com/jxlarrea/voice-satellite-card-integration",voice_isolation:"AI-based voice isolation, currently only available in Chrome"},{tts_target:"Leave empty for browser audio, or select a media player entity",announcement_display_duration:"Seconds to show announcement bubble after playback"},{timer_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",timer_border_color:"CSS color value (supports rgba)",timer_finished_duration:"Seconds to show finished timer alert (0 = until dismissed)"},{bar_gradient:"Comma-separated CSS color values"},{bubble_style:"Centered: bubbles centered on screen. Chat: user right, assistant left",bubble_container_width:"Width of the bubble area (useful for large screens)",transcription_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",transcription_border_color:"CSS color value (supports rgba)",response_font_family:"CSS font-family value (e.g., inherit, Arial, monospace)",response_border_color:"CSS color value (supports rgba)"});function Rt(t){let e=t;for(let t=0;t<20&&e;t++){const t=e.tagName;if("HUI-CARD-PREVIEW"===t)return!0;if("HUI-CARD"===t&&e.hasAttribute("preview"))return!0;if(t&&t.includes("PREVIEW"))return!0;e=e.parentElement||(e.getRootNode&&e.getRootNode()).host}return!1}function $t(t,e){const n=Object.assign({},d,e);t.innerHTML='\n    <style>\n      :host {\n        display: block;\n        position: relative;\n        overflow: hidden;\n        border-radius: var(--ha-card-border-radius, 12px);\n        min-height: 380px;\n      }\n      .preview-background {\n        position: absolute;\n        top: 0; left: 0; right: 0; bottom: 0;\n        background-image:\n          linear-gradient(45deg, #e0e0e0 25%, transparent 25%),\n          linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),\n          linear-gradient(45deg, transparent 75%, #e0e0e0 75%),\n          linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);\n        background-size: 20px 20px;\n        background-position: 0 0, 0 10px, 10px -10px, -10px 0;\n        background-color: #f5f5f5;\n      }\n      @media (prefers-color-scheme: dark) {\n        .preview-background {\n          background-image:\n            linear-gradient(45deg, #333 25%, transparent 25%),\n            linear-gradient(-45deg, #333 25%, transparent 25%),\n            linear-gradient(45deg, transparent 75%, #333 75%),\n            linear-gradient(-45deg, transparent 75%, #333 75%);\n          background-color: #222;\n        }\n      }\n      :host-context([data-theme="dark"]) .preview-background,\n      :host-context(.dark) .preview-background {\n        background-image:\n          linear-gradient(45deg, #333 25%, transparent 25%),\n          linear-gradient(-45deg, #333 25%, transparent 25%),\n          linear-gradient(45deg, transparent 75%, #333 75%),\n          linear-gradient(-45deg, transparent 75%, #333 75%);\n        background-color: #222;\n      }\n      .preview-container {\n        position: relative;\n        width: 100%;\n        min-height: 380px;\n        box-sizing: border-box;\n        display: flex;\n        flex-direction: column;\n        justify-content: flex-end;\n        padding: 24px 16px;\n      }\n      .preview-blur {\n        position: absolute;\n        top: 0; left: 0; right: 0; bottom: 0;\n        z-index: 1;\n        pointer-events: none;\n      }\n      .preview-bar {\n        position: absolute;\n        left: 0;\n        right: 0;\n        z-index: 2;\n        background-size: 200% 100%;\n        animation: preview-slide 2s linear infinite;\n      }\n      @keyframes preview-slide {\n        0% { background-position: 200% 0; }\n        100% { background-position: 0% 0; }\n      }\n      .preview-chat {\n        position: relative;\n        z-index: 3;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        width: 80%;\n        margin: 0 auto;\n      }\n      .preview-msg {\n        max-width: 85%;\n        word-wrap: break-word;\n        text-align: center;\n        line-height: 1.0;\n        animation: preview-fade-in 0.3s ease;\n      }\n      .preview-msg.user {\n        align-self: center;\n      }\n      .preview-msg.assistant {\n        align-self: center;\n      }\n      @keyframes preview-fade-in {\n        from { opacity: 0; transform: translateY(8px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n      .preview-timer {\n        position: absolute;\n        z-index: 4;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        overflow: hidden;\n      }\n      .preview-timer-progress {\n        position: absolute;\n        top: 0;\n        left: 0;\n        height: 100%;\n        opacity: 0.3;\n        border-radius: inherit;\n      }\n      .preview-timer-content {\n        position: relative;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n      }\n    </style>\n    <div class="preview-background"></div>\n    <div class="preview-container">\n      <div class="preview-blur"></div>\n      <div class="preview-bar"></div>\n      <div class="preview-chat">\n        <div class="preview-msg user"></div>\n        <div class="preview-msg assistant"></div>\n      </div>\n      <div class="preview-timer">\n        <div class="preview-timer-progress"></div>\n        <div class="preview-timer-content">\n          <span>⏱</span>\n          <span class="preview-timer-time">00:04:32</span>\n        </div>\n      </div>\n    </div>\n  ',t.querySelector(".preview-container");const i=t.querySelector(".preview-blur");n.background_blur&&(i.style.backdropFilter=`blur(${n.background_blur_intensity}px)`,i.style.webkitBackdropFilter=`blur(${n.background_blur_intensity}px)`);const r=t.querySelector(".preview-bar");r.style.height=`${n.bar_height}px`,r.style.background=h(n.bar_gradient),r.style.backgroundSize="200% 100%","top"===n.bar_position?(r.style.top="0",r.style.bottom="auto"):(r.style.bottom="0",r.style.top="auto");const s=t.querySelector(".preview-msg.user");s.textContent="What's the temperature outside?",x(s,n,"transcription");const o=t.querySelector(".preview-msg.assistant");n.show_response?(o.textContent="It's currently 75°F and sunny.",x(o,n,"response")):o.style.display="none";const a=t.querySelector(".preview-chat"),l="chat"===n.bubble_style;a.style.width=`${n.bubble_container_width||80}%`,l?(a.style.alignItems="flex-start",s.style.alignSelf="flex-end",s.style.textAlign="left",o.style.alignSelf="flex-start",o.style.textAlign="left"):(a.style.alignItems="center",s.style.alignSelf="center",s.style.textAlign="center",o.style.alignSelf="center",o.style.textAlign="center"),"bottom"===n.bar_position?a.style.marginBottom=`${n.bar_height+8}px`:a.style.marginTop=`${n.bar_height+8}px`;const c=t.querySelector(".preview-timer");x(c,n,"timer");const u=t.querySelector(".preview-timer-progress"),_=n.timer_border_color||"rgba(100, 200, 150, 0.5)";u.style.background=_,u.style.width="65%";const p=n.timer_position||"top-right";c.style.top=p.startsWith("top")?`${n.bar_height+8+4}px`:"auto",c.style.bottom=p.startsWith("top")?"auto":`${n.bar_height+8+4}px`,c.style.left=p.includes("left")?"8px":"auto",c.style.right=p.includes("left")?"auto":"8px"}function Bt(t,e){const n=t.config.satellite_entity;n&&t.hass?.connection&&e!==t.lastSyncedSatelliteState&&(t.lastSyncedSatelliteState=e,t.hass.connection.sendMessagePromise({type:"voice_satellite/update_state",entity_id:n,state:e}).catch(()=>{}))}function Pt(n,i){const r=n.currentState;n.currentState=i,n.logger.log("state",`${r} → ${i}`),n.ui.updateForState(i,n.pipeline.serviceUnavailable,n.tts.isPlaying),(!n.tts.isPlaying||i!==e&&i!==t)&&Bt(n,i)}async function Ut(e){if(!J()||G(e))if(Y())e.logger.log("lifecycle","Pipeline already starting globally, skipping");else{K(!0);try{Pt(e,"CONNECTING"),await e.audio.startMicrophone(),await e.pipeline.start(),function(t){j.instance=t,j.active=!0}(e),e.ui.hideStartButton(),e.timer.update(),it(e,t=>N(e,t)),e.doubleTap.setup()}catch(n){const i=n?.message||JSON.stringify(n);e.logger.error("pipeline",`Failed to start: ${i}`);let r="error";"NotAllowedError"===n.name?(r="not-allowed",e.logger.log("mic","Access denied — browser requires user gesture")):"NotFoundError"===n.name?(r="not-found",e.logger.error("mic","No microphone found")):"NotReadableError"!==n.name&&"AbortError"!==n.name||(r="not-readable",e.logger.error("mic","Microphone in use or not readable")),"error"!==r?(e.ui.showStartButton(r),Pt(e,t)):(Pt(e,t),e.pipeline.restart(e.pipeline.calculateRetryDelay()))}finally{K(!1)}}else e.logger.log("lifecycle","Another instance is active, skipping")}class qt extends HTMLElement{constructor(){super(),this._state=t,this._lastSyncedSatelliteState=null,this._config=Object.assign({},d),this._hass=null,this._connection=null,this._hasStarted=!1,this._disconnectTimeout=null,this._logger=new _,this._audio=new p(this),this._tts=new S(this),this._pipeline=new C(this),this._ui=new I(this),this._chat=new R(this),this._doubleTap=new z(this),this._visibility=new ot(this),this._timer=new gt(this),this._announcement=new bt(this),this._askQuestion=new vt(this),this._startConversation=new St(this)}get logger(){return this._logger}get audio(){return this._audio}get tts(){return this._tts}get pipeline(){return this._pipeline}get ui(){return this._ui}get chat(){return this._chat}get doubleTap(){return this._doubleTap}get visibility(){return this._visibility}get config(){return this._config}get timer(){return this._timer}get announcement(){return this._announcement}get askQuestion(){return this._askQuestion}get startConversation(){return this._startConversation}get currentState(){return this._state}set currentState(t){this._state=t}get lastSyncedSatelliteState(){return this._lastSyncedSatelliteState}set lastSyncedSatelliteState(t){this._lastSyncedSatelliteState=t}get isOwner(){return G(this)}get connection(){return!this._connection&&this._hass?.connection&&(this._connection=this._hass.connection),this._connection}get hass(){return this._hass}connectedCallback(){this._disconnectTimeout&&(clearTimeout(this._disconnectTimeout),this._disconnectTimeout=null),this._render(),requestAnimationFrame(()=>{Rt(this)&&this.shadowRoot?$t(this.shadowRoot,this._config):this._config.satellite_entity&&(this._ui.ensureGlobalUI(),this._visibility.setup(),!J()&&this._hass?.connection&&Ut(this))})}disconnectedCallback(){this._disconnectTimeout=setTimeout(()=>{},100)}setConfig(t){const e=!!this._config.satellite_entity;this._config=Object.assign({},d,t),this._logger.debug=this._config.debug,this._ui.element&&this._ui.applyStyles(),this.shadowRoot&&Rt(this)&&$t(this.shadowRoot,this._config),j.instance&&j.instance!==this&&j.instance.setConfig(this.config),e||!this._config.satellite_entity||this._hasStarted||!this._hass?.connection||Rt(this)||(this._connection=this._hass.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,Ut(this)):(this._hasStarted=!0,this._ui.showStartButton()))}set hass(t){this._hass=t,Rt(this)||(J()&&G(this)&&(this._timer.update(),it(this,t=>N(this,t))),this._hasStarted||t?.connection&&this._config.satellite_entity&&(Y()||J()&&!G(this)||(this._connection=t.connection,this._ui.ensureGlobalUI(),this._config.start_listening_on_load?(this._hasStarted=!0,Ut(this)):(this._hasStarted=!0,this._ui.showStartButton()))))}getCardSize(){return 0}static getConfigForm(){return{schema:[...Tt,...kt,...Ct,...xt,...At],computeLabel:t=>It[t.name]||void 0,computeHelper:t=>Et[t.name]||void 0}}static getStubConfig(){return{start_listening_on_load:!0}}setState(t){Pt(this,t)}onStartClick(){!async function(t){await t.audio.ensureAudioContextForGesture(),await Ut(t)}(this)}onPipelineMessage(t){!function(t,e){if(t.visibility.isPaused)return void t.logger.log("event",`Ignoring event while paused: ${e.type}`);if(t.pipeline.isRestarting)return void t.logger.log("event",`Ignoring event while restarting: ${e.type}`);const n=e.type,o=e.data||{};if(t.config.debug){const i=e.timestamp?e.timestamp.split("T")[1].split(".")[0]:"";t.logger.log("event",`${i} ${n} ${JSON.stringify(o).substring(0,500)}`)}switch(n){case"run-start":t.pipeline.handleRunStart(o);break;case"wake_word-start":t.pipeline.handleWakeWordStart();break;case"wake_word-end":t.pipeline.handleWakeWordEnd(o);break;case"stt-start":Pt(t,i);break;case"stt-vad-start":t.logger.log("event","VAD: speech started");break;case"stt-vad-end":t.logger.log("event","VAD: speech ended");break;case"stt-end":t.pipeline.handleSttEnd(o);break;case"intent-start":Pt(t,r);break;case"intent-progress":t.pipeline.handleIntentProgress(o);break;case"intent-end":t.pipeline.handleIntentEnd(o);break;case"tts-start":Pt(t,s);break;case"tts-end":t.pipeline.handleTtsEnd(o);break;case"run-end":t.pipeline.handleRunEnd();break;case"error":t.pipeline.handleError(o)}}(this,t)}onTTSComplete(t){!function(t,e){if([n,i,r].includes(t.currentState))return void t.logger.log("tts","New interaction in progress — skipping cleanup");if(!e&&t.pipeline.shouldContinue&&t.pipeline.continueConversationId){t.logger.log("pipeline","Continuing conversation — skipping wake word");const e=t.pipeline.continueConversationId;return t.pipeline.clearContinueState(),t.chat.streamEl=null,void t.pipeline.restartContinue(e)}const s=t.config.tts_target&&"browser"!==t.config.tts_target;!1===T(t.hass,t.config.satellite_entity,"wake_sound")||s||t.tts.playChime("done"),t.chat.clear(),t.ui.hideBlurOverlay(l),t.ui.updateForState(t.currentState,t.pipeline.serviceUnavailable,!1),Bt(t,"IDLE"),t.announcement.playQueued(),t.askQuestion.playQueued(),t.startConversation.playQueued()}(this,t)}_render(){this.shadowRoot||this.attachShadow({mode:"open"}),Rt(this)?$t(this.shadowRoot,this._config):this.shadowRoot.innerHTML='<div id="voice-satellite-card" style="display:none;"></div>'}}customElements.define("voice-satellite-card",qt),window.customCards=window.customCards||[],window.customCards.push({type:"voice-satellite-card",name:"Voice Satellite Card",description:"Transform your browser into a voice satellite for Home Assistant Assist",preview:!1,documentationURL:"https://github.com/owner/voice-satellite-card"}),console.info("%c VOICE-SATELLITE-CARD %c v4.0.0 ","color: white; background: #03a9f4; font-weight: bold;","color: #03a9f4; background: white; font-weight: bold;")})();